{% extends "website/base.html" %}
{% block title %}Dashboard - Fieldmax Shop{% endblock %}


{% block content %}
<style>
/* Dashboard Specific Styles */
.dashboard-wrapper {
  display: flex;
  min-height: calc(100vh - 160px);
  background-color: #4c5055;
  position: relative;
}

/* Sidebar */
.dashboard-sidebar {
  width: 260px;
  background: #52db89;
  border-right: 1px solid #e5e7eb;
  padding: 1.5rem 0;
  position: sticky;
  top: 76px;
  height: calc(100vh - 76px);
  overflow-y: auto;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
  flex-shrink: 0;
}

.sidebar-header {
  padding: 0 1.5rem 1.5rem;
  border-bottom: 2px solid #ffffff;
  margin-bottom: 1rem;
}

.sidebar-title {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  color: #1a1f2e;
  font-size: 1.25rem;
  font-weight: 700;
  margin: 0;
}

.sidebar-title i {
  font-size: 1.75rem;
  color: #000000;
}

.sidebar-nav {
  padding: 0 1rem;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  color: #000000;
  font-weight: 500;
  border-radius: 0.5rem;
  transition: all 0.3s ease;
  cursor: pointer;
  border: none;
  background: transparent;
  width: 100%;
  text-align: left;
  font-size: 0.95rem;
  text-decoration: none;
  margin-bottom: 0.25rem;
}

.nav-item:hover {
  background: #f3f4f6;
  color: #fa0000;
}

.nav-item.active {
  background: linear-gradient(135deg, #0dcaf0 0%, #0ab4d6 100%);
  color: #ffffff;
  box-shadow: 0 2px 4px rgba(13, 202, 240, 0.3);
}

.nav-item i {
  font-size: 1.25rem;
  width: 24px;
  text-align: center;
}

.nav-item .bi-chevron-down {
  margin-left: auto;
  font-size: 0.875rem;
  transition: transform 0.3s ease;
}

.nav-item[aria-expanded="true"] .bi-chevron-down {
  transform: rotate(180deg);
}

.submenu {
  margin-left: 2.5rem;
  margin-top: 0.5rem;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  padding-bottom: 0.5rem;
}

.submenu-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  color: #6c757d;
  font-size: 0.875rem;
  border-radius: 0.375rem;
  transition: all 0.3s ease;
  text-decoration: none;
  cursor: pointer;
}

.submenu-item:hover {
  background: #f3f4f6;
  color: #1a1f2e;
  transform: translateX(5px);
}

.submenu-item.active {
  background: #e0f7ff;
  color: #0dcaf0;
  font-weight: 600;
}

.submenu-item i {
  font-size: 1rem;
}

/* Main Content Area */
.dashboard-content {
  flex: 1;
  padding: 2rem;
  overflow-x: hidden;
}

.content-section {
  display: none;
}

.content-section.active {
  display: block;
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.content-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2rem;
  gap: 1rem;
  flex-wrap: wrap;
}

.page-title {
  font-size: 2rem;
  font-weight: 500;
  color: #1a1f2e;
  margin: 0;
}

.mobile-sidebar-toggle {
  display: none;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  color: #1a1f2e;
  font-size: 1.5rem;
  padding: 0.5rem 0.75rem;
  border-radius: 0.5rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.mobile-sidebar-toggle:hover {
  background: #0dcaf0;
  color: #ffffff;
  border-color: #0dcaf0;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.stat-card {
  display: flex;
  align-items: center;
  gap: 1.25rem;
  padding: 1.5rem;
  background: #ffffff;
  border-radius: 0.75rem;
  border: 1px solid #e5e7eb;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
  text-decoration: none;
  position: relative;
  overflow: hidden;
  cursor: pointer;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: #0dcaf0;
  transform: scaleY(0);
  transition: transform 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  border-color: #0dcaf0;
}

.stat-card:hover::before {
  transform: scaleY(1);
}

.stat-icon {
  width: 70px;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0.75rem;
  font-size: 2rem;
  flex-shrink: 0;
}

.stat-card-primary .stat-icon {
  background: linear-gradient(135deg, rgba(13, 202, 240, 0.15) 0%, rgba(13, 202, 240, 0.05) 100%);
  color: #0dcaf0;
}

.stat-card-success .stat-icon {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
  color: #10b981;
}

.stat-card-warning .stat-icon {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%);
  color: #f59e0b;
}

.stat-card-info .stat-icon {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.05) 100%);
  color: #3b82f6;
}

.stat-content {
  flex: 1;
}

.stat-label {
  display: block;
  font-size: 0.875rem;
  color: #6c757d;
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.stat-value {
  font-size: 1.25rem;
  font-weight: 400;
  color: #1a1f2e;
  margin: 0 0 0.25rem 0;
  line-height: 0.8;
}

.stat-subtitle {
  font-size: 0.8rem;
  color: #6c757d;
}

/* Dashboard Sections */
.dashboard-section {
  margin-bottom: 2rem;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.25rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.section-title-wrapper {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.section-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1a1f2e;
  margin: 0;
}

.section-subtitle {
  font-size: 0.875rem;
  color: #6c757d;
}

.btn-action {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1.25rem;
  border-radius: 0.5rem;
  font-weight: 600;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  border: none;
  cursor: pointer;
  text-decoration: none;
}

.btn-primary {
  background: linear-gradient(135deg, #0dcaf0 0%, #0ab4d6 100%);
  color: #ffffff;
  box-shadow: 0 2px 4px rgba(13, 202, 240, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(13, 202, 240, 0.4);
  color: #ffffff;
}

.btn-success {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: #ffffff;
  box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
  color: #ffffff;
}

/* Data Card & Table */
.data-card {
  background: #00bfff;
  border-radius: 0.75rem;
  border: 1px solid #e5e7eb;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  overflow: hidden;
}

.table-wrapper {
  overflow-x: auto;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
}

.data-table thead {
  background: #00bfe6;
}

.data-table th {
  padding: 1rem 1.25rem;
  text-align: left;
  font-size: 1rem;
  font-weight: 800;
  color: #000000;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid #e5e7eb;
}

.data-table td {
  padding: 1rem 1.25rem;
  border-bottom: 1px solid #f3f4f6;
  color: #000000;
  font-size: 0.925rem;
}

.data-table tbody tr {
  transition: background-color 0.15s ease;
}

.data-table tbody tr:hover {
  background: #f9fafb;
}

.data-table tbody tr:last-child td {
  border-bottom: none;
}

.table-cell-content {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.table-cell-content i {
  font-size: 1.25rem;
}

.text-primary {
  color: #0dcaf0 !important;
}

.text-success {
  color: #10b981 !important;
}

.text-end {
  text-align: right !important;
}

.text-center {
  text-align: center !important;
}

/* Badges */
.badge {
  display: inline-flex;
  padding: 0.375rem 0.75rem;
  font-size: 0.8rem;
  font-weight: 500;
  border-radius: 0.375rem;
}

.bg-secondary {
  background: #6c757d !important;
  color: #ffffff !important;
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-end;
}

.action-btn {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0.5rem;
  border: 1px solid #e5e7eb;
  background: #ffffff;
  color: #6c757d;
  transition: all 0.3s ease;
  cursor: pointer;
  text-decoration: none;
}

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.action-btn-edit:hover {
  background: #0dcaf0;
  color: #ffffff;
  border-color: #0dcaf0;
}

.action-btn-delete:hover {
  background: #ef4444;
  color: #ffffff;
  border-color: #ef4444;
}

.action-btn-info:hover {
  background: #3b82f6;
  color: #ffffff;
  border-color: #3b82f6;
}

.action-btn-warning:hover {
  background: #f59e0b;
  color: #ffffff;
  border-color: #f59e0b;
}

/* Special Elements */
.sale-id {
  font-family: 'Courier New', monospace;
  color: #6c757d;
  font-weight: 600;
}

.price-tag {
  color: #10b981;
  font-weight: 700;
  font-size: 1.05rem;
}

.empty-state {
  padding: 3rem !important;
  color: #6c757d;
  text-align: center;
}

.empty-state i {
  font-size: 3rem;
  color: #d1d5db;
  display: block;
  margin-bottom: 1rem;
}

.empty-state p {
  margin: 0;
  font-size: 1rem;
}

/* Form Styles */
.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: #1a1f2e;
  font-size: 0.95rem;
}

.form-label.required::after {
  content: ' *';
  color: #ef4444;
}

.form-control,
.form-select {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #e5e7eb;
  border-radius: 0.5rem;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  margin-bottom: 1rem;
}

.form-control:focus,
.form-select:focus {
  outline: none;
  border-color: #0dcaf0;
  box-shadow: 0 0 0 3px rgba(13, 202, 240, 0.1);
}

.form-check {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.form-check-input {
  width: 1.25rem;
  height: 1.25rem;
  cursor: pointer;
}

.form-check-label {
  cursor: pointer;
  user-select: none;
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  padding: 2rem;
  border-radius: 0.75rem;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-content h3 {
  margin: 0 0 1rem 0;
  color: #1a1f2e;
  font-size: 1.5rem;
}

.modal-actions {
  margin-top: 1.5rem;
  display: flex;
  justify-content: space-between;
  gap: 1rem;
}

.modal-actions button {
  flex: 1;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 0.5rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

/* Alert Styles */
.alert {
  padding: 1rem;
  border-radius: 0.5rem;
  margin-bottom: 1rem;
}

.alert-info {
  background: #e0f7ff;
  border: 1px solid #0dcaf0;
  color: #0a7a8f;
}

.alert-success {
  background: #d1fae5;
  border: 1px solid #10b981;
  color: #065f46;
}

.alert-danger {
  background: #fee2e2;
  border: 1px solid #ef4444;
  color: #991b1b;
}

/* Responsive Design */
@media (max-width: 992px) {
  .dashboard-wrapper {
    flex-direction: column;
  }

  .dashboard-sidebar {
    position: fixed;
    left: -260px;
    top: 76px;
    z-index: 998;
    transition: left 0.3s ease;
  }

  .dashboard-sidebar.active {
    left: 0;
  }

  .mobile-sidebar-toggle {
    display: block;
  }

  .dashboard-content {
    padding: 1.5rem;
  }

  .stats-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .dashboard-content {
    padding: 1rem;
  }

  .page-title {
    font-size: 1.5rem;
  }

  .stat-value {
    font-size: 1.75rem;
  }

  .stat-card {
    flex-direction: column;
    text-align: center;
  }

  .section-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .data-table th,
  .data-table td {
    padding: 0.75rem;
    font-size: 0.85rem;
  }
}

@media (max-width: 576px) {
  .content-header {
    flex-direction: column;
    align-items: flex-start;
  }
}


.toast-message {
    position: fixed;
    top: 20px;
    right: -300px;
    padding: 15px 20px;
    background: #28a745;
    color: white;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: all 0.4s ease;
    z-index: 9999;
    font-weight: bold;
}
.toast-message.error {
    background: #dc3545;
}
.toast-message.show {
    right: 20px;
}

/* ================================
   ACTION BUTTONS
================================ */
.action-buttons { display: flex; gap: 6px; justify-content: flex-end; }
.action-btn { width: 32px; height: 32px; border: none; cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
.action-btn i { font-size: 16px; }
.action-btn-edit { background: #0d6efd20; color: #0d6efd; }
.action-btn-edit:hover { background: #0d6efd; color: #fff; }
.action-btn-info { background: #0dcaf020; color: #0dcaf0; }
.action-btn-info:hover { background: #0dcaf0; color: #fff; }
.action-btn-delete { background: #dc354520; color: #dc3545; }
.action-btn-delete:hover { background: #dc3545; color: #fff; }

/* ================================
   MODAL BASE STYLE
================================ */
.modal-overlay { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); align-items: center; justify-content: center; }
.modal-content { background: #fff; padding: 25px; border-radius: 10px; width: 400px; position: relative; animation: popIn 0.3s ease-out; }
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* Modal titles and buttons */
.modal-content h3 { margin-top: 0; font-weight: 600; }
.modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.btn-cancel { background: #6c757d; color: #fff; padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; }
.btn-cancel:hover { opacity: 0.8; }
.btn-save, .btn-confirm-delete { background: #0d6efd; color: #fff; padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; }
.btn-save:hover, .btn-confirm-delete:hover { opacity: 0.85; }
.warning-icon { font-size: 36px; color: #dc3545; text-align: center; margin-bottom: 10px; }
.delete-text, .delete-warning-note { text-align: center; margin: 5px 0; font-weight: 500; }

/* Badge Styles */
.badge {
  display: inline-block;
  padding: 4px 8px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 4px;
  white-space: nowrap;
}

.badge-success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.badge-danger {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.badge-warning {
  background-color: #fff3cd;
  color: #856404;
  border: 1px solid #ffeeba;
}

/* Modal Styles */
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: #fff;
  margin: 10% auto;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.close-modal {
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  color: #aaa;
}

.close-modal:hover {
  color: #000;
}

#etr-modal-body {
  margin-top: 20px;
}

#etr-modal-body p {
  margin: 10px 0;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 4px;
}

#etr-modal-body strong {
  display: inline-block;
  width: 150px;
  color: #495057;
}

/* Enhanced Product Table Styles */
.product-row {
  transition: all 0.2s ease;
}

.product-row:hover {
  background-color: #f9fafb !important;
  transform: scale(1.001);
}

.product-row.hidden {
  display: none;
}

/* Stock status highlighting */
.product-row[data-stock-status="outofstock"] {
  background-color: #fee2e2 !important;
}

.product-row[data-stock-status="lowstock"] {
  background-color: #fef3c7 !important;
}

/* Badge styles */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  font-size: 11px;
  font-weight: 600;
  border-radius: 4px;
  white-space: nowrap;
}

.badge-success {
  background-color: #d1fae5;
  color: #065f46;
  border: 1px solid #6ee7b7;
}

.badge-warning {
  background-color: #fef3c7;
  color: #92400e;
  border: 1px solid #fcd34d;
}

.badge-danger {
  background-color: #fee2e2;
  color: #991b1b;
  border: 1px solid #fca5a5;
}

.stat-card-danger .stat-icon {
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%);
  color: #ef4444;
}

/* Action button colors */
.action-btn-warning {
  background: rgba(245, 158, 11, 0.1);
  color: #f59e0b;
  border: 1px solid rgba(245, 158, 11, 0.2);
}

.action-btn-warning:hover {
  background: #f59e0b;
  color: white;
  border-color: #f59e0b;
}

/* Modal enhancements */
.modal-content {
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header-custom {
  padding: 20px 25px;
  border-radius: 10px 10px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-body-custom {
  padding: 25px;
  max-height: 60vh;
  overflow-y: auto;
}

.form-input, .form-select {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #e5e7eb;
  border-radius: 6px;
  font-size: 14px;
  transition: all 0.3s ease;
}

.form-input:focus, .form-select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #374151;
  font-size: 14px;
}

/* Modal Overlay - Blocks entire screen */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 9998;
  backdrop-filter: blur(3px);
}

/* Custom Modal */
.custom-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

/* Modal Container */
.modal-container {
  background: white;
  border-radius: 10px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  width: 100%;
  max-width: 500px;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Modal Header */
.modal-header-custom {
  padding: 20px 25px;
  border-radius: 10px 10px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header-custom.bg-warning {
  background: #ffc107;
  color: #000;
}

.modal-header-custom.bg-primary {
  background: #007bff;
  color: white;
}

.modal-title {
  margin: 0;
  font-size: 20px;
  font-weight: bold;
}

.close-btn {
  background: transparent;
  border: none;
  font-size: 30px;
  cursor: pointer;
  color: inherit;
  line-height: 1;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-btn:hover {
  opacity: 0.7;
}

/* Modal Body */
.modal-body-custom {
  padding: 25px;
}

.modal-body-custom p {
  margin: 10px 0;
  font-size: 15px;
  line-height: 1.6;
}

/* Form Styles */
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #333;
  font-size: 14px;
}

.form-input {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 15px;
  transition: all 0.3s ease;
}

.form-input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

/* Modal Footer */
.modal-footer-custom {
  padding: 20px 25px;
  border-top: 1px solid #e9ecef;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.sale-row[data-status="reversed"] {
  background-color: #fef3c7 !important;
  opacity: 0.75;
}

.sale-row[data-status="reversed"]:hover {
  background-color: #fde68a !important;
  opacity: 0.85;
}

/* Hide reversed sales when filter is active */
.sale-row.hidden {
  display: none;
}

/* Reverse button animation */
.reverse-sale-btn {
  transition: all 0.3s ease;
}

.reverse-sale-btn:hover {
  transform: rotate(180deg);
}

/* Modal textarea focus */
.form-control:focus {
  outline: none;
  border-color: #f59e0b;
  box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
}

/* Buttons */
.btn-cancel {
  padding: 10px 20px;
  background: #6c757d;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.3s ease;
}

.btn-cancel:hover {
  background: #5a6268;
  transform: translateY(-2px);
}

.btn-save {
  padding: 10px 20px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.3s ease;
}

.btn-save:hover {
  background: #218838;
  transform: translateY(-2px);
}

.btn-proceed {
  padding: 10px 20px;
  background: #ffc107;
  color: #000;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  text-decoration: none;
  display: inline-block;
  transition: all 0.3s ease;
}

.btn-proceed:hover {
  background: #e0a800;
  transform: translateY(-2px);
}

/* Enhanced styles for sale type badges */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  font-size: 11px;
  font-weight: 800;
  border-radius: 4px;
  white-space: nowrap;
}

.sale-row[data-status="reversed"] {
  background-color: #fef3c7 !important;
  opacity: 0.8;
}

.sale-row[data-status="reversed"]:hover {
  background-color: #0d10d4 !important;
}

/* Filter animations */
.sale-row.hidden {
  display: none;
}

/* in your CSS file */
.stock-instock { color: #10b981; }
.stock-lowstock { color: #f59e0b; }
.stock-outofstock { color: #ef4444; }
.stock-sold { color: #ef4444; }

.margin-high { background: #10b981; color: white; }
.margin-medium { background: #f59e0b; color: white; }
.margin-low { background: #ef4444; color: white; }
.required::after {
  content: " *";
  color: #dc3545;
}

.data-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  overflow: hidden;
}

.card-header {
  padding: 1.25rem 2rem;
  border-bottom: 2px solid rgba(255,255,255,0.2);
}

.card-body {
  min-height: 500px;
}

.form-control:focus {
  border-color: #10b981;
  box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25);
}

.btn:disabled {
  cursor: not-allowed;
  opacity: 0.5;
}

/* Product Details Animations */
#productDetails {
  animation: fadeInUp 0.4s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Empty State Animation */
#emptyState i {
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 0.6; }
}

/* Badge Styles */
.product-badge {
  font-size: 0.875rem;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-weight: 600;
}

.badge.bg-success {
  background-color: #10b981 !important;
}

.badge.bg-warning {
  background-color: #f59e0b !important;
  color: #000;
}

.badge.bg-danger {
  background-color: #ef4444 !important;
}

/* Product Info Card */
.product-info-card {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 12px;
  padding: 1.5rem;
  border: 2px solid #e2e8f0;
}

.product-info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  border-bottom: 1px solid #e2e8f0;
}

.product-info-item:last-child {
  border-bottom: none;
}

.product-info-label {
  color: #64748b;
  font-size: 0.875rem;
  font-weight: 500;
}

.product-info-value {
  color: #1e293b;
  font-size: 1rem;
  font-weight: 600;
}

/* Responsive adjustments */
@media (max-width: 991px) {
  .col-lg-6 {
    margin-bottom: 1.5rem;
  }
  
  .card-body {
    min-height: auto;
  }
}

/* FIFO Age Badge */
.fifo-badge {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-size: 0.875rem;
  display: inline-block;
  margin-top: 0.5rem;
}

/* Sold Product Alert Styling */
.sold-alert {
  border-left: 4px solid #ef4444;
  background: #fef2f2;
  padding: 1.5rem;
  border-radius: 8px;
}

/* Available Product Styling */
.available-alert {
  border-left: 4px solid #10b981;
  background: #f0fdf4;
  padding: 1.5rem;
  border-radius: 8px;
}

.action-buttons {
  display: flex;
  gap: 8px; /* Adjust spacing as needed */
}

/* small visual for dragging */
th.draggable {
  cursor: move;
  user-select: none;
}
th.dragging {
  opacity: 0.5;
}


/* Grid lines for table */
.data-table {
  border-collapse: collapse;
  border: 1px solid #dee2e6;
}

.data-table thead th {
  border: 1px solid #dee2e6;
  background-color: #f8f9fa;
}

.data-table tbody td {
  border: 1px solid #dee2e6;
}

.data-table tbody tr:hover {
  background-color: #f8f9fa;
}

/* Search and entries controls */
.table-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  gap: 1rem;
  flex-wrap: wrap;
}

.entries-control {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.search-control {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex: 1;
  max-width: 400px;
}

.search-control input {
  flex: 1;
  padding: 0.5rem 1rem;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  font-size: 0.9rem;
}

.search-control button {
  padding: 0.5rem 1rem;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.search-control button:hover {
  background: #2563eb;
}

.entries-control select {
  padding: 0.5rem;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  font-size: 0.9rem;
}

.product-info-card {
  display: grid;
  gap: 12px;
  margin-top: 16px;
}

.product-info-item {
  display: flex;
  justify-content: space-between;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 6px;
  border-left: 3px solid #0d6efd;
}

.product-info-label {
  font-weight: 600;
  color: #6c757d;
  font-size: 0.9rem;
}

.product-info-value {
  text-align: right;
  color: #212529;
  font-size: 0.9rem;
}

.transfer-preview {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
}

.autocomplete-dropdown::-webkit-scrollbar {
  width: 8px;
}

.autocomplete-dropdown::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.autocomplete-dropdown::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 4px;
}

.autocomplete-dropdown::-webkit-scrollbar-thumb:hover {
  background: #555;
}

/* Animation for live preview updates */
#liveProductPreview, #liveOwnerPreview {
  transition: all 0.3s ease;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.updating {
  animation: pulse 1s ease-in-out;
}

/* Make product details compact */
#transferProductDetails .alert {
  margin-bottom: 0;
}

#transferProductDetails .product-info-card {
  margin-top: 12px;
}

/* Product Details Modal Styles */
.detail-row {
  display: grid;
  grid-template-columns: 140px 1fr;
  gap: 10px;
  padding: 12px;
  background: #f9fafb;
  border-radius: 6px;
}

.detail-row-highlight {
  background: #e0f2fe;
  border-left: 4px solid #3b82f6;
}

.detail-code {
  background: #e5e7eb;
  padding: 4px 8px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
}

/* Toast Message Styles */
.toast-message {
  position: fixed;
  top: 20px;
  right: -300px;
  padding: 15px 20px;
  background: #28a745;
  color: white;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transition: right 0.4s ease;
  z-index: 9999;
  font-weight: 600;
  max-width: 400px;
}

.toast-message.show {
  right: 20px;
}

.toast-message.error {
  background: #dc3545;
}

.toast-message.warning {
  background: #ffc107;
  color: #000;
}

.toast-message.info {
  background: #17a2b8;
}
</style>

<div class="dashboard-wrapper">

<!-- ======================================= -->
<!-- SIDEBAR  TEMPLATE -->
<!-- ======================================= -->
  <aside class="dashboard-sidebar" id="dashboardSidebar">
    <div class="sidebar-header">
      <h2 class="sidebar-title">
        <i class="bi bi-grid-3x3-gap-fill"></i>
        <span>MANAGER PANEL</span>
      </h2>
      <div class="sidebar-user mt-2">
        <i class="bi bi-person-circle"></i>
        <span>
          {% if user.is_authenticated %}
           {{ user.get_full_name|default:user.username }}
          {% else %}
          Guest
          {% endif %}
        </span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="#dashboard" class="nav-item active" data-section="dashboard">
        <i class="bi bi-speedometer2"></i>
        <span>Dashboard</span>
      </a>

      <button class="nav-item" data-bs-toggle="collapse" data-bs-target="#productsSubmenu" aria-expanded="false">
        <i class="bi bi-box-seam"></i>
        <span>Products</span>
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="submenu collapse" id="productsSubmenu">
        <a href="#product-list" class="submenu-item" data-section="product-list">
          <i class="bi bi-list-ul"></i>
          <span>All Products</span>
        </a>
        <a href="{% url 'inventory:category-create' %}" class="submenu-item" data-section="add-category">
          <i class="bi bi-plus-circle"></i>
          <span>Add Category</span>
        </a>
        <a href="{% url 'inventory:product-create' %}" class="submenu-item" data-section="add-product">
          <i class="bi bi-plus-circle"></i>
          <span>Add Product</span>
        </a>
        <a href="#" class="submenu-item" data-section="restock-product">
          <i class="bi bi-plus-circle"></i>
          <span>Restock products</span>
        </a>
        <a href="#" class="submenu-item" data-section="transfer-product">
          <i class="bi bi-plus-circle"></i>
          <span>Transfer products</span>
        </a>
      </div>

      <button class="nav-item" data-bs-toggle="collapse" data-bs-target="#salesSubmenu" aria-expanded="false">
        <i class="bi bi-cart-check"></i>
        <span>Sales</span>
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="submenu collapse" id="salesSubmenu">
        <a href="#sales-list" class="submenu-item" data-section="sales-list">
          <i class="bi bi-list-check"></i>
          <span>All Sales</span>
        </a>
        <a href="#generate-report" class="submenu-item" data-section="generate-report">
          <i class="bi bi-plus-circle"></i>
          <span>Generate Report</span>
        </a>
      </div>

      <button class="nav-item" data-bs-toggle="collapse" data-bs-target="#usersSubmenu" aria-expanded="false">
        <i class="bi bi-people"></i>
        <span>Users</span>
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="submenu collapse" id="usersSubmenu">
        <a href="#users-list" class="submenu-item" data-section="users-list">
          <i class="bi bi-person-lines-fill"></i>
          <span>All Users</span>
        </a>
        <a href="#add-user" class="submenu-item" data-section="add-user">
          <i class="bi bi-person-plus"></i>
          <span>Add User</span>
        </a>
      </div>
      <!-- LOGOUT -->
      <div style="margin-top: auto; padding: 1rem; border-top: 2px solid #e5e7eb;">
        <form method="post" action="{% url 'logout' %}">
        {% csrf_token %}
          <button type="submit" class="nav-item" style="border: 1px solid #dc2626; background: #fee2e2; color: #dc2626; width: 100%;">
            <i class="bi bi-box-arrow-right"></i>
            <span>Logout</span>
          </button>
        </form>
     </div>
    </nav>
  </aside>

  










<!-- ======================================= -->
<!-- MAIN DASHBOARD TEMPLATE -->
<!-- ======================================= -->
  <main class="dashboard-content">
    
    <!-- Dashboard Overview Section -->
    <div id="dashboard" class="content-section active">
      <!-- Content Header -->
      <div class="content-header">
        <button class="mobile-sidebar-toggle" id="mobileSidebarToggle">
          <i class="bi bi-list"></i>
        </button>
        <h1 class="page-title">Dashboard Overview</h1>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card stat-card-success" data-section="product-list">
          <div class="stat-icon">
            <i class="bi bi-stack"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">All Products</span>
            <h1 class="stat-value">{{ total_products|default:0 }}</h1>
            <span class="stat-subtitle">Sum of all product quantities</span>
          </div>
        </div>

        <div class="stat-card stat-card-success" data-section="sales-list">
          <div class="stat-icon">
            <i class="bi bi-currency-dollar"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Total Sales</span>
            <h1 class="stat-value">KSH {{ total_sales|default:0 }}</h1>
            <span class="stat-subtitle">Revenue generated</span>
          </div>
        </div>

      </div>


<!-- ========================================
     RECENT PRODUCTS
========================================= -->
<section class="dashboard-section">

  <!-- Section Header -->
  <div class="section-header">
    <div class="section-title-wrapper">
      <h2 class="section-title">Recent Products</h2>
      <span class="section-subtitle">Latest additions to inventory</span>
    </div>

    <a href="#add-product" class="btn-action btn-primary" data-section="add-product">
      <i class="bi bi-plus-circle"></i>
      <span>Add Product</span>
    </a>
  </div>

<!-- Products Table -->
  <div class="data-card">
    <div class="table-wrapper">
      <table class="data-table" id="productsTable">
        <thead>
          <tr>
            <th>Product Code</th>
            <th>Type</th>
            <th>Product Name</th>
            <th>Category</th>
            <th>Status</th>
            <th>Stock</th>
            <th>Buying Price</th>
            <th>Selling Price</th>
            <th>Margin</th>
            <th>Owner</th>
            <th>Date Added</th>
          </tr>
        </thead>
        <tbody>
          {% for product_info in recent_products_with_margin_and_status %}
          {% with product=product_info.product %}
          <tr class="product-row" 
              id="product-row-{{ product.id }}"
              data-product-id="{{ product.id }}"
              data-category="{{ product.category.id }}"
              data-stock-status="{{ product_info.status }}"
              data-type="{% if product.category.is_single_item %}single{% else %}bulk{% endif %}">
            
            <!-- Product Code -->
            <td>
              <code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                {{ product.product_code }}
              </code>
            </td>

            <!-- Type Badge -->
            <td>
              {% if product.category.is_single_item %}
                <span class="badge" style="background: #3b82f6; color: white;">
                  <i class="bi bi-tag"></i> Single
                </span>
              {% else %}
                <span class="badge" style="background: #8b5cf6; color: white;">
                  <i class="bi bi-box-seam"></i> Bulk
                </span>
              {% endif %}
            </td>

            <!-- Product Name -->
            <td class="product-name"><strong>{{ product.name }}</strong></td>

            <!-- Category -->
            <td><span class="badge bg-secondary">{{ product.category.name }}</span></td>

          
<!-- STATUS BADGE -->
<td>
  {% if product.category.is_single_item %}
    {% if product.status == "sold" %}
      <span class="badge badge-danger">
        <i class="bi bi-x-circle-fill"></i> Sold Out
      </span>
    {% else %}
      <span class="badge badge-success">
        <i class="bi bi-check-circle-fill"></i> In Stock
      </span>
    {% endif %}
  {% else %}
    {% if product.quantity == 0 %}
      <span class="badge badge-danger">
        <i class="bi bi-x-circle-fill"></i> Out of Stock
      </span>
    {% elif product.quantity <= 5 %}
      <span class="badge badge-warning">
        <i class="bi bi-exclamation-triangle-fill"></i> Low Stock
      </span>
    {% else %}
      <span class="badge badge-success">
        <i class="bi bi-check-circle-fill"></i> In Stock
      </span>
    {% endif %}
  {% endif %}
</td>

<!-- STOCK COLUMN -->
<td class="product-quantity">
  {% if product.category.is_single_item %}
    {% if product.status == 'sold' %}
      <strong style="color: #dc3545; font-weight: bold;">
        <i class="bi bi-x-circle-fill"></i> SOLD
      </strong>
    {% else %}
      <strong style="color: #28a745; font-weight: bold;">
        <i class="bi bi-check-circle-fill"></i> Available
      </strong>
    {% endif %}
  {% else %}
    {% if product.quantity > 5 %}
      <strong style="color: #28a745; font-weight: bold;">
        {{ product.quantity }} units
      </strong>
    {% elif product.quantity > 0 %}
      <strong style="color: #ffc107; font-weight: bold;">
        {{ product.quantity }} units (Low)
      </strong>
    {% else %}
      <strong style="color: #dc3545; font-weight: bold;">
        0 units (Out)
      </strong>
    {% endif %}
  {% endif %}
</td>
            <!-- Buying Price -->
            <td>
              <strong class="price-green">KSH {{ product.buying_price|floatformat:2 }}</strong>
            </td>

            <!-- Selling Price -->
            <td>
              <strong class="price-green">KSH {{ product.selling_price|floatformat:2 }}</strong>
            </td>

            <!-- Margin -->
            <td>
              <span class="badge
                {% if product_info.margin_pct >= 30 %}margin-high
                {% elif product_info.margin_pct >= 15 %}margin-medium
                {% else %}margin-low
                {% endif %}">
                +{{ product_info.margin_pct|floatformat:0 }}%
              </span>
            </td>

            <!-- Owner -->
            <td>
              <div class="owner-field">
                <i class="bi bi-person-circle"></i>
                <span>{{ product.owner.username|default:"FIELDMAX" }}</span>
              </div>
            </td>

            <!-- Date -->
            <td>
              <span class="date-text">{{ product.created_at|date:"M d, Y" }}</span>
            </td>

          </tr>

          {% endwith %}
          {% empty %}

          <tr>
            <td colspan="12">
              <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <p>No products found in inventory.</p>
              </div>
            </td>
          </tr>

          {% endfor %}
        </tbody>

      </table>
    </div>
  </div>

</section>


<!-- ======================================= -->
<!-- RECENT SALES TEMPLATE -->
<!-- ======================================= -->
<section class="dashboard-section">
  <div class="section-header">
    <div class="section-title-wrapper">
      <h2 class="section-title">Recent Sales</h2>
      <span class="section-subtitle">Latest transactions</span>
    </div>
    <a href="#record-sale" class="btn-action btn-success" data-section="record-sale">
      <i class="bi bi-plus-circle"></i>
      <span>Record Sale</span>
    </a>
  </div>

  <div class="data-card">
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Sale ID</th>
            <th>Buyer</th>
            <th>Total Price</th>
            <th>Sold By</th>
            <th>Date Sold</th>
            <th>View Receipt</th>
          </tr>
        </thead>
        <tbody>
          {% for sale in recent_sales %}
          <tr>
            <!-- Sale ID -->
            <td>
              <strong>#{{ sale.sale_id }}</strong>
              {% if sale.is_reversed %}
                <span class="badge badge-warning" style="font-size: 10px; background: #fef3c7; color: #92400e;">
                  <i class="bi bi-arrow-counterclockwise"></i> REVERSED
                </span>
              {% endif %}
            </td>

            <!-- buyer -->
            <td>{{ sale.buyer_name|default:"Walk-in" }}</td>

            <!-- Total Price -->
            <td>{{ sale.total_amount }}</td>

            <!-- seller -->
            <td>{{ sale.seller.username }}</td>

            <!-- sale date -->
            <td>{{ sale.sale_date|date:"M d, Y H:i" }}</td>

            <!-- Total Price -->
            <td>
              {% if sale.is_reversed %}
                <span class="btn btn-secondary disabled">ETR Returned</span>

              {% else %}
                {% if sale.batch_id %}
                  <a href="{% url 'sales:batch-receipt' sale.batch_id %}"
                     class="btn btn-primary"
                     style="display: inline-block;">
                    View Receipt ({{ sale.batch_total_sales }} items)
                  </a>
                {% else %}
                  <a href="{% url 'sales:sale-etr' sale.sale_id %}"
                     class="btn btn-primary"
                     style="display: inline-block;">
                   View Receipt
                  </a>
                {% endif %}
                {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9">
              <div class="empty-state">
                <i class="bi bi-box-seam"></i>
                <p>No recent sales found.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
</div>













<!-- ======================================= -->
<!-- PRODUCTS TEMPLATE -->
<!-- ======================================= -->
<div id="product-list" class="content-section">
  <div class="content-header">
    <h1 class="page-title">INVENTORY MANAGEMENT</h1>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <!-- Filter Buttons -->
      <select id="productStatusFilter" class="form-select" style="width: auto;" onchange="filterProducts()">
        <option value="all">All Products</option>
        <option value="instock">In Stock</option>
        <option value="outofstock">Out of Stock</option>
        <option value="lowstock">Low Stock (â‰¤5)</option>
      </select>
      
      <select id="productCategoryFilter" class="form-select" style="width: auto;" onchange="filterProducts()">
        <option value="all">All Categories</option>
        {% for category in categories %}
        <option value="{{ category.id }}">{{ category.name }}</option>
        {% endfor %}
      </select>
      
      <select id="productTypeFilter" class="form-select" style="width: auto;" onchange="filterProducts()">
        <option value="all">All Types</option>
        <option value="single">Single Items (SKU)</option>
        <option value="bulk">Bulk Items</option>
      </select>
      
      <a href="#add-product" class="btn-action btn-primary" data-section="add-product">
        <i class="bi bi-plus-circle"></i>
        <span>Add Product</span>
      </a>
    </div>
  </div>

  <!-- Product Statistics -->
  <div class="stats-grid" style="margin-bottom: 1.5rem;">
    <div class="stat-card stat-card-info">
      <div class="stat-icon"><i class="bi bi-box-seam"></i></div>
      <div class="stat-content">
        <span class="stat-label">Total Products</span>
         <h3 class="stat-value" id="totalProductsCount">{{ total_products }}</h3>
      </div>
    </div>
    
    <div class="stat-card stat-card-success">
      <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
      <div class="stat-content">
        <span class="stat-label">In Stock</span>
        <h3 class="stat-value" id="inStockCount">{{ in_stock_count }}</h3>
      </div>
    </div>
    
    <div class="stat-card stat-card-warning">
      <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
      <div class="stat-content">
        <span class="stat-label">Low Stock</span>
        <h3 class="stat-value" id="lowStockCount">{{ low_stock_count }}</h3>
      </div>
    </div>
    
    <div class="stat-card stat-card-danger">
      <div class="stat-icon"><i class="bi bi-x-circle"></i></div>
      <div class="stat-content">
        <span class="stat-label">Out of Stock</span>
        <h3 class="stat-value" id="outOfStockCount">{{ out_of_stock_count }}</h3>
      </div>
    </div>
  </div>

  <!-- Products Table -->
  <div class="data-card">
    <!-- Table Controls: Search and Entries -->
    <div class="table-controls">
      <div class="entries-control">
        <label for="entriesSelect">Show</label>
        <select id="entriesSelect" onchange="changeEntries()">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="all">All</option>
        </select>
        <span>entries</span>
      </div>
      
      <div class="search-control">
        <input type="text" id="productSearch" placeholder="Search products..." onkeyup="searchProducts()">
        <button onclick="searchProducts()">
          <i class="bi bi-search"></i>
          <span>Search</span>
        </button>
      </div>
    </div>

    <div class="table-wrapper">
      <table class="data-table" id="productsTable">
        <thead>
          <tr>
            <th><strong style="color:#1100ff;">PRODUCT CODE</strong></th>
            <th><strong style="color:#1100ff;">SKU TYPE</strong></th>
            <th><strong style="color:#1100ff;">PRODUCT NAME</strong></th>
            <th><strong style="color:#1100ff;">CATEGORY</strong></th>
            <th><strong style="color:#1100ff;">STATUS</strong></th>
            <th><strong style="color:#1100ff;">STOCK</strong></th>
            <th><strong style="color:#1100ff;">BUYING PRICE</strong></th>
            <th><strong style="color:#002fff;">SELLING PRICE</strong></th>
            <th><strong style="color:#1100ff;">MARGIN</strong></th>
            <th><strong style="color:#1100ff;">OWNER</strong></th>
            <th><strong style="color:#1100ff;">DATE ADDED</strong></th>
          </tr>
        </thead>
        <tbody>
          {% for product_info in products_with_margin_and_status %}
          {% with product=product_info.product %}
          <tr class="product-row" 
              id="product-row-{{ product.id }}"
              data-product-id="{{ product.id }}"
              data-category="{{ product.category.id }}"
              data-stock-status="{{ product_info.status }}"
              data-type="{% if product.category.is_single_item %}single{% else %}bulk{% endif %}">
            
            <!-- Product Code -->
            <td>
              <code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                {{ product.product_code }}
              </code>
            </td>

            <!-- Type Badge -->
            <td>
              {% if product.category.is_single_item %}
                <span class="badge" style="background: #3b82f6; color: white;">
                  <i class="bi bi-tag"></i> Single
                </span>
              {% else %}
                <span class="badge" style="background: #8b5cf6; color: white;">
                  <i class="bi bi-box-seam"></i> Bulk
                </span>
              {% endif %}
            </td>

            <!-- Product Name -->
            <td class="product-name"><strong>{{ product.name }}</strong></td>

            <!-- Category -->
            <td><span class="badge bg-secondary">{{ product.category.name }}</span></td>

            <!-- STATUS BADGE -->
            <td>
              {% if product.category.is_single_item %}
                {% if product.status == "sold" %}
                  <span class="badge badge-danger">
                    <i class="bi bi-x-circle-fill"></i> Sold Out
                  </span>
                {% else %}
                  <span class="badge badge-success">
                    <i class="bi bi-check-circle-fill"></i> In Stock
                  </span>
                {% endif %}
              {% else %}
                {% if product.quantity == 0 %}
                  <span class="badge badge-danger">
                    <i class="bi bi-x-circle-fill"></i> Out of Stock
                  </span>
                {% elif product.quantity <= 5 %}
                  <span class="badge badge-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i> Low Stock
                  </span>
                {% else %}
                  <span class="badge badge-success">
                    <i class="bi bi-check-circle-fill"></i> In Stock
                  </span>
                {% endif %}
              {% endif %}
            </td>

            <!-- STOCK COLUMN -->
            <td class="product-quantity">
              {% if product.category.is_single_item %}
                {% if product.status == 'sold' %}
                  <strong style="color: #dc3545; font-weight: bold;">
                    <i class="bi bi-x-circle-fill"></i> SOLD
                  </strong>
                {% else %}
                  <strong style="color: #28a745; font-weight: bold;">
                    <i class="bi bi-check-circle-fill"></i> Available
                  </strong>
                {% endif %}
              {% else %}
                {% if product.quantity > 5 %}
                  <strong style="color: #28a745; font-weight: bold;">
                    {{ product.quantity }} units
                  </strong>
                {% elif product.quantity > 0 %}
                  <strong style="color: #ffc107; font-weight: bold;">
                    {{ product.quantity }} units (Low)
                  </strong>
                {% else %}
                  <strong style="color: #dc3545; font-weight: bold;">
                    0 units (Out)
                  </strong>
                {% endif %}
              {% endif %}
            </td>

            <!-- Buying Price -->
            <td class="product-buying-price">
              <strong style="color: #10b981;">KSH {{ product.buying_price|floatformat:2 }}</strong>
            </td>

            <!-- Selling Price -->
            <td class="product-selling-price">
              <strong style="color: #10b981;">KSH {{ product.selling_price|floatformat:2 }}</strong>
            </td>

            <!-- Profit Margin -->
            <td>
              <span class="badge
                {% if product_info.margin_pct >= 30 %}margin-high
                {% elif product_info.margin_pct >= 15 %}margin-medium
                {% else %}margin-low
                {% endif %}">
                +{{ product_info.margin_pct|floatformat:0 }}%
              </span>
            </td>

            <!-- Owner -->
            <td class="product-owner">
              <div style="display: flex; align-items: center; gap: 6px;">
                <i class="bi bi-person-circle" style="color: #6c757d;"></i>
                <span>{{ product.owner.username|default:"FIELDMAX" }}</span>
              </div>
            </td>

            <!-- Date Added -->
            <td><span style="color: #6c757d;">{{ product.created_at|date:"M d, Y" }}</span></td>

          </tr>
          {% endwith %}
          {% empty %}
          <tr>
            <td colspan="12">
              <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <p>No products found in inventory.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>














<!-- ======================================= -->
<!-- ADD CATEGORY TEMPLATE -->
<!-- ======================================= -->

<!-- Add Category Section - Fixed Version -->
<div id="add-category" class="content-section">
  <div class="content-header">
    <h1 class="page-title">Add New Category</h1>
  </div>

  <div class="data-card">
    <div style="padding: 2rem; max-width: 1000px; margin: 0 auto;">

      <!-- Success Message -->
      <div id="success-message-category" style="display: none;" class="alert alert-success"></div>

      <!-- Error Messages -->
      <div id="message-div-category"></div>

      <form id="addCategoryForm" method="POST" action="/inventory/category/create/">
        {% csrf_token %}

        <!-- Basic Information Section -->
        <div class="mb-4">
          <h4 style="border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem;">
            <i class="bi bi-info-circle"></i> Basic Information
          </h4>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="category-name" class="form-label required">Category Name:</label>
              <input type="text" 
                     name="name" 
                     id="category-name" 
                     class="form-control" 
                     placeholder="e.g., Category type" 
                     required>
              <small class="form-text text-muted">Enter a descriptive category name</small>
            </div>
            <div class="col-md-6">
              <label for="category-code" class="form-label">Category Code:</label>
              <input type="text" 
                     id="category-code" 
                     name="category_code"
                     class="form-control" 
                     placeholder="Auto-generated" 
                     readonly 
                     style="background: #f3f4f6;">
              <small class="form-text text-muted">Automatically generated from name</small>
            </div>
          </div>
        </div>

        <!-- Configuration Section -->
        <div class="mb-4">
          <h4 style="border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem;">
            <i class="bi bi-gear"></i> Configuration
          </h4>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="item-type" class="form-label required">Item Type:</label>
              <select name="item_type" id="item-type" class="form-select" required>
                <option value="">-- Select Item Type --</option>
                <option value="single">Single Item</option>
                <option value="bulk">Bulk Item</option>
              </select>
              <small class="form-text text-muted">
                <strong>Single:</strong> Unique Items<br>
                <strong>Bulk:</strong> Multiple units
              </small>
            </div>
    
            <div class="col-md-6">
              <label for="sku-type" class="form-label required">SKU Type:</label>
              <select name="sku_type" id="sku-type" class="form-select" required>
                <option value="">-- Select SKU Type --</option>
                <option value="imei">IMEI NUMBER</option>
                <option value="serial">SERIAL NUMBER</option>
                <option value="barcode">BARCODE</option>
              </select>
              <small class="form-text text-muted">Type of identifier for products in this category</small>
            </div>
          </div>
        </div>

        <!-- Products Section -->
        <div class="mb-4">
          <h4 style="border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem;">
            <i class="bi bi-box-seam"></i> Products in this Category
          </h4>


          <!-- Django Formset Management Form -->
          <input type="hidden" name="products-TOTAL_FORMS" id="id_products-TOTAL_FORMS" value="1">
          <input type="hidden" name="products-INITIAL_FORMS" id="id_products-INITIAL_FORMS" value="0">
          <input type="hidden" name="products-MIN_NUM_FORMS" id="id_products-MIN_NUM_FORMS" value="0">
          <input type="hidden" name="products-MAX_NUM_FORMS" id="id_products-MAX_NUM_FORMS" value="1000">



          <div class="table-responsive">
            <table class="table table-bordered" id="products-table">
              <thead class="table-light">
                <tr>
                  <th style="width: 15%;">Product Code</th>
                  <th style="width: 25%;">Product Name</th>
                  <th style="width: 20%;">SKU/IMEI/Serial</th>
                  <th style="width: 10%;">Quantity</th>
                  <th style="width: 15%;">Status</th>
                  <th style="width: 10%;">Active</th>
                  <th style="width: 5%;"></th>
                </tr>
              </thead>
              <tbody>
                <!-- Template Row (will be cloned by JavaScript) -->
                <tr class="product-row">
                  <td>
                    <input type="text" 
                           name="products-0-code" 
                           class="form-control form-control-sm" 
                           readonly 
                           style="background: #f3f4f6;">
                  </td>
                  <td>
                    <input type="text" 
                           name="products-0-name" 
                           class="form-control form-control-sm" 
                           placeholder="Optional">
                  </td>
                  <td>
                    <input type="text" 
                           name="products-0-sku" 
                           class="form-control form-control-sm"
                           placeholder="Optional">
                  </td>
                  <td>
                    <input type="number" 
                           name="products-0-qty" 
                           class="form-control form-control-sm" 
                           min="0" 
                           value="">
                  </td>
                  <td>
                    <select name="products-0-status" class="form-select form-select-sm">
                      <option value="available" selected>Available</option>
                      <option value="sold">Sold</option>
                      <option value="lowstock">Low Stock</option>
                      <option value="outofstock">Out of Stock</option>
                    </select>
                  </td>
                  <td class="text-center">
                    <input type="checkbox" 
                           name="products-0-active" 
                           class="form-check-input" 
                           checked>
                  </td>
                  <td class="text-center">
                    <button type="button" 
                            class="btn btn-danger btn-sm remove-product" 
                            title="Remove this product">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <button type="button" 
                  id="add-product-btn" 
                  class="btn btn-secondary">
            <i class="bi bi-plus-circle"></i> Add Another Product
          </button>
        </div>

        <!-- Submit Buttons -->
        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">
          <button type="submit" class="btn-action btn-primary">
            <i class="bi bi-save"></i>
            <span>Save Category & Products</span>
          </button>
          <a href="#category-list" 
             class="btn-action" 
             data-section="category-list"
             style="background: #6c757d; color: #fff; margin-left: 0.5rem;">
            <i class="bi bi-x-circle"></i>
            <span>Cancel</span>
          </a>
        </div>
      </form>
    </div>
  </div>
</div>











<!-- ======================================= -->
<!-- ADD PRODUCT TEMPLATE -->
<!-- ======================================= -->
   <!-- Add Product Section -->
<div id="add-product" class="content-section">
  <div class="content-header">
    <h1 class="page-title">Add New Product</h1>
  </div>

  <div class="data-card">
    <div style="padding: 2rem; max-width: 800px; margin: 0 auto;">
      
      <!-- Success Message -->
      <div id="success-message-product" style="display: none;" class="alert alert-success">
        Product saved successfully!
      </div>

      <!-- Error Message -->
      <div id="message-div"></div>

      <form id="addProductForm" method="POST" action="{% url 'inventory:product-create' %}">
        {% csrf_token %}

        <div class="row g-3">
          <!-- Category -->
          <div class="col-12">
            <label for="category-select" class="form-label required">Category</label>
            <select name="category" id="category-select" class="form-select" required>
              <option value=""></option>
              {% for cat in categories %}
              <option value="{{ cat.id }}"
                      data-is-single="{{ cat.is_single_item|yesno:'true,false' }}"
                      data-is-bulk="{{ cat.is_bulk_item|yesno:'true,false' }}"
                      data-sku-type="{{ cat.get_sku_type_display }}">
                {{ cat.name }}
              </option>
              {% endfor %}
            </select>
          </div>

      
          <!-- Product Name -->
          <div class="col-12">
            <label for="product-name" class="form-label required">Product Name</label>
            <input type="text" name="name" id="product-name" class="form-control" placeholder="Enter product name" required>
          </div>

          <!-- Buying Price -->
          <div class="col-md-6">
            <label for="buying-price" class="form-label required">Buying Price (KSH)</label>
            <input type="number" step="0.01" name="buying_price" id="buying-price" class="form-control" placeholder="0.00" required>
          </div>

          <!-- Selling Price -->
          <div class="col-md-6">
            <label for="selling-price" class="form-label required">Selling Price (KSH)</label>
            <input type="number" step="0.01" name="selling_price" id="selling-price" class="form-control" placeholder="0.00" required>
          </div>

          <!-- SKU Field (single items) -->
          <div class="col-12" id="sku-field" style="display:none;">
            <label class="form-label" id="sku-label"></label>
            <input type="text" name="sku_value" id="sku-input" class="form-control">
          </div>

          <!-- Quantity Field (bulk items) -->
          <div class="col-12" id="quantity-field" style="display:none;">
            <label for="quantity" class="form-label required">Quantity</label>
            <input type="number" name="quantity" id="quantity" class="form-control" min="1" placeholder="Enter quantity">
          </div>

          <!-- Buttons -->
          <div class="col-12" style="margin-top: 1.5rem;">
            <button type="submit" class="btn-action btn-primary">
              <i class="bi bi-save"></i>
              <span>Save Product</span>
            </button>
            <a href="#product-list" class="btn-action" style="background: #6c757d; color: #fff; margin-left: 0.5rem;" data-section="product-list">
              <i class="bi bi-x-circle"></i>
              <span>Cancel</span>
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
















<!-- ============================= -->
<!--     RESTOCK PRODUCT SECTION     -->
<!-- ============================= -->
<div id="restock-product" class="content-section">
  
  <!-- Header -->
  <div class="content-header">
    <button class="mobile-sidebar-toggle" id="mobileSidebarToggle4">
      <i class="bi bi-list"></i>
    </button>
    <h1 class="page-title">
      <i class="bi bi-box-seam-fill"></i> Restock Products
      <small class="text-muted" style="font-size: 0.6em; display: block; margin-top: 0.5rem;">
        Add Stock to Existing Products
      </small>
    </h1>
  </div>

  <!-- Two Column Layout -->
  <div class="row g-4">
    
    <!-- ==========================================
         COLUMN 1: SEARCH & INPUT FORM
    ========================================== -->
    <div class="col-lg-5">
      
      <!-- Search Card -->
      <div class="data-card mb-3">
        <div class="card-header bg-primary text-white">
          <h2 class="mb-0">
            <i class="bi bi-search"></i> Search Product
          </h2>
        </div>
        <div class="card-body" style="padding: 0.1rem 0.6rem; height: 20px; overflow: hidden;">
          <p class="text-muted mb-3">
            <i class="bi bi-info-circle"></i> Search by name, code, or scan barcode
          </p>
          
          <div class="position-relative">
            <div class="input-group input-group-lg mb-3">
              <span class="input-group-text">
                <i class="bi bi-upc-scan"></i>
              </span>
              <input 
                type="text" 
                id="restockSearchInput" 
                placeholder="Type product name/code or scan..."
                class="form-control"
                autocomplete="off"
                autofocus>
              <button 
                id="restockSearchBtn"
                class="btn btn-primary">
                <i class="bi bi-search"></i> Search
              </button>
            </div>

            <!-- Auto-complete Dropdown -->
            <div id="restockAutocomplete" 
                 class="position-absolute w-100 bg-white border rounded shadow-lg" 
                 style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto; top: 100%; margin-top: -0.75rem;">
              <div id="restockAutocompleteList"></div>
            </div>
          </div>

          <div id="restockSearchMessage" class="mt-3" style="display: none; font-size: 0.8em; height: 20px; line-height: 20px; overflow: hidden;"></div>
        </div>
      </div>

      <!-- Multiple Results Section -->
      <div id="restockMultipleResults" class="data-card mb-4" style="display: none;">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-list-ul"></i> Multiple Products Found
          </h5>
        </div>
        <div class="card-body" style="padding: 0.75rem; height: 150px; overflow-y: auto;">
          <p class="text-muted mb-3">Select the product you want to restock:</p>
          <div id="restockProductsList" class="d-grid gap-2"></div>
        </div>
      </div>

      <!-- Restock Form Card -->
      <div id="restockFormSection" class="data-card" style="display: none;">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-plus-circle"></i> Add Stock
          </h5>
        </div>
        <div class="card-body" style="padding: 1rem; min-height: 400px;">
          
          <form id="restockForm">
            {% csrf_token %}
            <input type="hidden" id="restockProductId" name="product_id">
            
            <!-- Quantity -->
            <div class="mb-3">
              <label for="restockQuantity" class="form-label required">
                <i class="bi bi-box"></i> Quantity to Add
              </label>
              <input 
                type="number" 
                id="restockQuantity" 
                name="quantity" 
                min="1"
                required
                class="form-control form-control-lg"
                placeholder="Enter quantity"
                style="height: calc(1.5em + 0.75rem + 2px);">
            </div>

            <!-- Buying Price -->
            <div class="mb-3">
              <label for="restockBuyingPrice" class="form-label required">
                <i class="bi bi-currency-exchange"></i> Buying Price (per unit)
              </label>
              <div class="input-group input-group-lg">
                <span class="input-group-text">KSH</span>
                <input 
                  type="number" 
                  id="restockBuyingPrice" 
                  name="buying_price" 
                  step="0.01"
                  min="0"
                  required
                  class="form-control"
                  placeholder="0.00"
                  style="height: calc(1.5em + 0.75rem + 2px);">
              </div>
            </div>

            <!-- Selling Price -->
            <div class="mb-3">
              <label for="restockSellingPrice" class="form-label">
                <i class="bi bi-tag"></i> Selling Price (per unit)
              </label>
              <div class="input-group input-group-lg">
                <span class="input-group-text">KSH</span>
                <input 
                  type="number" 
                  id="restockSellingPrice" 
                  name="selling_price" 
                  step="0.01"
                  min="0"
                  class="form-control"
                  placeholder="0.00"
                  style="height: calc(1.5em + 0.75rem + 2px);">
              </div>
              <small class="form-text text-muted">
                Optional - updates product selling price
              </small>
            </div>

            <!-- Total Amount Display -->
            <div id="restockTotalAmountDisplay" class="mb-4" style="display: none;">
              <label class="form-label">
                <i class="bi bi-calculator"></i> Total Amount
              </label>
              <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); 
                          padding: 1rem; 
                          border-radius: 8px; 
                          border: 2px solid #10b981;">
                <div style="font-size: 1.8rem; font-weight: 700; color: #059669; text-align: center;">
                  KSH <span id="restockTotalAmount">0.00</span>
                </div>
              </div>
            </div>

            <!-- Notes -->
            <div class="mb-4">
              <label for="restockNotes" class="form-label">
                <i class="bi bi-pencil-square"></i> Notes (Optional)
              </label>
              <textarea 
                id="restockNotes" 
                name="notes" 
                rows="2"
                class="form-control"
                placeholder="Add any notes about this restock..."
                style="height: calc(1em + 1rem);"></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2">
              <button 
                type="submit" 
                id="restockSubmitBtn"
                class="btn btn-success btn-lg">
                <i class="bi bi-check-circle"></i> Add Stock
              </button>
              <button 
                type="button"
                id="restockResetBtn"
                class="btn btn-secondary">
                <i class="bi bi-arrow-counterclockwise"></i> Search Another Product
              </button>
            </div>

            <!-- Form Messages -->
            <div id="restockFormMessage" class="mt-3" style="display: none; font-size: 0.8em; height: 20px; line-height: 20px; overflow: hidden;"></div>
          </form>
          
        </div>
      </div>

    </div>

    <!-- ==========================================
         COLUMN 2: PRODUCT DETAILS DISPLAY
    ========================================== -->
    <div class="col-lg-7">
      <div class="data-card h-100">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-info-circle"></i> Product Details
          </h5>
        </div>
        <div class="card-body" style="padding: 0.5rem 3rem;">
          
          <!-- Empty State -->
          <div id="restockEmptyState" class="text-center py-5" style="height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <i class="bi bi-box-seam" style="font-size: 4rem; color: #cbd5e1;"></i>
            <h5 class="text-muted mt-3">No Product Selected</h5>
            <p class="text-muted">
              Search for a product to view details and add stock
            </p>
          </div>

          <!-- Product Details Display -->
          <div id="restockProductInfo" style="display: none;">
            
            <!-- Product Header -->
            <div class="alert alert-info" style="background: #dbeafe; border-color: #3b82f6;">
              <h4 class="mb-2">
                <i class="bi bi-box-seam-fill"></i> 
                <span id="restockDisplayName"></span>
              </h4>
              <div class="row g-3 mt-2">
                <div class="col-6">
                  <small class="text-muted d-block">Product Code</small>
                  <strong id="restockDisplayCode"></strong>
                </div>
                <div class="col-6">
                  <small class="text-muted d-block">Category</small>
                  <strong id="restockDisplayCategory"></strong>
                </div>
                <div style="font-size: 2rem; font-weight: 700; color: #059669;">
                  <h3 class="text-muted mb-2">Current Stock</h3>
                  <span id="restockDisplayStock">0</span>
                </div>
                <div class="row g-3">
                  <div class="col-6">
                    <small class="text-muted d-block">Buying Price</small>
                    <div style="font-size: 2rem; font-weight: 700; color: #10b981;">
                      KSH <span id="restockDisplayBuyingPrice">0.00</span>
                    </div>
                  </div>
                  <div class="col-6">
                    <small class="text-muted d-block">Selling Price</small>
                    <div style="font-size: 2rem; font-weight: 700; color: #10b981;">
                      KSH <span id="restockDisplaySellingPrice">0.00</span>
                    </div>
                  </div>
                </div>                
              </div>
            </div>

            <!-- Success Message Display -->
            <div id="restockSuccessDisplay" class="alert alert-success" style="display: none;">
              <i class="bi bi-check-circle-fill"></i>
              <strong>Stock Added Successfully!</strong>
              <div class="mt-2">
                <small>New stock quantity: <strong id="restockNewStock"></strong> units</small>
              </div>
            </div>

          </div>

        </div>
      </div>
    </div>

  </div><!-- End Row -->

</div>

















<!-- ============================= -->
<!--  TRANSFER PRODUCT SECTION   -->
<!-- ============================= -->
<div id="transfer-product" class="content-section">

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">
        <i class="bi bi-arrow-left-right"></i> Transfer Product
      </h2>
    </div>
  </div>

  <div class="row">
    <!-- LEFT COLUMN: Search & Form -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-search"></i> Search Product</h5>
        </div>
        <div class="card-body">
          <!-- Search Input -->
          <div class="mb-3">
            <label class="form-label fw-bold">Product Code or SKU</label>
            <div class="input-group">
              <input 
                type="text" 
                class="form-control" 
                id="transferSearchInput"
                placeholder="Enter product code, name, or SKU..."
                autocomplete="off"
              >
              <button class="btn btn-primary" type="button" id="transferSearchBtn">
                <i class="bi bi-search"></i> Search
              </button>
            </div>
            <div id="transferSearchingIndicator" style="display: none; margin-top: 8px;">
              <span class="spinner-border spinner-border-sm text-primary"></span>
              <span class="text-muted ms-2">Searching...</span>
            </div>
          </div>

          <!-- Transfer Form -->
          <div class="mb-3">
            <label class="form-label fw-bold">Receiving User</label>
            <select class="form-select" id="transferUserSelect" disabled>
              <option value="">Select receiving user</option>
            </select>
          </div>

          <div class="mb-3" id="transferQuantityField" style="display: none;">
            <label class="form-label fw-bold">Quantity to Transfer</label>
            <input 
              type="number" 
              class="form-control" 
              id="transferQuantity"
              min="1"
              value="1"
            >
            <small class="text-muted">
              Maximum available: <span id="transferMaxQuantity">0</span> units
            </small>
          </div>

          <!-- Action Buttons -->
          <div class="d-grid gap-2">
            <button class="btn btn-success btn-lg" id="transferSubmitBtn" disabled>
              <i class="bi bi-check-circle"></i> Confirm Transfer
            </button>
            <button class="btn btn-outline-secondary" id="transferResetBtn">
              <i class="bi bi-arrow-counterclockwise"></i> Reset
            </button>
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div id="transferMessage" class="mt-3"></div>
    </div>

    <!-- RIGHT COLUMN: Live Preview -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="bi bi-eye"></i> Live Preview</h5>
        </div>
        <div class="card-body">
          <!-- Product Preview -->
          <div class="mb-3 p-3 bg-light rounded">
            <div class="fw-bold text-muted mb-2">ðŸ“¦ PRODUCT</div>
            <div id="liveProductPreview" class="fs-6">
              <span class="text-muted">No product selected</span>
            </div>
          </div>

          <!-- Owner Transfer Preview -->
          <div class="mb-3 p-3 bg-light rounded">
            <div class="fw-bold text-muted mb-2">ðŸ‘¤ OWNER TRANSFER</div>
            <div id="liveOwnerPreview" class="fs-6">
              <span class="text-muted">No transfer configured</span>
            </div>
          </div>

          <!-- Divider -->
          <hr class="my-3">

          <!-- Product Details Area - NOW INSIDE LIVE PREVIEW CARD -->
          <div id="transferEmptyState">
            <div class="text-center py-4">
              <i class="bi bi-box-seam display-4 text-muted"></i>
              <h6 class="mt-3 text-muted">No Product Selected</h6>
              <p class="text-muted small mb-0">Search for a product to view details</p>
            </div>
          </div>

          <div id="transferLoadingState" style="display: none;">
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <h6 class="mt-3 text-muted">Loading Product Details...</h6>
            </div>
          </div>

          <div id="transferProductDetails" style="display: none;">
            <!-- Product details will be inserted here by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</div>












<!-- ============================= -->
<!-- SALES SECTION     -->
<!-- ============================= -->
<div id="sales-list" class="content-section">

  <!-- Header with Filters and Action Button -->
  <div class="content-header">
    <h1 class="page-title">All Sales</h1>
    <div style="display: flex; gap: 10px;">
      <!-- Status Filter -->
      <select id="statusFilter" class="form-select" onchange="filterSales()">
        <option value="all">All Status</option>
        <option value="active">Active</option>
        <option value="reversed">Reversed</option>
      </select>


      <!-- Seller Filter -->
      <select id="sellerFilter" class="form-select" onchange="filterSales()">
        <option value="all">All Sellers</option>
        <!-- Options will be populated from database -->
      </select>

      <!-- Type Filter -->
      <select id="typeFilter" class="form-select" onchange="filterSales()">
        <option value="all">All Types</option>
        <option value="single">Single</option>
        <option value="bulk">Bulk</option>
      </select>

      <!-- Record Sale Button -->
      <a href="#record-sale" class="btn-action btn-success" data-section="record-sale">
        <i class="bi bi-plus-circle"></i>
        <span>Record Sale</span>
      </a>
    </div>
  </div>

  <!-- Sales Summary Stats -->
  <div class="stats-grid" style="margin-bottom: 1.5rem;">
    <!-- Total Sales -->
    <div class="stat-card stat-card-info">
      <div class="stat-icon"><i class="bi bi-receipt"></i></div>
      <div class="stat-content">
        <span class="stat-label">Total Sales</span>
        <h3 class="stat-value" id="totalSalesCount">{{ all_sales.count }}</h3>
      </div>
    </div>
    
    <!-- Daily Sales -->
    <div class="stat-card stat-card-success">
      <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
      <div class="stat-content">
        <span class="stat-label">Daily Sales</span>
        <h3 class="stat-value" id="activeSalesCount">{{ daily_sales_count }}</h3>
      </div>
    </div>
    <!-- Weekly Sales -->
    <div class="stat-card stat-card-success">
      <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
      <div class="stat-content">
        <span class="stat-label">Weekly Sales</span>
        <h3 class="stat-value" id="activeSalesCount">{{ weekly_sales_count }}</h3>
      </div>
    </div>
    <!-- Monthly Sales -->
    <div class="stat-card stat-card-success">
      <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
      <div class="stat-content">
        <span class="stat-label">Monthly Sales</span>
        <h3 class="stat-value" id="activeSalesCount">{{ monthly_sales_count }}</h3>
      </div>
    </div>
    <!-- Annual Sales -->
    <div class="stat-card stat-card-success">
      <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
      <div class="stat-content">
        <span class="stat-label">Annual Sales</span>
        <h3 class="stat-value" id="activeSalesCount">{{ annual_sales_count }}</h3>
      </div>
    </div>
    <!-- Active Sales -->
    <div class="stat-card stat-card-success">
      <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
      <div class="stat-content">
        <span class="stat-label">Active Sales</span>
        <h3 class="stat-value" id="activeSalesCount">{{ active_sales_count }}</h3>
      </div>
    </div>    
    <!-- Reversed Sales -->
    <div class="stat-card stat-card-warning">
      <div class="stat-icon"><i class="bi bi-arrow-counterclockwise"></i></div>
      <div class="stat-content">
        <span class="stat-label">Reversed Sales</span>
        <h3 class="stat-value" id="reversedSalesCount">{{ reversed_sales_count }}</h3>
      </div>
    </div>
  </div>

  <!-- Sales Table -->
  <div class="data-card">
    <div class="table-wrapper">
      <table class="data-table" id="salesTable">
        <thead>
          <tr>
            <th><strong style="color:#000000;">SALE ID</strong></th>
            <th><strong style="color:#000000;">BUYER</strong></th>
            <th><strong style="color:#000000;">TOTAL AMOUNT</strong></th>
            <th><strong style="color:#000000;">SOLD BY</strong></th>
            <th><strong style="color:#000000;">DATE SOLD</strong></th>
            <th><strong style="color:#ff0000;">ACTIONS</strong></th>
          </tr>
        </thead>
        <tbody>
          {% for sale in all_sales %}
          <tr class="sale-row"
              id="sale-row-{{ sale.sale_id }}"
              data-status="{% if sale.is_reversed %}reversed{% else %}active{% endif %}"
              data-type="{% if sale.has_sku_items %}single{% else %}bulk{% endif %}"
              data-seller="{{ sale.seller.id|default:'' }}"
              data-sale-id="{{ sale.sale_id }}">

            <!-- Sale ID & Reversal Badge -->
            <td>
              <strong>#{{ sale.sale_id }}</strong>
              {% if sale.is_reversed %}
              <span class="badge badge-warning"
                    style="font-size: 10px; background:#fef3c7; color:#92400e;">
                <i class="bi bi-arrow-counterclockwise"></i> REVERSED
              </span>
              {% endif %}
            </td>

            <!-- Buyer -->
            <td>{{ sale.buyer_name|default:"Walk-in" }}</td>

            <!-- Total Amount -->
            <td><strong style="color:#10b981;">{{ sale.total_amount }}</strong></td>

            <!-- Sold By -->
            <td>{{ sale.seller.username|default:"N/A" }}</td>

            <!-- Date -->
            <td>{{ sale.sale_date|date:"M d, Y H:i" }}</td>

             <!-- Actions -->
            <td>
                <div class="action-buttons">
                    {% if not sale.is_reversed %}
                    
                    <!-- Reverse Sale Link -->
                    <a href="#" 
                           class="reverse-sale-btn btn btn-warning btn-sm"
                           data-sale-id="{{ sale.sale_id }}">
                         Reverse Sale
                    </a>

                    <!-- Optional: View Receipt -->
                    <a href="{% url 'sales:sale-etr' sale.sale_id %}" target="_blank" class="btn btn-primary">
                        <i class="bi bi-receipt"></i> View Receipt
                    </a>
                    {% else %}
                    <span class="text-muted">Reversed</span>
                    {% endif %}
                </div>
            </td>
          </tr>
          {% empty %}
          <!-- No sales message -->
          <tr>
            <td colspan="11">
              <div class="empty-state">
                <i class="bi bi-receipt"></i>
                <p>No sales found.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>













<!-- ======================================-->
<!-- REPORTS GENERATOR SECTION -->
<!--======================================== -->
<div id="generate-report" class="content-section">

  <!-- Header -->
  <div class="content-header">
    <button class="mobile-sidebar-toggle" id="mobileSidebarToggle3">
      <i class="bi bi-list"></i>
    </button>
    <h1 class="page-title">
      <i class="bi bi-bar-chart-line"></i> Sales Reports
      <small class="text-muted" style="font-size: 0.6em; display: block; margin-top: 0.5rem;">
        Filtered Sales Reports
      </small>
    </h1>
  </div>

  <!-- Two Column Layout -->
  <div class="row g-4">
    
    <!-- ==========================================
         COLUMN A: FILTER FORM
    ========================================== -->
    <div class="col-lg-6">
      <div class="data-card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-funnel"></i> Report Filters
          </h5>
        </div>
        <div class="card-body" style="padding: 2rem;">
          
          <form id="reportFilterForm">

            <!-- Seller -->
            <div class="mb-4">
              <label for="seller" class="form-label required">
                <i class="bi bi-person-badge"></i> Seller
              </label>
              <select id="seller" name="seller" class="form-select form-select-lg">
                <option value="">All Sellers</option>
              </select>
            </div>

            <!-- Category -->
            <div class="mb-4">
              <label for="category" class="form-label required">
                <i class="bi bi-tags"></i> Category
              </label>
              <select id="category" name="category" class="form-select form-select-lg">
                <option value="">All Categories</option>
              </select>
            </div>

            <!-- Date Range -->
            <div class="mb-4">
              <label class="form-label">
                <i class="bi bi-calendar-range"></i> Date Range
              </label>
              <div class="row g-2">
                <div class="col-md-6">
                  <input type="date" id="startDate" name="start_date" class="form-control form-control-lg">
                </div>
                <div class="col-md-6">
                  <input type="date" id="endDate" name="end_date" class="form-control form-control-lg">
                </div>
              </div>
            </div>

            <!-- Buttons -->
            <div class="d-grid gap-2 mt-4">
              <button type="button" id="generateReportBtn" class="btn btn-success btn-lg">
                <i class="bi bi-file-earmark-bar-graph"></i> Generate Report
              </button>
              <button type="button" id="exportReportBtn" class="btn btn-secondary btn-lg" disabled>
                <i class="bi bi-download"></i> Export Report
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>

    <!-- ==========================================
         COLUMN B: REPORT DISPLAY
    ========================================== -->
    <div class="col-lg-6">
      <div class="data-card h-100">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-table"></i> Report Results
          </h5>
        </div>
        <div class="card-body" style="padding: 2rem;">
          
          <!-- Empty State -->
          <div id="reportEmptyState" class="text-center py-5">
            <i class="bi bi-clipboard-data" style="font-size: 4rem; color: #cbd5e1;"></i>
            <h5 class="text-muted mt-3">No Report Generated</h5>
            <p class="text-muted">
              Select filters and click "Generate Report"
            </p>
          </div>

          <!-- Report Table -->
          <div id="reportResults" style="display: none;">
            <div class="table-responsive">
              <table class="table table-bordered table-striped">
                <thead class="table-light">
                  <tr>
                    <th>Date</th>
                    <th>Seller</th>
                    <th>Category</th>
                    <th>Product</th>
                    <th>Qty</th>
                    <th>Total (KSH)</th>
                  </tr>
                </thead>
                <tbody id="reportTableBody"></tbody>
              </table>
            </div>

            <!-- Summary -->
            <div class="mt-3 alert alert-success">
              <strong>Total Sales:</strong> <span id="reportTotal">0.00</span> KSH
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>

</div>









<!-- ======================================= -->
<!-- USERS TEMPLATE -->
<!-- ======================================= -->
    <!-- Users List Section -->
    <div id="users-list" class="content-section">
      <div class="content-header">
        <h1 class="page-title">All Users</h1>
        <a href="#add-user" class="btn-action btn-primary" data-section="add-user">
          <i class="bi bi-person-plus"></i>
          <span>Add User</span>
        </a>
      </div>
      
      <div class="data-card">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Full Name</th>
                <th>Staff Status</th>
                <th>Date Joined</th>
                <th>Role</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <td><strong>#{{ user.id }}</strong></td>
                <td>
                  <div class="table-cell-content">
                    <i class="bi bi-person-circle text-primary"></i>
                    <strong>{{ user.username }}</strong>
                  </div>
                </td>
                <td>{{ user.email|default:"N/A" }}</td>
                <td>{{ user.first_name }} {{ user.last_name }}</td>
                <td>
                  {% if user.is_staff %}
                  <span class="badge" style="background: #10b981;">Staff</span>
                  {% else %}
                  <span class="badge bg-secondary">User</span>
                  {% endif %}
                </td>
                <td>{{ user.date_joined|date:"M d, Y" }}</td>
                <td>{% if user.profile %}
                    {{ user.profile.role }}
                    {% else %}
                     <span class="badge bg-secondary">No Role</span>
                    {% endif %}
                </td>
                <td>
                  <div class="action-buttons">
                    <a href="{% url 'user-edit' user.id %}" class="action-btn action-btn-edit" title="Edit">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <a href="{% url 'user-delete' user.id %}" class="action-btn action-btn-delete" title="Delete" onclick="return confirm('Are you sure?')">
                      <i class="bi bi-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7">
                  <div class="empty-state">
                    <i class="bi bi-people"></i>
                    <p>No users found.</p>
                  </div>
                </td>
              </tr>
              {% endfor %}
              {% load static %}
              <script src="{% static 'js/sale-reversal.js' %}"></script>
            </tbody>
          </table>
        </div>
      </div>
    </div>















    <!-- ======================================= -->
<!-- ADD USER TEMPLATE -->
<!-- ======================================= -->
    <!-- Add User Section -->
    <div id="add-user" class="content-section">
      <div class="content-header">
        <h1 class="page-title">Add New User</h1>
      </div>
      
      <div class="data-card">
        <div style="padding: 2rem; max-width: 800px; margin: 0 auto;">
          <form method="post" action="{% url 'user-add' %}">
            {% csrf_token %}
            
            <div class="row g-3">
              <div class="col-md-6">
                <label for="username" class="form-label required">Username</label>
                <input type="text" class="form-control" id="username" name="username" required>
              </div>
              
              <div class="col-md-6">
                <label for="email" class="form-label required">Email</label>
                <input type="email" class="form-control" id="email" name="email" required>
              </div>
              
              <div class="col-md-6">
                <label for="firstName" class="form-label required">First Name</label>
                <input type="text" class="form-control" id="firstName" name="first_name" required>
              </div>
              
              <div class="col-md-6">
                <label for="lastName" class="form-label required">Last Name</label>
                <input type="text" class="form-control" id="lastName" name="last_name" required>
              </div>
              
              <div class="col-md-6">
                <label for="password1" class="form-label required">Password</label>
                <input type="password" class="form-control" id="password1" name="password1" required>
              </div>
              
              <div class="col-md-6">
                <label for="password2" class="form-label required">Confirm Password</label>
                <input type="password" class="form-control" id="password2" name="password2" required>
              </div>
              
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="isStaff" name="is_staff">
                  <label class="form-check-label" for="isStaff">
                    Staff Status (Can access admin panel)
                  </label>
                </div>
              </div>
              <div class="col-12">
               <label for="role" class="form-label required">User Role</label>
                <select name="role" id="role" class="form-select" required>
                  <option value="">-- Select Role --</option>
                  {% for role in roles %}
                  <option value="{{ role.name }}">{{ role.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="isSuperuser" name="is_superuser">
                  <label class="form-check-label" for="isSuperuser">
                    Superuser Status (Full permissions)
                  </label>
                </div>
              </div>
              
              <div class="col-12">
                <button type="submit" class="btn-action btn-primary">
                  <i class="bi bi-person-plus"></i>
                  <span>Add User</span>
                </button>
                <a href="#users-list" class="btn-action" style="background: #6c757d; color: #fff; margin-left: 0.5rem;" data-section="users-list">
                  <i class="bi bi-x-circle"></i>
                  <span>Cancel</span>
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

  </main>
</div>














<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

  // =========================
// UTILITY FUNCTIONS
// =========================

/**
 * âœ… FIX #1: Added null safety check
 * Safely retrieves CSRF token
 */
function csrfToken() {
  const token = document.querySelector('[name=csrfmiddlewaretoken]');
  if (!token) {
    console.error('âŒ CSRF token not found in page');
    return '';
  }
  return token.value;
}

// =========================
// SECTION NAVIGATION SYSTEM
// =========================

/**
 * âœ… FIX #2: Added safety checks for elements
 * Shows the specified section and updates navigation state
 */
function showSection(sectionId) {
  // Hide all sections
  document.querySelectorAll('.content-section').forEach(section => {
    section.classList.remove('active');
  });

  // Show target section
  const targetSection = document.getElementById(sectionId);
  if (targetSection) {
    targetSection.classList.add('active');
  } else {
    console.warn(`âš ï¸ Section "${sectionId}" not found`);
    return; // âœ… FIX: Exit early if section doesn't exist
  }

  // Remove active class from all nav items
  document.querySelectorAll('.nav-item, .submenu-item').forEach(item => {
    item.classList.remove('active');
  });

  // Add active class to clicked nav item
  const clickedNavItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
  const clickedSubmenuItem = document.querySelector(`.submenu-item[data-section="${sectionId}"]`);

  if (clickedNavItem) clickedNavItem.classList.add('active');
  if (clickedSubmenuItem) clickedSubmenuItem.classList.add('active');

  // Smooth scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });

  // âœ… FIX #3: Close mobile sidebar with overlay cleanup
  if (window.innerWidth <= 992) {
    const sidebar = document.getElementById('dashboardSidebar');
    if (sidebar) {
      sidebar.classList.remove('active');
      removeSidebarOverlay(); // âœ… Clean up overlay
    }
  }
}

/**
 * âœ… FIX #4: Helper function to remove sidebar overlay
 */
function removeSidebarOverlay() {
  const overlay = document.getElementById('sidebarOverlay');
  if (overlay) {
    overlay.remove();
  }
}

/**
 * âœ… FIX #5: Initialize navigation after DOM is ready
 * Moved inside DOMContentLoaded to ensure elements exist
 */
function initializeNavigation() {
  // Handle navigation clicks
  const navElements = document.querySelectorAll('[data-section]');
  
  if (navElements.length === 0) {
    console.warn('âš ï¸ No navigation elements found');
    return;
  }

  navElements.forEach(el => {
    el.addEventListener('click', e => {
      e.preventDefault();
      const sectionId = el.getAttribute('data-section');
      
      if (sectionId) {
        showSection(sectionId);
        history.pushState(null, null, `#${sectionId}`);
      }
    });
  });

  console.log(`âœ… Navigation initialized (${navElements.length} items)`);
}

/**
 * âœ… FIX #6: Handle browser back/forward buttons
 */
window.addEventListener('popstate', () => {
  const hash = window.location.hash.substring(1);
  showSection(hash || 'dashboard');
});

/**
 * âœ… FIX #7: Initialize on page load
 * Consolidated into single DOMContentLoaded
 */
window.addEventListener('DOMContentLoaded', () => {
  console.log('ðŸš€ Initializing Dashboard Navigation...');
  
  // Initialize navigation listeners
  initializeNavigation();
  
  // Show section from URL hash or default to dashboard
  const hash = window.location.hash.substring(1);
  if (hash) {
    showSection(hash);
  } else {
    showSection('dashboard'); // âœ… Explicitly show dashboard
  }
  
  console.log('âœ… Navigation ready');
});








// ======================
// MOBILE SIDEBAR TOGGLE
// ======================
const sidebar = document.getElementById('dashboardSidebar');

// Handle all mobile sidebar toggle buttons
document.querySelectorAll('[id^="mobileSidebarToggle"]').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    sidebar.classList.toggle('active');
    
    // Add/remove overlay
    toggleSidebarOverlay();
  });
});

// Create and toggle overlay
function toggleSidebarOverlay() {
  let overlay = document.getElementById('sidebarOverlay');
  
  if (sidebar.classList.contains('active')) {
    // Create overlay if it doesn't exist
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'sidebarOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 997;
        display: block;
      `;
      document.body.appendChild(overlay);
      
      // Close sidebar when clicking overlay
      overlay.addEventListener('click', () => {
        sidebar.classList.remove('active');
        overlay.remove();
      });
    }
  } else {
    // Remove overlay
    if (overlay) {
      overlay.remove();
    }
  }
}

// Close sidebar when clicking outside on mobile
document.addEventListener('click', (e) => {
  if (window.innerWidth <= 992) {
    if (!sidebar.contains(e.target) && 
        !e.target.closest('[id^="mobileSidebarToggle"]')) {
      sidebar.classList.remove('active');
      const overlay = document.getElementById('sidebarOverlay');
      if (overlay) overlay.remove();
    }
  }
});

// Close sidebar when window is resized to desktop
window.addEventListener('resize', () => {
  if (window.innerWidth > 992) {
    sidebar.classList.remove('active');
    const overlay = document.getElementById('sidebarOverlay');
    if (overlay) overlay.remove();
  }
});

// ===================
// SWIPE TO CLOSE SIDEBAR (MOBILE)
// ===================
let touchStartX = 0;
let touchEndX = 0;

sidebar.addEventListener('touchstart', (e) => {
  touchStartX = e.changedTouches[0].screenX;
}, { passive: true });

sidebar.addEventListener('touchend', (e) => {
  touchEndX = e.changedTouches[0].screenX;
  handleSwipeGesture();
}, { passive: true });

function handleSwipeGesture() {
  // Swipe left to close (threshold: 50px)
  if (touchStartX - touchEndX > 50) {
    if (sidebar.classList.contains('active')) {
      sidebar.classList.remove('active');
      const overlay = document.getElementById('sidebarOverlay');
      if (overlay) overlay.remove();
    }
  }
}

// ===================
// PREVENT BODY SCROLL WHEN SIDEBAR IS OPEN (MOBILE)
// ===================
const observer = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    if (mutation.attributeName === 'class') {
      if (window.innerWidth <= 992) {
        if (sidebar.classList.contains('active')) {
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = '';
        }
      }
    }
  });
});

observer.observe(sidebar, { attributes: true });











// ================================
// FILTER PRODUCTS - CLEAN VERSION
// ================================

/**
 * Filters product rows based on status, category, and type
 * Updates visibility and refreshes statistics
 * @returns {void}
 */
function filterProducts() {
  // Get filter values with null safety
  const statusFilter = document.getElementById('productStatusFilter')?.value || 'all';
  const categoryFilter = document.getElementById('productCategoryFilter')?.value || 'all';
  const typeFilter = document.getElementById('productTypeFilter')?.value || 'all';
  
  // Get all product rows
  const rows = document.querySelectorAll('.product-row');
  
  // Early exit if no rows exist
  if (!rows || rows.length === 0) {
    console.warn('âš ï¸ No product rows found to filter');
    updateProductStats();
    return;
  }
  
  let visibleCount = 0;
  
  // Filter each row
  rows.forEach(row => {
    // Get row data attributes
    const stockStatus = row.dataset.stockStatus || '';
    const category = row.dataset.category || '';
    const type = row.dataset.type || '';
    
    // Check each filter condition
    const statusMatch = statusFilter === 'all' || stockStatus === statusFilter;
    const categoryMatch = categoryFilter === 'all' || category === categoryFilter;
    const typeMatch = typeFilter === 'all' || type === typeFilter;
    
    // Determine visibility (all conditions must match)
    const isVisible = statusMatch && categoryMatch && typeMatch;
    
    // Update row visibility
    if (isVisible) {
      row.classList.remove('hidden');
      row.style.display = '';
      visibleCount++;
    } else {
      row.classList.add('hidden');
      row.style.display = 'none';
    }
  });
  
  // Log filter results (optional - remove in production)
  console.log(`âœ… Filter applied: ${visibleCount} of ${rows.length} products visible`);
  
  // Update statistics after filtering
  updateProductStats();
  
  // Optional: Save filter state to localStorage
  saveFilterState();
}

/**
 * Updates product statistics based on visible rows
 * @returns {void}
 */
function updateProductStats() {
  // Get all visible rows only
  const allRows = document.querySelectorAll('.product-row');
  const visibleRows = Array.from(allRows).filter(row => row.style.display !== 'none');
  
  // Early exit if no rows
  if (!visibleRows || visibleRows.length === 0) {
    updateStatCounters(0, 0, 0, 0);
    return;
  }
  
  // Count products by status
  let inStockCount = 0;
  let lowStockCount = 0;
  let outOfStockCount = 0;
  
  visibleRows.forEach(row => {
    const status = row.dataset.stockStatus;
    
    switch(status) {
      case 'instock':
        inStockCount++;
        break;
      case 'lowstock':
        lowStockCount++;
        break;
      case 'outofstock':
      case 'sold':
        outOfStockCount++;
        break;
      default:
        console.warn(`âš ï¸ Unknown stock status: ${status}`);
    }
  });
  
  // Update UI counters
  updateStatCounters(visibleRows.length, inStockCount, lowStockCount, outOfStockCount);
}

/**
 * Updates the statistics counter elements in the UI
 * @param {number} total - Total visible products
 * @param {number} inStock - Products in stock
 * @param {number} lowStock - Products with low stock
 * @param {number} outOfStock - Products out of stock
 * @returns {void}
 */
function updateStatCounters(total, inStock, lowStock, outOfStock) {
  // Get counter elements with null safety
  const totalCounter = document.getElementById('totalProductsCount');
  const inStockCounter = document.getElementById('inStockCount');
  const lowStockCounter = document.getElementById('lowStockCount');
  const outOfStockCounter = document.getElementById('outOfStockCount');
  
  // Update each counter if element exists
  if (totalCounter) totalCounter.textContent = total;
  if (inStockCounter) inStockCounter.textContent = inStock;
  if (lowStockCounter) lowStockCounter.textContent = lowStock;
  if (outOfStockCounter) outOfStockCounter.textContent = outOfStock;
}

/**
 * Saves current filter state to localStorage
 * @returns {void}
 */
function saveFilterState() {
  try {
    const filterState = {
      status: document.getElementById('productStatusFilter')?.value || 'all',
      category: document.getElementById('productCategoryFilter')?.value || 'all',
      type: document.getElementById('productTypeFilter')?.value || 'all',
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('productFilterState', JSON.stringify(filterState));
  } catch (error) {
    console.error('âŒ Failed to save filter state:', error);
  }
}

/**
 * Loads and applies saved filter state from localStorage
 * @returns {void}
 */
function loadFilterState() {
  try {
    const saved = localStorage.getItem('productFilterState');
    
    if (!saved) return;
    
    const filterState = JSON.parse(saved);
    
    // Apply saved values to filter dropdowns
    const statusFilter = document.getElementById('productStatusFilter');
    const categoryFilter = document.getElementById('productCategoryFilter');
    const typeFilter = document.getElementById('productTypeFilter');
    
    if (statusFilter && filterState.status) {
      statusFilter.value = filterState.status;
    }
    
    if (categoryFilter && filterState.category) {
      categoryFilter.value = filterState.category;
    }
    
    if (typeFilter && filterState.type) {
      typeFilter.value = filterState.type;
    }
    
    // Apply filters after loading state
    filterProducts();
    
    console.log('âœ… Filter state restored from localStorage');
  } catch (error) {
    console.error('âŒ Failed to load filter state:', error);
  }
}

// ================================
// EVENT LISTENERS SETUP
// ================================

/**
 * Initialize filter event listeners
 * Call this on DOMContentLoaded
 */
function initializeProductFilters() {
  // Get filter elements
  const statusFilter = document.getElementById('productStatusFilter');
  const categoryFilter = document.getElementById('productCategoryFilter');
  const typeFilter = document.getElementById('productTypeFilter');
  
  // Add change listeners with null safety
  if (statusFilter) {
    statusFilter.addEventListener('change', filterProducts);
  }
  
  if (categoryFilter) {
    categoryFilter.addEventListener('change', filterProducts);
  }
  
  if (typeFilter) {
    typeFilter.addEventListener('change', filterProducts);
  }
  
  // Load saved filter state
  loadFilterState();
  
  console.log('âœ… Product filters initialized');
}

// Auto-initialize on page load
document.addEventListener('DOMContentLoaded', initializeProductFilters);





// ============================================================
// SALES MANAGEMENT MODULE - CLEAN VERSION
// ============================================================

/**
 * State management for sales filters
 */
const SalesFilterState = {
  sellers: [],
  isLoading: false,
  lastUpdated: null
};

// ================================
// LOAD SELLERS FROM DATABASE
// ================================

/**
 * Fetches and populates the sellers dropdown
 * @returns {Promise<void>}
 */
async function loadSellers() {
  const sellerFilter = document.getElementById('sellerFilter');
  
  // Guard: Check if element exists
  if (!sellerFilter) {
    console.warn('âš ï¸ Seller filter element not found');
    return;
  }
  
  // Prevent duplicate loading
  if (SalesFilterState.isLoading) {
    console.log('â³ Sellers already loading...');
    return;
  }
  
  try {
    SalesFilterState.isLoading = true;
    
    // Show loading state
    sellerFilter.innerHTML = '<option value="all">Loading sellers...</option>';
    sellerFilter.disabled = true;
    
    const response = await fetch('/sales/api/get-sellers/', {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    
    // Check response status
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    // Handle both response formats: {sellers: [...]} or [...]
    const sellers = data.sellers || data;
    
    // Validate data
    if (!Array.isArray(sellers)) {
      throw new Error('Invalid sellers data format');
    }
    
    // Store in state
    SalesFilterState.sellers = sellers;
    SalesFilterState.lastUpdated = new Date();
    
    // Clear and populate dropdown
    sellerFilter.innerHTML = '<option value="all">All Sellers</option>';
    
    if (sellers.length === 0) {
      const emptyOption = document.createElement('option');
      emptyOption.disabled = true;
      emptyOption.textContent = '(No sellers found)';
      sellerFilter.appendChild(emptyOption);
    } else {
      sellers.forEach(seller => {
        const option = document.createElement('option');
        option.value = seller.id;
        
        // Prioritize display name: username > first_name > fallback
        option.textContent = seller.username || 
                            seller.first_name || 
                            seller.full_name ||
                            `User #${seller.id}`;
        
        sellerFilter.appendChild(option);
      });
    }
    
    console.log(`âœ… Loaded ${sellers.length} sellers`);
    
  } catch (error) {
    console.error('âŒ Error loading sellers:', error);
    
    // Show error state
    sellerFilter.innerHTML = '<option value="all">All Sellers (Error loading)</option>';
    
    // Show user-friendly error message
    showToast('Failed to load sellers list', 'error');
    
  } finally {
    sellerFilter.disabled = false;
    SalesFilterState.isLoading = false;
  }
}

// ================================
// FILTER SALES
// ================================

/**
 * Filters sales rows based on status, seller, and type
 * @returns {void}
 */
function filterSales() {
  // Get filter values with null safety
  const statusFilter = document.getElementById('statusFilter')?.value || 'all';
  const sellerFilter = document.getElementById('sellerFilter')?.value || 'all';
  const typeFilter = document.getElementById('typeFilter')?.value || 'all';
  
  // Get all sale rows
  const rows = document.querySelectorAll('.sale-row');
  
  // Early exit if no rows
  if (!rows || rows.length === 0) {
    console.warn('âš ï¸ No sale rows found to filter');
    updateSalesStats(0, 0, 0);
    return;
  }
  
  let visibleCount = 0;
  let totalActive = 0;
  let totalReversed = 0;
  
  // Filter each row
  rows.forEach(row => {
    // Get row data attributes
    const status = row.dataset.status || '';
    const type = row.dataset.type || '';
    const seller = row.dataset.seller || '';
    
    // Match conditions
    const statusMatch = statusFilter === 'all' || status === statusFilter;
    const sellerMatch = sellerFilter === 'all' || seller === sellerFilter;
    const typeMatch = typeFilter === 'all' || type === typeFilter;
    
    // Determine visibility
    const isVisible = statusMatch && sellerMatch && typeMatch;
    
    if (isVisible) {
      row.classList.remove('hidden');
      row.style.display = '';
      visibleCount++;
      
      // Count by status
      if (status === 'active') totalActive++;
      if (status === 'reversed') totalReversed++;
    } else {
      row.classList.add('hidden');
      row.style.display = 'none';
    }
  });
  
  // Log filter results
  console.log(`âœ… Sales filter: ${visibleCount} visible (${totalActive} active, ${totalReversed} reversed)`);
  
  // Update statistics
  updateSalesStats(visibleCount, totalActive, totalReversed);
  
  // Optional: Save filter state
  saveSalesFilterState();
}

// ================================
// UPDATE SALES STATISTICS
// ================================

/**
 * Updates sales statistics counters in the UI
 * @param {number} visibleCount - Total visible sales
 * @param {number} activeCount - Active sales count
 * @param {number} reversedCount - Reversed sales count
 * @returns {void}
 */
function updateSalesStats(visibleCount, activeCount, reversedCount) {
  // Update total visible sales
  const totalElement = document.getElementById('totalSalesCount');
  if (totalElement) {
    totalElement.textContent = visibleCount;
  }
  
  // Update active sales count
  const activeElement = document.getElementById('activeSalesCount');
  if (activeElement) {
    activeElement.textContent = activeCount;
  }
  
  // Update reversed sales count
  const reversedElement = document.getElementById('reversedSalesCount');
  if (reversedElement) {
    reversedElement.textContent = reversedCount;
  }
}

// ================================
// FILTER STATE PERSISTENCE
// ================================

/**
 * Saves sales filter state to localStorage
 * @returns {void}
 */
function saveSalesFilterState() {
  try {
    const filterState = {
      status: document.getElementById('statusFilter')?.value || 'all',
      seller: document.getElementById('sellerFilter')?.value || 'all',
      type: document.getElementById('typeFilter')?.value || 'all',
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('salesFilterState', JSON.stringify(filterState));
  } catch (error) {
    console.error('âŒ Failed to save sales filter state:', error);
  }
}

/**
 * Loads and applies saved sales filter state
 * @returns {void}
 */
function loadSalesFilterState() {
  try {
    const saved = localStorage.getItem('salesFilterState');
    
    if (!saved) return;
    
    const filterState = JSON.parse(saved);
    
    // Apply saved values
    const statusFilter = document.getElementById('statusFilter');
    const sellerFilter = document.getElementById('sellerFilter');
    const typeFilter = document.getElementById('typeFilter');
    
    if (statusFilter && filterState.status) {
      statusFilter.value = filterState.status;
    }
    
    if (sellerFilter && filterState.seller) {
      sellerFilter.value = filterState.seller;
    }
    
    if (typeFilter && filterState.type) {
      typeFilter.value = filterState.type;
    }
    
    // Apply filters
    filterSales();
    
    console.log('âœ… Sales filter state restored');
  } catch (error) {
    console.error('âŒ Failed to load sales filter state:', error);
  }
}

// ============================================================
// PRODUCT DETAILS MODULE - CLEAN VERSION
// ============================================================

/**
 * Fetches and displays detailed product information in a modal
 * @param {number|string} productId - The product ID to fetch
 * @returns {Promise<void>}
 */
async function viewProductDetails(productId) {
  // Validate productId
  if (!productId || productId === 'undefined') {
    showToast('Invalid product ID', 'error');
    return;
  }
  
  // Get CSRF token
  const csrftoken = getCsrfToken();
  if (!csrftoken) {
    showToast('Security token missing', 'error');
    return;
  }
  
  // Get modal elements
  const modal = document.getElementById('productDetailsModal');
  const contentDiv = document.getElementById('productDetailsContent');
  
  if (!modal || !contentDiv) {
    console.error('âŒ Product details modal elements not found');
    showToast('Modal not found', 'error');
    return;
  }
  
  try {
    // Show loading state
    contentDiv.innerHTML = `
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading product details...</p>
      </div>
    `;
    modal.style.display = 'flex';
    
    // Fetch product details
    const response = await fetch(`/inventory/products/${productId}/`, {
      method: 'GET',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    // Check response status
    if (data.status !== 'success' || !data.product) {
      throw new Error(data.message || 'Failed to load product details');
    }
    
    // Render product details
    renderProductDetails(data.product, contentDiv);
    
  } catch (error) {
    console.error('âŒ Error fetching product details:', error);
    
    // Show error state
    contentDiv.innerHTML = `
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i>
        <strong>Error:</strong> ${error.message || 'Failed to load product details'}
      </div>
    `;
    
    showToast('Failed to load product details', 'error');
  }
}

/**
 * Renders product details HTML
 * @param {Object} product - Product data object
 * @param {HTMLElement} container - Container element
 * @returns {void}
 */
function renderProductDetails(product, container) {
  // Calculate margin
  const margin = product.selling_price - product.buying_price;
  const marginPct = ((margin / product.buying_price) * 100).toFixed(1);
  
  // Determine quantity color
  const qtyColor = product.quantity > 5 ? '#10b981' : 
                   product.quantity > 0 ? '#f59e0b' : '#ef4444';
  
  // Determine margin badge color
  const marginBgColor = marginPct >= 30 ? '#10b981' : 
                        marginPct >= 15 ? '#f59e0b' : '#ef4444';
  
  // Build HTML
  const html = `
    <div style="display: grid; gap: 15px;">
      <!-- Product Code -->
      <div class="detail-row">
        <strong>Product Code:</strong>
        <code class="detail-code">${escapeHtml(product.product_code)}</code>
      </div>
      
      <!-- Product Name -->
      <div class="detail-row">
        <strong>Product Name:</strong>
        <span>${escapeHtml(product.name)}</span>
      </div>
      
      <!-- Category -->
      <div class="detail-row">
        <strong>Category:</strong>
        <span class="badge bg-secondary">${escapeHtml(product.category || 'N/A')}</span>
      </div>
      
      <!-- Quantity -->
      <div class="detail-row">
        <strong>Quantity:</strong>
        <span style="font-weight: 600; color: ${qtyColor}">
          ${product.quantity}
        </span>
      </div>
      
      <!-- Buying Price -->
      <div class="detail-row">
        <strong>Buying Price:</strong>
        <span>KSH ${parseFloat(product.buying_price).toFixed(2)}</span>
      </div>
      
      <!-- Selling Price -->
      <div class="detail-row">
        <strong>Selling Price:</strong>
        <span style="color: #10b981; font-weight: 600;">
          KSH ${parseFloat(product.selling_price).toFixed(2)}
        </span>
      </div>
      
      <!-- Profit Margin -->
      <div class="detail-row detail-row-highlight">
        <strong>Profit Margin:</strong>
        <div>
          <span style="font-weight: 600; color: #10b981;">
            KSH ${margin.toFixed(2)}
          </span>
          <span class="badge" style="background: ${marginBgColor}; color: white; margin-left: 8px;">
            +${marginPct}%
          </span>
        </div>
      </div>
      
      <!-- Status -->
      <div class="detail-row">
        <strong>Status:</strong>
        <span>
          ${product.is_active ? 
            '<span class="badge badge-success">Active</span>' : 
            '<span class="badge badge-danger">Inactive</span>'}
        </span>
      </div>
      
      <!-- Owner -->
      <div class="detail-row">
        <strong>Owner:</strong>
        <span>${escapeHtml(product.owner || 'FIELDMAX')}</span>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
}

/**
 * Closes the product details modal
 * @returns {void}
 */
function closeProductDetails() {
  const modal = document.getElementById('productDetailsModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// ================================
// UTILITY FUNCTIONS
// ================================

/**
 * Gets CSRF token from the page
 * @returns {string|null} CSRF token or null
 */
function getCsrfToken() {
  const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
  if (!tokenElement) {
    console.error('âŒ CSRF token not found');
    return null;
  }
  return tokenElement.value;
}

/**
 * Escapes HTML to prevent XSS attacks
 * @param {string} text - Text to escape
 * @returns {string} Escaped text
 */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * Shows a toast notification
 * @param {string} message - Message to display
 * @param {string} type - Type: 'success', 'error', 'info', 'warning'
 * @returns {void}
 */
function showToast(message, type = 'success') {
  // Remove existing toast
  const existingToast = document.querySelector('.toast-message');
  if (existingToast) {
    existingToast.remove();
  }
  
  // Create new toast
  const toast = document.createElement('div');
  toast.className = `toast-message ${type}`;
  toast.textContent = message;
  
  // Add icon based on type
  const icons = {
    success: 'âœ…',
    error: 'âŒ',
    warning: 'âš ï¸',
    info: 'â„¹ï¸'
  };
  toast.textContent = `${icons[type] || ''} ${message}`;
  
  document.body.appendChild(toast);
  
  // Show toast
  setTimeout(() => toast.classList.add('show'), 100);
  
  // Auto-hide after 4 seconds
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 400);
  }, 4000);
}

// ================================
// INITIALIZATION
// ================================

/**
 * Initialize sales filters and event listeners
 * @returns {void}
 */
function initializeSalesFilters() {
  // Load sellers dropdown
  loadSellers();
  
  // Add event listeners to filters
  const statusFilter = document.getElementById('statusFilter');
  const sellerFilter = document.getElementById('sellerFilter');
  const typeFilter = document.getElementById('typeFilter');
  
  if (statusFilter) {
    statusFilter.addEventListener('change', filterSales);
  }
  
  if (sellerFilter) {
    sellerFilter.addEventListener('change', filterSales);
  }
  
  if (typeFilter) {
    typeFilter.addEventListener('change', filterSales);
  }
  
  // Calculate initial stats
  const totalRows = document.querySelectorAll('.sale-row').length;
  const activeRows = document.querySelectorAll('.sale-row[data-status="active"]').length;
  const reversedRows = document.querySelectorAll('.sale-row[data-status="reversed"]').length;
  
  updateSalesStats(totalRows, activeRows, reversedRows);
  
  // Load saved filter state
  loadSalesFilterState();
  
  console.log('âœ… Sales filters initialized');
}

// Auto-initialize on page load
document.addEventListener('DOMContentLoaded', initializeSalesFilters);









// ====================================
// ADD CATEGORY SECTION - 
// ====================================

document.addEventListener("DOMContentLoaded", function() {
    console.log('ðŸ”§ Category form initialization started');
    
    // Wait for section to be visible
    const initCategoryForm = () => {
        const addBtn = document.getElementById("add-product-btn");
        const tableBody = document.querySelector("#products-table tbody");
        const categoryNameInput = document.getElementById("category-name");
        const categoryCodeInput = document.getElementById("category-code");
        const categoryForm = document.getElementById("addCategoryForm");

        if (categoryForm.dataset.initialized === "true") {
           console.log("âš ï¸ Form already initialized, skipping duplicate binding");
           return;
        }
        categoryForm.dataset.initialized = "true";


        if (!addBtn || !tableBody || !categoryNameInput || !categoryCodeInput) {
            console.log('â³ Category form elements not ready, retrying...');
            setTimeout(initCategoryForm, 500);
            return;
        }

        console.log('âœ… Category form elements found');

        // ==========================================
        // AUTO-GENERATE CATEGORY CODE
        // ==========================================
        categoryNameInput.addEventListener("input", function() {
            const name = this.value.trim();
            if (name.length > 0) {
                const firstLetter = name.charAt(0).toUpperCase();
                categoryCodeInput.value = `${firstLetter}FSL`;
            } else {
                categoryCodeInput.value = "";
            }
        });

        // ==========================================
        // ADD NEW PRODUCT ROW
        // ==========================================
        addBtn.addEventListener("click", function(e) {
            e.preventDefault();
            console.log('âž• Adding new product row');
            
            const rows = tableBody.querySelectorAll("tr.product-row");
            const newIndex = rows.length;
            
            // Clone the first row
            const firstRow = rows[0];
            const newRow = firstRow.cloneNode(true);

            // Update all input/select names with new index
            newRow.querySelectorAll("input, select").forEach(el => {
                const name = el.getAttribute("name");
                if (name) {
                    // Replace any existing index with new index
                    const newName = name.replace(/products-\d+-/, `products-${newIndex}-`);
                    el.setAttribute("name", newName);
                    el.setAttribute("id", `id_${newName}`);

                    // Reset values
                    if (el.type === "checkbox") {
                        el.checked = true;
                    } else if (el.tagName.toLowerCase() === "select") {
                        el.selectedIndex = 0;
                    } else if (!el.readOnly) {
                        el.value = "";
                    }
                }
            });

            // Auto-generate product code for new row
            const codeInput = newRow.querySelector('input[name^="products-"][name$="-code"]');
            if (codeInput && categoryCodeInput.value) {
                const categoryCode = categoryCodeInput.value;
                codeInput.value = `${categoryCode}${String(newIndex + 1).padStart(3, '0')}`;
            }

            tableBody.appendChild(newRow);
            console.log(`âœ… New row added with index ${newIndex}`);
        });

        // ==========================================
        // REMOVE PRODUCT ROW
        // ==========================================
        tableBody.addEventListener("click", function(e) {
            if (e.target && e.target.classList.contains("remove-product")) {
                e.preventDefault();
                
                const rows = tableBody.querySelectorAll("tr.product-row");
                
                if (rows.length <= 1) {
                    alert("âš ï¸ At least one product row is required.");
                    return;
                }

                const row = e.target.closest("tr");
                row.remove();
                console.log('ðŸ—‘ï¸ Product row removed');

                // Reindex remaining rows
                reindexProductRows();
            }
        });

        // ==========================================
        // REINDEX ROWS AFTER DELETION
        // ==========================================
        function reindexProductRows() {
            const rows = tableBody.querySelectorAll("tr.product-row");
            
            rows.forEach((row, index) => {
                row.querySelectorAll("input, select").forEach(el => {
                    const name = el.getAttribute("name");
                    if (name) {
                        const newName = name.replace(/products-\d+-/, `products-${index}-`);
                        el.setAttribute("name", newName);
                        el.setAttribute("id", `id_${newName}`);
                    }
                });

                // Update product code
                const codeInput = row.querySelector('input[name^="products-"][name$="-code"]');
                if (codeInput && categoryCodeInput.value) {
                    const categoryCode = categoryCodeInput.value;
                    codeInput.value = `${categoryCode}${String(index + 1).padStart(3, '0')}`;
                }
            });
            
            console.log(`âœ… Reindexed ${rows.length} product rows`);
        }

        // ==========================================
        // AUTO-GENERATE PRODUCT CODES ON CATEGORY CODE CHANGE
        // ==========================================
        categoryCodeInput.addEventListener("change", function() {
            const categoryCode = this.value;
            if (!categoryCode) return;

            const rows = tableBody.querySelectorAll("tr.product-row");
            rows.forEach((row, index) => {
                const codeInput = row.querySelector('input[name^="products-"][name$="-code"]');
                if (codeInput) {
                    codeInput.value = `${categoryCode}${String(index + 1).padStart(3, '0')}`;
                }
            });
        });

        // ==========================================
        // FORM SUBMISSION - AJAX
        // ==========================================
        if (categoryForm) {
            categoryForm.addEventListener("submit", function(e) {
                e.preventDefault();
                
                console.log('ðŸ“¤ Submitting category form');
                
                const submitBtn = categoryForm.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                
                // Disable submit button
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
                
                const formData = new FormData(categoryForm);
                
                // Add management form data for formset
                const rows = tableBody.querySelectorAll("tr.product-row");
                formData.set('products-TOTAL_FORMS', rows.length);
                formData.set('products-INITIAL_FORMS', '0');
                formData.set('products-MIN_NUM_FORMS', '0');
                formData.set('products-MAX_NUM_FORMS', '1000');

                fetch(categoryForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('âœ… Category saved successfully');
                        
                        // Show success message
                        const successDiv = document.getElementById('success-message-category');
                        if (successDiv) {
                            successDiv.textContent = data.message || 'Category saved successfully!';
                            successDiv.style.display = 'block';
                            
                            setTimeout(() => {
                                successDiv.style.display = 'none';
                            }, 5000);
                        }
                        
                        // Reset form
                        categoryForm.reset();
                        categoryCodeInput.value = '';
                        
                        // Reset product rows to one empty row
                        const allRows = Array.from(tableBody.querySelectorAll("tr.product-row"));
                        allRows.slice(1).forEach(row => row.remove());
                        
                        // Clear first row
                        const firstRow = tableBody.querySelector("tr.product-row");
                        firstRow.querySelectorAll("input, select").forEach(el => {
                            if (el.type === "checkbox") {
                                el.checked = true;
                            } else if (!el.readOnly) {
                                el.value = "";
                            }
                        });
                        
                        // Show toast notification
                        showToast('âœ… Category created successfully!', 'success');
                        
                        // Optional: Navigate to category list
                        // setTimeout(() => {
                        //     showSection('category-list');
                        // }, 2000);
                        
                    } else {
                        console.error('âŒ Server error:', data.message);
                        
                        const messageDiv = document.getElementById('message-div-category');
                        if (messageDiv) {
                            messageDiv.innerHTML = `
                                <div class="alert alert-danger">
                                    <strong>Error:</strong> ${data.message || 'Failed to save category'}
                                </div>
                            `;
                        }
                        
                        showToast('âŒ ' + (data.message || 'Failed to save category'), 'error');
                    }
                })
                .catch(error => {
                    console.error('âŒ Network error:', error);
                    
                    const messageDiv = document.getElementById('message-div-category');
                    if (messageDiv) {
                        messageDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <strong>Network Error:</strong> Could not connect to server. Please try again.
                            </div>
                        `;
                    }
                    
                    showToast('âŒ Network error occurred', 'error');
                })
                .finally(() => {
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                });
            });
        }

        console.log('âœ… Category form fully initialized');
    };

    // Initialize when add-category section becomes active
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.target.id === 'add-category' && 
                mutation.target.classList.contains('active')) {
                console.log('ðŸ“‹ Add Category section activated');
                initCategoryForm();
            }
        });
    });

    const addCategorySection = document.getElementById('add-category');
    if (addCategorySection) {
        observer.observe(addCategorySection, {
            attributes: true,
            attributeFilter: ['class']
        });
    }

    // Also try immediate init if section is already active
    if (addCategorySection && addCategorySection.classList.contains('active')) {
        initCategoryForm();
    }
});

// ==========================================
// HELPER: SHOW TOAST NOTIFICATION
// ==========================================
function showToast(message, type = 'success') {
    const existingToast = document.querySelector('.toast-message');
    if (existingToast) {
        existingToast.remove();
    }

    const toast = document.createElement('div');
    toast.className = `toast-message ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 400);
    }, 4000);
}











// ====================================
// ADD PRODUCT  SECTION
// ====================================

document.addEventListener('DOMContentLoaded', function () {

    const categorySelect = document.getElementById('category-select');
    const skuField = document.getElementById('sku-field');
    const skuInput = document.getElementById('sku-input');
    const skuLabel = document.getElementById('sku-label');
    const quantityField = document.getElementById('quantity-field');
    const quantityInput = document.getElementById('quantity');
    const form = document.getElementById('addProductForm');
    const messageDiv = document.getElementById('message-div');
    const successDiv = document.getElementById('success-message-product');
    const saveBtn = form.querySelector("button[type='submit']");

    function getCookie(name) {
        let cookieValue = null;
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = cookie.slice(name.length + 1);
                break;
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function showToast(msg, type="success") {
        const t = document.createElement("div");
        t.className = `toast-message ${type}`;
        t.innerHTML = msg;
        document.body.appendChild(t);
        setTimeout(() => t.classList.add("show"), 50);
        setTimeout(() => t.remove(), 3500);
    }

    function validateInline() {
        const name = document.getElementById("product-name").value.trim();
        const category = categorySelect.value;
        const buy = parseFloat(document.getElementById("buying-price").value);
        const sell = parseFloat(document.getElementById("selling-price").value);

        messageDiv.innerHTML = "";

        if (!category) {
            messageDiv.innerHTML = `<div class="alert alert-danger">Please select a category.</div>`;
            return false;
        }

        if (!name) {
            messageDiv.innerHTML = `<div class="alert alert-danger">Product name is required.</div>`;
            return false;
        }

        if (isNaN(buy) || buy <= 0) {
            messageDiv.innerHTML = `<div class="alert alert-danger">Valid buying price is required.</div>`;
            return false;
        }

        if (isNaN(sell) || sell <= 0) {
            messageDiv.innerHTML = `<div class="alert alert-danger">Valid selling price is required.</div>`;
            return false;
        }

        if (sell < buy) {
            messageDiv.innerHTML = `<div class="alert alert-danger">Selling price must be higher than buying price.</div>`;
            return false;
        }

        // Check if single item needs SKU
        const selected = categorySelect.options[categorySelect.selectedIndex];
        const isSingle = selected.dataset.isSingle === "true";
        if (isSingle && !skuInput.value.trim()) {
            messageDiv.innerHTML = `<div class="alert alert-danger">SKU/IMEI/Serial is required for single items.</div>`;
            skuInput.focus();
            return false;
        }

        // Check if bulk item needs quantity
        const isBulk = selected.dataset.isBulk === "true";
        if (isBulk) {
            const qty = parseInt(quantityInput.value);
            if (isNaN(qty) || qty <= 0) {
                messageDiv.innerHTML = `<div class="alert alert-danger">Valid quantity is required for bulk items.</div>`;
                quantityInput.focus();
                return false;
            }
        }

        return true;
    }

    function updateFields() {
        const selected = categorySelect.options[categorySelect.selectedIndex];
        const isSingle = selected.dataset.isSingle === "true";
        const isBulk = selected.dataset.isBulk === "true";
        const skuType = selected.dataset.skuType || "SKU";

        if (isSingle) {
            skuField.style.display = 'block';
            skuLabel.textContent = `${skuType} *`;
            skuInput.required = true;
            quantityField.style.display = 'none';
            quantityInput.value = 1;
            quantityInput.required = false;
        } else if (isBulk) {
            skuField.style.display = 'none';
            skuInput.required = false;
            quantityField.style.display = 'block';
            quantityInput.required = true;
        } else {
            skuField.style.display = 'none';
            skuInput.required = false;
            quantityField.style.display = 'none';
            quantityInput.required = false;
        }
    }

    categorySelect.addEventListener('change', updateFields);
    updateFields();

    form.addEventListener('submit', function (e) {
        e.preventDefault();

        if (!validateInline()) return;

        saveBtn.disabled = true;
        saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Saving...`;
        messageDiv.innerHTML = "";

        fetch(form.action, {
            method: "POST",
            body: new FormData(form),
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": csrftoken
            }
        })
        .then(response => {
            // CRITICAL FIX: Check content type before parsing
            const contentType = response.headers.get("content-type");
            
            if (contentType && contentType.includes("application/json")) {
                return response.json().then(data => ({ 
                    status: response.status, 
                    data: data 
                }));
            } else {
                // Non-JSON response (probably HTML redirect or error page)
                return response.text().then(text => ({ 
                    status: response.status, 
                    data: { success: false, message: "Unexpected response from server" },
                    rawText: text
                }));
            }
        })
        .then(({ status, data, rawText }) => {
            console.log("Response status:", status);
            console.log("Response data:", data);
            
            if (status === 200 && data.success) {
                showToast("âœ… Product saved successfully!");

                form.reset();
                updateFields();

                successDiv.style.display = "block";
                setTimeout(() => successDiv.style.display = "none", 5000);

                // Navigate to product list
                const listBtn = document.querySelector("[data-section='product-list']");
                if (listBtn) {
                    setTimeout(() => {
                        listBtn.click();
                        // Optionally reload to show new product
                        setTimeout(() => window.location.reload(), 500);
                    }, 1200);
                }
            }
            else {
                // Error response
                let errorMessage = "Error saving product";
                
                if (data.message) {
                    errorMessage = data.message;
                } else if (data.errors) {
                    const firstError = Object.values(data.errors)[0];
                    if (Array.isArray(firstError) && firstError.length > 0) {
                        errorMessage = firstError[0];
                    }
                } else if (rawText) {
                    console.error("Raw response:", rawText);
                    errorMessage = "Server error. Check console for details.";
                }
                
                messageDiv.innerHTML = `<div class="alert alert-danger"><strong>âŒ Error:</strong> ${errorMessage}</div>`;
                showToast(errorMessage, "error");
            }
        })
        .catch(error => {
            console.error("Network error:", error);
            messageDiv.innerHTML = `<div class="alert alert-danger"><strong>âŒ Network Error:</strong> Could not connect to server. Please check your connection.</div>`;
            showToast("Network error occurred", "error");
        })
        .finally(() => {
            saveBtn.disabled = false;
            saveBtn.innerHTML = `<i class="bi bi-save"></i><span> Save Product</span>`;
        });
    });
});







// ============================
// RESTOCK PRODUCT SECTION
// ============================

document.addEventListener('DOMContentLoaded', function() {
  // Elements
  const searchInput = document.getElementById('restockSearchInput');
  const searchBtn = document.getElementById('restockSearchBtn');
  const searchMessage = document.getElementById('restockSearchMessage');
  const autocompleteDiv = document.getElementById('restockAutocomplete');
  const autocompleteList = document.getElementById('restockAutocompleteList');
  const multipleResults = document.getElementById('restockMultipleResults');
  const productsList = document.getElementById('restockProductsList');
  const formSection = document.getElementById('restockFormSection');
  const restockForm = document.getElementById('restockForm');
  const resetBtn = document.getElementById('restockResetBtn');
  const submitBtn = document.getElementById('restockSubmitBtn');
  const formMessage = document.getElementById('restockFormMessage');
  const emptyState = document.getElementById('restockEmptyState');
  const productInfo = document.getElementById('restockProductInfo');
  
  // Form inputs
  const quantityInput = document.getElementById('restockQuantity');
  const buyingPriceInput = document.getElementById('restockBuyingPrice');
  const sellingPriceInput = document.getElementById('restockSellingPrice');
  const totalAmountDiv = document.getElementById('restockTotalAmountDisplay');
  const totalAmountSpan = document.getElementById('restockTotalAmount');
  const successDisplay = document.getElementById('restockSuccessDisplay');

  let autocompleteTimer = null;

  // Auto-complete on input
  searchInput.addEventListener('input', function() {
    clearTimeout(autocompleteTimer);
    const searchTerm = searchInput.value.trim();
    
    if (searchTerm.length < 2) {
      autocompleteDiv.style.display = 'none';
      return;
    }

    // Debounce - wait 300ms after user stops typing
    autocompleteTimer = setTimeout(() => {
      fetchAutocomplete(searchTerm);
    }, 300);
  });

  // Hide autocomplete when clicking outside
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !autocompleteDiv.contains(e.target)) {
      autocompleteDiv.style.display = 'none';
    }
  });

  // Fetch autocomplete suggestions
  function fetchAutocomplete(searchTerm) {
    fetch(`/inventory/restock/search/?search=${encodeURIComponent(searchTerm)}&autocomplete=true`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success && data.suggestions && data.suggestions.length > 0) {
        displayAutocomplete(data.suggestions);
      } else {
        autocompleteDiv.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Autocomplete error:', error);
      autocompleteDiv.style.display = 'none';
    });
  }

  // Display autocomplete suggestions
  function displayAutocomplete(suggestions) {
    autocompleteList.innerHTML = suggestions.map(item => `
      <div class="autocomplete-item p-3 border-bottom" 
           style="cursor: pointer; transition: background 0.2s;"
           onmouseover="this.style.background='#f3f4f6'"
           onmouseout="this.style.background='white'"
           onclick="selectAutocompleteItem(${item.id}, '${item.name.replace(/'/g, "\\'")}')">
        <div class="d-flex justify-content-between align-items-start">
          <div style="flex: 1;">
            <div class="fw-bold text-dark">${item.name}</div>
            <small class="text-muted">
              <i class="bi bi-tag me-1"></i>${item.product_code}
              ${item.category ? ` | <i class="bi bi-folder me-1"></i>${item.category}` : ''}
              | <i class="bi bi-box me-1"></i>Stock: ${item.current_quantity}
            </small>
          </div>
          ${item.is_single_item 
            ? '<span class="badge bg-danger ms-2">Cannot Restock</span>' 
            : '<span class="badge bg-success ms-2">Can Restock</span>'}
        </div>
      </div>
    `).join('');
    
    autocompleteDiv.style.display = 'block';
  }

  // Select item from autocomplete
  window.selectAutocompleteItem = function(productId, productName) {
    searchInput.value = productName;
    autocompleteDiv.style.display = 'none';
    performSearch();
  };

  // Search on Enter key
  searchInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      autocompleteDiv.style.display = 'none';
      performSearch();
    }
  });

  // Search button click
  searchBtn.addEventListener('click', function() {
    autocompleteDiv.style.display = 'none';
    performSearch();
  });

  // Reset button
  resetBtn.addEventListener('click', function() {
    resetSearch();
  });

  function resetSearch() {
    searchInput.value = '';
    searchInput.focus();
    autocompleteDiv.style.display = 'none';
    formSection.style.display = 'none';
    multipleResults.style.display = 'none';
    searchMessage.style.display = 'none';
    emptyState.style.display = 'block';
    productInfo.style.display = 'none';
    successDisplay.style.display = 'none';
    restockForm.reset();
    totalAmountDiv.style.display = 'none';
  }

  function performSearch() {
    const searchTerm = searchInput.value.trim();
    if (!searchTerm) {
      showSearchMessage('Please enter a product name, code, or SKU', 'error');
      return;
    }

    searchBtn.disabled = true;
    searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Searching...';
    searchMessage.style.display = 'none';
    multipleResults.style.display = 'none';
    formSection.style.display = 'none';

    fetch(`/inventory/restock/search/?search=${encodeURIComponent(searchTerm)}`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        if (data.multiple) {
          displayMultipleProducts(data.products);
        } else {
          displayRestockForm(data.product);
        }
      } else {
        showSearchMessage(data.message, 'error');
      }
    })
    .catch(error => {
      showSearchMessage('Search failed: ' + error.message, 'error');
    })
    .finally(() => {
      searchBtn.disabled = false;
      searchBtn.innerHTML = '<i class="bi bi-search"></i> Search';
    });
  }

  function showSearchMessage(message, type) {
    searchMessage.className = 'alert ' + (type === 'error' ? 'alert-danger' : 'alert-success');
    searchMessage.innerHTML = `<i class="bi bi-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}-fill me-2"></i>${message}`;
    searchMessage.style.display = 'block';
  }

  function displayMultipleProducts(products) {
    productsList.innerHTML = products.map(p => `
      <button 
        onclick="selectRestockProduct(${p.id})"
        class="btn btn-outline-primary text-start p-3">
        <div class="fw-bold">${p.name}</div>
        <small class="text-muted">
          Code: ${p.product_code} | Category: ${p.category} | Stock: ${p.current_quantity}
        </small>
      </button>
    `).join('');
    multipleResults.style.display = 'block';
  }

  // Make selectRestockProduct global
  window.selectRestockProduct = function(productId) {
    fetch(`/inventory/restock/search/?search=${productId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success && !data.multiple) {
        displayRestockForm(data.product);
        multipleResults.style.display = 'none';
      }
    });
  };

  function displayRestockForm(product) {
    // Fill product info
    document.getElementById('restockProductId').value = product.id;
    document.getElementById('restockDisplayName').textContent = product.name;
    document.getElementById('restockDisplayCode').textContent = product.product_code;
    document.getElementById('restockDisplayCategory').textContent = product.category;
    document.getElementById('restockDisplayStock').textContent = product.current_quantity;
    document.getElementById('restockDisplayBuyingPrice').textContent = parseFloat(product.buying_price).toFixed(2);
    document.getElementById('restockDisplaySellingPrice').textContent = parseFloat(product.selling_price).toFixed(2);
    
    // Pre-fill prices
    buyingPriceInput.value = product.buying_price || '';
    sellingPriceInput.value = product.selling_price || '';
    
    // Show sections
    emptyState.style.display = 'none';
    productInfo.style.display = 'block';
    formSection.style.display = 'block';
    successDisplay.style.display = 'none';
    quantityInput.focus();
  }

  // Calculate total amount
  function updateTotal() {
    const qty = parseFloat(quantityInput.value) || 0;
    const price = parseFloat(buyingPriceInput.value) || 0;
    const total = qty * price;

    if (qty > 0 && price > 0) {
      totalAmountSpan.textContent = total.toFixed(2);
      totalAmountDiv.style.display = 'block';
    } else {
      totalAmountDiv.style.display = 'none';
    }
  }

  quantityInput.addEventListener('input', updateTotal);
  buyingPriceInput.addEventListener('input', updateTotal);

  // Form submission
  restockForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(restockForm);
    const submitText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
    formMessage.style.display = 'none';
    successDisplay.style.display = 'none';

    fetch('/inventory/restock/process/', {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update stock display
        document.getElementById('restockDisplayStock').textContent = data.product.new_quantity;
        document.getElementById('restockNewStock').textContent = data.product.new_quantity;
        
        // Show success message
        successDisplay.style.display = 'block';
        
        // Reset form fields but keep product info
        quantityInput.value = '';
        document.getElementById('restockNotes').value = '';
        totalAmountDiv.style.display = 'none';
        
        // Scroll to success message
        successDisplay.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Focus back to quantity
        setTimeout(() => {
          quantityInput.focus();
          successDisplay.style.display = 'none';
        }, 4000);
      } else {
        throw new Error(data.message || 'Operation failed');
      }
    })
    .catch(error => {
      formMessage.className = 'alert alert-danger';
      formMessage.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>${error.message || 'An error occurred'}`;
      formMessage.style.display = 'block';
    })
    .finally(() => {
      submitBtn.disabled = false;
      submitBtn.innerHTML = submitText;
    });
  });
});












// ============================
// TRANSFER PRODUCT SECTION
// ============================

document.addEventListener('DOMContentLoaded', function() {
  console.log('ðŸ”§ Enhanced Transfer Product Module Initializing...');
  
  // ============================================
  // ELEMENTS
  // ============================================
  const searchInput = document.getElementById('transferSearchInput');
  const searchBtn = document.getElementById('transferSearchBtn');
  const searchingIndicator = document.getElementById('transferSearchingIndicator');
  const autocompleteDropdown = document.createElement('div');
  const userSelect = document.getElementById('transferUserSelect');
  const quantityField = document.getElementById('transferQuantityField');
  const quantityInput = document.getElementById('transferQuantity');
  const maxQuantitySpan = document.getElementById('transferMaxQuantity');
  const submitBtn = document.getElementById('transferSubmitBtn');
  const resetBtn = document.getElementById('transferResetBtn');
  const messageDiv = document.getElementById('transferMessage');
  const emptyState = document.getElementById('transferEmptyState');
  const loadingState = document.getElementById('transferLoadingState');
  const productDetails = document.getElementById('transferProductDetails');
  
  // NEW: Live preview elements
  const liveProductPreview = document.getElementById('liveProductPreview');
  const liveOwnerPreview = document.getElementById('liveOwnerPreview');
  
  // ============================================
  // STATE
  // ============================================
  let currentProduct = null;
  let autocompleteTimer = null;
  let currentRequest = null;
  let selectedIndex = -1;
  let autocompleteResults = [];
  let usersList = [];
  
  // ============================================
  // SETUP AUTOCOMPLETE DROPDOWN
  // ============================================
  autocompleteDropdown.id = 'transferAutocompleteDropdown';
  autocompleteDropdown.className = 'autocomplete-dropdown';
  autocompleteDropdown.style.cssText = `
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 350px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    display: none;
    margin-top: -1px;
  `;
  
  const searchContainer = searchInput.parentElement;
  searchContainer.style.position = 'relative';
  searchContainer.appendChild(autocompleteDropdown);

  // ============================================
  // LOAD USERS FOR DROPDOWN
  // ============================================
  function loadTransferUsers() {
    console.log('ðŸ“¥ Loading transfer users...');
    
    fetch('/inventory/transfer/users/', {
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        usersList = data.users;
        userSelect.innerHTML = '<option value="">Select receiving user</option>';
        
        data.users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = user.full_name;
          userSelect.appendChild(option);
        });
        
        console.log(`âœ… Loaded ${data.users.length} users`);
      } else {
        console.error('âŒ Failed to load users');
        showMessage('Failed to load users', 'danger');
      }
    })
    .catch(err => {
      console.error('âŒ Error loading users:', err);
      showMessage('Error loading users', 'danger');
    });
  }

  // ============================================
  // LIVE SEARCH - WITH PREVIEW
  // ============================================
  
  searchInput.addEventListener('input', function(e) {
    const searchTerm = e.target.value.trim();
    
    // Clear existing timer
    clearTimeout(autocompleteTimer);
    
    // Cancel any pending request
    if (currentRequest) {
      currentRequest.abort();
      currentRequest = null;
    }
    
    // Reset selection
    selectedIndex = -1;
    
    // Update live preview
    if (searchTerm.length >= 2) {
      updateLiveProductPreview('Searching...', 'info');
    } else {
      updateLiveProductPreview('', 'empty');
    }
    
    // Hide dropdown if input is too short
    if (searchTerm.length < 2) {
      hideAutocomplete();
      return;
    }
    
    // Show loading indicator
    searchingIndicator.style.display = 'inline-block';
    
    // Debounce the search (300ms delay)
    autocompleteTimer = setTimeout(() => {
      performLiveSearch(searchTerm);
    }, 300);
  });

  // Keyboard navigation for autocomplete
  searchInput.addEventListener('keydown', function(e) {
    if (autocompleteDropdown.style.display === 'none') return;
    
    const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
      updateAutocompleteSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, -1);
      updateAutocompleteSelection(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (selectedIndex >= 0 && items[selectedIndex]) {
        items[selectedIndex].click();
      } else {
        performFullSearch();
      }
    } else if (e.key === 'Escape') {
      hideAutocomplete();
    }
  });
  
  // User selection change - update owner preview
  userSelect.addEventListener('change', function() {
    updateLiveOwnerPreview();
  });
  
  // Quantity change - update preview
  quantityInput.addEventListener('input', function() {
    updateTransferPreview();
  });
  
  // Close autocomplete when clicking outside
  document.addEventListener('click', function(e) {
    if (!searchContainer.contains(e.target)) {
      hideAutocomplete();
    }
  });

  // ============================================
  // LIVE PREVIEW FUNCTIONS
  // ============================================
  
  function updateLiveProductPreview(text, type = 'info') {
    if (!liveProductPreview) return;
    
    let icon = 'ðŸ“¦';
    let className = 'text-muted';
    
    if (type === 'success') {
      icon = 'âœ…';
      className = 'text-success fw-bold';
    } else if (type === 'warning') {
      icon = 'âš ï¸';
      className = 'text-warning';
    } else if (type === 'error') {
      icon = 'âŒ';
      className = 'text-danger';
    } else if (type === 'info') {
      icon = 'ðŸ”';
      className = 'text-info';
    }
    
    liveProductPreview.innerHTML = text ? 
      `<span class="${className}">${icon} ${text}</span>` : 
      '<span class="text-muted">No product selected</span>';
  }
  
  function updateLiveOwnerPreview() {
    if (!liveOwnerPreview) return;
    
    const selectedUserId = userSelect.value;
    const selectedUser = usersList.find(u => u.id == selectedUserId);
    
    if (!currentProduct) {
      liveOwnerPreview.innerHTML = '<span class="text-muted">Select product first</span>';
      return;
    }
    
    if (!selectedUser) {
      liveOwnerPreview.innerHTML = '<span class="text-muted">Select new owner</span>';
      return;
    }
    
    const currentOwner = currentProduct.owner || 'FIELDMAX';
    
    liveOwnerPreview.innerHTML = `
      <div class="transfer-preview">
        <span class="text-muted">${currentOwner}</span>
        <i class="bi bi-arrow-right mx-2 text-primary"></i>
        <span class="text-success fw-bold">${selectedUser.full_name}</span>
      </div>
    `;
    
    updateTransferPreview();
  }
  
  function updateTransferPreview() {
    if (!currentProduct || !userSelect.value) return;
    
    const quantity = parseInt(quantityInput.value) || 1;
    const selectedUser = usersList.find(u => u.id == userSelect.value);
    
    if (!selectedUser) return;
    
    // Calculate remaining quantity after transfer
    let remaining = currentProduct.is_single_item ? 0 : currentProduct.current_quantity - quantity;
    
    // Update the transfer summary
    const summaryHtml = `
      <div class="alert alert-light border mt-3">
        <div class="row text-center">
          <div class="col-md-4">
            <div class="fw-bold text-primary">Transferring</div>
            <div class="fs-5">${quantity} ${currentProduct.is_single_item ? 'item' : 'units'}</div>
          </div>
          <div class="col-md-4">
            <div class="fw-bold text-success">To</div>
            <div class="fs-5">${selectedUser.full_name}</div>
          </div>
          <div class="col-md-4">
            <div class="fw-bold ${remaining === 0 ? 'text-warning' : 'text-muted'}">Remaining</div>
            <div class="fs-5">${remaining} units</div>
          </div>
        </div>
      </div>
    `;
    
    // Check if transfer summary div exists, if not create it
    let summaryDiv = document.getElementById('transferSummary');
    if (!summaryDiv) {
      summaryDiv = document.createElement('div');
      summaryDiv.id = 'transferSummary';
      productDetails.appendChild(summaryDiv);
    }
    
    summaryDiv.innerHTML = summaryHtml;
  }

  function performLiveSearch(searchTerm) {
    const controller = new AbortController();
    currentRequest = controller;
    
    const url = `/inventory/transfer/search/?search=${encodeURIComponent(searchTerm)}&autocomplete=true`;
    
    fetch(url, {
      headers: {'X-Requested-With': 'XMLHttpRequest'},
      signal: controller.signal
    })
    .then(res => res.json())
    .then(data => {
      currentRequest = null;
      searchingIndicator.style.display = 'none';
      
      if (data.success && data.suggestions) {
        autocompleteResults = data.suggestions;
        displayAutocomplete(data.suggestions, searchTerm);
        
        // Update live preview with match count
        updateLiveProductPreview(
          `${data.suggestions.length} product(s) found`, 
          'success'
        );
      } else {
        hideAutocomplete();
        updateLiveProductPreview('No matches found', 'warning');
      }
    })
    .catch(err => {
      if (err.name === 'AbortError') {
        console.log('Request cancelled');
      } else {
        console.error('Live search error:', err);
        searchingIndicator.style.display = 'none';
        updateLiveProductPreview('Search error', 'error');
      }
      currentRequest = null;
    });
  }

  function displayAutocomplete(suggestions, searchTerm) {
    if (suggestions.length === 0) {
      hideAutocomplete();
      return;
    }
    
    let html = '';
    
    suggestions.forEach((product, index) => {
      const ownerBadge = product.is_mine ? 
        '<span class="badge bg-success" style="font-size: 0.7rem;">Yours</span>' : 
        `<span class="badge bg-secondary" style="font-size: 0.7rem;">${product.owner}</span>`;
      
      const stockInfo = product.is_single_item ? 
        '<span class="text-muted" style="font-size: 0.8rem;">Single Item</span>' :
        `<span class="text-success" style="font-size: 0.8rem;"><strong>${product.current_quantity}</strong> units</span>`;
      
      const highlightedName = highlightMatch(product.name, searchTerm);
      const highlightedCode = highlightMatch(product.product_code, searchTerm);
      
      html += `
        <div class="autocomplete-item" data-product-id="${product.id}" style="
          padding: 12px 16px;
          cursor: pointer;
          border-bottom: 1px solid #f0f0f0;
          transition: all 0.2s ease;
        ">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #2c3e50; margin-bottom: 4px;">
                ${highlightedName}
              </div>
              <div style="font-size: 0.85rem; color: #7f8c8d;">
                Code: ${highlightedCode} | ${product.category}
              </div>
            </div>
            <div style="text-align: right; margin-left: 12px;">
              ${ownerBadge}
              <div style="margin-top: 4px;">
                ${stockInfo}
              </div>
            </div>
          </div>
        </div>
      `;
    });
    
    autocompleteDropdown.innerHTML = html;
    autocompleteDropdown.style.display = 'block';
    
    // Add click handlers
    const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
    items.forEach((item, index) => {
      item.addEventListener('click', function() {
        const productId = this.dataset.productId;
        selectProductFromAutocomplete(productId);
      });
      
      // Hover effect
      item.addEventListener('mouseenter', function() {
        items.forEach(i => i.style.backgroundColor = '');
        this.style.backgroundColor = '#f8f9fa';
        selectedIndex = index;
      });
      
      item.addEventListener('mouseleave', function() {
        this.style.backgroundColor = '';
      });
    });
  }

  function highlightMatch(text, searchTerm) {
    if (!searchTerm || !text) return text;
    
    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<strong style="background-color: #fff3cd; color: #856404;">$1</strong>');
  }

  function updateAutocompleteSelection(items) {
    items.forEach((item, index) => {
      if (index === selectedIndex) {
        item.style.backgroundColor = '#e3f2fd';
        item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      } else {
        item.style.backgroundColor = '';
      }
    });
  }

  function hideAutocomplete() {
    autocompleteDropdown.style.display = 'none';
    autocompleteDropdown.innerHTML = '';
    selectedIndex = -1;
    autocompleteResults = [];
  }

  function selectProductFromAutocomplete(productId) {
    hideAutocomplete();
    const selected = autocompleteResults.find(p => p.id == productId);
    if (selected) {
      searchInput.value = selected.product_code;
      updateLiveProductPreview(`Selected: ${selected.name}`, 'success');
    }
    performFullSearch();
  }

  // ============================================
  // FULL SEARCH (ON ENTER OR BUTTON CLICK)
  // ============================================
  searchBtn.addEventListener('click', performFullSearch);
  
  function performFullSearch() {
    const searchTerm = searchInput.value.trim();
    
    if (!searchTerm) {
      showMessage('Please enter a product code or SKU', 'danger');
      updateLiveProductPreview('Enter search term', 'warning');
      return;
    }
    
    hideAutocomplete();
    searchingIndicator.style.display = 'inline-block';
    emptyState.style.display = 'none';
    loadingState.style.display = 'block';
    productDetails.style.display = 'none';
    updateLiveProductPreview('Loading...', 'info');

    const url = `/inventory/transfer/search/?search=${encodeURIComponent(searchTerm)}`;

    fetch(url, {
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        if (data.multiple) {
          displayMultipleProducts(data.products);
          updateLiveProductPreview(`${data.products.length} products found`, 'success');
        } else if (data.product) {
          displayProductInfo(data.product);
          updateLiveProductPreview(`${data.product.name} (${data.product.product_code})`, 'success');
        }
      } else {
        showMessage(data.message, 'danger');
        showEmptyState();
        updateLiveProductPreview(data.message, 'error');
      }
    })
    .catch(err => {
      console.error('Search error:', err);
      showMessage('Search failed. Please try again.', 'danger');
      showEmptyState();
      updateLiveProductPreview('Search failed', 'error');
    })
    .finally(() => {
      searchingIndicator.style.display = 'none';
      loadingState.style.display = 'none';
    });
  }

  // ============================================
  // DISPLAY MULTIPLE PRODUCTS
  // ============================================
  function displayMultipleProducts(products) {
    let html = `
      <div class="alert alert-info" style="margin-bottom: 16px;">
        <i class="bi bi-info-circle"></i>
        <strong>Multiple Products Found (${products.length})</strong>
        <p class="mb-0 mt-2">Click on a product to select it for transfer:</p>
      </div>
    `;

    products.forEach(p => {
      const ownerBadge = p.is_mine ? 
        '<span class="badge bg-success">Your Product</span>' : 
        `<span class="badge bg-secondary">Owner: ${p.owner}</span>`;
      
      const clickable = p.is_mine || (typeof userIsAdmin !== 'undefined' && userIsAdmin);
      const cardStyle = clickable ? 
        'cursor: pointer; transition: all 0.2s ease;' : 
        'opacity: 0.6; cursor: not-allowed;';
      
      const cardClass = clickable ? 'product-card-selectable' : '';
      
      html += `
        <div class="card mb-2 ${cardClass}" ${clickable ? `onclick="selectTransferProduct(${p.id})"` : ''} style="${cardStyle}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div style="flex: 1;">
                <h6 class="mb-2">${p.name}</h6>
                <div class="text-muted" style="font-size: 0.9rem;">
                  <strong>Code:</strong> ${p.product_code} | 
                  <strong>Category:</strong> ${p.category} | 
                  ${p.is_single_item ? 
                    '<span class="badge bg-primary">Single Item</span>' : 
                    `<span class="badge bg-success">${p.current_quantity} units</span>`
                  }
                </div>
              </div>
              <div style="text-align: right;">
                ${ownerBadge}
              </div>
            </div>
          </div>
        </div>
      `;
    });

    productDetails.innerHTML = html;
    productDetails.style.display = 'block';
    emptyState.style.display = 'none';
    
    // Add hover effects
    document.querySelectorAll('.product-card-selectable').forEach(card => {
      card.addEventListener('mouseenter', function() {
        this.style.backgroundColor = '#f8f9fa';
        this.style.transform = 'translateX(4px)';
        this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
      });
      
      card.addEventListener('mouseleave', function() {
        this.style.backgroundColor = '';
        this.style.transform = '';
        this.style.boxShadow = '';
      });
    });
  }

  // Make function global
  window.selectTransferProduct = function(productId) {
    searchInput.value = productId;
    performFullSearch();
  };

  // ============================================
  // DISPLAY PRODUCT INFO
  // ============================================
  function displayProductInfo(product) {
    currentProduct = product;

    let ownerBadge;
    if (product.is_admin) {
      ownerBadge = product.is_mine ? 
        '<span class="badge bg-success">Your Product</span>' : 
        `<span class="badge bg-info">Owner: ${product.owner}</span>`;
    } else {
      ownerBadge = product.is_mine ? 
        '<span class="badge bg-success">Your Product</span>' : 
        `<span class="badge bg-warning text-dark">Owner: ${product.owner}</span>`;
    }

    const adminNote = product.is_admin && !product.is_mine ? 
      `<div class="alert alert-info mt-3">
        <i class="bi bi-shield-check"></i> 
        <strong>Admin Mode:</strong> You can transfer this product from ${product.owner} to another user.
      </div>` : '';

    let html = `
      <div class="alert ${product.is_single_item ? 'alert-info' : 'alert-success'}">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <h5 class="mb-0">
            ${product.is_single_item ? 'ðŸ“±' : 'ðŸ“¦'} ${product.name}
          </h5>
          ${ownerBadge}
        </div>
        
        <div class="product-info-card">
          <div class="product-info-item">
            <span class="product-info-label">Product Code</span>
            <span class="product-info-value">${product.product_code}</span>
          </div>
          
          <div class="product-info-item">
            <span class="product-info-label">SKU</span>
            <span class="product-info-value">${product.sku_value}</span>
          </div>
          
          <div class="product-info-item">
            <span class="product-info-label">Category</span>
            <span class="product-info-value">${product.category}</span>
          </div>
          
          <div class="product-info-item">
            <span class="product-info-label">Current Owner</span>
            <span class="product-info-value">
              <strong>${product.owner}</strong>
            </span>
          </div>
          
          <div class="product-info-item">
            <span class="product-info-label">Type</span>
            <span class="product-info-value">
              ${product.is_single_item ? 
                '<span class="badge bg-primary">Single Item</span>' : 
                '<span class="badge bg-success">Bulk Item</span>'}
            </span>
          </div>
          
          <div class="product-info-item">
            <span class="product-info-label">Available Quantity</span>
            <span class="product-info-value text-success">
              <strong>${product.current_quantity} ${product.is_single_item ? 'unit' : 'units'}</strong>
            </span>
          </div>
        </div>
        
        ${adminNote}
      </div>
    `;

    productDetails.innerHTML = html;
    productDetails.style.display = 'block';
    emptyState.style.display = 'none';

    // Enable form
    userSelect.disabled = false;
    submitBtn.disabled = false;

    // Handle quantity field
    if (product.is_single_item) {
      quantityField.style.display = 'none';
      quantityInput.value = 1;
    } else {
      quantityField.style.display = 'block';
      quantityInput.max = product.current_quantity;
      maxQuantitySpan.textContent = product.current_quantity;
      quantityInput.value = 1;
    }

    // Update live previews
    updateLiveOwnerPreview();
    userSelect.focus();
  }

  // ============================================
  // SUBMIT TRANSFER
  // ============================================
  submitBtn.addEventListener('click', function(e) {
    e.preventDefault();

    if (!currentProduct) {
      showMessage('Please search for a product first', 'danger');
      return;
    }

    const userId = userSelect.value;
    const quantity = parseInt(quantityInput.value);

    if (!userId) {
      showMessage('Please select a recipient', 'danger');
      userSelect.focus();
      return;
    }

    if (!currentProduct.is_single_item && (!quantity || quantity <= 0)) {
      showMessage('Please enter a valid quantity', 'danger');
      quantityInput.focus();
      return;
    }

    if (!currentProduct.is_single_item && quantity > currentProduct.current_quantity) {
      showMessage(`Only ${currentProduct.current_quantity} units available`, 'danger');
      return;
    }

    // Confirm transfer
    const recipientName = userSelect.options[userSelect.selectedIndex].text;
    const confirmMsg = `Transfer ${quantity} unit(s) of "${currentProduct.name}" to ${recipientName}?`;
    
    if (!confirm(confirmMsg)) return;

    // Submit
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

    const formData = new FormData();
    formData.append('product_id', currentProduct.id);
    formData.append('user_id', userId);
    formData.append('quantity', quantity);

    fetch('/inventory/transfer/process/', {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showMessage(data.message, 'success');
        
        // Update UI based on transfer type
        if (currentProduct.is_single_item || data.product.remaining_quantity === 0) {
          showMessage('Product transferred successfully. Redirecting...', 'success');
          updateLiveProductPreview('Transfer complete! âœ…', 'success');
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          // Partial transfer - update current product
          currentProduct.current_quantity = data.product.remaining_quantity;
          showMessage(data.message + ' You can transfer more or search for another product.', 'success');
          displayProductInfo(currentProduct);
          updateLiveProductPreview(`${currentProduct.name} - ${data.product.remaining_quantity} units remaining`, 'success');
        }
      } else {
        showMessage(data.message, 'danger');
        updateLiveProductPreview('Transfer failed', 'error');
      }
    })
    .catch(err => {
      console.error('Transfer error:', err);
      showMessage('Transfer failed. Please try again.', 'danger');
      updateLiveProductPreview('Transfer failed', 'error');
    })
    .finally(() => {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Confirm Transfer';
    });
  });

  // ============================================
  // RESET FORM
  // ============================================
  resetBtn.addEventListener('click', resetForm);

  function resetForm() {
    searchInput.value = '';
    userSelect.value = '';
    userSelect.disabled = true;
    quantityInput.value = 1;
    quantityField.style.display = 'none';
    submitBtn.disabled = true;
    currentProduct = null;
    messageDiv.innerHTML = '';
    hideAutocomplete();
    showEmptyState();
    
    // Reset live previews
    updateLiveProductPreview('', 'empty');
    if (liveOwnerPreview) {
      liveOwnerPreview.innerHTML = '<span class="text-muted">No transfer configured</span>';
    }
    
    // Remove transfer summary if exists
    const summaryDiv = document.getElementById('transferSummary');
    if (summaryDiv) {
      summaryDiv.remove();
    }
    
    searchInput.focus();
  }

  // ============================================
  // UTILITY FUNCTIONS
  // ============================================
  function showEmptyState() {
    emptyState.style.display = 'block';
    productDetails.style.display = 'none';
    loadingState.style.display = 'none';
  }

  function showMessage(msg, type = 'info') {
    const alertClass = type === 'danger' ? 'alert-danger' : 
                       type === 'success' ? 'alert-success' : 'alert-info';
    
    const icon = type === 'danger' ? 'bi-exclamation-triangle' :
                 type === 'success' ? 'bi-check-circle' : 'bi-info-circle';
    
    messageDiv.innerHTML = `
      <div class="alert ${alertClass} alert-dismissible fade show">
        <i class="bi ${icon}"></i>
        ${msg}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
    
    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    // Auto-dismiss success messages after 5 seconds
    if (type === 'success') {
      setTimeout(() => {
        const alert = messageDiv.querySelector('.alert');
        if (alert) {
          alert.classList.remove('show');
          setTimeout(() => messageDiv.innerHTML = '', 150);
        }
      }, 5000);
    }
  }

  // ============================================
  // INITIALIZE
  // ============================================
  loadTransferUsers();
  searchInput.focus();
  
  // Initialize live previews
  updateLiveProductPreview('Enter product code to search', 'info');
  if (liveOwnerPreview) {
    liveOwnerPreview.innerHTML = '<span class="text-muted">No transfer configured</span>';
  }
  
  console.log('âœ… Enhanced Transfer Product Module Ready with Live Previews');
});











// =====================================
// BUTTON CLICK HANDLERS FOR ROW ACTIONS
// ======================================
function editProduct(btn) {
    const id = btn.dataset.id;
    const name = btn.dataset.name;
    const row = document.getElementById(`product-row-${id}`);
    const buy = row.querySelector(".product-buying-price").innerText.replace("KSH", "").trim();
    const sell = row.querySelector(".product-selling-price").innerText.replace("KSH", "").trim();
    const qty = row.querySelector(".product-quantity").innerText.trim();
    openEditModal(id, name, buy, sell, qty);
}

function deleteProduct(btn) {
    openDeleteModal(btn.dataset.id, btn.dataset.name);
}

function transferProduct(btn) {
    const id = btn.dataset.id;
    const row = document.getElementById(`product-row-${id}`);
    const qty = parseInt(row.querySelector(".product-quantity").innerText);
    const isSKU = qty === 1;
    openTransferModal(id, isSKU);
}










// ================================
// GENERATE REPORT SECTION
// ================================
document.addEventListener("DOMContentLoaded", function () {

  // --- DOM Elements ---
  const sellerSelect = document.getElementById("seller");
  const categorySelect = document.getElementById("category");
  const startDateInput = document.getElementById("startDate");
  const endDateInput = document.getElementById("endDate");
  const generateBtn = document.getElementById("generateReportBtn");
  const exportBtn = document.getElementById("exportReportBtn");
  const emptyState = document.getElementById("reportEmptyState");
  const reportResults = document.getElementById("reportResults");
  const reportTableBody = document.getElementById("reportTableBody");
  const reportTotal = document.getElementById("reportTotal");

  let currentReportData = [];

  // --- Initialize Sellers & Categories ---
  function loadFilterOptions() {
    // Fetch sellers
    fetch("/sales/api/get-sellers/")
      .then(res => res.json())
      .then(data => {
        data.sellers.forEach(seller => {
          const opt = document.createElement("option");
          opt.value = seller.id;
          opt.textContent = seller.username;
          sellerSelect.appendChild(opt);
        });
      });

    // Fetch categories
    fetch("/inventory/api/get-categories/")
      .then(res => res.json())
      .then(data => {
        data.categories.forEach(cat => {
          const opt = document.createElement("option");
          opt.value = cat.id;
          opt.textContent = cat.name;
          categorySelect.appendChild(opt);
        });
      });
  }

  loadFilterOptions();

  // --- Generate Report ---
  generateBtn.addEventListener("click", function () {
    const seller = sellerSelect.value;
    const category = categorySelect.value;
    const start = startDateInput.value;
    const end = endDateInput.value;

    fetch(`/sales/api/reports/?seller=${seller}&category=${category}&start=${start}&end=${end}`)
      .then(res => res.json())
      .then(data => {
        currentReportData = data.results || [];
        renderReport(currentReportData);
      })
      .catch(err => {
        console.error("Error fetching report:", err);
        alert("Failed to fetch report. Please try again.");
      });
  });

  // --- Render Report Table ---
  function renderReport(data) {
    reportTableBody.innerHTML = "";
    let total = 0;

    if (!data || data.length === 0) {
      emptyState.style.display = "block";
      reportResults.style.display = "none";
      exportBtn.disabled = true;
      reportTotal.textContent = "0.00";
      return;
    }

    emptyState.style.display = "none";
    reportResults.style.display = "block";

    data.forEach(row => {
      total += parseFloat(row.total || 0);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.date}</td>
        <td>${row.seller}</td>
        <td>${row.category}</td>
        <td>${row.product}</td>
        <td>${row.quantity}</td>
        <td>${parseFloat(row.total).toFixed(2)}</td>
      `;
      reportTableBody.appendChild(tr);
    });

    reportTotal.textContent = total.toFixed(2);
    exportBtn.disabled = false;
  }

  // --- Export Report as CSV ---
  exportBtn.addEventListener("click", function () {
    if (!currentReportData.length) return;

    let csvContent = "Date,Seller,Category,Product,Quantity,Total\n";
    currentReportData.forEach(row => {
      csvContent += `${row.date},${row.seller},${row.category},${row.product},${row.quantity},${row.total}\n`;
    });

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `sales_report_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });

});











// ================================
// LIVE PRODUCT TABLE UI
// ================================

function updateProductRow(product) {
    const row = document.querySelector(`#product-row-${product.id}`);
    if (!row) return;

    /* ---------------------------
       Update dataset attributes
       --------------------------- */
    row.dataset.stockStatus = product.status;
    row.dataset.category = product.category_id;
    row.dataset.type = product.is_single ? "single" : "bulk";

    /* ---------------------------
       Update PRODUCT NAME
       --------------------------- */
    row.querySelector(".product-name").innerHTML = `<strong>${product.name}</strong>`;

    /* ---------------------------
       Update BUYING PRICE
       --------------------------- */
    row.querySelector(".product-buying-price").innerHTML =
        `<strong style="color:#10b981;">KSH ${Number(product.buying_price).toFixed(2)}</strong>`;

    /* ---------------------------
       Update SELLING PRICE
       --------------------------- */
    row.querySelector(".product-selling-price").innerHTML =
        `<strong style="color:#10b981;">KSH ${Number(product.selling_price).toFixed(2)}</strong>`;

    /* ---------------------------
       STATUS BADGE
       --------------------------- */
    let statusHtml = "";

    if (product.is_single) {
        if (product.status === "sold") {
            statusHtml = `
                <span class="badge badge-danger">
                    <i class="bi bi-x-circle-fill"></i> Sold Out
                </span>`;
        } else {
            statusHtml = `
                <span class="badge badge-success">
                    <i class="bi bi-check-circle-fill"></i> In Stock
                </span>`;
        }
    } else {
        if (product.quantity === 0) {
            statusHtml = `
                <span class="badge badge-danger">
                    <i class="bi bi-x-circle-fill"></i> Out of Stock
                </span>`;
        } else if (product.quantity <= 5) {
            statusHtml = `
                <span class="badge badge-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i> Low Stock
                </span>`;
        } else {
            statusHtml = `
                <span class="badge badge-success">
                    <i class="bi bi-check-circle-fill"></i> In Stock
                </span>`;
        }
    }

    row.querySelector("td:nth-child(5)").innerHTML = statusHtml;

    /* ---------------------------
       STOCK COLUMN
       --------------------------- */
    let stockHtml = "";

    if (product.is_single) {
        if (product.status === "sold") {
            stockHtml = `
                <strong style="color:#dc3545;font-weight:bold;">
                    <i class="bi bi-x-circle-fill"></i> SOLD
                </strong>`;
        } else {
            stockHtml = `
                <strong style="color:#28a745;font-weight:bold;">
                    <i class="bi bi-check-circle-fill"></i> Available
                </strong>`;
        }
    } else {
        if (product.quantity === 0) {
            stockHtml = `
                <strong style="color:#dc3545;font-weight:bold;">
                    0 units (Out)
                </strong>`;
        } else if (product.quantity <= 5) {
            stockHtml = `
                <strong style="color:#ffc107;font-weight:bold;">
                    ${product.quantity} units (Low)
                </strong>`;
        } else {
            stockHtml = `
                <strong style="color:#28a745;font-weight:bold;">
                    ${product.quantity} units
                </strong>`;
        }
    }

    row.querySelector(".product-quantity").innerHTML = stockHtml;

    /* ---------------------------
       MARGIN BADGE
       --------------------------- */
    const marginCell = row.querySelector("td:nth-child(9)");
    const marginPct = Number(product.margin_percentage);

    let marginClass = "margin-low";
    if (marginPct >= 30) marginClass = "margin-high";
    else if (marginPct >= 15) marginClass = "margin-medium";

    marginCell.innerHTML = `
        <span class="badge ${marginClass}">
            +${marginPct.toFixed(0)}%
        </span>
    `;

    /* ---------------------------
       Update OWNER
       --------------------------- */
    row.querySelector(".product-owner span").textContent = product.owner;

    /* ---------------------------
       Update summary counters
       --------------------------- */
    refreshInventoryCounters();
}

/* ======================================================
   UPDATE INVENTORY STATISTICS COUNTERS
   ====================================================== */
function refreshInventoryCounters() {
    const rows = document.querySelectorAll(".product-row");

    let total = 0, instock = 0, lowstock = 0, outofstock = 0;

    rows.forEach(row => {
        total++;

        const status = row.dataset.stockStatus;
        const qtyCell = row.querySelector(".product-quantity").innerText;

        if (qtyCell.includes("Out")) outofstock++;
        else if (qtyCell.includes("Low")) lowstock++;
        else instock++;
    });

    document.getElementById("totalProductsCount").innerText = total;
    document.getElementById("inStockCount").innerText = instock;
    document.getElementById("lowStockCount").innerText = lowstock;
    document.getElementById("outOfStockCount").innerText = outofstock;
}

/* ======================================================
   CALL THIS AFTER SALE OR REVERSAL API RESPONDS
   ====================================================== */
/*
fetch('/reverse-sale/12/', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        updateProductRow(data.product);
    });
*/





// ========================= FILTER LOGIC ========================= //

function filterProducts() {
    const statusFilter = document.getElementById("productStatusFilter").value;
    const categoryFilter = document.getElementById("productCategoryFilter").value;
    const typeFilter = document.getElementById("productTypeFilter").value;

    const rows = document.querySelectorAll("#productsTable tbody .product-row");

    rows.forEach(row => {
        const rowStatus = row.dataset.stockStatus;       // instock | lowstock | outofstock | sold
        const rowCategory = row.dataset.category;        // category id
        const rowType = row.dataset.type;                // single | bulk

        let visible = true;

        // ----- STATUS FILTER -----
        if (statusFilter !== "all") {
            if (statusFilter === "instock" && rowStatus !== "instock") visible = false;
            else if (statusFilter === "lowstock" && rowStatus !== "lowstock") visible = false;
            else if (statusFilter === "outofstock") {
                if (rowStatus !== "outofstock" && rowStatus !== "sold") visible = false;
            }
        }

        // ----- CATEGORY FILTER -----
        if (categoryFilter !== "all" && rowCategory !== categoryFilter) {
            visible = false;
        }

        // ----- TYPE FILTER -----
        if (typeFilter !== "all" && rowType !== typeFilter) {
            visible = false;
        }

        // Show / Hide row
        row.style.display = visible ? "" : "none";
    });

    // After filtering, update stats
    updateProductStats();
}



// ========================= STAT REFRESH ========================= //

function updateProductStats() {
    const rows = document.querySelectorAll("#productsTable tbody .product-row");

    let total = 0;
    let instock = 0;
    let low = 0;
    let out = 0;

    rows.forEach(row => {
        if (row.style.display === "none") return; // Skip hidden rows

        total++;

        const status = row.dataset.stockStatus;

        if (status === "instock") instock++;
        else if (status === "lowstock") low++;
        else if (status === "outofstock" || status === "sold") out++;
    });

    document.getElementById("totalProductsCount").textContent = total;
    document.getElementById("inStockCount").textContent = instock;
    document.getElementById("lowStockCount").textContent = low;
    document.getElementById("outOfStockCount").textContent = out;
}



// ========================= AUTO-RUN ON LOAD ========================= //
document.addEventListener("DOMContentLoaded", filterProducts);







/* ============================================================
   GLOBAL CONFIG
   ============================================================ */

let currentPage = 1;
const rowsPerPage = 15;  // Adjust if needed

// Cache selectors
const table = document.getElementById("productsTable");
const tbody = table.querySelector("tbody");
const rows = Array.from(tbody.querySelectorAll(".product-row"));



/* ============================================================
   SAVE / LOAD FILTER STATE
   ============================================================ */

function saveFilterState() {
    localStorage.setItem("productFilters", JSON.stringify({
        status: document.getElementById("productStatusFilter").value,
        category: document.getElementById("productCategoryFilter").value,
        type: document.getElementById("productTypeFilter").value,
        search: document.getElementById("productSearchInput")?.value || ""
    }));
}

function loadFilterState() {
    const state = JSON.parse(localStorage.getItem("productFilters") || "{}");

    if (state.status) document.getElementById("productStatusFilter").value = state.status;
    if (state.category) document.getElementById("productCategoryFilter").value = state.category;
    if (state.type) document.getElementById("productTypeFilter").value = state.type;

    if (state.search && document.getElementById("productSearchInput")) {
        document.getElementById("productSearchInput").value = state.search;
    }
}






/* ============================================================
   FILTERING SYSTEM (same from previous message, extended)
   ============================================================ */

function filterProducts() {
    const statusFilter = document.getElementById("productStatusFilter").value;
    const categoryFilter = document.getElementById("productCategoryFilter").value;
    const typeFilter = document.getElementById("productTypeFilter").value;
    const searchTerm = (document.getElementById("productSearchInput")?.value || "").toLowerCase();

    // âœ… define rows here
    const rows = document.querySelectorAll(".product-row");

    rows.forEach(row => {
        const rowStatus = row.dataset.stockStatus;
        const rowCategory = row.dataset.category;
        const rowType = row.dataset.type;
        const rowName = row.querySelector(".product-name").innerText.toLowerCase();
        const rowCode = row.querySelector("code").innerText.toLowerCase();

        let visible = true;

        if (statusFilter !== "all") {
            if (statusFilter === "instock" && rowStatus !== "instock") visible = false;
            else if (statusFilter === "lowstock" && rowStatus !== "lowstock") visible = false;
            else if (statusFilter === "outofstock") {
                if (rowStatus !== "outofstock" && rowStatus !== "sold") visible = false;
            }
        }

        if (categoryFilter !== "all" && rowCategory !== categoryFilter) visible = false;

        if (typeFilter !== "all" && rowType !== typeFilter) visible = false;

        if (searchTerm && !rowName.includes(searchTerm) && !rowCode.includes(searchTerm)) {
            visible = false;
        }

        row.style.display = visible ? "" : "none";
    });

    if (typeof saveFilterState === "function") saveFilterState();
    if (typeof updateProductStats === "function") updateProductStats();
    if (typeof paginateRows === "function") paginateRows();
}











/* ============================================================
    SEARCH BUTTON AND ENTRIES
   ============================================================ */

// Search functionality
function searchProducts() {
  applyAllFilters();
}

// Entries selection functionality
function changeEntries() {
  applyAllFilters();
}

// Master filter function that applies all filters together
function applyAllFilters() {
  const searchTerm = document.getElementById('productSearch').value.toLowerCase();
  const entriesValue = document.getElementById('entriesSelect').value;
  const statusFilter = document.getElementById('productStatusFilter').value;
  const categoryFilter = document.getElementById('productCategoryFilter').value;
  const typeFilter = document.getElementById('productTypeFilter').value;
  
  const rows = document.querySelectorAll('.product-row');
  let visibleCount = 0;
  const limit = entriesValue === 'all' ? Infinity : parseInt(entriesValue);
  
  rows.forEach(row => {
    // Skip rows without data-product-id (empty state rows)
    if (!row.dataset.productId) {
      row.style.display = 'none';
      return;
    }
    
    // Check search filter
    const matchesSearch = searchTerm === '' || row.textContent.toLowerCase().includes(searchTerm);
    
    // Check status filter
    const stockStatus = row.dataset.stockStatus;
    const matchesStatus = statusFilter === 'all' || stockStatus === statusFilter;
    
    // Check category filter
    const category = row.dataset.category;
    const matchesCategory = categoryFilter === 'all' || category === categoryFilter;
    
    // Check type filter
    const type = row.dataset.type;
    const matchesType = typeFilter === 'all' || type === typeFilter;
    
    // Check entries limit
    const withinLimit = visibleCount < limit;
    
    // Show row only if it passes ALL filters AND is within the entries limit
    if (matchesSearch && matchesStatus && matchesCategory && matchesType && withinLimit) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });
}

// Update the filterProducts function to use the master filter
function filterProducts() {
  applyAllFilters();
}












/* ============================================================
   LIVE SEARCH
   ============================================================ */

function setupSearchBox() {
    if (!document.getElementById("productSearchInput")) {

        // Insert search bar dynamically
        const header = document.querySelector(".content-header div");
        const searchInput = document.createElement("input");
        searchInput.id = "productSearchInput";
        searchInput.className = "form-control";
        searchInput.placeholder = "Search by code or name...";
        searchInput.style.width = "250px";
        searchInput.onkeyup = filterProducts;

        header.prepend(searchInput);  
    }
}



/* ============================================================
   COLUMN SORTING
   ============================================================ */

let sortDirection = 1;

function sortTable(columnIndex) {
    const sorted = rows.sort((a, b) => {
        const A = a.children[columnIndex].innerText.trim().toLowerCase();
        const B = b.children[columnIndex].innerText.trim().toLowerCase();

        if (!isNaN(A) && !isNaN(B)) {
            return (parseFloat(A) - parseFloat(B)) * sortDirection;
        }
        return A.localeCompare(B) * sortDirection;
    });

    sortDirection *= -1; // toggle

    tbody.innerHTML = "";
    sorted.forEach(r => tbody.appendChild(r));

    paginateRows();
}

function enableColumnSorting() {
    const headers = table.querySelectorAll("thead th");
    headers.forEach((th, i) => {
        th.style.cursor = "pointer";
        th.addEventListener("click", () => sortTable(i));
    });
}



/* ============================================================
   PAGINATION
   ============================================================ */

function paginateRows() {
    const visibleRows = rows.filter(r => r.style.display !== "none");

    const total = visibleRows.length;
    const totalPages = Math.ceil(total / rowsPerPage);

    visibleRows.forEach((row, index) => {
        row.style.display =
            index >= (currentPage - 1) * rowsPerPage &&
            index < currentPage * rowsPerPage
            ? ""
            : "none";
    });

    renderPaginationControls(totalPages);
}

function renderPaginationControls(totalPages) {
    let container = document.getElementById("paginationControls");

    if (!container) {
        container = document.createElement("div");
        container.id = "paginationControls";
        container.style.marginTop = "10px";
        container.style.display = "flex";
        container.style.gap = "10px";
        document.querySelector("#product-list").appendChild(container);
    }

    container.innerHTML = "";

    const prev = document.createElement("button");
    prev.innerText = "Previous";
    prev.className = "btn btn-secondary";
    prev.disabled = currentPage === 1;
    prev.onclick = () => {
        currentPage--;
        paginateRows();
    };

    const next = document.createElement("button");
    next.innerText = "Next";
    next.className = "btn btn-secondary";
    next.disabled = currentPage === totalPages;
    next.onclick = () => {
        currentPage++;
        paginateRows();
    };

    container.appendChild(prev);
    container.appendChild(next);
}



/* ============================================================
   HIDE / SHOW COLUMNS
   ============================================================ */

function toggleColumn(index) {
    const rowsAll = table.querySelectorAll("tr");
    rowsAll.forEach(row => {
        const cell = row.children[index];
        if (cell) {
            cell.style.display = cell.style.display === "none" ? "" : "none";
        }
    });
}

function initColumnHider() {
    const controls = document.createElement("div");
    controls.style.margin = "10px 0";

    const headers = table.querySelectorAll("thead th");

    headers.forEach((th, i) => {
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = true;
        cb.onchange = () => toggleColumn(i);

        const label = document.createElement("label");
        label.style.marginRight = "10px";
        label.appendChild(cb);
        label.appendChild(document.createTextNode(" " + th.innerText));

        controls.appendChild(label);
    });

    document.querySelector("#product-list").prepend(controls);
}



/* ============================================================
   EXPORT TO EXCEL
   ============================================================ */

function exportTableToExcel() {
    let csv = [];

    const trs = table.querySelectorAll("tr");
    trs.forEach(tr => {
        if (tr.style.display === "none") return; // skip hidden

        const cells = Array.from(tr.children).map(td => '"' + td.innerText.replace(/"/g, '""') + '"');
        csv.push(cells.join(","));
    });

    const blob = new Blob([csv.join("\n")], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "products_export.csv";
    a.click();
}



/* ============================================================
   INITIALIZE ALL SYSTEMS
   ============================================================ */

document.addEventListener("DOMContentLoaded", () => {
    setupSearchBox();
    enableColumnSorting();
    initColumnHider();
    loadFilterState();
    filterProducts();  // automatically triggers pagination
});

/* DRAG-TO-REORDER COLUMNS */
(function(){
  const tableEl = document.getElementById('productsTable');
  const storageKey = 'productsTableColOrder';

  function getHeaderCells() {
    return Array.from(tableEl.querySelectorAll('thead th'));
  }

  function saveOrder() {
    const order = getHeaderCells().map(th => th.innerText.trim());
    localStorage.setItem(storageKey, JSON.stringify(order));
  }

  function applySavedOrder() {
    const saved = JSON.parse(localStorage.getItem(storageKey) || 'null');
    if (!saved) return;
    const headers = getHeaderCells();
    const current = headers.map(h => h.innerText.trim());
    // Build mapping index -> current index of saved label
    const newIndexOrder = saved.map(label => current.indexOf(label)).filter(i => i >= 0);

    // Reorder head
    const theadRow = tableEl.querySelector('thead tr');
    newIndexOrder.forEach(idx => theadRow.appendChild(headers[idx]));

    // Reorder each body row accordingly
    const bodyRows = tableEl.querySelectorAll('tbody tr');
    bodyRows.forEach(r => {
      const cells = Array.from(r.children);
      newIndexOrder.forEach(idx => r.appendChild(cells[idx]));
    });
  }

  function enableDrag() {
    const headers = getHeaderCells();
    headers.forEach(th => {
      th.classList.add('draggable');
      th.draggable = true;
      th.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', th.innerText.trim());
        th.classList.add('dragging');
      });
      th.addEventListener('dragend', () => th.classList.remove('dragging'));
      th.addEventListener('dragover', e => e.preventDefault());
      th.addEventListener('drop', e => {
        e.preventDefault();
        const label = e.dataTransfer.getData('text/plain');
        const dragged = Array.from(headers).find(h => h.innerText.trim() === label);
        if (!dragged) return;
        // insert before target
        const target = e.currentTarget;
        if (dragged !== target) {
          target.parentNode.insertBefore(dragged, target);
          // apply same reordering to all rows
          const newOrder = Array.from(tableEl.querySelectorAll('thead th')).map(h => h.innerText.trim());
          const currentCells = Array.from(tableEl.querySelectorAll('thead th')).map(h => h.innerText.trim());
          // find new indices
          const indices = newOrder.map(lbl => currentCells.indexOf(lbl));
          const bodyRows = tableEl.querySelectorAll('tbody tr');
          bodyRows.forEach(row => {
            const cells = Array.from(row.children);
            indices.forEach(i => row.appendChild(cells[i]));
          });
          saveOrder();
        }
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    applySavedOrder();
    enableDrag();
  });
})();


</script>


{% endblock %}