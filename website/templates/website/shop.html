{% extends 'website/base.html' %}
{% load static %}
{% load cloudinary %}

{% block title %}Shop - Fieldmax{% endblock %}

{% block content %}

<style>
  :root {
    --primary: #0dcaf0;
    --primary-dark: #0ab4d6;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-900: #111827;
  }

  .shop-hero {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    padding: 4rem 0 3rem;
    position: relative;
    overflow: hidden;
  }

  .shop-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.4;
  }

  .shop-hero-content {
    position: relative;
    z-index: 1;
  }

  .shop-hero h1 {
    color: #ffffff;
    font-weight: 800;
    font-size: 3rem;
    margin-bottom: 1rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    letter-spacing: -0.5px;
  }

  .shop-hero p {
    color: rgba(255, 255, 255, 0.95);
    font-size: 1.25rem;
    font-weight: 500;
  }

  .shop-stats {
    display: flex;
    gap: 2rem;
    justify-content: center;
    margin-top: 2rem;
    flex-wrap: wrap;
  }

  .stat-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1.5rem;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .stat-icon {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
  }

  .stat-content h3 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    color: #ffffff;
  }

  .stat-content p {
    font-size: 0.875rem;
    margin: 0;
    color: rgba(255, 255, 255, 0.9);
  }

  .controls-section {
    background: #ffffff;
    padding: 1.5rem;
    border-radius: 1rem;
    margin: -2rem auto 2rem;
    max-width: 1400px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    position: relative;
    z-index: 10;
  }

  .search-bar-container {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .search-input-wrapper {
    flex: 1;
    min-width: 250px;
    position: relative;
  }

  .search-input {
    width: 100%;
    padding: 0.875rem 1rem 0.875rem 3rem;
    border: 2px solid var(--gray-200);
    border-radius: 0.75rem;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(13, 202, 240, 0.1);
  }

  .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-600);
    font-size: 1.25rem;
  }

  .view-toggle {
    display: flex;
    gap: 0.5rem;
    background: var(--gray-100);
    padding: 0.25rem;
    border-radius: 0.75rem;
  }

  .view-btn {
    padding: 0.625rem 1rem;
    border: none;
    background: transparent;
    color: var(--gray-600);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .view-btn.active {
    background: #ffffff;
    color: var(--primary);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .filters-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-group {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .filter-label {
    font-weight: 600;
    color: var(--gray-700);
    display: flex;
    align-items: center;
    margin-right: 0.5rem;
    white-space: nowrap;
  }

  .filter-chip {
    padding: 0.5rem 1rem;
    border: 2px solid var(--gray-200);
    background: #ffffff;
    color: var(--gray-700);
    border-radius: 2rem;
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .filter-chip:hover {
    border-color: var(--primary);
    color: var(--primary);
  }

  .filter-chip.active {
    background: var(--primary);
    border-color: var(--primary);
    color: #ffffff;
  }

  .sort-select {
    padding: 0.625rem 1rem;
    border: 2px solid var(--gray-200);
    border-radius: 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .sort-select:focus {
    outline: none;
    border-color: var(--primary);
  }

  .category-section {
    margin-bottom: 4rem;
  }

  .category-header {
    background: linear-gradient(135deg, var(--gray-50) 0%, #ffffff 100%);
    padding: 2rem;
    border-radius: 1rem;
    margin-bottom: 2rem;
    border-left: 5px solid var(--primary);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .category-title-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .category-title {
    font-size: 2rem;
    font-weight: 800;
    color: var(--gray-900);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .category-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ffffff;
    font-size: 1.5rem;
  }

  .category-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1.25rem;
    background: var(--primary);
    color: #ffffff;
    border-radius: 2rem;
    font-size: 0.875rem;
    font-weight: 700;
  }

  .category-meta {
    display: flex;
    gap: 2rem;
    margin-top: 1rem;
    flex-wrap: wrap;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--gray-600);
    font-size: 0.95rem;
  }

  .meta-item i {
    color: var(--primary);
  }

  .products-grid {
    display: grid;
    gap: 1.5rem;
    transition: all 0.3s ease;
  }

  .products-grid.grid-view {
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  }

  .products-grid.list-view {
    grid-template-columns: 1fr;
  }

  .product-card {
    background: #ffffff;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    display: flex;
    height: 100%;
    position: relative;
  }

  .products-grid.grid-view .product-card {
    flex-direction: column;
  }

  .products-grid.list-view .product-card {
    flex-direction: row;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.15);
  }

  .product-image-wrapper {
    position: relative;
    background: var(--gray-100);
    overflow: hidden;
  }

  .products-grid.grid-view .product-image-wrapper {
    width: 100%;
    padding-top: 75%;
  }

  .products-grid.list-view .product-image-wrapper {
    width: 250px;
    min-height: 200px;
    flex-shrink: 0;
  }

  .product-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .product-card:hover .product-image {
    transform: scale(1.1);
  }

  .no-image-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-50) 100%);
    color: var(--gray-300);
  }

  .no-image-placeholder i {
    font-size: 4rem;
    margin-bottom: 0.5rem;
  }

  .no-image-placeholder span {
    font-size: 0.875rem;
    color: var(--gray-600);
  }

  .product-badges {
    position: absolute;
    top: 1rem;
    left: 1rem;
    right: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    z-index: 2;
  }

  .badge-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .product-badge {
    padding: 0.375rem 0.875rem;
    border-radius: 2rem;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
  }

  .status-badge {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .status-badge::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
  }

  .status-available {
    background: linear-gradient(135deg, var(--success), #059669);
    color: #ffffff;
  }

  .status-lowstock {
    background: linear-gradient(135deg, var(--warning), #d97706);
    color: #ffffff;
  }

  .status-outofstock,
  .status-sold {
    background: linear-gradient(135deg, var(--danger), #dc2626);
    color: #ffffff;
  }

  .item-type-badge {
    background: rgba(255, 255, 255, 0.95);
    color: var(--gray-700);
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .product-info {
    padding: 1.5rem;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .product-header {
    margin-bottom: 1rem;
  }

  .product-code {
    font-size: 0.75rem;
    color: var(--gray-600);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .product-code i {
    color: var(--primary);
  }

  .product-name {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: 0.75rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .product-details {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .detail-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
  }

  .detail-icon {
    width: 32px;
    height: 32px;
    background: var(--gray-100);
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
  }

  .detail-content {
    flex: 1;
  }

  .detail-label {
    font-size: 0.75rem;
    color: var(--gray-600);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .detail-value {
    font-weight: 600;
    color: var(--gray-900);
  }

  .product-footer {
    margin-top: auto;
    padding-top: 1.5rem;
    border-top: 2px solid var(--gray-100);
  }

  .price-section {
    margin-bottom: 1rem;
  }

  .price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .product-price {
    font-size: 2rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .price-label {
    font-size: 0.75rem;
    color: var(--gray-600);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .profit-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    background: var(--success);
    color: #ffffff;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 700;
  }

  .stock-indicator {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--gray-50);
    border-radius: 0.5rem;
    margin-bottom: 1rem;
  }

  .stock-icon {
    width: 36px;
    height: 36px;
    background: var(--primary);
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ffffff;
  }

  .stock-text {
    flex: 1;
  }

  .stock-text strong {
    display: block;
    font-size: 1.125rem;
    color: var(--gray-900);
  }

  .stock-text span {
    font-size: 0.75rem;
    color: var(--gray-600);
  }

  .action-buttons {
    display: flex;
    gap: 0.75rem;
  }

  .btn-primary {
    flex: 1;
    padding: 0.875rem;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: #ffffff;
    border: none;
    border-radius: 0.75rem;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(13, 202, 240, 0.3);
  }

  .btn-primary:disabled {
    background: var(--gray-200);
    color: var(--gray-600);
    cursor: not-allowed;
    transform: none;
  }

  .btn-icon {
    width: 2.75rem;
    height: 2.75rem;
    background: var(--gray-100);
    color: var(--gray-700);
    border: 2px solid var(--gray-200);
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-icon:hover {
    background: var(--primary);
    color: #ffffff;
    border-color: var(--primary);
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--gray-50);
    border-radius: 1rem;
    margin: 2rem 0;
  }

  .empty-icon {
    width: 120px;
    height: 120px;
    margin: 0 auto 1.5rem;
    background: linear-gradient(135deg, var(--gray-200), var(--gray-100));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4rem;
    color: var(--gray-300);
  }

  .empty-state h3 {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: 0.75rem;
  }

  .empty-state p {
    font-size: 1.125rem;
    color: var(--gray-600);
    max-width: 500px;
    margin: 0 auto;
  }

  @media (max-width: 992px) {
    .shop-hero h1 {
      font-size: 2.5rem;
    }

    .category-title {
      font-size: 1.75rem;
    }

    .products-grid.grid-view {
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
  }

  @media (max-width: 768px) {
    .shop-hero {
      padding: 3rem 0 2rem;
    }

    .shop-hero h1 {
      font-size: 2rem;
    }

    .controls-section {
      margin: -1.5rem auto 1.5rem;
    }

    .products-grid.list-view .product-card {
      flex-direction: column;
    }

    .products-grid.list-view .product-image-wrapper {
      width: 100%;
      padding-top: 75%;
      min-height: auto;
    }

    .view-toggle {
      width: 100%;
    }

    .view-btn {
      flex: 1;
      justify-content: center;
    }
  }

  @media (max-width: 576px) {
    .shop-hero h1 {
      font-size: 1.75rem;
    }

    .shop-stats {
      gap: 1rem;
    }

    .stat-item {
      padding: 0.5rem 1rem;
    }

    .products-grid.grid-view {
      grid-template-columns: 1fr;
    }

    .category-title {
      font-size: 1.5rem;
    }

    .filters-row {
      flex-direction: column;
      align-items: stretch;
    }

    .filter-group {
      width: 100%;
    }

    .filter-chip {
      flex: 1;
      text-align: center;
    }
  }
</style>

<!-- Hero Section -->
<section class="shop-hero">
  <div class="container-fluid px-4 shop-hero-content">
    <h1 class="text-center">Premium Shop Collection</h1>
    <p class="text-center">Discover quality products at unbeatable prices</p>
    
    <div class="shop-stats">
      <div class="stat-item">
        <div class="stat-icon">
          <i class="bi bi-box-seam"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalProducts">0</h3>
          <p>Products</p>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">
          <i class="bi bi-check-circle"></i>
        </div>
        <div class="stat-content">
          <h3 id="availableProducts">0</h3>
          <p>Available</p>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">
          <i class="bi bi-grid-3x3"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalCategories">0</h3>
          <p>Categories</p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Controls Section -->
<div class="container-fluid px-4">
  <div class="controls-section">
    <!-- Search and View Toggle -->
    <div class="search-bar-container">
      <div class="search-input-wrapper">
        <i class="bi bi-search search-icon"></i>
        <input type="text" 
               id="searchInput" 
               class="search-input" 
               placeholder="Search products by name, code, or SKU...">
      </div>
      <div class="view-toggle">
        <button class="view-btn active" data-view="grid">
          <i class="bi bi-grid-3x3-gap"></i>
          Grid
        </button>
        <button class="view-btn" data-view="list">
          <i class="bi bi-list-ul"></i>
          List
        </button>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-row">
      <div class="filter-group">
        <span class="filter-label">Status:</span>
        <button class="filter-chip active" data-filter="status" data-value="all">
          All
        </button>
        <button class="filter-chip" data-filter="status" data-value="available">
          Available
        </button>
        <button class="filter-chip" data-filter="status" data-value="lowstock">
          Low Stock
        </button>
        <button class="filter-chip" data-filter="status" data-value="outofstock">
          Out of Stock
        </button>
      </div>

      <div class="filter-group">
        <span class="filter-label">Type:</span>
        <button class="filter-chip active" data-filter="type" data-value="all">
          All
        </button>
        <button class="filter-chip" data-filter="type" data-value="single">
          Single Items
        </button>
        <button class="filter-chip" data-filter="type" data-value="bulk">
          Bulk Items
        </button>
      </div>

      <select class="sort-select" id="sortSelect">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="price-low">Price: Low to High</option>
        <option value="price-high">Price: High to Low</option>
        <option value="name-az">Name: A to Z</option>
        <option value="name-za">Name: Z to A</option>
      </select>
    </div>
  </div>
</div>

<!-- Products by Category -->
<div class="container-fluid px-4 mb-5">
  {% if categories %}
    {% for category in categories %}
      <div class="category-section" data-category="{{ category.name }}">
        <div class="category-header">
          <div class="category-title-row">
            <div class="category-title">
              <div class="category-icon">
                <i class="bi bi-{% if category.is_single_item %}phone{% else %}box-seam{% endif %}"></i>
              </div>
              <span>{{ category.name }}</span>
            </div>
            <div class="category-badge">
              <i class="bi bi-box-seam"></i>
              <span>{{ category.filtered_products.count }} {{ category.get_item_type_display }}</span>
            </div>
          </div>
          <div class="category-meta">
            <div class="meta-item">
              <i class="bi bi-tag"></i>
              <span>Identifier: <strong>{{ category.get_sku_type_display }}</strong></span>
            </div>
            <div class="meta-item">
              <i class="bi bi-diagram-3"></i>
              <span>Code: <strong>{{ category.category_code }}</strong></span>
            </div>
          </div>
        </div>

        {% if category.filtered_products.exists %}
          <div class="products-grid grid-view">
            {% for product in category.filtered_products %}
              <div class="product-card" 
                   data-status="{{ product.status }}"
                   data-type="{% if category.is_single_item %}single{% else %}bulk{% endif %}"
                   data-product-id="{{ product.id }}"
                   data-name="{{ product.name|lower }}"
                   data-code="{{ product.product_code|lower }}"
                   data-sku="{{ product.sku_value|lower }}"
                   data-price="{{ product.selling_price }}"
                   data-created="{{ product.created_at|date:'Y-m-d' }}">
                
                <!-- Product Image -->
                <div class="product-image-wrapper">
                  {% if product.image %}
                    {% if debug %}
                      <img src="{{ product.image.url }}" 
                           alt="{{ product.name }}" 
                           class="product-image"
                           loading="lazy"
                           onerror="this.parentElement.innerHTML='<div class=\'no-image-placeholder\'><i class=\'bi bi-image\'></i><span>No Image</span></div>'">
                    {% else %}
                      <img src="{% cloudinary_url product.image.name width=600 height=450 crop='fill' quality='auto' %}" 
                           alt="{{ product.name }}" 
                           class="product-image"
                           loading="lazy"
                           onerror="this.parentElement.innerHTML='<div class=\'no-image-placeholder\'><i class=\'bi bi-image\'></i><span>No Image</span></div>'">
                    {% endif %}
                  {% else %}
                    <div class="no-image-placeholder">
                      <i class="bi bi-image"></i>
                      <span>No Image Available</span>
                    </div>
                  {% endif %}

                  <!-- Badges -->
                  <div class="product-badges">
                    <div class="badge-group">
                      <span class="product-badge status-badge status-{{ product.status }}">
                        {{ product.get_status_display }}
                      </span>
                      <span class="product-badge item-type-badge">
                        <i class="bi bi-{% if category.is_single_item %}1-circle{% else %}stack{% endif %}"></i>
                        {{ category.get_item_type_display }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Product Info -->
                <div class="product-info">
                  <div class="product-header">
                    <div class="product-code">
                      <i class="bi bi-upc"></i>
                      {{ product.product_code }}
                    </div>
                    <h3 class="product-name">{{ product.name }}</h3>
                  </div>

                  <div class="product-details">
                    {% if product.sku_value %}
                      <div class="detail-row">
                        <div class="detail-icon">
                          <i class="bi bi-upc-scan"></i>
                        </div>
                        <div class="detail-content">
                          <div class="detail-label">{{ category.get_sku_type_display }}</div>
                          <div class="detail-value">{{ product.sku_value|truncatechars:25 }}</div>
                        </div>
                      </div>
                    {% endif %}
                  </div>

                  <div class="product-footer">
                    <div class="price-section">
                      <div class="price-row">
                        <div>
                          <div class="price-label">Selling Price</div>
                          <div class="product-price">KSh {{ product.selling_price|floatformat:2 }}</div>
                        </div>
                        {% if product.profit_margin > 0 %}
                          <div class="profit-indicator">
                            <i class="bi bi-graph-up-arrow"></i>
                            <span>+{{ product.profit_percentage|floatformat:1 }}%</span>
                          </div>
                        {% endif %}
                      </div>
                    </div>

                    {% if category.is_bulk_item and product.quantity > 0 %}
                      <div class="stock-indicator">
                        <div class="stock-icon">
                          <i class="bi bi-box-seam"></i>
                        </div>
                        <div class="stock-text">
                          <strong>{{ product.quantity }} units</strong>
                          <span>Available in stock</span>
                        </div>
                      </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    {% if not user.is_authenticated %}
                      <div class="action-buttons">
                        {% if product.status == 'available' or product.status == 'lowstock' %}
                          <button class="btn-primary" 
                                  data-product-id="{{ product.id }}"
                                  data-product-name="{{ product.name }}"
                                  data-product-price="{{ product.selling_price }}"
                                  data-product-code="{{ product.product_code }}"
                                  data-product-image="{% if product.image %}{% if debug %}{{ product.image.url }}{% else %}{% cloudinary_url product.image.name width=400 height=300 crop='fill' %}{% endif %}{% endif %}"
                                  data-max-quantity="{{ product.quantity }}"
                                  onclick="addToCart(this)">
                            <i class="bi bi-cart-plus"></i>
                            <span>Add to Cart</span>
                          </button>
                          <button class="btn-icon" title="Quick View" onclick="quickView({{ product.id }})">
                            <i class="bi bi-eye"></i>
                          </button>
                        {% elif product.status == 'outofstock' %}
                          <button class="btn-primary" disabled>
                            <i class="bi bi-inbox"></i>
                            <span>Out of Stock</span>
                          </button>
                        {% elif product.status == 'sold' %}
                          <button class="btn-primary" disabled>
                            <i class="bi bi-x-circle"></i>
                            <span>Sold Out</span>
                          </button>
                        {% else %}
                          <button class="btn-primary" disabled>
                            <i class="bi bi-x-circle"></i>
                            <span>Not Available</span>
                          </button>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <div class="empty-icon">
              <i class="bi bi-inbox"></i>
            </div>
            <h3>No products in this category</h3>
            <p>Check back soon for new arrivals in {{ category.name }}!</p>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <div class="empty-state">
      <div class="empty-icon">
        <i class="bi bi-shop"></i>
      </div>
      <h3>Shop Opening Soon</h3>
      <p>Our collection is being curated. Check back soon for amazing products!</p>
    </div>
  {% endif %}
</div>

<script>
  // ====================================
  // INITIALIZATION
  // ====================================
  document.addEventListener('DOMContentLoaded', function() {
    updateStats();
    initializeFilters();
    initializeSearch();
    initializeViewToggle();
    initializeSort();
  });

  // ====================================
  // STATISTICS
  // ====================================
  function updateStats() {
    const allProducts = document.querySelectorAll('.product-card');
    const availableProducts = document.querySelectorAll('.product-card[data-status="available"]');
    const categories = document.querySelectorAll('.category-section');

    document.getElementById('totalProducts').textContent = allProducts.length;
    document.getElementById('availableProducts').textContent = availableProducts.length;
    document.getElementById('totalCategories').textContent = categories.length;
  }

  // ====================================
  // FILTERS
  // ====================================
  let activeFilters = {
    status: 'all',
    type: 'all'
  };

  function initializeFilters() {
    const filterChips = document.querySelectorAll('.filter-chip');

    filterChips.forEach(chip => {
      chip.addEventListener('click', function() {
        const filterType = this.getAttribute('data-filter');
        const filterValue = this.getAttribute('data-value');

        // Update active state
        document.querySelectorAll(`[data-filter="${filterType}"]`).forEach(c => {
          c.classList.remove('active');
        });
        this.classList.add('active');

        // Update active filters
        activeFilters[filterType] = filterValue;

        // Apply filters
        applyFilters();
      });
    });
  }

  function applyFilters() {
    const products = document.querySelectorAll('.product-card');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    let visibleCount = 0;

    products.forEach(product => {
      const status = product.getAttribute('data-status');
      const type = product.getAttribute('data-type');
      const name = product.getAttribute('data-name');
      const code = product.getAttribute('data-code');
      const sku = product.getAttribute('data-sku');

      // Check filters
      const statusMatch = activeFilters.status === 'all' || status === activeFilters.status;
      const typeMatch = activeFilters.type === 'all' || type === activeFilters.type;
      const searchMatch = !searchTerm || 
                         name.includes(searchTerm) || 
                         code.includes(searchTerm) || 
                         sku.includes(searchTerm);

      if (statusMatch && typeMatch && searchMatch) {
        product.style.display = 'flex';
        visibleCount++;
      } else {
        product.style.display = 'none';
      }
    });

    // Update category visibility
    updateCategoryVisibility();
    
    console.log(`Filtered: ${visibleCount} products visible`);
  }

  function updateCategoryVisibility() {
    const categories = document.querySelectorAll('.category-section');
    
    categories.forEach(category => {
      const visibleProducts = category.querySelectorAll('.product-card[style*="display: flex"]');
      
      if (visibleProducts.length === 0) {
        category.style.display = 'none';
      } else {
        category.style.display = 'block';
      }
    });
  }

  // ====================================
  // SEARCH
  // ====================================
  function initializeSearch() {
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;

    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        applyFilters();
      }, 300);
    });
  }

  // ====================================
  // VIEW TOGGLE
  // ====================================
  function initializeViewToggle() {
    const viewButtons = document.querySelectorAll('.view-btn');
    const grids = document.querySelectorAll('.products-grid');

    viewButtons.forEach(button => {
      button.addEventListener('click', function() {
        const view = this.getAttribute('data-view');

        // Update active button
        viewButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');

        // Update grid layout
        grids.forEach(grid => {
          grid.classList.remove('grid-view', 'list-view');
          grid.classList.add(`${view}-view`);
        });

        console.log(`View changed to: ${view}`);
      });
    });
  }

  // ====================================
  // SORTING
  // ====================================
  function initializeSort() {
    const sortSelect = document.getElementById('sortSelect');

    sortSelect.addEventListener('change', function() {
      const sortValue = this.value;
      sortProducts(sortValue);
    });
  }

  function sortProducts(sortType) {
    const categories = document.querySelectorAll('.category-section');

    categories.forEach(category => {
      const grid = category.querySelector('.products-grid');
      if (!grid) return;

      const products = Array.from(grid.querySelectorAll('.product-card'));

      products.sort((a, b) => {
        switch(sortType) {
          case 'newest':
            return new Date(b.getAttribute('data-created')) - new Date(a.getAttribute('data-created'));
          
          case 'oldest':
            return new Date(a.getAttribute('data-created')) - new Date(b.getAttribute('data-created'));
          
          case 'price-low':
            return parseFloat(a.getAttribute('data-price')) - parseFloat(b.getAttribute('data-price'));
          
          case 'price-high':
            return parseFloat(b.getAttribute('data-price')) - parseFloat(a.getAttribute('data-price'));
          
          case 'name-az':
            return a.getAttribute('data-name').localeCompare(b.getAttribute('data-name'));
          
          case 'name-za':
            return b.getAttribute('data-name').localeCompare(a.getAttribute('data-name'));
          
          default:
            return 0;
        }
      });

      // Reorder in DOM
      products.forEach(product => grid.appendChild(product));
    });

    console.log(`Products sorted by: ${sortType}`);
  }

  {% if not user.is_authenticated %}
  // ====================================
  // CART FUNCTIONALITY
  // ====================================
  function addToCart(button) {
    try {
      const productId = button.getAttribute('data-product-id');
      const productName = button.getAttribute('data-product-name');
      const price = button.getAttribute('data-product-price');
      const productCode = button.getAttribute('data-product-code');
      const imageUrl = button.getAttribute('data-product-image');
      const maxQuantity = parseInt(button.getAttribute('data-max-quantity')) || 1;

      let cart = JSON.parse(localStorage.getItem('fieldmax_cart') || '[]');

      const existingItem = cart.find(item => item.id === productId);
      
      if (existingItem) {
        if (existingItem.quantity < maxQuantity) {
          existingItem.quantity += 1;
          showNotification('success', `${productName} quantity increased to ${existingItem.quantity}!`);
        } else {
          showNotification('warning', `Maximum quantity (${maxQuantity}) reached for ${productName}`);
          return;
        }
      } else {
        cart.push({
          id: productId,
          name: productName,
          price: parseFloat(price),
          code: productCode,
          image: imageUrl,
          quantity: 1,
          maxQuantity: maxQuantity
        });
        showNotification('success', `${productName} added to cart!`);
      }

      localStorage.setItem('fieldmax_cart', JSON.stringify(cart));
      window.dispatchEvent(new Event('cartUpdated'));
      
      console.log('Cart updated:', cart);
    } catch (error) {
      console.error('Error adding to cart:', error);
      showNotification('error', 'Failed to add item to cart. Please try again.');
    }
  }

  function quickView(productId) {
    showNotification('info', 'Quick view feature coming soon!');
    console.log('Quick view for product:', productId);
  }

  // ====================================
  // NOTIFICATIONS
  // ====================================
  function showNotification(type, message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#0dcaf0'};
      color: white;
      border-radius: 0.75rem;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      z-index: 10000;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      animation: slideIn 0.3s ease;
    `;

    const icon = type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'error' ? 'x-circle' : 'info-circle';
    notification.innerHTML = `<i class="bi bi-${icon}"></i> ${message}`;

    document.body.appendChild(notification);

    // Remove after 3 seconds
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Add animation styles
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }
  `;
  document.head.appendChild(style);
  {% endif %}
</script>

{% endblock %}\'></i>