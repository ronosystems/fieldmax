{% extends "website/base.html" %}
{% block title %}Dashboard - Fieldmax Shop{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashier Dashboard - Fieldmax Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ff00aa;
            padding: 20px;
            padding-bottom: 40px; /* Add padding at bottom to prevent footer overlap */
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .row {
            margin-bottom: 20px;
        }

        .card {
            background: rgb(3, 188, 240);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Row 1 - Shop Name */
        .header-card {
            text-align: center;
            background: linear-gradient(135deg, #000000 100%, #000000 100%);
            color: rgb(255, 255, 255);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }

        .shop-name {
            font-size: 100px;
            font-weight: 1000;
            letter-spacing: 10px;
        }

        /* Row 2 - 3 Columns */
        .row-2 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .search-card input {
            width: 100%;
            padding: 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
        }

        .search-card input:focus {
            outline: none;
            border-color: #764ba2;
        }

        .display-card {
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .display-label {
            font-size: 14px;
            color: #000000;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .display-value {
            font-size: 32px;
            font-weight: 900;
            color: #000000;
        }

        .price-value {
            color: #000000;
        }

        /* Row 3 - 2 Columns - NO FIXED HEIGHT */
        .row-3 {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            min-height: 400px; /* Minimum height only */
        }

        /* Column A - Compact */
        .row-3 .card:first-child {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .row-3 .card:first-child h3 {
            margin-bottom: 15px;
            color: #000000;
            font-size: 20px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #000000;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #00ffff;
        }

        /* Highlight editable sale amount */
        #saleAmount {
            background-color: #ffffcc;
            font-weight: bold;
            border: 2px solid #667eea;
        }

        #saleAmount:focus {
            background-color: #ffff99;
            border-color: #764ba2;
        }

        .add-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg,#00ffff 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s;
        }

        .add-btn:hover {
            transform: translateY(-2px);
        }

        .add-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Column B - Cart Display */
        .cart-card {
            display: flex;
            flex-direction: column;
            padding: 20px;
            height: 100%;
        }

        .cart-card h3 {
            margin-bottom: 15px;
            color: #000000;
            font-size: 20px;
        }

        /* Scrollable Table Container - Takes available space */
        .table-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            min-height: 150px;
            max-height: 250px; /* Maximum height, but can be less */
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #000000;
            color: white;
            position: sticky;
            top: 0;
        }

        th {
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        tbody tr:hover {
            background: #f8f9ff;
        }

        .remove-cell {
            text-align: center;
            width: 40px;
        }

        .remove-icon {
            cursor: pointer;
            color: #ff4757;
            font-size: 16px;
            transition: transform 0.2s;
        }

        .remove-icon:hover {
            transform: scale(1.2);
        }

        .empty-cart {
            text-align: center;
            padding: 40px 20px;
            color: #0c0a0a;
            font-size: 14px;
        }

        .cart-summary {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #667eea;
            text-align: right;
        }

        .summary-row {
            display: flex;
            justify-content: flex-end;
            gap: 80px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .summary-row.total {
            font-size: 22px;
            font-weight: 700;
            color: #000000;
            margin-top: 10px;
        }

        .checkout-btn {
            width: 100%;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: background 0.3s;
        }

        .checkout-btn:hover {
            background: #218838;
        }

        .checkout-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Payment Methods */
        .payment-methods-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #667eea;
        }

        .payment-methods-container h4 {
            margin-bottom: 15px;
            color: #000000;
            font-size: 20px;
            text-align: center;
        }

        .payment-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .payment-card {
            text-align: center;
            border: 2px solid #ddd;
            padding: 12px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .payment-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .payment-card.active {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .payment-icon {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .payment-title {
            font-size: 16px;
            font-weight: 800;
            color: #ff0000;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .payment-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
            margin-bottom: 8px;
        }

        .payment-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .submit-btn {
            width: 100%;
            padding: 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .submit-btn:hover {
            background: #218838;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Messages */
        .alert {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        .alert-danger {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .processing-overlay.active {
            display: flex;
        }

        .processing-message {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 15px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1200px) {
            .row-2 {
                grid-template-columns: 1fr;
            }
            .row-3 {
                grid-template-columns: 1fr;
            }
            .payment-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .shop-name {
                font-size: 48px;
                letter-spacing: 4px;
            }
            .payment-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Row 1: Shop Name -->
        <div class="row">
            <div class="card header-card">
                <div class="shop-name">FIELDMAX LIMITED üõí</div>
            </div>
        </div>

        <!-- Row 2: Product Lookup Display -->
        <div class="row row-2">
            <div class="card search-card">
                <input type="text" id="skuLookup" placeholder="Enter Product Code or Scan SKU">
            </div>
            <div class="card display-card">
                <div class="display-label">Product Name</div>
                <div class="display-value" id="displayName">---</div>
            </div>
            <div class="card display-card">
                <div class="display-label">Selling Price</div>
                <div class="display-value price-value" id="displayPrice">KSh 0.00</div>
            </div>
        </div>

        <!-- Row 3: Sales Recording and Cart -->
        <div class="row row-3">
            <!-- Column A: Recording Sale Section -->
            <div class="card">
                <h3>Record Sale</h3>
                <form id="saleForm">
                    <div class="input-group">
                        <label>Product Code / SKU</label>
                        <input type="text" id="productCode" placeholder="Enter or scan SKU" autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label>Quantity</label>
                        <input type="number" id="quantity" min="1" value="1">
                    </div>
                    <div class="input-group">
                        <label>Sale Amount (Editable)</label>
                        <input type="number" id="saleAmount" placeholder="KSh 0.00" step="0.01" min="0">
                    </div>
                    <button type="button" class="add-btn" id="addToCartBtn">Add to Cart</button>
                </form>
            </div>

            <!-- Column B: Cart Display -->
            <div class="card cart-card">
                <h3>Sales Cart</h3>
                <!-- Messages Container -->
                <div id="messageContainer"></div>
                
                <!-- Scrollable Table Container -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Product Code</th>
                                <th>Product Name</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total Price</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="cartTableBody">
                            <tr>
                                <td colspan="6" class="empty-cart">Cart is empty. Add products to start.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="cart-summary" id="cartSummary" style="display: none;">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">KSh 0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax (16%):</span>
                        <span id="tax">KSh 0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>TOTAL:</span>
                        <span id="total">KSh 0.00</span>
                    </div>
                </div>

                <!-- Payment Methods - INSIDE COLUMN B -->
                <div class="payment-methods-container">
                    <h4><strong>Select Payment Methods</strong></h4>
                    <div class="payment-grid">
                        <!-- Cash Payment -->
                        <div class="payment-card" data-payment="cash">
                            <div class="payment-title"><strong>Cash</strong></div>
                            <input type="number" class="payment-input" id="cashAmount" placeholder="Enter Amount" min="0" step="0.01">
                            <button class="submit-btn" data-payment="cash">Submit Sale</button>
                        </div>

                        <!-- M-Pesa Payment -->
                        <div class="payment-card" data-payment="mpesa">
                            <div class="payment-title"><strong>M-Pesa</strong></div>
                            <input type="number" class="payment-input" id="mpesaAmount" placeholder="Enter Amount" min="0" step="0.01">
                            <button class="submit-btn" data-payment="mpesa">Submit Sale</button>
                        </div>

                        <!-- Card Payment -->
                        <div class="payment-card" data-payment="card">
                            <div class="payment-title"><strong>Card</strong></div>
                            <input type="number" class="payment-input" id="cardAmount" placeholder="Enter Amount" min="0" step="0.01">
                            <button class="submit-btn" data-payment="card">Submit Sale</button>
                        </div>

                        <!-- Points Payment -->
                        <div class="payment-card" data-payment="points">
                            <div class="payment-title"><strong>Points</strong></div>
                            <input type="number" class="payment-input" id="pointsAmount" placeholder="Enter Points" min="0" step="1">
                            <button class="submit-btn" data-payment="points">Submit Sale</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End of Row 3 -->
    </div>

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-message">
            <div class="spinner"></div>
            <div>Processing Sale...</div>
            <div style="margin-top: 10px; font-size: 14px; font-weight: normal;">Please wait, do not refresh</div>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL STATE & FLAGS
        // ============================================
        let cart = [];
        let currentProduct = null;
        let debounceTimer = null;
        let isAddingToCart = false;
        let isSubmittingSale = false;
        let lastSubmissionTime = 0;
        const SUBMISSION_COOLDOWN = 3000; // 3 seconds cooldown between submissions

        // Get CSRF token
        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }

        // ============================================
        // ROW 2: SKU LOOKUP (Display Only)
        // ============================================
        document.getElementById('skuLookup').addEventListener('input', function(e) {
            clearTimeout(debounceTimer);
            const code = e.target.value.trim().toUpperCase();
            
            if (code.length < 2) {
                document.getElementById('displayName').textContent = '---';
                document.getElementById('displayPrice').textContent = 'KSh 0.00';
                return;
            }
            
            debounceTimer = setTimeout(() => lookupProductDisplay(code), 300);
        });

        async function lookupProductDisplay(code) {
            try {
                const response = await fetch(`/sales/product-lookup/?product_code=${encodeURIComponent(code)}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('displayName').textContent = data.product.name;
                    document.getElementById('displayPrice').textContent = `KSh ${parseFloat(data.product.unit_price).toFixed(2)}`;
                } else {
                    document.getElementById('displayName').textContent = '---';
                    document.getElementById('displayPrice').textContent = 'KSh 0.00';
                }
            } catch (error) {
                console.error('Lookup error:', error);
            }
        }

        // ============================================
        // ROW 3: PRODUCT CODE INPUT (For Cart)
        // ============================================
        document.getElementById('productCode').addEventListener('input', function() {
            clearTimeout(debounceTimer);
            const code = this.value.trim().toUpperCase();
            
            if (code.length < 2) {
                currentProduct = null;
                document.getElementById('saleAmount').value = '';
                return;
            }
            
            debounceTimer = setTimeout(() => lookupProductForCart(code), 300);
        });

        async function lookupProductForCart(code) {
            try {
                const response = await fetch(`/sales/product-lookup/?product_code=${encodeURIComponent(code)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentProduct = data.product;
                    updateSaleAmount();
                } else {
                    currentProduct = null;
                    showMessage(data.message || 'Product not found', 'danger');
                    document.getElementById('saleAmount').value = '';
                }
            } catch (error) {
                console.error('Lookup error:', error);
                showMessage('Error looking up product', 'danger');
            }
        }

        // ============================================
        // QUANTITY & AMOUNT CALCULATION - EDITABLE
        // ============================================
        document.getElementById('quantity').addEventListener('input', updateSaleAmount);

        // Allow manual editing of sale amount
        document.getElementById('saleAmount').addEventListener('input', function() {
            const manualAmount = parseFloat(this.value);
            if (manualAmount && currentProduct) {
                const qty = parseInt(document.getElementById('quantity').value) || 1;
                currentProduct.manual_unit_price = manualAmount / qty;
            }
        });

        function updateSaleAmount() {
            const qty = parseInt(document.getElementById('quantity').value) || 0;
            const saleAmountInput = document.getElementById('saleAmount');
            
            if (currentProduct && qty > 0) {
                if (!saleAmountInput.value || !currentProduct.manual_unit_price) {
                    const amount = currentProduct.unit_price * qty;
                    saleAmountInput.value = amount.toFixed(2);
                } else {
                    const amount = currentProduct.manual_unit_price * qty;
                    saleAmountInput.value = amount.toFixed(2);
                }
            }
        }

        // ============================================
        // ADD TO CART - SMART DUPLICATE HANDLING
        // ============================================
        document.getElementById('addToCartBtn').addEventListener('click', addToCart);

        // Prevent form submission on Enter
        document.getElementById('saleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addToCart();
        });

        function addToCart() {
            if (isAddingToCart) {
                console.log('Already adding to cart, please wait...');
                showMessage('Please wait, adding item...', 'danger');
                return;
            }

            const code = document.getElementById('productCode').value.trim().toUpperCase();
            const qty = parseInt(document.getElementById('quantity').value);
            const totalAmount = parseFloat(document.getElementById('saleAmount').value);
            
            if (!code || !qty || qty <= 0) {
                showMessage('Please enter valid product code and quantity', 'danger');
                return;
            }

            if (!currentProduct) {
                showMessage('Product not found!', 'danger');
                return;
            }

            if (!totalAmount || totalAmount <= 0) {
                showMessage('Please enter a valid sale amount', 'danger');
                return;
            }

            // Calculate unit price from total amount
            const unitPrice = totalAmount / qty;

            // Set flag to prevent duplicate additions
            isAddingToCart = true;
            const addBtn = document.getElementById('addToCartBtn');
            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';

            try {
                // Check if exact same product with same unit price exists
                const existingItem = cart.find(item => 
                    item.code === code && 
                    Math.abs(item.amount - unitPrice) < 0.01
                );
                
                if (existingItem) {
                    // Same product, same price - ask to combine
                    if (confirm(`${code} at KSh ${unitPrice.toFixed(2)} is already in cart.\n\nCombine quantities?\nYES = Add ${qty} more units\nNO = Add as separate line`)) {
                        existingItem.quantity += qty;
                        existingItem.totalPrice = existingItem.quantity * existingItem.amount;
                        showMessage(`‚úÖ Combined: ${existingItem.quantity} units at KSh ${unitPrice.toFixed(2)} each`, 'success');
                    } else {
                        // Add as new line item
                        cart.push({
                            code: code,
                            name: currentProduct.name,
                            quantity: qty,
                            amount: unitPrice,
                            totalPrice: totalAmount
                        });
                        showMessage('‚úÖ Added as separate line item', 'success');
                    }
                } else {
                    // Different price or product not in cart
                    cart.push({
                        code: code,
                        name: currentProduct.name,
                        quantity: qty,
                        amount: unitPrice,
                        totalPrice: totalAmount
                    });
                    
                    // Check if same product exists with different price
                    const sameProductDifferentPrice = cart.filter(item => item.code === code).length > 1;
                    if (sameProductDifferentPrice) {
                        showMessage(`‚úÖ Added ${code} at KSh ${unitPrice.toFixed(2)} (different price)`, 'success');
                    } else {
                        showMessage('‚úÖ Added to cart successfully', 'success');
                    }
                }

                // Clear inputs
                document.getElementById('productCode').value = '';
                document.getElementById('quantity').value = '1';
                document.getElementById('saleAmount').value = '';
                currentProduct = null;

                updateCartDisplay();

            } finally {
                setTimeout(() => {
                    isAddingToCart = false;
                    addBtn.disabled = false;
                    addBtn.textContent = 'Add to Cart';
                    document.getElementById('productCode').focus();
                }, 800);
            }
        }

        // ============================================
        // UPDATE CART DISPLAY - SHOW NEWEST FIRST
        // ============================================
        function updateCartDisplay() {
            const tbody = document.getElementById('cartTableBody');
            
            if (cart.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-cart">Cart is empty. Add products to start.</td></tr>';
                document.getElementById('cartSummary').style.display = 'none';
                return;
            }

            // Show newest items first (reverse the array)
            const reversedCart = [...cart].reverse();
            
            tbody.innerHTML = reversedCart.map((item, index) => `
                <tr>
                    <td><strong>${item.code}</strong></td>
                    <td><strong>${item.name}</strong></td>
                    <td>${item.quantity}</td>
                    <td>KSh ${item.amount.toFixed(2)}</td>
                    <td><strong>KSh ${item.totalPrice.toFixed(2)}</strong></td>
                    <td class="remove-cell"><span class="remove-icon" onclick="removeItem(${cart.length - 1 - index})">üóëÔ∏è</span></td>
                </tr>
            `).join('');

            document.getElementById('cartSummary').style.display = 'block';
            updateTotals();
            
            // Auto scroll to top to show newest items
            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.scrollTop = 0;
            }
        }

        function removeItem(index) {
            if (confirm('Remove this item from cart?')) {
                cart.splice(index, 1);
                updateCartDisplay();
                showMessage('Item removed from cart', 'success');
            }
        }

        function updateTotals() {
            const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
            const tax = total * (16 / 116);
            const subtotal = total - tax;

            document.getElementById('subtotal').textContent = `KSh ${subtotal.toFixed(2)}`;
            document.getElementById('tax').textContent = `KSh ${tax.toFixed(2)}`;
            document.getElementById('total').textContent = `KSh ${total.toFixed(2)}`;
        }

        // ============================================
        // PAYMENT METHODS
        // ============================================
        const paymentCards = document.querySelectorAll('.payment-card');
        const paymentInputs = {
            cash: document.getElementById('cashAmount'),
            mpesa: document.getElementById('mpesaAmount'),
            card: document.getElementById('cardAmount'),
            points: document.getElementById('pointsAmount')
        };

        // Auto-fill total when clicking payment card
        paymentCards.forEach(card => {
            card.addEventListener('click', function() {
                if (cart.length === 0) {
                    showMessage('Please add items to cart first', 'danger');
                    return;
                }
                
                const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
                const paymentType = this.getAttribute('data-payment');
                const input = document.getElementById(`${paymentType}Amount`);
                input.value = total.toFixed(2);
                
                paymentCards.forEach(c => c.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Checkout button
        document.getElementById('checkoutBtn').addEventListener('click', function() {
            if (cart.length === 0) return;
            
            const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
            showMessage(`Total: KSh ${total.toFixed(2)} - Select payment method below`, 'success');
            
            // Scroll to payment methods
            document.querySelector('.payment-methods-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        // Payment submission with duplicate prevention
        document.querySelectorAll('.submit-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const now = Date.now();
                if (now - lastSubmissionTime < SUBMISSION_COOLDOWN) {
                    const remainingTime = Math.ceil((SUBMISSION_COOLDOWN - (now - lastSubmissionTime)) / 1000);
                    showMessage(`Please wait ${remainingTime} seconds before submitting again`, 'danger');
                    return;
                }

                if (isSubmittingSale) {
                    showMessage('Sale is being processed, please wait...', 'danger');
                    return;
                }

                const paymentType = this.getAttribute('data-payment');
                const paymentMethodMap = {
                    'cash': 'Cash',
                    'mpesa': 'M-Pesa',
                    'card': 'Card',
                    'points': 'Points'
                };
                
                const amount = document.getElementById(`${paymentType}Amount`).value;
                processSale(paymentMethodMap[paymentType], amount);
            });
        });

        async function processSale(paymentMethod, amount) {
            if (isSubmittingSale) {
                console.log('Sale already being processed, blocked duplicate');
                return;
            }

            if (cart.length === 0) {
                showMessage('Cart is empty!', 'danger');
                return;
            }

            const amountPaid = parseFloat(amount);
            if (!amountPaid || amountPaid <= 0) {
                showMessage('Please enter a valid amount', 'danger');
                return;
            }

            const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);

            if (amountPaid < total) {
                showMessage(`Insufficient amount! Total: KSh ${total.toFixed(2)}`, 'danger');
                return;
            }

            // Set all flags
            isSubmittingSale = true;
            lastSubmissionTime = Date.now();
            
            // Disable ALL interactive elements
            document.querySelectorAll('.submit-btn, .add-btn, .checkout-btn').forEach(btn => {
                btn.disabled = true;
            });
            document.querySelectorAll('input').forEach(input => {
                input.disabled = true;
            });
            
            // Show processing overlay
            document.getElementById('processingOverlay').classList.add('active');

            try {
                // Prepare sales data
                const salesData = cart.map(item => ({
                    product_code: item.code,
                    quantity: item.quantity,
                    unit_price: item.amount
                }));

                console.log('Submitting sale:', {
                    payment_method: paymentMethod,
                    amount_paid: amountPaid,
                    items_count: salesData.length
                });

                const response = await fetch('/sales/batch-create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        sales_cart: salesData,
                        payment_method: paymentMethod,
                        amount_paid: amountPaid
                    })
                });

                const data = await response.json();

                // Hide processing overlay
                document.getElementById('processingOverlay').classList.remove('active');

                if (data.status === 'success') {
                    // Reset submission flag immediately on success
                    isSubmittingSale = false;
                    
                    const change = amountPaid - total;
                    let message = `‚úÖ SALE COMPLETED!\n\nPayment Method: ${paymentMethod}\nTotal: KSh ${total.toFixed(2)}\nPaid: KSh ${amountPaid.toFixed(2)}`;
                    
                    if (change > 0) {
                        message += `\nChange: KSh ${change.toFixed(2)}`;
                    }

                    // Check for batch_id or receipt_url in response
                    if (data.batch_id) {
                        const receiptUrl = `/sales/fieldmax-receipt/${data.batch_id}/`;
                        message += `\n\nReceipt generated successfully!`;
                        setTimeout(() => window.open(receiptUrl, '_blank'), 500);
                    } else if (data.receipt_url) {
                        message += `\n\nReceipt generated successfully!`;
                        setTimeout(() => window.open(data.receipt_url, '_blank'), 500);
                    }

                    showMessage(message, 'success');

                    // Clear everything immediately
                    cart = [];
                    updateCartDisplay();
                    Object.values(paymentInputs).forEach(input => input.value = '');
                    paymentCards.forEach(c => c.classList.remove('active'));

                    // Re-enable inputs for next transaction
                    setTimeout(() => {
                        document.querySelectorAll('.submit-btn, .add-btn, .checkout-btn').forEach(btn => {
                            btn.disabled = false;
                        });
                        document.querySelectorAll('input').forEach(input => {
                            input.disabled = false;
                        });
                        document.getElementById('productCode').focus();
                    }, 1500);
                } else {
                    showMessage(`‚ùå Sale failed: ${data.message}`, 'danger');
                    
                    // Re-enable elements on failure
                    document.querySelectorAll('.submit-btn, .add-btn, .checkout-btn').forEach(btn => {
                        btn.disabled = false;
                    });
                    document.querySelectorAll('input').forEach(input => {
                        input.disabled = false;
                    });
                    
                    // Reset flags
                    isSubmittingSale = false;
                    lastSubmissionTime = 0;
                }
            } catch (error) {
                console.error('Sale error:', error);
                document.getElementById('processingOverlay').classList.remove('active');
                showMessage('‚ùå Error processing sale. Please try again.', 'danger');
                
                // Re-enable elements on error
                document.querySelectorAll('.submit-btn, .add-btn, .checkout-btn').forEach(btn => {
                    btn.disabled = false;
                });
                document.querySelectorAll('input').forEach(input => {
                    input.disabled = false;
                });
                
                // Reset flags
                isSubmittingSale = false;
                lastSubmissionTime = 0;
            }
        }

        // ============================================
        // MESSAGE DISPLAY
        // ============================================
        function showMessage(message, type = 'success') {
            const container = document.getElementById('messageContainer');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            
            const formattedMessage = message.replace(/\n/g, '<br>');
            
            container.innerHTML = `<div class="alert ${alertClass}">${formattedMessage}</div>`;
            
            setTimeout(() => {
                if (type !== 'success' || !isSubmittingSale) {
                    container.innerHTML = '';
                }
            }, 5000);
        }

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to add to cart
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                if (!isAddingToCart) {
                    addToCart();
                }
            }
            
            // Escape to clear current product
            if (e.key === 'Escape') {
                document.getElementById('productCode').value = '';
                document.getElementById('quantity').value = '1';
                document.getElementById('saleAmount').value = '';
                currentProduct = null;
                document.getElementById('productCode').focus();
            }
        });

        // ============================================
        // PREVENT PAGE UNLOAD DURING SUBMISSION
        // ============================================
        window.addEventListener('beforeunload', function(e) {
            if (isSubmittingSale) {
                e.preventDefault();
                e.returnValue = 'Sale is being processed. Are you sure you want to leave?';
                return e.returnValue;
            }
        });

        // ============================================
        // INITIALIZE
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('productCode').focus();
            console.log('Cashier Dashboard initialized');
        });
    </script>
</body>
</html>

{% endblock %}