{% extends 'website/base.html' %}
{% load static %}

{% block title %}{{ product.display_name }} - Fieldmax{% endblock %}

{% block content %}
<style>
  /* Product Detail Styles */
  body {
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
    color: #333333;
  }

  .product-detail-section {
    padding: 100px 5% 80px;
    min-height: 100vh;
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 40px;
    font-size: 14px;
    color: #666666;
  }

  .breadcrumb a {
    color: #667eea;
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .breadcrumb a:hover {
    color: #02adfc;
  }

  .breadcrumb-separator {
    opacity: 0.5;
    color: #999999;
  }

  .product-detail-container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .product-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 60px;
    margin-bottom: 80px;
  }

  /* Image Gallery */
  .product-gallery {
    position: sticky;
    top: 100px;
    height: fit-content;
  }

  .main-image-container {
    background: #ffffff;
    border: 2px solid #e0e0e0;
    border-radius: 20px;
    padding: 40px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
  }

  .main-image-container::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .main-image-container:hover::before {
    opacity: 1;
  }

  .main-image {
    width: 100%;
    height: 500px;
    object-fit: contain;
    transition: transform 0.3s ease;
  }

  .main-image-container:hover .main-image {
    transform: scale(1.05);
  }

  .image-placeholder {
    width: 100%;
    height: 500px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 6rem;
    color: #667eea;
    opacity: 0.3;
    background: #f8f9fa;
    border-radius: 15px;
  }

  .product-badges {
    position: absolute;
    top: 20px;
    left: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 2;
  }

  .badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .badge-featured {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  }

  .badge-new {
    background: linear-gradient(135deg, #f093fb, #f5576c);
    color: white;
    box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
  }

  .badge-condition {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
  }

  /* Product Info */
  .product-info {
    animation: fadeInUp 0.8s ease;
  }

  .product-category-tag {
    display: inline-block;
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    padding: 8px 20px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 20px;
    border: 1px solid rgba(102, 126, 234, 0.2);
  }

  .product-title {
    font-size: 2.5rem;
    font-weight: 900;
    margin-bottom: 20px;
    line-height: 1.2;
    color: #1a1f2e;
  }

  .product-code-display {
    font-family: 'Courier New', monospace;
    color: #666666;
    font-size: 14px;
    margin-bottom: 20px;
    background: #f8f9fa;
    padding: 8px 16px;
    border-radius: 8px;
    display: inline-block;
    border: 1px solid #e0e0e0;
  }

  .product-rating {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 30px;
  }

  .stars {
    display: flex;
    gap: 5px;
  }

  .star {
    color: #ffc107;
    font-size: 20px;
  }

  .rating-text {
    color: #666666;
    font-size: 14px;
  }

  .price-section {
    background: #ffffff;
    border: 2px solid #e0e0e0;
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
  }

  .price-current {
    font-size: 3rem;
    font-weight: 900;
    color: #1a1f2e;
    margin-bottom: 10px;
  }

  .price-savings {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-top: 15px;
  }

  .price-original {
    font-size: 1.5rem;
    color: #999999;
    text-decoration: line-through;
  }

  .savings-badge {
    background: linear-gradient(135deg, #f093fb, #f5576c);
    color: white;
    padding: 8px 18px;
    border-radius: 15px;
    font-size: 14px;
    font-weight: 700;
    box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
  }

  .stock-info {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 20px;
    background: rgba(16, 185, 129, 0.1);
    color: #065f46;
    border: 2px solid rgba(16, 185, 129, 0.3);
    border-radius: 12px;
    margin-bottom: 30px;
    font-weight: 600;
  }

  .stock-info.low-stock {
    background: rgba(245, 158, 11, 0.1);
    border-color: rgba(245, 158, 11, 0.3);
    color: #92400e;
  }

  .stock-info.out-of-stock {
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.3);
    color: #991b1b;
  }

  .stock-icon {
    font-size: 24px;
  }

  .stock-text {
    font-weight: 600;
    font-size: 15px;
  }

  /* Quantity Selector */
  .quantity-selector {
    margin-bottom: 30px;
  }

  .quantity-label {
    font-weight: 600;
    margin-bottom: 10px;
    display: block;
    color: #333333;
  }

  .quantity-controls {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .quantity-btn {
    width: 45px;
    height: 45px;
    background: #ffffff;
    border: 2px solid #667eea;
    border-radius: 12px;
    color: #667eea;
    font-size: 20px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .quantity-btn:hover:not(:disabled) {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
  }

  .quantity-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    border-color: #cccccc;
    color: #cccccc;
  }

  .quantity-input {
    width: 80px;
    height: 45px;
    background: #ffffff;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    color: #333333;
    text-align: center;
    font-size: 18px;
    font-weight: 600;
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
  }

  .btn-add-cart {
    flex: 1;
    padding: 18px 32px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 50px;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
  }

  .btn-add-cart:hover:not(:disabled) {
    transform: translateY(-3px);
    box-shadow: 0 20px 40px rgba(102, 126, 234, 0.5);
  }

  .btn-add-cart:disabled {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    cursor: not-allowed;
    opacity: 0.6;
    box-shadow: none;
  }

  .btn-wishlist {
    width: 60px;
    height: 60px;
    background: #ffffff;
    border: 2px solid #e0e0e0;
    border-radius: 50%;
    color: #333333;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  }

  .btn-wishlist:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
    color: #ef4444;
    transform: scale(1.1);
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.2);
  }

  /* Product Features */
  .product-features {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 40px;
  }

  .feature-item {
    background: #ffffff;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  }

  .feature-item:hover {
    background: #f8f9fa;
    border-color: #667eea;
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.1);
  }

  .feature-icon {
    font-size: 28px;
    margin-bottom: 10px;
    display: block;
    color: #667eea;
  }

  .feature-label {
    font-size: 14px;
    color: #333333;
    font-weight: 600;
  }

  /* Tabs */
  .product-tabs {
    margin-bottom: 40px;
    background: #ffffff;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    border: 2px solid #e0e0e0;
  }

  .tab-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 10px;
  }

  .tab-btn {
    padding: 12px 24px;
    background: transparent;
    border: none;
    color: #666666;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 8px;
    position: relative;
  }

  .tab-btn.active {
    color: #667eea;
    background: rgba(102, 126, 234, 0.1);
  }

  .tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #667eea, #764ba2);
  }

  .tab-content {
    display: none;
    animation: fadeIn 0.5s ease;
  }

  .tab-content.active {
    display: block;
  }

  .description-text {
    line-height: 1.8;
    color: #444444;
    font-size: 16px;
  }

  .specs-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }

  .spec-item {
    background: #f8f9fa;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
  }

  .spec-item:hover {
    background: #ffffff;
    border-color: #667eea;
    transform: translateY(-2px);
  }

  .spec-label {
    color: #666666;
    font-size: 14px;
    font-weight: 500;
  }

  .spec-value {
    font-weight: 700;
    font-size: 15px;
    color: #1a1f2e;
  }

  /* Related Products */
  .related-section {
    margin-top: 80px;
  }

  .section-title {
    font-size: 2rem;
    font-weight: 900;
    margin-bottom: 40px;
    text-align: center;
    color: #1a1f2e;
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 30px;
  }

  .related-card {
    background: #ffffff;
    border: 2px solid #e0e0e0;
    border-radius: 16px;
    overflow: hidden;
    transition: all 0.3s ease;
    text-decoration: none;
    color: inherit;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  }

  .related-card:hover {
    transform: translateY(-10px);
    border-color: #667eea;
    box-shadow: 0 20px 40px rgba(102, 126, 234, 0.2);
    text-decoration: none;
    color: inherit;
  }

  .related-image {
    width: 100%;
    height: 200px;
    object-fit: contain;
    padding: 20px;
    background: #f8f9fa;
    border-bottom: 2px solid #e0e0e0;
  }

  .related-info {
    padding: 20px;
  }

  .related-name {
    font-weight: 700;
    margin-bottom: 10px;
    font-size: 15px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: #1a1f2e;
  }

  .related-price {
    font-size: 1.5rem;
    font-weight: 900;
    color: #667eea;
  }

  /* Toast Notification */
  .toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #ffffff;
    color: #333333;
    padding: 20px 30px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    transform: translateX(400px);
    transition: transform 0.4s ease;
    z-index: 1000;
    font-weight: 600;
    border-left: 4px solid #667eea;
  }

  .toast.show {
    transform: translateX(0);
  }

  /* Animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .product-detail-grid {
      grid-template-columns: 1fr;
      gap: 40px;
    }

    .product-gallery {
      position: static;
    }

    .related-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .specs-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .product-detail-section {
      padding: 80px 5% 60px;
    }

    .product-title {
      font-size: 2rem;
    }

    .price-current {
      font-size: 2.5rem;
    }

    .product-features {
      grid-template-columns: 1fr;
    }

    .related-grid {
      grid-template-columns: 1fr;
    }

    .action-buttons {
      flex-direction: column;
    }

    .btn-wishlist {
      width: 100%;
      border-radius: 50px;
    }
  }
</style>

<section class="product-detail-section">
  <div class="product-detail-container">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <a href="{% url 'home' %}">Home</a>
      <span class="breadcrumb-separator">‚Ä∫</span>
      <a href="{% url 'shop' %}">Shop</a>
      <span class="breadcrumb-separator">‚Ä∫</span>
      <span>{{ product.display_name }}</span>
    </div>

    <!-- Product Detail Grid -->
    <div class="product-detail-grid">
      <!-- Image Gallery -->
      <div class="product-gallery">
        <div class="main-image-container">
          <!-- Badges -->
          <div class="product-badges">
            {% if product.is_featured %}
              <span class="badge badge-featured">‚≠ê Featured</span>
            {% endif %}
            {% if product.condition == 'new' %}
              <span class="badge badge-new">‚ú® Brand New</span>
            {% else %}
              <span class="badge badge-condition">{{ product.get_condition_display }}</span>
            {% endif %}
          </div>

          <!-- Main Image -->
          {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.display_name }}" class="main-image">
          {% else %}
            <div class="image-placeholder">üì±</div>
          {% endif %}
        </div>
      </div>

      <!-- Product Info -->
      <div class="product-info">
        <!-- Category Tag -->
        <span class="product-category-tag">{{ product.category.name }}</span>

        <!-- Title -->
        <h1 class="product-title">{{ product.display_name }}</h1>

        <!-- Product Code -->
        <div class="product-code-display">SKU: {{ product.product_code }}</div>

        <!-- Rating -->
        <div class="product-rating">
          <div class="stars">
            <span class="star">‚≠ê</span>
            <span class="star">‚≠ê</span>
            <span class="star">‚≠ê</span>
            <span class="star">‚≠ê</span>
            <span class="star">‚≠ê</span>
          </div>
          <span class="rating-text">4.8 ({{ product.sales_count|default:0 }} reviews)</span>
        </div>

        <!-- Price Section -->
        <div class="price-section">
          <div class="price-current">KSh {{ product.selling_price|floatformat:0 }}</div>
          {% if product.buying_price and product.buying_price < product.selling_price %}
            <div class="price-savings">
              <span class="savings-badge">Save KSh {{ product.profit_margin|floatformat:0 }}</span>
            </div>
          {% endif %}
        </div>

        <!-- Stock Info -->
        {% if product.status == 'available' %}
          <div class="stock-info">
            <span class="stock-icon">‚úÖ</span>
            <span class="stock-text">
              {% if product.category.is_bulk_item %}
                In Stock ({{ product.quantity }} available)
              {% else %}
                In Stock
              {% endif %}
            </span>
          </div>
        {% elif product.status == 'lowstock' %}
          <div class="stock-info low-stock">
            <span class="stock-icon">‚ö†Ô∏è</span>
            <span class="stock-text">Low Stock (Only {{ product.quantity }} left)</span>
          </div>
        {% else %}
          <div class="stock-info out-of-stock">
            <span class="stock-icon">‚ùå</span>
            <span class="stock-text">Out of Stock</span>
          </div>
        {% endif %}

        <!-- Quantity Selector (only for bulk items) -->
        {% if product.category.is_bulk_item and product.status != 'sold' and product.status != 'outofstock' %}
          <div class="quantity-selector">
            <label class="quantity-label">Quantity:</label>
            <div class="quantity-controls">
              <button class="quantity-btn" onclick="decreaseQuantity()">‚àí</button>
              <input type="number" id="quantity" class="quantity-input" value="1" min="1" max="{{ product.quantity }}" readonly>
              <button class="quantity-btn" onclick="increaseQuantity()">+</button>
            </div>
          </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="action-buttons">
          {% if product.status == 'available' or product.status == 'lowstock' %}
            <button class="btn-add-cart" 
                    data-product-id="{{ product.id }}"
                    data-product-name="{{ product.display_name }}"
                    data-product-price="{{ product.selling_price }}"
                    data-product-code="{{ product.product_code }}"
                    onclick="addToCart()">
              <span>üõí</span>
              <span>Add to Cart</span>
            </button>
          {% else %}
            <button class="btn-add-cart" disabled>
              <span>‚è≥</span>
              <span>Out of Stock</span>
            </button>
          {% endif %}
          <button class="btn-wishlist" title="Add to Wishlist" onclick="addToWishlist()">‚ù§Ô∏è</button>
        </div>

        <!-- Product Features -->
        <div class="product-features">
          <div class="feature-item">
            <span class="feature-icon">üöö</span>
            <div class="feature-label">Free Delivery</div>
          </div>
          <div class="feature-item">
            <span class="feature-icon">üîí</span>
            <div class="feature-label">
              {% if product.warranty_months %}
                {{ product.warranty_months }}mo Warranty
              {% else %}
                Secure Payment
              {% endif %}
            </div>
          </div>
          <div class="feature-item">
            <span class="feature-icon">üîÑ</span>
            <div class="feature-label">Easy Returns</div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="product-tabs">
          <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('description')">Description</button>
            <button class="tab-btn" onclick="switchTab('specifications')">Specifications</button>
          </div>

          <!-- Description Tab -->
          <div class="tab-content active" id="description-tab">
            <div class="description-text">
              {% if product.description %}
                {{ product.description|linebreaks }}
              {% else %}
                <p>{{ product.display_name }} - Premium quality product available at Fieldmax.</p>
                <p>Experience the best in technology with our carefully curated selection of products. Each item undergoes strict quality control to ensure you receive only the finest products.</p>
                {% if product.warranty_months %}
                  <p><strong>Warranty:</strong> This product comes with a {{ product.warranty_months }}-month warranty for your peace of mind.</p>
                {% endif %}
              {% endif %}
            </div>
          </div>

          <!-- Specifications Tab -->
          <div class="tab-content" id="specifications-tab">
            <div class="specs-grid">
              {% if product.brand %}
                <div class="spec-item">
                  <span class="spec-label">Brand</span>
                  <span class="spec-value">{{ product.brand }}</span>
                </div>
              {% endif %}
              
              {% if product.model %}
                <div class="spec-item">
                  <span class="spec-label">Model</span>
                  <span class="spec-value">{{ product.model }}</span>
                </div>
              {% endif %}

              <div class="spec-item">
                <span class="spec-label">Condition</span>
                <span class="spec-value">{{ product.get_condition_display }}</span>
              </div>

              <div class="spec-item">
                <span class="spec-label">Category</span>
                <span class="spec-value">{{ product.category.name }}</span>
              </div>

              {% if product.warranty_months %}
                <div class="spec-item">
                  <span class="spec-label">Warranty</span>
                  <span class="spec-value">{{ product.warranty_months }} Months</span>
                </div>
              {% endif %}

              {% if product.sku_value %}
                <div class="spec-item">
                  <span class="spec-label">{{ product.category.get_sku_type_display }}</span>
                  <span class="spec-value">{{ product.sku_value }}</span>
                </div>
              {% endif %}

              {% if product.specifications %}
                {% for key, value in product.specifications.items %}
                  <div class="spec-item">
                    <span class="spec-label">{{ key|title }}</span>
                    <span class="spec-value">{{ value }}</span>
                  </div>
                {% endfor %}
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Related Products -->
    {% if related_products %}
      <div class="related-section">
        <h2 class="section-title">You May Also Like</h2>
        <div class="related-grid">
          {% for related in related_products %}
            <a href="{% url 'product_detail' related.id %}" class="related-card">
              {% if related.image %}
                <img src="{{ related.image.url }}" alt="{{ related.display_name }}" class="related-image">
              {% else %}
                <div class="related-image" style="display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #667eea; opacity: 0.3; background: #f8f9fa;">üì±</div>
              {% endif %}
              <div class="related-info">
                <div class="related-name">{{ related.display_name }}</div>
                <div class="related-price">KSh {{ related.selling_price|floatformat:0 }}</div>
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>
</section>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>

<script>
  // Add CSS for animations
  const style = document.createElement('style');
  style.textContent = `
    .btn-add-cart.adding-to-cart {
      background: linear-gradient(135deg, #10b981, #059669) !important;
      transform: scale(0.95);
      transition: all 0.3s ease;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .product-gallery:hover .main-image {
      animation: pulse 2s ease-in-out infinite;
    }
    
    .stock-info {
      animation: fadeInUp 0.5s ease;
    }
    
    .price-current {
      position: relative;
      overflow: hidden;
    }
    
    .price-current::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.2), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
  `;
  document.head.appendChild(style);

  // Quantity controls
  function increaseQuantity() {
    const input = document.getElementById('quantity');
    if (!input) return;
    
    const max = parseInt(input.max);
    const current = parseInt(input.value);
    if (current < max) {
      input.value = current + 1;
    }
  }

  function decreaseQuantity() {
    const input = document.getElementById('quantity');
    if (!input) return;
    
    const min = parseInt(input.min);
    const current = parseInt(input.value);
    if (current > min) {
      input.value = current - 1;
    }
  }

  // Tab switching
  function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // Remove active from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Find and activate the clicked button
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => {
      if (btn.textContent.toLowerCase().includes(tabName.toLowerCase())) {
        btn.classList.add('active');
      }
    });
  }

  // Show toast notification
  function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    if (!toast) return;
    
    // Set message and style
    toast.textContent = message;
    toast.className = 'toast';
    
    // Add type class
    if (type === 'success') {
      toast.style.borderLeft = '4px solid #10b981';
    } else if (type === 'error') {
      toast.style.borderLeft = '4px solid #ef4444';
    } else if (type === 'warning') {
      toast.style.borderLeft = '4px solid #f59e0b';
    } else {
      toast.style.borderLeft = '4px solid #667eea';
    }
    
    // Show toast
    toast.classList.add('show');
    
    // Hide after 3 seconds
    setTimeout(() => {
      toast.classList.remove('show');
    }, 3000);
  }

  // Add to cart
  function addToCart() {
    const button = document.querySelector('.btn-add-cart');
    if (!button || button.disabled) return;
    
    const productId = button.dataset.productId;
    const productName = button.dataset.productName;
    const productPrice = parseFloat(button.dataset.productPrice);
    const productCode = button.dataset.productCode;
    
    // Check if product is bulk item
    const quantityInput = document.getElementById('quantity');
    let isBulkItem = false;
    if (quantityInput) {
      isBulkItem = true;
    }
    
    // Get quantity
    const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
    
    // Validate quantity
    if (quantity < 1) {
      showToast('‚ùå Please select at least 1 item', 'error');
      return;
    }
    
    // Get existing cart
    let cart = JSON.parse(localStorage.getItem('fieldmax_cart') || '[]');
    
    // Check if product already exists in cart
    const existingItemIndex = cart.findIndex(item => item.id == productId);
    
    if (existingItemIndex !== -1) {
      // Update existing item quantity
      if (isBulkItem) {
        const newQuantity = cart[existingItemIndex].quantity + quantity;
        cart[existingItemIndex].quantity = newQuantity;
        cart[existingItemIndex].subtotal = cart[existingItemIndex].price * newQuantity;
        showToast('‚úÖ Quantity updated in cart', 'success');
      } else {
        showToast('‚ö†Ô∏è This single item is already in your cart', 'warning');
        return;
      }
    } else {
      // Add new item to cart
      const cartItem = {
        id: productId,
        name: productName,
        price: productPrice,
        quantity: quantity,
        subtotal: productPrice * quantity,
        code: productCode,
        is_single_item: !isBulkItem,
        max_quantity: quantityInput ? parseInt(quantityInput.max) : 1
      };
      
      cart.push(cartItem);
      showToast('‚úÖ ' + productName + ' added to cart!', 'success');
    }
    
    // Save to localStorage
    localStorage.setItem('fieldmax_cart', JSON.stringify(cart));
    
    // Update cart count in navbar
    updateCartCount();
    
    // Animate button
    animateAddToCart(button);
  }

  // Update cart count in navbar
  function updateCartCount() {
    let cart = JSON.parse(localStorage.getItem('fieldmax_cart') || '[]');
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    // Update cart badge if it exists
    const cartBadge = document.querySelector('.cart-badge');
    if (cartBadge) {
      cartBadge.textContent = totalItems;
      cartBadge.style.display = totalItems > 0 ? 'flex' : 'none';
    }
  }

  // Animate add to cart button
  function animateAddToCart(button) {
    const originalHTML = button.innerHTML;
    
    // Add animation class
    button.classList.add('adding-to-cart');
    button.innerHTML = '<span>‚úÖ</span><span>Added!</span>';
    button.disabled = true;
    
    // Reset after animation
    setTimeout(() => {
      button.classList.remove('adding-to-cart');
      button.innerHTML = originalHTML;
      button.disabled = false;
    }, 1500);
  }

  // Add to wishlist
  function addToWishlist() {
    const button = document.querySelector('.btn-wishlist');
    if (!button) return;
    
    const productId = '{{ product.id }}';
    const productName = '{{ product.display_name }}';
    const productPrice = parseFloat('{{ product.selling_price|default:0 }}');
    
    // Get existing wishlist
    let wishlist = JSON.parse(localStorage.getItem('fieldmax_wishlist') || '[]');
    
    // Check if product already in wishlist
    const existingIndex = wishlist.findIndex(item => item.id == productId);
    
    if (existingIndex !== -1) {
      // Remove from wishlist
      wishlist.splice(existingIndex, 1);
      button.innerHTML = 'ü§ç';
      showToast('Removed from wishlist', 'info');
    } else {
      // Add to wishlist
      wishlist.push({
        id: productId,
        name: productName,
        price: productPrice,
        image: '{{ product.image.url|default:"" }}'
      });
      button.innerHTML = '‚ù§Ô∏è';
      showToast('Added to wishlist!', 'success');
    }
    
    // Save to localStorage
    localStorage.setItem('fieldmax_wishlist', JSON.stringify(wishlist));
    
    // Animate button
    button.style.transform = 'scale(1.2)';
    setTimeout(() => {
      button.style.transform = 'scale(1)';
    }, 300);
  }

  // Share product
  function shareProduct() {
    const productUrl = window.location.href;
    const productName = '{{ product.display_name }}';
    
    if (navigator.share) {
      // Use Web Share API if available
      navigator.share({
        title: productName,
        text: 'Check out this product from Fieldmax Electronics:',
        url: productUrl,
      })
      .then(() => showToast('‚úÖ Product shared!', 'success'))
      .catch(error => {
        console.log('Error sharing:', error);
        copyToClipboard(productUrl);
      });
    } else {
      // Fallback to clipboard
      copyToClipboard(productUrl);
    }
  }

  // Copy to clipboard
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text)
      .then(() => showToast('‚úÖ Link copied to clipboard!', 'success'))
      .catch(err => {
        console.error('Failed to copy:', err);
        showToast('‚ùå Failed to copy link', 'error');
      });
  }

  // Image zoom functionality
  function initImageZoom() {
    const mainImage = document.querySelector('.main-image');
    const mainImageContainer = document.querySelector('.main-image-container');
    
    if (mainImage && mainImageContainer) {
      mainImageContainer.addEventListener('mousemove', function(e) {
        if (window.innerWidth > 768) { // Only on desktop
          const rect = this.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;
          
          mainImage.style.transformOrigin = `${x}% ${y}%`;
          mainImage.style.transform = 'scale(1.5)';
        }
      });
      
      mainImageContainer.addEventListener('mouseleave', function() {
        mainImage.style.transform = 'scale(1)';
        mainImage.style.transformOrigin = 'center';
      });
    }
  }

  // Track product view
  function trackProductView() {
    const productId = '{{ product.id }}';
    const productName = '{{ product.display_name }}';
    const productPrice = parseFloat('{{ product.selling_price|default:0 }}');
    
    // Get recently viewed
    let recentlyViewed = JSON.parse(localStorage.getItem('fieldmax_recently_viewed') || '[]');
    
    // Remove if already exists
    recentlyViewed = recentlyViewed.filter(item => item.id != productId);
    
    // Add to beginning
    recentlyViewed.unshift({
      id: productId,
      name: productName,
      price: productPrice,
      viewed_at: new Date().toISOString()
    });
    
    // Keep only last 10 items
    if (recentlyViewed.length > 10) {
      recentlyViewed = recentlyViewed.slice(0, 10);
    }
    
    // Save to localStorage
    localStorage.setItem('fieldmax_recently_viewed', JSON.stringify(recentlyViewed));
  }

  // Check stock status
  function checkStockStatus() {
    const stockStatus = '{{ product.status }}';
    const button = document.querySelector('.btn-add-cart');
    
    if (!button) return;
    
    if (stockStatus === 'sold' || stockStatus === 'outofstock') {
      button.innerHTML = '<span>‚ùå</span><span>Out of Stock</span>';
      button.disabled = true;
      button.style.opacity = '0.6';
    }
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize cart count
    updateCartCount();
    
    // Initialize quantity input for bulk items
    const quantityInput = document.getElementById('quantity');
    if (quantityInput) {
      quantityInput.addEventListener('change', function() {
        const max = parseInt(this.max);
        const value = parseInt(this.value);
        
        if (value > max) {
          this.value = max;
          showToast('‚ùå Maximum quantity is ' + max, 'error');
        } else if (value < 1) {
          this.value = 1;
          showToast('‚ùå Minimum quantity is 1', 'error');
        }
      });
    }
    
    // Check if product is already in cart
    const productId = '{{ product.id }}';
    let cart = JSON.parse(localStorage.getItem('fieldmax_cart') || '[]');
    const existingItem = cart.find(item => item.id == productId);
    
    if (existingItem) {
      const button = document.querySelector('.btn-add-cart');
      const quantityInput = document.getElementById('quantity');
      
      if (quantityInput) {
        // Update quantity input to match cart
        quantityInput.value = existingItem.quantity;
      } else if (existingItem.is_single_item) {
        // For single items, disable the button
        button.innerHTML = '<span>‚úÖ</span><span>Already in Cart</span>';
        button.disabled = true;
        button.style.opacity = '0.8';
      }
    }
    
    // Initialize image zoom
    initImageZoom();
    
    // Initialize product view tracking
    trackProductView();
    
    // Check stock status
    checkStockStatus();
  });

  // Check if mobile device
  function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  }
</script>
{% endblock %}