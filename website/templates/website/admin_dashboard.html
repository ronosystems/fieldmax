{% extends "website/base.html" %}
{% block title %}Dashboard - Fieldmax Shop{% endblock %}


{% block content %}
<style>
/* Dashboard Specific Styles */
.dashboard-wrapper {
  display: flex;
  min-height: calc(100vh - 160px);
  background-color: #8ec4fa;
  position: relative;
}

/* Sidebar */
.dashboard-sidebar {
  width: 260px;
  background: #ffffff;
  border-right: 1px solid #e5e7eb;
  padding: 1.5rem 0;
  position: sticky;
  top: 76px;
  height: calc(100vh - 76px);
  overflow-y: auto;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
  flex-shrink: 0;
}

.sidebar-header {
  padding: 0 1.5rem 1.5rem;
  border-bottom: 2px solid #e5e7eb;
  margin-bottom: 1rem;
}

.sidebar-title {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  color: #1a1f2e;
  font-size: 1.25rem;
  font-weight: 700;
  margin: 0;
}

.sidebar-title i {
  font-size: 1.75rem;
  color: #0dcaf0;
}

.sidebar-nav {
  padding: 0 1rem;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  color: #6c757d;
  font-weight: 500;
  border-radius: 0.5rem;
  transition: all 0.3s ease;
  cursor: pointer;
  border: none;
  background: transparent;
  width: 100%;
  text-align: left;
  font-size: 0.95rem;
  text-decoration: none;
  margin-bottom: 0.25rem;
}

.nav-item:hover {
  background: #f3f4f6;
  color: #1a1f2e;
}

.nav-item.active {
  background: linear-gradient(135deg, #0dcaf0 0%, #0ab4d6 100%);
  color: #ffffff;
  box-shadow: 0 2px 4px rgba(13, 202, 240, 0.3);
}

.nav-item i {
  font-size: 1.25rem;
  width: 24px;
  text-align: center;
}

.nav-item .bi-chevron-down {
  margin-left: auto;
  font-size: 0.875rem;
  transition: transform 0.3s ease;
}

.nav-item[aria-expanded="true"] .bi-chevron-down {
  transform: rotate(180deg);
}

.submenu {
  margin-left: 2.5rem;
  margin-top: 0.5rem;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  padding-bottom: 0.5rem;
}

.submenu-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  color: #6c757d;
  font-size: 0.875rem;
  border-radius: 0.375rem;
  transition: all 0.3s ease;
  text-decoration: none;
  cursor: pointer;
}

.submenu-item:hover {
  background: #f3f4f6;
  color: #1a1f2e;
  transform: translateX(5px);
}

.submenu-item.active {
  background: #e0f7ff;
  color: #0dcaf0;
  font-weight: 600;
}

.submenu-item i {
  font-size: 1rem;
}

/* Main Content Area */
.dashboard-content {
  flex: 1;
  padding: 2rem;
  overflow-x: hidden;
}

.content-section {
  display: none;
}

.content-section.active {
  display: block;
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.content-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2rem;
  gap: 1rem;
  flex-wrap: wrap;
}

.page-title {
  font-size: 2rem;
  font-weight: 500;
  color: #1a1f2e;
  margin: 0;
}

.mobile-sidebar-toggle {
  display: none;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  color: #1a1f2e;
  font-size: 1.5rem;
  padding: 0.5rem 0.75rem;
  border-radius: 0.5rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.mobile-sidebar-toggle:hover {
  background: #0dcaf0;
  color: #ffffff;
  border-color: #0dcaf0;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.stat-card {
  display: flex;
  align-items: center;
  gap: 1.25rem;
  padding: 1.5rem;
  background: #ffffff;
  border-radius: 0.75rem;
  border: 1px solid #e5e7eb;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
  text-decoration: none;
  position: relative;
  overflow: hidden;
  cursor: pointer;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: #0dcaf0;
  transform: scaleY(0);
  transition: transform 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  border-color: #0dcaf0;
}

.stat-card:hover::before {
  transform: scaleY(1);
}

.stat-icon {
  width: 70px;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0.75rem;
  font-size: 2rem;
  flex-shrink: 0;
}

.stat-card-primary .stat-icon {
  background: linear-gradient(135deg, rgba(13, 202, 240, 0.15) 0%, rgba(13, 202, 240, 0.05) 100%);
  color: #0dcaf0;
}

.stat-card-success .stat-icon {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
  color: #10b981;
}

.stat-card-warning .stat-icon {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%);
  color: #f59e0b;
}

.stat-card-info .stat-icon {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.05) 100%);
  color: #3b82f6;
}

.stat-content {
  flex: 1;
}

.stat-label {
  display: block;
  font-size: 0.875rem;
  color: #000000;
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.stat-value {
  font-size: 1.25rem;
  font-weight: 400;
  color: #0040ff;
  margin: 0 0 0.25rem 0;
  line-height: 0.8;
}

.stat-subtitle {
  font-size: 0.8rem;
  color: #000000;
}

/* Dashboard Sections */
.dashboard-section {
  margin-bottom: 2rem;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.25rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.section-title-wrapper {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.section-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #000000;
  margin: 0;
}

.section-subtitle {
  font-size: 0.875rem;
  color: #000000;
}

.btn-action {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1.25rem;
  border-radius: 0.5rem;
  font-weight: 600;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  border: none;
  cursor: pointer;
  text-decoration: none;
}

.btn-primary {
  background: linear-gradient(135deg, #0dcaf0 0%, #0ab4d6 100%);
  color: #ffffff;
  box-shadow: 0 2px 4px rgba(13, 202, 240, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(13, 202, 240, 0.4);
  color: #ffffff;
}

.btn-success {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: #ffffff;
  box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
  color: #ffffff;
}

/* Data Card & Table */
.data-card {
  background: #ffffff;
  border-radius: 0.75rem;
  border: 1px solid #e5e7eb;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  overflow: hidden;
}

.table-wrapper {
  overflow-x: auto;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
}

.data-table thead {
  background: #ff0000;
}

.data-table th {
  padding: 1rem 1.25rem;
  text-align: left;
  font-size: 0.8rem;
  font-weight: 600;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid #e5e7eb;
}

.data-table td {
  padding: 1rem 1.25rem;
  border-bottom: 1px solid #f3f4f6;
  color: #1a1f2e;
  font-size: 0.925rem;
}

.data-table tbody tr {
  transition: background-color 0.15s ease;
}

.data-table tbody tr:hover {
  background: #f9fafb;
}

.data-table tbody tr:last-child td {
  border-bottom: none;
}

.table-cell-content {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.table-cell-content i {
  font-size: 1.25rem;
}

.text-primary {
  color: #0dcaf0 !important;
}

.text-success {
  color: #10b981 !important;
}

.text-end {
  text-align: right !important;
}

.text-center {
  text-align: center !important;
}

/* Badges */
.badge {
  display: inline-flex;
  padding: 0.375rem 0.75rem;
  font-size: 0.8rem;
  font-weight: 500;
  border-radius: 0.375rem;
}

.bg-secondary {
  background: #6c757d !important;
  color: #ffffff !important;
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-end;
}

.action-btn {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0.5rem;
  border: 1px solid #e5e7eb;
  background: #ffffff;
  color: #6c757d;
  transition: all 0.3s ease;
  cursor: pointer;
  text-decoration: none;
}

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.action-btn-edit:hover {
  background: #0dcaf0;
  color: #ffffff;
  border-color: #0dcaf0;
}

.action-btn-delete:hover {
  background: #ef4444;
  color: #ffffff;
  border-color: #ef4444;
}

.action-btn-info:hover {
  background: #3b82f6;
  color: #ffffff;
  border-color: #3b82f6;
}

.action-btn-warning:hover {
  background: #f59e0b;
  color: #ffffff;
  border-color: #f59e0b;
}

/* Special Elements */
.sale-id {
  font-family: 'Courier New', monospace;
  color: #6c757d;
  font-weight: 600;
}

.price-tag {
  color: #10b981;
  font-weight: 700;
  font-size: 1.05rem;
}

.empty-state {
  padding: 3rem !important;
  color: #6c757d;
  text-align: center;
}

.empty-state i {
  font-size: 3rem;
  color: #d1d5db;
  display: block;
  margin-bottom: 1rem;
}

.empty-state p {
  margin: 0;
  font-size: 1rem;
}

/* Form Styles */
.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: #1a1f2e;
  font-size: 0.95rem;
}

.form-label.required::after {
  content: ' *';
  color: #ef4444;
}

.form-control,
.form-select {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #e5e7eb;
  border-radius: 0.5rem;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  margin-bottom: 1rem;
}

.form-control:focus,
.form-select:focus {
  outline: none;
  border-color: #0dcaf0;
  box-shadow: 0 0 0 3px rgba(13, 202, 240, 0.1);
}

.form-check {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.form-check-input {
  width: 1.25rem;
  height: 1.25rem;
  cursor: pointer;
}

.form-check-label {
  cursor: pointer;
  user-select: none;
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  padding: 2rem;
  border-radius: 0.75rem;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-content h3 {
  margin: 0 0 1rem 0;
  color: #1a1f2e;
  font-size: 1.5rem;
}

.modal-actions {
  margin-top: 1.5rem;
  display: flex;
  justify-content: space-between;
  gap: 1rem;
}

.modal-actions button {
  flex: 1;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 0.5rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

/* Alert Styles */
.alert {
  padding: 1rem;
  border-radius: 0.5rem;
  margin-bottom: 1rem;
}

.alert-info {
  background: #e0f7ff;
  border: 1px solid #0dcaf0;
  color: #0a7a8f;
}

.alert-success {
  background: #d1fae5;
  border: 1px solid #10b981;
  color: #065f46;
}

.alert-danger {
  background: #fee2e2;
  border: 1px solid #ef4444;
  color: #991b1b;
}

/* Responsive Design */
@media (max-width: 992px) {
  .dashboard-wrapper {
    flex-direction: column;
  }

  .dashboard-sidebar {
    position: fixed;
    left: -260px;
    top: 76px;
    z-index: 998;
    transition: left 0.3s ease;
  }

  .dashboard-sidebar.active {
    left: 0;
  }

  .mobile-sidebar-toggle {
    display: block;
  }

  .dashboard-content {
    padding: 1.5rem;
  }

  .stats-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .dashboard-content {
    padding: 1rem;
  }

  .page-title {
    font-size: 1.5rem;
  }

  .stat-value {
    font-size: 1.75rem;
  }

  .stat-card {
    flex-direction: column;
    text-align: center;
  }

  .section-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .data-table th,
  .data-table td {
    padding: 0.75rem;
    font-size: 0.85rem;
  }
}

@media (max-width: 576px) {
  .content-header {
    flex-direction: column;
    align-items: flex-start;
  }
}


.toast-message {
    position: fixed;
    top: 20px;
    right: -300px;
    padding: 15px 20px;
    background: #28a745;
    color: white;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: all 0.4s ease;
    z-index: 9999;
    font-weight: bold;
}
.toast-message.error {
    background: #dc3545;
}
.toast-message.show {
    right: 20px;
}

/* ================================
   ACTION BUTTONS
================================ */
.action-buttons { display: flex; gap: 6px; justify-content: flex-end; }
.action-btn { width: 32px; height: 32px; border: none; cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
.action-btn i { font-size: 16px; }
.action-btn-edit { background: #0d6efd20; color: #0d6efd; }
.action-btn-edit:hover { background: #0d6efd; color: #fff; }
.action-btn-info { background: #0dcaf020; color: #0dcaf0; }
.action-btn-info:hover { background: #0dcaf0; color: #fff; }
.action-btn-delete { background: #dc354520; color: #dc3545; }
.action-btn-delete:hover { background: #dc3545; color: #fff; }

/* ================================
   MODAL BASE STYLE
================================ */
.modal-overlay { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); align-items: center; justify-content: center; }
.modal-content { background: #fff; padding: 25px; border-radius: 10px; width: 400px; position: relative; animation: popIn 0.3s ease-out; }
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* Modal titles and buttons */
.modal-content h3 { margin-top: 0; font-weight: 600; }
.modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.btn-cancel { background: #6c757d; color: #fff; padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; }
.btn-cancel:hover { opacity: 0.8; }
.btn-save, .btn-confirm-delete { background: #0d6efd; color: #fff; padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; }
.btn-save:hover, .btn-confirm-delete:hover { opacity: 0.85; }
.warning-icon { font-size: 36px; color: #dc3545; text-align: center; margin-bottom: 10px; }
.delete-text, .delete-warning-note { text-align: center; margin: 5px 0; font-weight: 500; }

/* Badge Styles */
.badge {
  display: inline-block;
  padding: 4px 8px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 4px;
  white-space: nowrap;
}

.badge-success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.badge-danger {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.badge-warning {
  background-color: #fff3cd;
  color: #856404;
  border: 1px solid #ffeeba;
}

/* Modal Styles */
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: #fff;
  margin: 10% auto;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.close-modal {
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  color: #aaa;
}

.close-modal:hover {
  color: #000;
}

#etr-modal-body {
  margin-top: 20px;
}

#etr-modal-body p {
  margin: 10px 0;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 4px;
}

#etr-modal-body strong {
  display: inline-block;
  width: 150px;
  color: #495057;
}

/* Enhanced Product Table Styles */
.product-row {
  transition: all 0.2s ease;
}

.product-row:hover {
  background-color: #f9fafb !important;
  transform: scale(1.001);
}

.product-row.hidden {
  display: none;
}

/* Stock status highlighting */
.product-row[data-stock-status="outofstock"] {
  background-color: #fee2e2 !important;
}

.product-row[data-stock-status="lowstock"] {
  background-color: #fef3c7 !important;
}

/* Badge styles */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  font-size: 11px;
  font-weight: 600;
  border-radius: 4px;
  white-space: nowrap;
}

.badge-success {
  background-color: #d1fae5;
  color: #065f46;
  border: 1px solid #6ee7b7;
}

.badge-warning {
  background-color: #fef3c7;
  color: #92400e;
  border: 1px solid #fcd34d;
}

.badge-danger {
  background-color: #fee2e2;
  color: #991b1b;
  border: 1px solid #fca5a5;
}

.stat-card-danger .stat-icon {
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%);
  color: #ef4444;
}

/* Action button colors */
.action-btn-warning {
  background: rgba(245, 158, 11, 0.1);
  color: #f59e0b;
  border: 1px solid rgba(245, 158, 11, 0.2);
}

.action-btn-warning:hover {
  background: #f59e0b;
  color: white;
  border-color: #f59e0b;
}

/* Modal enhancements */
.modal-content {
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header-custom {
  padding: 20px 25px;
  border-radius: 10px 10px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-body-custom {
  padding: 25px;
  max-height: 60vh;
  overflow-y: auto;
}

.form-input, .form-select {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #e5e7eb;
  border-radius: 6px;
  font-size: 14px;
  transition: all 0.3s ease;
}

.form-input:focus, .form-select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #374151;
  font-size: 14px;
}

/* Modal Overlay - Blocks entire screen */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 9998;
  backdrop-filter: blur(3px);
}

/* Custom Modal */
.custom-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

/* Modal Container */
.modal-container {
  background: white;
  border-radius: 10px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  width: 100%;
  max-width: 500px;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Modal Header */
.modal-header-custom {
  padding: 20px 25px;
  border-radius: 10px 10px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header-custom.bg-warning {
  background: #ffc107;
  color: #000;
}

.modal-header-custom.bg-primary {
  background: #007bff;
  color: white;
}

.modal-title {
  margin: 0;
  font-size: 20px;
  font-weight: bold;
}

.close-btn {
  background: transparent;
  border: none;
  font-size: 30px;
  cursor: pointer;
  color: inherit;
  line-height: 1;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-btn:hover {
  opacity: 0.7;
}

/* Modal Body */
.modal-body-custom {
  padding: 25px;
}

.modal-body-custom p {
  margin: 10px 0;
  font-size: 15px;
  line-height: 1.6;
}

/* Form Styles */
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #333;
  font-size: 14px;
}

.form-input {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 15px;
  transition: all 0.3s ease;
}

.form-input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

/* Modal Footer */
.modal-footer-custom {
  padding: 20px 25px;
  border-top: 1px solid #e9ecef;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.sale-row[data-status="reversed"] {
  background-color: #fef3c7 !important;
  opacity: 0.75;
}

.sale-row[data-status="reversed"]:hover {
  background-color: #fde68a !important;
  opacity: 0.85;
}

/* Hide reversed sales when filter is active */
.sale-row.hidden {
  display: none;
}

/* Reverse button animation */
.reverse-sale-btn {
  transition: all 0.3s ease;
}

.reverse-sale-btn:hover {
  transform: rotate(180deg);
}

/* Modal textarea focus */
.form-control:focus {
  outline: none;
  border-color: #f59e0b;
  box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
}

/* Buttons */
.btn-cancel {
  padding: 10px 20px;
  background: #6c757d;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.3s ease;
}

.btn-cancel:hover {
  background: #5a6268;
  transform: translateY(-2px);
}

.btn-save {
  padding: 10px 20px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.3s ease;
}

.btn-save:hover {
  background: #218838;
  transform: translateY(-2px);
}

.btn-proceed {
  padding: 10px 20px;
  background: #ffc107;
  color: #000;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  text-decoration: none;
  display: inline-block;
  transition: all 0.3s ease;
}

.btn-proceed:hover {
  background: #e0a800;
  transform: translateY(-2px);
}

/* Enhanced styles for sale type badges */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  font-size: 11px;
  font-weight: 800;
  border-radius: 4px;
  white-space: nowrap;
}

.sale-row[data-status="reversed"] {
  background-color: #fef3c7 !important;
  opacity: 0.8;
}

.sale-row[data-status="reversed"]:hover {
  background-color: #0d10d4 !important;
}

/* Filter animations */
.sale-row.hidden {
  display: none;
}

/* in your CSS file */
.stock-instock { color: #10b981; }
.stock-lowstock { color: #f59e0b; }
.stock-outofstock { color: #ef4444; }
.stock-sold { color: #ef4444; }

.margin-high { background: #10b981; color: white; }
.margin-medium { background: #f59e0b; color: white; }
.margin-low { background: #ef4444; color: white; }
.required::after {
  content: " *";
  color: #dc3545;
}

.data-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  overflow: hidden;
}

.card-header {
  padding: 1.25rem 2rem;
  border-bottom: 2px solid rgba(255,255,255,0.2);
}

.card-body {
  min-height: 500px;
}

.form-control:focus {
  border-color: #10b981;
  box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25);
}

.btn:disabled {
  cursor: not-allowed;
  opacity: 0.5;
}

/* Product Details Animations */
#productDetails {
  animation: fadeInUp 0.4s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Empty State Animation */
#emptyState i {
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 0.6; }
}

/* Badge Styles */
.product-badge {
  font-size: 0.875rem;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-weight: 600;
}

.badge.bg-success {
  background-color: #10b981 !important;
}

.badge.bg-warning {
  background-color: #f59e0b !important;
  color: #000;
}

.badge.bg-danger {
  background-color: #ef4444 !important;
}

/* Product Info Card */
.product-info-card {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 12px;
  padding: 1.5rem;
  border: 2px solid #e2e8f0;
}

.product-info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  border-bottom: 1px solid #e2e8f0;
}

.product-info-item:last-child {
  border-bottom: none;
}

.product-info-label {
  color: #64748b;
  font-size: 0.875rem;
  font-weight: 500;
}

.product-info-value {
  color: #1e293b;
  font-size: 1rem;
  font-weight: 600;
}

/* Responsive adjustments */
@media (max-width: 991px) {
  .col-lg-6 {
    margin-bottom: 1.5rem;
  }
  
  .card-body {
    min-height: auto;
  }
}

/* FIFO Age Badge */
.fifo-badge {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-size: 0.875rem;
  display: inline-block;
  margin-top: 0.5rem;
}

/* Sold Product Alert Styling */
.sold-alert {
  border-left: 4px solid #ef4444;
  background: #fef2f2;
  padding: 1.5rem;
  border-radius: 8px;
}

/* Available Product Styling */
.available-alert {
  border-left: 4px solid #10b981;
  background: #f0fdf4;
  padding: 1.5rem;
  border-radius: 8px;
}

.action-buttons {
  display: flex;
  gap: 8px; /* Adjust spacing as needed */
}

/* small visual for dragging */
th.draggable {
  cursor: move;
  user-select: none;
}
th.dragging {
  opacity: 0.5;
}


/* Grid lines for table */
.data-table {
  border-collapse: collapse;
  border: 1px solid #dee2e6;
}

.data-table thead th {
  border: 1px solid #dee2e6;
  background-color: #f8f9fa;
}

.data-table tbody td {
  border: 1px solid #dee2e6;
}

.data-table tbody tr:hover {
  background-color: #f8f9fa;
}

/* Search and entries controls */
.table-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  gap: 1rem;
  flex-wrap: wrap;
}

.entries-control {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.search-control {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex: 1;
  max-width: 400px;
}

.search-control input {
  flex: 1;
  padding: 0.5rem 1rem;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  font-size: 0.9rem;
}

.search-control button {
  padding: 0.5rem 1rem;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.search-control button:hover {
  background: #2563eb;
}

.entries-control select {
  padding: 0.5rem;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  font-size: 0.9rem;
}

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  user-select: none;
}

.dropdown-icon {
  transition: transform 0.3s ease;
  font-size: 1.2rem;
}

.dropdown-icon.rotated {
  transform: rotate(180deg);
}

.stat-dropdown {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-top: 0;
}

.stat-dropdown.active {
  max-height: 300px;
  margin-top: 1rem;
}

.stat-dropdown .stat-subtitle {
  padding: 0.25rem 0;
}



/* ============================================
   ENHANCED DASHBOARD SIDEBAR MOBILE STYLES
   Add this CSS to your dashboard template
   ============================================ */

/* Responsive Design for Sidebar */
@media (max-width: 992px) {
  .dashboard-wrapper {
    flex-direction: column;
  }

  /* Sidebar Mobile Positioning */
  .dashboard-sidebar {
    position: fixed;
    left: -280px; /* Hidden off-screen */
    top: 76px;
    width: 260px;
    height: calc(100vh - 76px);
    z-index: 998;
    transition: left 0.3s ease;
    box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
    overflow-y: auto;
  }

  /* Sidebar Active State (Visible) */
  .dashboard-sidebar.active {
    left: 0;
  }

  /* Mobile Sidebar Toggle Button */
  .mobile-sidebar-toggle {
    display: flex !important;
    align-items: center;
    justify-content: center;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    color: #1a1f2e;
    font-size: 1.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .mobile-sidebar-toggle:hover {
    background: #0dcaf0;
    color: #ffffff;
    border-color: #0dcaf0;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(13, 202, 240, 0.3);
  }

  .mobile-sidebar-toggle:active {
    transform: translateY(0);
  }

  /* Overlay for Sidebar */
  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 76px;
    left: 0;
    width: 100%;
    height: calc(100vh - 76px);
    background: rgba(0, 0, 0, 0.5);
    z-index: 997;
    opacity: 0;
    transition: opacity 0.3s ease;
    backdrop-filter: blur(2px);
  }

  .sidebar-overlay.active {
    display: block;
    opacity: 1;
  }

  /* Dashboard Content Adjustments */
  .dashboard-content {
    padding: 1.5rem 1rem;
    width: 100%;
  }

  /* Stats Grid Mobile */
  .stats-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  /* Content Header Mobile */
  .content-header {
    flex-direction: row;
    align-items: center;
    gap: 0.75rem;
  }

  .page-title {
    font-size: 1.5rem;
  }
}

/* Tablet Adjustments */
@media (max-width: 768px) {
  .dashboard-sidebar {
    width: 240px;
    left: -260px;
  }

  .dashboard-content {
    padding: 1rem;
  }

  .page-title {
    font-size: 1.25rem;
  }

  .stat-value {
    font-size: 1.5rem;
  }

  .stat-card {
    padding: 1rem;
  }

  .section-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .data-table th,
  .data-table td {
    padding: 0.75rem;
    font-size: 0.85rem;
  }
}

/* Small Mobile Adjustments */
@media (max-width: 576px) {
  .dashboard-sidebar {
    width: 220px;
    left: -240px;
  }

  .mobile-sidebar-toggle {
    font-size: 1.25rem;
    padding: 0.4rem 0.6rem;
  }

  .content-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }

  .page-title {
    font-size: 1.1rem;
  }

  .stat-card {
    flex-direction: column;
    text-align: center;
    padding: 0.875rem;
  }

  .stat-icon {
    width: 50px;
    height: 50px;
    font-size: 1.5rem;
  }

  .stat-value {
    font-size: 1.25rem;
  }

  .data-table th,
  .data-table td {
    padding: 0.5rem;
    font-size: 0.8rem;
  }
}

/* Extra Small Mobile */
@media (max-width: 380px) {
  .dashboard-sidebar {
    width: 200px;
    left: -220px;
  }

  .mobile-sidebar-toggle {
    font-size: 1.1rem;
    padding: 0.35rem 0.5rem;
  }

  .page-title {
    font-size: 1rem;
  }

  .navbar-content {
    padding: 0.625rem 0.75rem;
  }
}

/* Landscape Orientation Mobile */
@media (max-height: 500px) and (orientation: landscape) {
  .dashboard-sidebar {
    height: 100vh;
    top: 0;
  }

  .sidebar-overlay {
    height: 100vh;
    top: 0;
  }
}

/* Touch Device Improvements */
@media (hover: none) and (pointer: coarse) {
  .mobile-sidebar-toggle {
    min-width: 44px;
    min-height: 44px;
  }

  .nav-item,
  .submenu-item {
    min-height: 44px;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
  }

  .dashboard-sidebar {
    -webkit-overflow-scrolling: touch;
  }
}

/* Prevent Body Scroll When Sidebar Open */
body.sidebar-open {
  overflow: hidden;
}

/* Smooth Scrolling for Sidebar */
.dashboard-sidebar {
  scrollbar-width: thin;
  scrollbar-color: rgba(13, 202, 240, 0.3) transparent;
}

.dashboard-sidebar::-webkit-scrollbar {
  width: 6px;
}

.dashboard-sidebar::-webkit-scrollbar-track {
  background: transparent;
}

.dashboard-sidebar::-webkit-scrollbar-thumb {
  background: rgba(13, 202, 240, 0.3);
  border-radius: 3px;
}

.dashboard-sidebar::-webkit-scrollbar-thumb:hover {
  background: rgba(13, 202, 240, 0.5);
}

/* Animation Enhancement */
@keyframes slideIn {
  from {
    transform: translateX(-100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.dashboard-sidebar.active {
  animation: slideIn 0.3s ease-out;
}

/* ============================
   ADVANCED TRANSFER SEARCH STYLES
   Add these to your CSS file
   ============================ */

/* Autocomplete Dropdown Scrollbar */
#transferAutocompleteDropdown::-webkit-scrollbar {
  width: 8px;
}

#transferAutocompleteDropdown::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

#transferAutocompleteDropdown::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 10px;
}

#transferAutocompleteDropdown::-webkit-scrollbar-thumb:hover {
  background: #555;
}

/* Autocomplete Item Hover Animation */
.autocomplete-item {
  position: relative;
  overflow: hidden;
}

.autocomplete-item::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 0;
  background: linear-gradient(90deg, rgba(52, 152, 219, 0.1) 0%, transparent 100%);
  transition: width 0.3s ease;
}

.autocomplete-item:hover::before {
  width: 100%;
}

/* Product Card Selectable */
.product-card-selectable {
  position: relative;
  border: 2px solid transparent;
}

.product-card-selectable::after {
  content: 'â†’';
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%) translateX(-10px);
  opacity: 0;
  font-size: 1.5rem;
  color: #3498db;
  transition: all 0.3s ease;
}

.product-card-selectable:hover::after {
  opacity: 1;
  transform: translateY(-50%) translateX(0);
}

/* Product Info Card Styles */
.product-info-card {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 8px;
  padding: 16px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.product-info-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.product-info-label {
  font-size: 0.85rem;
  color: #6c757d;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.product-info-value {
  font-size: 1rem;
  color: #2c3e50;
  font-weight: 600;
}

/* Search Input Focus Effect */
#transferSearchInput:focus {
  border-color: #3498db;
  box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
  transform: translateY(-1px);
  transition: all 0.2s ease;
}

/* Loading Indicator Animation */
@keyframes spin {
  to { transform: rotate(360deg); }
}

#transferSearchingIndicator {
  animation: spin 1s linear infinite;
}

/* Empty State Styling */
#transferEmptyState {
  padding: 60px 20px;
  text-align: center;
  color: #95a5a6;
}

#transferEmptyState i {
  font-size: 4rem;
  margin-bottom: 20px;
  opacity: 0.5;
}

/* Button Hover Effects */
#transferSubmitBtn {
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
}

#transferSubmitBtn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

#transferSubmitBtn:hover::before {
  width: 300px;
  height: 300px;
}

#transferSubmitBtn:active {
  transform: scale(0.98);
}

/* Alert Animation */
.alert {
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    transform: translateY(-10px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* Responsive Design */
@media (max-width: 768px) {
  .product-info-card {
    grid-template-columns: 1fr;
  }
  
  #transferAutocompleteDropdown {
    max-height: 250px;
  }
}

/* Badge Animations */
.badge {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Highlight Effect */
strong[style*="background-color"] {
  padding: 2px 4px;
  border-radius: 3px;
  animation: highlight 0.5s ease;
}

@keyframes highlight {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
}

#imagePreviewContainer {
  text-align: center;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
}

#imagePreview {
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.btn-group button {
  flex: 1;
}

#cameraStream, #cameraCanvas {
  background: #000;
  max-height: 500px;
  width: 100%;
  object-fit: contain;
}

/* Ensure modal doesn't block page */
.modal-backdrop {
  z-index: 1040;
}

.modal {
  z-index: 1050;
}

#cameraLoading {
  width: 3rem;
  height: 3rem;
  margin: 50px auto;
}


#scanner-container {
  min-height: 300px;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
}

#barcodeScannerVideo {
  width: 100%;
  max-height: 500px;
  object-fit: contain;
}

#barcodeScannerCanvas {
  display: none;
}

#scanningOverlay {
  pointer-events: none;
}

#scannerResult {
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.input-group .btn {
  white-space: nowrap;
}


</style>

<div class="dashboard-wrapper">
  
<!-- ======================================== -->
<!-- ============SIDEBAR NAVIGATION ========= -->
<!-- ======================================== -->
  <aside class="dashboard-sidebar" id="dashboardSidebar">
    <div class="sidebar-header">
      <h2 class="sidebar-title">
        <i class="bi bi-grid-3x3-gap-fill"></i>
        <span>ADMIN PANEL</span>
      </h2>
      <div class="sidebar-user mt-2">
        <i class="bi bi-person-circle"></i>
        <span>
          {% if user.is_authenticated %}
           {{ user.get_full_name|default:user.username }}
          {% else %}
          Guest
          {% endif %}
        </span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="#dashboard" class="nav-item active" data-section="dashboard">
        <i class="bi bi-speedometer2"></i>
        <span>Dashboard</span>
      </a>
      <button class="nav-item" data-bs-toggle="collapse" data-bs-target="#productsSubmenu" aria-expanded="false">
        <i class="bi bi-box-seam"></i>
        <span>Products</span>
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="submenu collapse" id="productsSubmenu">
        <a href="#product-list" class="submenu-item" data-section="product-list">
          <i class="bi bi-list-ul"></i>
          <span>All Products</span>
        </a>
        <a href="{% url 'inventory:category-create' %}" class="submenu-item" data-section="add-category">
          <i class="bi bi-plus-circle"></i>
          <span>Add Category</span>
        </a>
        <a href="{% url 'inventory:product-create' %}" class="submenu-item" data-section="add-product">
          <i class="bi bi-plus-circle"></i>
          <span>Add Product</span>
        </a>
        <a href="#" class="submenu-item" data-section="restock-product">
          <i class="bi bi-plus-circle"></i>
          <span>Restock products</span>
        </a>
        <a href="#" class="submenu-item" data-section="transfer-product">
          <i class="bi bi-plus-circle"></i>
          <span>Transfer product</span>
        </a>
      </div>

      <button class="nav-item" data-bs-toggle="collapse" data-bs-target="#salesSubmenu" aria-expanded="false">
        <i class="bi bi-cart-check"></i>
        <span>Sales</span>
        <i class="bi bi-chevron-down"></i>
      </button>
      <div class="submenu collapse" id="salesSubmenu">
        <a href="#sales-list" class="submenu-item" data-section="sales-list">
          <i class="bi bi-list-check"></i>
          <span>All Sales</span>
        </a>
        <a href="#record-sale" class="submenu-item" data-section="record-sale">
          <i class="bi bi-plus-circle"></i>
          <span>Record Sale</span>
        </a>
        <a href="#generate-report" class="submenu-item" data-section="generate-report">
          <i class="bi bi-plus-circle"></i>
          <span>Generate Report</span>
        </a>       
      </div>

<!-- USER MANAGEMENT -->
      <div style="margin-top: auto; padding: 1rem; border-top: 2px solid #e5e7eb;">
        <button class="nav-item" data-bs-toggle="collapse" data-bs-target="#userSubmenu" aria-expanded="false" style="width: 100%;">
          <i class="bi bi-person-circle"></i>
          <span>User Management</span>
          <i class="bi bi-chevron-down"></i>
        </button>
        <div class="submenu collapse" id="userSubmenu">
          <a href="#users-list" class="submenu-item" data-section="users-list">
            <i class="bi bi-people"></i>
            <span>All Users</span>
          </a>
          <a href="#add-user" class="submenu-item" data-section="add-user">
            <i class="bi bi-person-plus"></i>
            <span>Add User</span>
          </a>
          <a href="#roles-permissions" class="submenu-item" data-section="roles-permissions">
            <i class="bi bi-shield-check"></i>
            <span>Roles & Permissions</span>
          </a>
          <form method="post" action="{% url 'logout' %}" style="margin: 0;">
            {% csrf_token %}
            <button type="submit" class="submenu-item" style="border: 1px solid #dc2626; background: #fee2e2; color: #dc2626; width: 100%;">
              <i class="bi bi-box-arrow-right"></i>
              <span>Logout</span>
            </button>
          </form>
        </div>
      </div>
    </nav>
  </aside>



<!-- ======================================== -->
<!-- ======= MAIN DASHBOARD CONTENTS========= -->
<!-- ======================================== -->
  <main class="dashboard-content">
    
    <!-- Dashboard Overview Section -->
    <div id="dashboard" class="content-section active">
      <!-- Content Header -->
      <div class="content-header">
        <button class="mobile-sidebar-toggle" id="mobileSidebarToggle">
          <i class="bi bi-list"></i>
        </button>
        <h1 class="page-title">Dashboard Overview</h1>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <!-- Column A: Inventory Card -->
        <div class="stat-card stat-card-success" data-section="product-list">
          <div class="stat-icon">
            <i class="bi bi-box-seam"></i>
          </div>
          <div class="stat-content">
            <div class="stat-header" onclick="toggleCardDropdown(this)">
              <span class="stat-label">Inventory</span>
              <i class="bi bi-chevron-down dropdown-icon"></i>
            </div>
            <h1 class="stat-value">{{ total_products|default:0 }}</h1>
            <div class="stat-dropdown">
              <span class="stat-subtitle">Products Count: {{ total_products|default:0 }}</span>
              <span class="stat-subtitle">Value: KSH {{ total_product_value|floatformat:2 }}</span>
              <span class="stat-subtitle">Cost: KSH {{ total_product_cost|floatformat:2 }}</span>
            </div>
          </div>
        </div>

        <!-- Column B: Sales Count Card -->
        <div class="stat-card stat-card-info" data-section="sales-list">
          <div class="stat-icon">
            <i class="bi bi-check-circle"></i>
          </div>
          <div class="stat-content">
            <div class="stat-header" onclick="toggleCardDropdown(this)">
              <span class="stat-label">Sales Count</span>
              <i class="bi bi-chevron-down dropdown-icon"></i>
            </div>
            <h1 class="stat-value">{{ total_sales_count|default:0 }}</h1>
            <div class="stat-dropdown">
              <span class="stat-subtitle">Daily: {{ daily_sales_count|default:0 }}</span>
              <span class="stat-subtitle">Weekly: {{ weekly_sales_count|default:0 }}</span>
              <span class="stat-subtitle">Monthly: {{ monthly_sales_count|default:0 }}</span>
            </div>
          </div>
        </div>

        <!-- Column C: Sales Value Card -->
        <div class="stat-card stat-card-success" data-section="sales-list">
          <div class="stat-icon">
            <i class="bi bi-cash-stack"></i>
          </div>
          <div class="stat-content">
            <div class="stat-header" onclick="toggleCardDropdown(this)">
              <span class="stat-label">Sales Value</span>
              <i class="bi bi-chevron-down dropdown-icon"></i>
            </div>
            <h1 class="stat-value">KSH {{ total_sales_value|floatformat:2|default:0 }}</h1>
            <div class="stat-dropdown">
              <span class="stat-subtitle">Daily: KSH {{ daily_sales_value|floatformat:2|default:0 }}</span>
              <span class="stat-subtitle">Weekly: KSH {{ weekly_sales_value|floatformat:2|default:0 }}</span>
              <span class="stat-subtitle">Monthly: KSH {{ monthly_sales_value|floatformat:2|default:0 }}</span>
            </div>
          </div>
        </div>

        <!-- Column D: Profits Card -->
        <div class="stat-card stat-card-warning" data-section="profits">
          <div class="stat-icon">
            <i class="bi bi-graph-up-arrow"></i>
          </div>
          <div class="stat-content">
            <div class="stat-header" onclick="toggleCardDropdown(this)">
              <span class="stat-label">Profits</span>
              <i class="bi bi-chevron-down dropdown-icon"></i>
            </div>
            <h1 class="stat-value">KSH {{ total_profit|floatformat:2|default:0 }}</h1>
            <div class="stat-dropdown">
              <span class="stat-subtitle">Daily: KSH {{ daily_profit|floatformat:2|default:0 }}</span>
              <span class="stat-subtitle">Weekly: KSH {{ weekly_profit|floatformat:2|default:0 }}</span>
              <span class="stat-subtitle">Monthly: KSH {{ monthly_profit|floatformat:2|default:0 }}</span>
            </div>
          </div>
        </div>

        <!-- Column E: Users Card -->
        <div class="stat-card stat-card-info" data-section="users-list">
          <div class="stat-icon">
            <i class="bi bi-people"></i>
          </div>
          <div class="stat-content">
            <div class="stat-header" onclick="toggleCardDropdown(this)">
              <span class="stat-label">Users</span>
              <i class="bi bi-chevron-down dropdown-icon"></i>
            </div>
            <h1 class="stat-value">{{ total_users|default:0 }}</h1>
            <div class="stat-dropdown">
              <span class="stat-subtitle">Cashiers: {{ total_cashiers|default:0 }}</span>
              <span class="stat-subtitle">Managers: {{ total_managers|default:0 }}</span>
              <span class="stat-subtitle">Agents: {{ total_agents|default:0 }}</span>
            </div>
          </div>
        </div>
      </div>


      






<!-- ======================================== -->
<!-- ========== SALES STATISTICS ========== -->
<!-- ======================================== -->
<section class="dashboard-section" style="margin-bottom: 2rem;">
  
  <!-- Section Header -->
  <div class="section-header">
    <div class="section-title-wrapper">
      <h2 class="section-title">Sales Statistics</h2>
      <span class="section-subtitle">Visual breakdown of sales performance</span>
    </div>
  </div>

  <!-- Two Column Layout -->
  <div class="row g-4">
    
    <!-- ==========================================
         COLUMN A: BAR CHART - SALES TRENDS
    ========================================== -->
    <div class="col-lg-6">
      <div class="data-card">
        <div class="card-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1rem 1.5rem;">
          <h5 class="mb-0">
            <i class="bi bi-bar-chart-line-fill"></i> Sales Trends (Last 7 Days)
          </h5>
        </div>
        <div class="card-body" style="padding: 1.5rem;">
          <canvas id="salesBarChart" style="max-height: 300px;"></canvas>
        </div>
      </div>
    </div>

    <!-- ==========================================
         COLUMN B: DONUT CHART - SALES BY CATEGORY
    ========================================== -->
    <div class="col-lg-6">
      <div class="data-card">
        <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1rem 1.5rem;">
          <h5 class="mb-0">
            <i class="bi bi-pie-chart-fill"></i> Sales by Category
          </h5>
        </div>
        <div class="card-body" style="padding: 1.5rem;">
          <canvas id="salesDonutChart" style="max-height: 300px;"></canvas>
        </div>
      </div>
    </div>

  </div><!-- End Row -->
  
</section>




      







      
<!-- ======================================== -->
<!-- ============== RECENT PRODUCTS ========= -->
<!-- ======================================== -->
<section class="dashboard-section">

  <!-- Section Header -->
  <div class="section-header">
    <div class="section-title-wrapper">
      <h2 class="section-title">Recent Products</h2>
      <span class="section-subtitle">Latest additions to inventory</span>
    </div>
  </div>

<!-- Products Table -->
  <div class="data-card">
    <div class="table-wrapper">
      <table class="data-table" id="productsTable">
        <thead>
          <tr>
            <th><strong style="color:#ff0000;">PRODUCT CODE</strong></th>
            <th><strong style="color:#ff0000;">PRODUCT TYPE</strong></th>
            <th><strong style="color:#ff0000;">PRODUCT NAME</strong></th>
            <th><strong style="color:#ff0000;">CATEGORY</strong></th>
            <th><strong style="color:#ff0000;">STATUS</strong></th>
            <th><strong style="color:#ff0000;">STOCK</strong></th>
            <th><strong style="color:#ff0000;">BUYING PRICE</strong></th>
            <th><strong style="color:#ff0000;">SELLING PRICE</strong></th>
            <th><strong style="color:#ff0000;">% MARGIN</strong></th>
            <th><strong style="color:#ff0000;">OWNER</strong></th>
            <th><strong style="color:#ff0000;">DATE ADDED</strong></th>
          </tr>
        </thead>
        <tbody>
          {% for product_info in recent_products_with_margin_and_status %}
          {% with product=product_info.product %}
          <tr class="product-row" 
              id="product-row-{{ product.id }}"
              data-product-id="{{ product.id }}"
              data-category="{{ product.category.id }}"
              data-stock-status="{{ product_info.status }}"
              data-type="{% if product.category.is_single_item %}single{% else %}bulk{% endif %}">
            
            <!-- Product Code -->
            <td>
              <code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                {{ product.product_code }}
              </code>
            </td>

            <!-- Type Badge -->
            <td>
              {% if product.category.is_single_item %}
                <span class="badge" style="background: #3b82f6; color: white;">
                  <i class="bi bi-tag"></i> Single
                </span>
              {% else %}
                <span class="badge" style="background: #8b5cf6; color: white;">
                  <i class="bi bi-box-seam"></i> Bulk
                </span>
              {% endif %}
            </td>

            <!-- Product Name -->
            <td class="product-name"><strong>{{ product.name }}</strong></td>

            <!-- Category -->
            <td><span class="badge bg-secondary">{{ product.category.name }}</span></td>

          
<!-- STATUS BADGE -->
<td>
  {% if product.category.is_single_item %}
    {% if product.status == "sold" %}
      <span class="badge badge-danger">
        <i class="bi bi-x-circle-fill"></i> Sold Out
      </span>
    {% else %}
      <span class="badge badge-success">
        <i class="bi bi-check-circle-fill"></i> In Stock
      </span>
    {% endif %}
  {% else %}
    {% if product.quantity == 0 %}
      <span class="badge badge-danger">
        <i class="bi bi-x-circle-fill"></i> Out of Stock
      </span>
    {% elif product.quantity <= 5 %}
      <span class="badge badge-warning">
        <i class="bi bi-exclamation-triangle-fill"></i> Low Stock
      </span>
    {% else %}
      <span class="badge badge-success">
        <i class="bi bi-check-circle-fill"></i> In Stock
      </span>
    {% endif %}
  {% endif %}
</td>

<!-- STOCK COLUMN -->
<td class="product-quantity">
  {% if product.category.is_single_item %}
    {% if product.status == 'sold' %}
      <strong style="color: #dc3545; font-weight: bold;">
        <i class="bi bi-x-circle-fill"></i> SOLD
      </strong>
    {% else %}
      <strong style="color: #28a745; font-weight: bold;">
        <i class="bi bi-check-circle-fill"></i> Available
      </strong>
    {% endif %}
  {% else %}
    {% if product.quantity > 5 %}
      <strong style="color: #28a745; font-weight: bold;">
        {{ product.quantity }} units
      </strong>
    {% elif product.quantity > 0 %}
      <strong style="color: #ffc107; font-weight: bold;">
        {{ product.quantity }} units (Low)
      </strong>
    {% else %}
      <strong style="color: #dc3545; font-weight: bold;">
        0 units (Out)
      </strong>
    {% endif %}
  {% endif %}
</td>
            <!-- Buying Price -->
            <td>
              <strong class="price-green">KSH {{ product.buying_price|floatformat:2 }}</strong>
            </td>

            <!-- Selling Price -->
            <td>
              <strong class="price-green">KSH {{ product.selling_price|floatformat:2 }}</strong>
            </td>

            <!-- Margin -->
            <td>
              <span class="badge
                {% if product_info.margin_pct >= 30 %}margin-high
                {% elif product_info.margin_pct >= 15 %}margin-medium
                {% else %}margin-low
                {% endif %}">
                +{{ product_info.margin_pct|floatformat:0 }}%
              </span>
            </td>

            <!-- Owner -->
            <td>
              <div class="owner-field">
                <i class="bi bi-person-circle"></i>
                <span>{{ product.owner.username|default:"FIELDMAX" }}</span>
              </div>
            </td>

            <!-- Date -->
            <td>
              <span class="date-text">{{ product.created_at|date:"M d, Y" }}</span>
            </td>

          </tr>

          {% endwith %}
          {% empty %}

          <tr>
            <td colspan="12">
              <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <p>No products found in inventory.</p>
              </div>
            </td>
          </tr>

          {% endfor %}
        </tbody>

      </table>
    </div>
  </div>

</section>













<!-- ======================================== -->
<!-- ==========RECENT SALES SECTION ========= -->
<!-- ======================================== -->
<!-- Recent Sales -->
<section class="dashboard-section">
  <div class="section-header">
    <div class="section-title-wrapper">
      <h2 class="section-title">Recent Sales</h2>
      <span class="section-subtitle">Latest transactions</span>
    </div>
  </div>

  <div class="data-card">
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th><strong style="color:#ff0000;">SALE ID</strong></th>
            <th><strong style="color:#ff0000;">ETR NUMBER</strong></th>
            <th><strong style="color:#ff0000;">BUYER</strong></th>
            <th><strong style="color:#ff0000;">TOTAL PRICE</strong></th>
            <th><strong style="color:#ff0000;">SOLD BY</strong></th>
            <th><strong style="color:#ff0000;">DATE SOLD</strong></th>
            <th><strong style="color:#ff0000;">VIEW RECEIPT</strong></th>
          </tr>
        </thead>
        <tbody>
          {% for sale in recent_sales %}
          <tr>
            <!-- Sale ID -->
            <td>
              <strong>#{{ sale.sale_id }}</strong>
              {% if sale.is_reversed %}
                <span class="badge badge-warning" style="font-size: 10px; background: #fef3c7; color: #92400e;">
                  <i class="bi bi-arrow-counterclockwise"></i> REVERSED
                </span>
              {% endif %}
            </td>

            <!-- ETR -->
            <td>{{ sale.etr_receipt_number }}</td>

            <!-- buyer -->
            <td>{{ sale.buyer_name|default:"Walk-in" }}</td>

            <!-- Total Price -->
            <td>{{ sale.total_amount }}</td>

            <!-- seller -->
            <td>{{ sale.seller.username }}</td>

            <!-- sale date -->
            <td>{{ sale.sale_date|date:"M d, Y H:i" }}</td>

            <!-- Total Price -->
            <td>
            {% if sale.is_reversed %}
              <span class="btn btn-secondary disabled">ETR Returned</span>

            {% else %}
              {% if sale.batch_id %}
                <a href="{% url 'sales:batch-receipt' sale.batch_id %}"
                    class="btn btn-primary"
                    style="display: inline-block;">
                  View Receipt ({{ sale.batch_total_sales }} items)
                </a>
              {% else %}
                <a href="{% url 'sales:sale-etr' sale.sale_id %}"
                    class="btn btn-primary"
                    style="display: inline-block;">
                  View Receipt
                </a>
              {% endif %}
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9">
              <div class="empty-state">
                <i class="bi bi-box-seam"></i>
                <p>No recent sales found.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
</div>



<!-- ======================================== -->
<!-- ENHANCED PRODUCTS LIST SECTION ========= -->
<!-- ======================================== -->
<div id="product-list" class="content-section">
  <div class="content-header">
    <h1 class="page-title">INVENTORY MANAGEMENT</h1>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <!-- Filter Buttons -->
      <select id="productStatusFilter" class="form-select" style="width: auto;" onchange="filterProducts()">
        <option value="all">All Products</option>
        <option value="instock">In Stock</option>
        <option value="outofstock">Out of Stock</option>
        <option value="lowstock">Low Stock (â‰¤5)</option>
      </select>
      
      <select id="productCategoryFilter" class="form-select" style="width: auto;" onchange="filterProducts()">
        <option value="all">All Categories</option>
        {% for category in categories %}
        <option value="{{ category.id }}">{{ category.name }}</option>
        {% endfor %}
      </select>
      
      <select id="productTypeFilter" class="form-select" style="width: auto;" onchange="filterProducts()">
        <option value="all">All Types</option>
        <option value="single">Single Items (SKU)</option>
        <option value="bulk">Bulk Items</option>
      </select>
    </div>
  </div>

  <!-- Product Statistics -->
  <div class="stats-grid" style="margin-bottom: 1.5rem;">
    <div class="stat-card stat-card-info">
      <div class="stat-icon"><i class="bi bi-box-seam"></i></div>
      <div class="stat-content">
        <span class="stat-label">Total Products</span>
         <h3 class="stat-value" id="totalProductsCount">{{ total_products }}</h3>
      </div>
    </div>
    
    <div class="stat-card stat-card-success">
      <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
      <div class="stat-content">
        <span class="stat-label">In Stock</span>
        <h3 class="stat-value" id="inStockCount">{{ in_stock_count }}</h3>
      </div>
    </div>
    
    <div class="stat-card stat-card-warning">
      <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
      <div class="stat-content">
        <span class="stat-label">Low Stock</span>
        <h3 class="stat-value" id="lowStockCount">{{ low_stock_count }}</h3>
      </div>
    </div>
    
    <div class="stat-card stat-card-danger">
      <div class="stat-icon"><i class="bi bi-x-circle"></i></div>
      <div class="stat-content">
        <span class="stat-label">Out of Stock</span>
        <h3 class="stat-value" id="outOfStockCount">{{ out_of_stock_count }}</h3>
      </div>
    </div>
  </div>

  <!-- Products Table -->
  <div class="data-card">
    <!-- Table Controls: Search and Entries -->
    <div class="table-controls">
      <div class="entries-control">
        <label for="entriesSelect">Show</label>
        <select id="entriesSelect" onchange="changeEntries()">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="all">All</option>
        </select>
        <span>entries</span>
      </div>
      
      <div class="search-control">
        <input type="text" id="productSearch" placeholder="Search products..." onkeyup="searchProducts()">
        <button onclick="searchProducts()">
          <i class="bi bi-search"></i>
          <span>Search</span>
        </button>
      </div>
    </div>

    <div class="table-wrapper">
      <table class="data-table" id="productsTable">
        <thead>
          <tr>
            <th><strong style="color:#ff0000;">PRODUCT CODE</strong></th>
            <th><strong style="color:#ff0000;">PRODUCT SKU</strong></th>
            <th><strong style="color:#ff0000;">PRODUCT TYPE</strong></th>
            <th><strong style="color:#ff0000;">PRODUCT NAME</strong></th>
            <th><strong style="color:#ff0000;">CATEGORY</strong></th>
            <th><strong style="color:#ff0000;">STATUS</strong></th>
            <th><strong style="color:#ff0000;">STOCK</strong></th>
            <th><strong style="color:#ff0000;">BUYING PRICE</strong></th>
            <th><strong style="color:#ff0000;">SELLING PRICE</strong></th>
            <th><strong style="color:#ff0000;">% MARGIN</strong></th>
            <th><strong style="color:#ff0000;">OWNER</strong></th>
            <th><strong style="color:#ff0000;">DATE ADDED</strong></th>
          </tr>
        </thead>
        <tbody>
          {% for product_info in products_with_margin_and_status %}
          {% with product=product_info.product %}
          <tr class="product-row" 
              id="product-row-{{ product.id }}"
              data-product-id="{{ product.id }}"
              data-category="{{ product.category.id }}"
              data-stock-status="{{ product_info.status }}"
              data-type="{% if product.category.is_single_item %}single{% else %}bulk{% endif %}">
            
            <!-- Product Code -->
            <td>
              <code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                {{ product.product_code }}
              </code>
            </td>

            <!-- Product sku -->
            <td>{{ product.sku_value }}</td>
                       
            <!-- Type Badge -->
            <td>
              {% if product.category.is_single_item %}
                <span class="badge" style="background: #3b82f6; color: white;">
                  <i class="bi bi-tag"></i> Single
                </span>
              {% else %}
                <span class="badge" style="background: #8b5cf6; color: white;">
                  <i class="bi bi-box-seam"></i> Bulk
                </span>
              {% endif %}
            </td>

            <!-- Product Name -->
            <td class="product-name"><strong>{{ product.name }}</strong></td>

            <!-- Category -->
            <td><span class="badge bg-secondary">{{ product.category.name }}</span></td>

            <!-- STATUS BADGE -->
            <td>
              {% if product.category.is_single_item %}
                {% if product.status == "sold" %}
                  <span class="badge badge-danger">
                    <i class="bi bi-x-circle-fill"></i> Sold Out
                  </span>
                {% else %}
                  <span class="badge badge-success">
                    <i class="bi bi-check-circle-fill"></i> In Stock
                  </span>
                {% endif %}
              {% else %}
                {% if product.quantity == 0 %}
                  <span class="badge badge-danger">
                    <i class="bi bi-x-circle-fill"></i> Out of Stock
                  </span>
                {% elif product.quantity <= 5 %}
                  <span class="badge badge-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i> Low Stock
                  </span>
                {% else %}
                  <span class="badge badge-success">
                    <i class="bi bi-check-circle-fill"></i> In Stock
                  </span>
                {% endif %}
              {% endif %}
            </td>

            <!-- STOCK COLUMN -->
            <td class="product-quantity">
              {% if product.category.is_single_item %}
                {% if product.status == 'sold' %}
                  <strong style="color: #dc3545; font-weight: bold;">
                    <i class="bi bi-x-circle-fill"></i> SOLD
                  </strong>
                {% else %}
                  <strong style="color: #28a745; font-weight: bold;">
                    <i class="bi bi-check-circle-fill"></i> Available
                  </strong>
                {% endif %}
              {% else %}
                {% if product.quantity > 5 %}
                  <strong style="color: #28a745; font-weight: bold;">
                    {{ product.quantity }} units
                  </strong>
                {% elif product.quantity > 0 %}
                  <strong style="color: #ffc107; font-weight: bold;">
                    {{ product.quantity }} units (Low)
                  </strong>
                {% else %}
                  <strong style="color: #dc3545; font-weight: bold;">
                    0 units (Out)
                  </strong>
                {% endif %}
              {% endif %}
            </td>

            <!-- Buying Price -->
            <td class="product-buying-price">
              <strong style="color: #10b981;">KSH {{ product.buying_price|floatformat:2 }}</strong>
            </td>

            <!-- Selling Price -->
            <td class="product-selling-price">
              <strong style="color: #10b981;">KSH {{ product.selling_price|floatformat:2 }}</strong>
            </td>

            <!-- Profit Margin -->
            <td>
              <span class="badge
                {% if product_info.margin_pct >= 30 %}margin-high
                {% elif product_info.margin_pct >= 15 %}margin-medium
                {% else %}margin-low
                {% endif %}">
                +{{ product_info.margin_pct|floatformat:0 }}%
              </span>
            </td>

            <!-- Owner -->
            <td class="product-owner">
              <div style="display: flex; align-items: center; gap: 6px;">
                <i class="bi bi-person-circle" style="color: #6c757d;"></i>
                <span>{{ product.owner.username|default:"FIELDMAX" }}</span>
              </div>
            </td>

            <!-- Date Added -->
            <td><span style="color: #6c757d;">{{ product.created_at|date:"M d, Y" }}</span></td>

          </tr>
          {% endwith %}
          {% empty %}
          <tr>
            <td colspan="12">
              <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <p>No products found in inventory.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>



<!-- ======================================= -->
<!-- ADD CATEGORY TEMPLATE -->
<!-- ======================================= -->
<div id="add-category" class="content-section">
  <div class="content-header">
    <h1 class="page-title">Add New Category</h1>
  </div>

  <div class="data-card">
    <div style="padding: 2rem; max-width: 1000px; margin: 0 auto;">

      <!-- Success Message -->
      <div id="success-message-category" style="display: none;" class="alert alert-success"></div>

      <!-- Error Messages -->
      <div id="message-div-category"></div>

      <form id="addCategoryForm" method="POST" action="/inventory/category/create/">
        {% csrf_token %}

        <!-- Basic Information Section -->
        <div class="mb-4">
          <h4 style="border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem;">
            <i class="bi bi-info-circle"></i> Basic Information
          </h4>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="category-name" class="form-label required">Category Name:</label>
              <input type="text" 
                     name="name" 
                     id="category-name" 
                     class="form-control" 
                     placeholder="e.g., Category type" 
                     required>
              <small class="form-text text-muted">Enter a descriptive category name</small>
            </div>
            <div class="col-md-6">
              <label for="category-code" class="form-label">Category Code:</label>
              <input type="text" 
                     id="category-code" 
                     name="category_code"
                     class="form-control" 
                     placeholder="Auto-generated" 
                     readonly 
                     style="background: #f3f4f6;">
              <small class="form-text text-muted">Automatically generated from name</small>
            </div>
          </div>
        </div>

        <!-- Configuration Section -->
        <div class="mb-4">
          <h4 style="border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem;">
            <i class="bi bi-gear"></i> Configuration
          </h4>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="item-type" class="form-label required">Item Type:</label>
              <select name="item_type" id="item-type" class="form-select" required>
                <option value="">-- Select Item Type --</option>
                <option value="single">Single Item</option>
                <option value="bulk">Bulk Item</option>
              </select>
              <small class="form-text text-muted">
                <strong>Single:</strong> Unique Items<br>
                <strong>Bulk:</strong> Multiple units
              </small>
            </div>
    
            <div class="col-md-6">
              <label for="sku-type" class="form-label required">SKU Type:</label>
              <select name="sku_type" id="sku-type" class="form-select" required>
                <option value="">-- Select SKU Type --</option>
                <option value="imei">IMEI NUMBER</option>
                <option value="serial">SERIAL NUMBER</option>
                <option value="barcode">BARCODE</option>
              </select>
              <small class="form-text text-muted">Type of identifier for products in this category</small>
            </div>
          </div>
        </div>

        <!-- Products Section -->
        <div class="mb-4">
          <h4 style="border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem;">
            <i class="bi bi-box-seam"></i> Products in this Category
          </h4>


          <!-- Django Formset Management Form -->
          <input type="hidden" name="products-TOTAL_FORMS" id="id_products-TOTAL_FORMS" value="1">
          <input type="hidden" name="products-INITIAL_FORMS" id="id_products-INITIAL_FORMS" value="0">
          <input type="hidden" name="products-MIN_NUM_FORMS" id="id_products-MIN_NUM_FORMS" value="0">
          <input type="hidden" name="products-MAX_NUM_FORMS" id="id_products-MAX_NUM_FORMS" value="1000">



          <div class="table-responsive">
            <table class="table table-bordered" id="products-table">
              <thead class="table-light">
                <tr>
                  <th style="width: 15%;">Product Code</th>
                  <th style="width: 25%;">Product Name</th>
                  <th style="width: 20%;">SKU/IMEI/Serial</th>
                  <th style="width: 10%;">Quantity</th>
                  <th style="width: 15%;">Status</th>
                  <th style="width: 10%;">Active</th>
                  <th style="width: 5%;"></th>
                </tr>
              </thead>
              <tbody>
                <!-- Template Row (will be cloned by JavaScript) -->
                <tr class="product-row">
                  <td>
                    <input type="text" 
                           name="products-0-code" 
                           class="form-control form-control-sm" 
                           readonly 
                           style="background: #f3f4f6;">
                  </td>
                  <td>
                    <input type="text" 
                           name="products-0-name" 
                           class="form-control form-control-sm" 
                           placeholder="Optional">
                  </td>
                  <td>
                    <input type="text" 
                           name="products-0-sku" 
                           class="form-control form-control-sm"
                           placeholder="Optional">
                  </td>
                  <td>
                    <input type="number" 
                           name="products-0-qty" 
                           class="form-control form-control-sm" 
                           min="0" 
                           value="">
                  </td>
                  <td>
                    <select name="products-0-status" class="form-select form-select-sm">
                      <option value="available" selected>Available</option>
                      <option value="sold">Sold</option>
                      <option value="lowstock">Low Stock</option>
                      <option value="outofstock">Out of Stock</option>
                    </select>
                  </td>
                  <td class="text-center">
                    <input type="hidden" name="products-0-active" value="false">
                    <input type="checkbox" 
                           name="products-0-active" 
                           class="form-check-input" 
                           checked>
                  </td>
                  <td class="text-center">
                    <button type="button" 
                            class="btn btn-danger btn-sm remove-product" 
                            title="Remove this product">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <button type="button" 
                  id="add-product-btn" 
                  class="btn btn-secondary">
            <i class="bi bi-plus-circle"></i> Add Another Product
          </button>
        </div>

        <!-- Submit Buttons -->
        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">
          <button type="submit" class="btn-action btn-primary">
            <i class="bi bi-save"></i>
            <span>Save Category & Products</span>
          </button>
          <a href="#category-list" 
             class="btn-action" 
             data-section="category-list"
             style="background: #6c757d; color: #fff; margin-left: 0.5rem;">
            <i class="bi bi-x-circle"></i>
            <span>Cancel</span>
          </a>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- ======================================= -->
<!-- ADD PRODUCT TEMPLATE -->
<!-- ======================================= -->
<div id="add-product" class="content-section">
  <div class="content-header">
    <h1 class="page-title">Add New Product</h1>
  </div>

  <div class="data-card">
    <div style="padding: 2rem; max-width: 800px; margin: 0 auto;">
      
      <!-- Success Message -->
      <div id="success-message-product" style="display: none;" class="alert alert-success">
        Product saved successfully!
      </div>

      <!-- Error Message -->
      <div id="message-div"></div>

      <form id="addProductForm" method="POST" action="{% url 'inventory:product-create' %}" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="row g-3">
          
          <!-- Category -->
          <div class="col-12">
            <label for="category-select" class="form-label required">Category</label>
            <select name="category" id="category-select" class="form-select" required>
              <option value="">-- Select Category --</option>
              {% for cat in categories %}
              <option value="{{ cat.id }}"
                      data-is-single="{{ cat.is_single_item|yesno:'true,false' }}"
                      data-is-bulk="{{ cat.is_bulk_item|yesno:'true,false' }}"
                      data-sku-type="{{ cat.get_sku_type_display }}">
                {{ cat.name }}
              </option>
              {% endfor %}
            </select>
            <small class="form-text text-muted">Select the product category first to show relevant fields</small>
          </div>

          <!-- Product Name -->
          <div class="col-12">
            <label for="product-name" class="form-label required">Product Name</label>
            <input type="text" name="name" id="product-name" class="form-control" placeholder="Enter product name" required>
          </div>

          <!-- ===================================== -->
          <!-- SKU VALUE FIELD (ENHANCED VERSION) -->
          <!-- ===================================== -->
          <div class="col-12" id="sku-value-container" style="display: none;">
            <div class="alert alert-info" style="background: #e0f2fe; border-color: #3b82f6;">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-info-circle-fill text-primary me-2" style="font-size: 1.5rem;"></i>
                <h6 class="mb-0" id="sku-field-title">Product Identifier</h6>
              </div>
              <p class="mb-3 small" id="sku-field-description">Enter the unique identifier for this product</p>
              
              <label for="sku-input" class="form-label fw-bold" id="sku-label">
                <i class="bi bi-upc-scan"></i> SKU / IMEI / Serial Number <span class="text-danger">*</span>
              </label>
              
              <div class="input-group input-group-lg">
                <span class="input-group-text bg-white">
                  <i class="bi bi-hash"></i>
                </span>
                <input type="text" 
                       name="sku_value" 
                       id="sku-input" 
                       class="form-control" 
                       placeholder="Enter or scan identifier"
                       style="font-family: 'Courier New', monospace; font-weight: 600;">
                <button type="button" 
                        class="btn btn-primary" 
                        onclick="openBarcodeScanner('sku')"
                        title="Scan with camera">
                  <i class="bi bi-camera"></i> Scan
                </button>
              </div>
              
              <div class="mt-2">
                <small class="text-muted" id="sku-field-hint">
                  <i class="bi bi-lightbulb"></i> Tip: Click "Scan" to use your camera
                </small>
              </div>
            </div>
          </div>

          <!-- Product Image with Camera -->
          <div class="col-12">
            <label for="product-image" class="form-label">Product Image (Optional)</label>
            
            <!-- Image Preview -->
            <div id="imagePreviewContainer" style="margin-bottom: 15px; display: none;">
              <img id="imagePreview" src="" alt="Preview" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 2px solid #ddd;">
              <button type="button" class="btn btn-sm btn-danger mt-2" onclick="clearImage()">
                <i class="bi bi-trash"></i> Remove Image
              </button>
            </div>
            
            <!-- Button Group -->
            <div class="btn-group w-100 mb-2" role="group">
              <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('product-image').click()">
                <i class="bi bi-upload"></i> Upload Image
              </button>
              <button type="button" class="btn btn-outline-primary" onclick="openCameraModal()">
                <i class="bi bi-camera"></i> Take Photo
              </button>
            </div>
            
            <!-- Hidden File Inputs -->
            <input type="file" name="image" id="product-image" class="form-control d-none" accept="image/*" onchange="previewImage(this)">
            <input type="file" id="camera-capture" class="form-control d-none" accept="image/*" capture="environment" onchange="previewImage(this)">
            
            <small class="form-text text-muted">Supported formats: JPG, PNG, GIF (Max 5MB)</small>
          </div>

          <!-- Buying Price -->
          <div class="col-md-6">
            <label for="buying-price" class="form-label required">Buying Price (KSH)</label>
            <div class="input-group">
              <span class="input-group-text">KSH</span>
              <input type="number" step="0.01" name="buying_price" id="buying-price" class="form-control" placeholder="0.00" required>
            </div>
          </div>

          <!-- Selling Price -->
          <div class="col-md-6">
            <label for="selling-price" class="form-label required">Selling Price (KSH)</label>
            <div class="input-group">
              <span class="input-group-text">KSH</span>
              <input type="number" step="0.01" name="selling_price" id="selling-price" class="form-control" placeholder="0.00" required>
            </div>
          </div>

          <!-- Barcode Field (bulk items only) -->
          <div class="col-12" id="barcode-field" style="display:none;">
            <div class="alert alert-warning" style="background: #fef3c7; border-color: #f59e0b;">
              <label for="barcode-input" class="form-label fw-bold">
                <i class="bi bi-upc-scan"></i> Barcode (Optional)
              </label>
              <div class="input-group">
                <span class="input-group-text bg-white">
                  <i class="bi bi-upc"></i>
                </span>
                <input type="text" name="barcode" id="barcode-input" class="form-control" placeholder="Enter or scan barcode">
                <button type="button" class="btn btn-warning" onclick="openBarcodeScanner('barcode')">
                  <i class="bi bi-camera"></i> Scan
                </button>
              </div>
              <small class="form-text text-muted mt-2 d-block">
                <i class="bi bi-info-circle"></i> For bulk items: Add barcode for faster scanning during sales
              </small>
            </div>
          </div>

          <!-- Quantity Field (bulk items) -->
          <div class="col-12" id="quantity-field" style="display:none;">
            <div class="alert alert-success" style="background: #d1fae5; border-color: #10b981;">
              <label for="quantity" class="form-label fw-bold required">
                <i class="bi bi-box-seam"></i> Initial Stock Quantity
              </label>
              <input type="number" name="quantity" id="quantity" class="form-control form-control-lg" min="1" placeholder="Enter quantity">
              <small class="form-text text-muted mt-2 d-block">
                <i class="bi bi-info-circle"></i> Enter the number of units you're adding to inventory
              </small>
            </div>
          </div>

          <!-- Buttons -->
          <div class="col-12" style="margin-top: 1.5rem;">
            <button type="submit" class="btn-action btn-primary">
              <i class="bi bi-save"></i>
              <span>Save Product</span>
            </button>
            <a href="#product-list" class="btn-action" style="background: #6c757d; color: #fff; margin-left: 0.5rem;" data-section="product-list">
              <i class="bi bi-x-circle"></i>
              <span>Cancel</span>
            </a>
          </div>

        </div>
      </form>
    </div>
  </div>
</div>

<!-- ======================================= -->
<!-- CAMERA MODAL FOR PRODUCT IMAGE -->
<!-- ======================================= -->
<div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cameraModalLabel">
          <i class="bi bi-camera"></i> Take Photo
        </h5>
        <button type="button" class="btn-close" onclick="closeCameraModal()"></button>
      </div>
      <div class="modal-body text-center">
        <video id="cameraStream" autoplay playsinline style="max-width: 100%; border-radius: 8px; display: none; background: #000;"></video>
        <canvas id="cameraCanvas" style="max-width: 100%; border-radius: 8px; display: none;"></canvas>
        <div id="cameraError" class="alert alert-danger" style="display: none;"></div>
        <div id="cameraLoading" class="spinner-border text-primary" role="status" style="display: none;">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeCameraModal()">
          <i class="bi bi-x"></i> Cancel
        </button>
        <button type="button" id="captureBtn" class="btn btn-primary" onclick="capturePhoto()" style="display: none;">
          <i class="bi bi-camera-fill"></i> Capture
        </button>
        <button type="button" id="retakeBtn" class="btn btn-warning" onclick="retakePhoto()" style="display: none;">
          <i class="bi bi-arrow-counterclockwise"></i> Retake
        </button>
        <button type="button" id="usePhotoBtn" class="btn btn-success" onclick="usePhoto()" style="display: none;">
          <i class="bi bi-check-lg"></i> Use Photo
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ======================================= -->
<!-- BARCODE SCANNER MODAL -->
<!-- ======================================= -->
<div class="modal fade" id="barcodeScannerModal" tabindex="-1" aria-labelledby="barcodeScannerLabel" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="barcodeScannerLabel">
          <i class="bi bi-upc-scan"></i> Scan Barcode/IMEI/Serial
        </h5>
        <button type="button" class="btn-close" onclick="closeBarcodeScanner()"></button>
      </div>
      <div class="modal-body text-center">
        <!-- Scanner Video -->
        <div id="scanner-container" style="position: relative;">
          <video id="barcodeScannerVideo" autoplay playsinline style="max-width: 100%; border-radius: 8px; display: none; background: #000;"></video>
          <canvas id="barcodeScannerCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 50%;"></canvas>
          
          <!-- Scanning overlay -->
          <div id="scanningOverlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
            <div style="width: 500px; height: 100px; border: 3px solid #10b981; border-radius: 8px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);"></div>
            <p style="color: white; margin-top: 10px; font-weight: bold;">Position barcode within frame</p>
          </div>
        </div>
        
        <!-- Scanner Status -->
        <div id="scannerStatus" class="alert alert-info mt-3" style="display: none;">
          <i class="bi bi-info-circle"></i> <span id="scannerStatusText">Initializing scanner...</span>
        </div>
        
        <!-- Scanner Error -->
        <div id="scannerError" class="alert alert-danger mt-3" style="display: none;"></div>
        
        <!-- Loading -->
        <div id="scannerLoading" class="spinner-border text-primary" role="status" style="display: none;">
          <span class="visually-hidden">Loading...</span>
        </div>
        
        <!-- Detected Result -->
        <div id="scannerResult" class="alert alert-success mt-3" style="display: none;">
          <h6><i class="bi bi-check-circle"></i> Detected:</h6>
          <h4 id="detectedCode" style="font-family: monospace; color: #059669;"></h4>
          <small class="text-muted" id="detectedFormat"></small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeBarcodeScanner()">
          <i class="bi bi-x"></i> Cancel
        </button>
        <button type="button" id="useBarcodeBtn" class="btn btn-success" onclick="useDetectedBarcode()" style="display: none;">
          <i class="bi bi-check-lg"></i> Use This Code
        </button>
        <button type="button" id="rescanBtn" class="btn btn-primary" onclick="restartScanner()" style="display: none;">
          <i class="bi bi-arrow-repeat"></i> Scan Again
        </button>
      </div>
    </div>
  </div>
</div>


<!-- ============================= -->
<!--     RESTOCK PRODUCT SECTION     -->
<!-- ============================= -->
<div id="restock-product" class="content-section">
  
  <!-- Header -->
  <div class="content-header">
    <button class="mobile-sidebar-toggle" id="mobileSidebarToggle4">
      <i class="bi bi-list"></i>
    </button>
    <h1 class="page-title">
      <i class="bi bi-box-seam-fill"></i> Restock Products
      <small class="text-muted" style="font-size: 0.6em; display: block; margin-top: 0.5rem;">
        Add Stock to Existing Products
      </small>
    </h1>
  </div>

  <!-- Two Column Layout -->
  <div class="row g-4">
    
    <!-- ==========================================
         COLUMN 1: SEARCH & INPUT FORM
    ========================================== -->
    <div class="col-lg-5">
      
      <!-- Search Card -->
      <div class="data-card mb-3">
        <div class="card-header bg-primary text-white">
          <h2 class="mb-0">
            <i class="bi bi-search"></i> Search Product
          </h2>
        </div>
        <div class="card-body" style="padding: 0.1rem 0.6rem; height: 20px; overflow: hidden;">
          <p class="text-muted mb-3">
            <i class="bi bi-info-circle"></i> Search by name, code, or scan barcode
          </p>
          
          <div class="position-relative">
            <div class="input-group input-group-lg mb-3">
              <span class="input-group-text">
                <i class="bi bi-upc-scan"></i>
              </span>
              <input 
                type="text" 
                id="restockSearchInput" 
                placeholder="Type product name/code or scan..."
                class="form-control"
                autocomplete="off"
                autofocus>
              <button 
                id="restockSearchBtn"
                class="btn btn-primary">
                <i class="bi bi-search"></i> Search
              </button>
            </div>

            <!-- Auto-complete Dropdown -->
            <div id="restockAutocomplete" 
                 class="position-absolute w-100 bg-white border rounded shadow-lg" 
                 style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto; top: 100%; margin-top: -0.75rem;">
              <div id="restockAutocompleteList"></div>
            </div>
          </div>

          <div id="restockSearchMessage" class="mt-3" style="display: none; font-size: 0.8em; height: 20px; line-height: 20px; overflow: hidden;"></div>
        </div>
      </div>

      <!-- Multiple Results Section -->
      <div id="restockMultipleResults" class="data-card mb-4" style="display: none;">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-list-ul"></i> Multiple Products Found
          </h5>
        </div>
        <div class="card-body" style="padding: 0.75rem; height: 150px; overflow-y: auto;">
          <p class="text-muted mb-3">Select the product you want to restock:</p>
          <div id="restockProductsList" class="d-grid gap-2"></div>
        </div>
      </div>

      <!-- Restock Form Card -->
      <div id="restockFormSection" class="data-card" style="display: none;">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-plus-circle"></i> Add Stock
          </h5>
        </div>
        <div class="card-body" style="padding: 1rem; min-height: 400px;">
          
          <form id="restockForm">
            {% csrf_token %}
            <input type="hidden" id="restockProductId" name="product_id">
            
            <!-- Quantity -->
            <div class="mb-3">
              <label for="restockQuantity" class="form-label required">
                <i class="bi bi-box"></i> Quantity to Add
              </label>
              <input 
                type="number" 
                id="restockQuantity" 
                name="quantity" 
                min="1"
                required
                class="form-control form-control-lg"
                placeholder="Enter quantity"
                style="height: calc(1.5em + 0.75rem + 2px);">
            </div>

            <!-- Buying Price -->
            <div class="mb-3">
              <label for="restockBuyingPrice" class="form-label required">
                <i class="bi bi-currency-exchange"></i> Buying Price (per unit)
              </label>
              <div class="input-group input-group-lg">
                <span class="input-group-text">KSH</span>
                <input 
                  type="number" 
                  id="restockBuyingPrice" 
                  name="buying_price" 
                  step="0.01"
                  min="0"
                  required
                  class="form-control"
                  placeholder="0.00"
                  style="height: calc(1.5em + 0.75rem + 2px);">
              </div>
            </div>

            <!-- Selling Price -->
            <div class="mb-3">
              <label for="restockSellingPrice" class="form-label">
                <i class="bi bi-tag"></i> Selling Price (per unit)
              </label>
              <div class="input-group input-group-lg">
                <span class="input-group-text">KSH</span>
                <input 
                  type="number" 
                  id="restockSellingPrice" 
                  name="selling_price" 
                  step="0.01"
                  min="0"
                  class="form-control"
                  placeholder="0.00"
                  style="height: calc(1.5em + 0.75rem + 2px);">
              </div>
              <small class="form-text text-muted">
                Optional - updates product selling price
              </small>
            </div>

            <!-- Total Amount Display -->
            <div id="restockTotalAmountDisplay" class="mb-4" style="display: none;">
              <label class="form-label">
                <i class="bi bi-calculator"></i> Total Amount
              </label>
              <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); 
                          padding: 1rem; 
                          border-radius: 8px; 
                          border: 2px solid #10b981;">
                <div style="font-size: 1.8rem; font-weight: 700; color: #059669; text-align: center;">
                  KSH <span id="restockTotalAmount">0.00</span>
                </div>
              </div>
            </div>

            <!-- Notes -->
            <div class="mb-4">
              <label for="restockNotes" class="form-label">
                <i class="bi bi-pencil-square"></i> Notes (Optional)
              </label>
              <textarea 
                id="restockNotes" 
                name="notes" 
                rows="2"
                class="form-control"
                placeholder="Add any notes about this restock..."
                style="height: calc(1em + 1rem);"></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2">
              <button 
                type="submit" 
                id="restockSubmitBtn"
                class="btn btn-success btn-lg">
                <i class="bi bi-check-circle"></i> Add Stock
              </button>
              <button 
                type="button"
                id="restockResetBtn"
                class="btn btn-secondary">
                <i class="bi bi-arrow-counterclockwise"></i> Search Another Product
              </button>
            </div>

            <!-- Form Messages -->
            <div id="restockFormMessage" class="mt-3" style="display: none; font-size: 0.8em; height: 20px; line-height: 20px; overflow: hidden;"></div>
          </form>
          
        </div>
      </div>

    </div>

    <!-- ==========================================
         COLUMN 2: PRODUCT DETAILS DISPLAY
    ========================================== -->
    <div class="col-lg-7">
      <div class="data-card h-100">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-info-circle"></i> Product Details
          </h5>
        </div>
        <div class="card-body" style="padding: 0.5rem 3rem;">
          
          <!-- Empty State -->
          <div id="restockEmptyState" class="text-center py-5" style="height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <i class="bi bi-box-seam" style="font-size: 4rem; color: #cbd5e1;"></i>
            <h5 class="text-muted mt-3">No Product Selected</h5>
            <p class="text-muted">
              Search for a product to view details and add stock
            </p>
          </div>

          <!-- Product Details Display -->
          <div id="restockProductInfo" style="display: none;">
            
            <!-- Product Header -->
            <div class="alert alert-info" style="background: #dbeafe; border-color: #3b82f6;">
              <h4 class="mb-2">
                <i class="bi bi-box-seam-fill"></i> 
                <span id="restockDisplayName"></span>
              </h4>
              <div class="row g-3 mt-2">
                <div class="col-6">
                  <small class="text-muted d-block">Product Code</small>
                  <strong id="restockDisplayCode"></strong>
                </div>
                <div class="col-6">
                  <small class="text-muted d-block">Category</small>
                  <strong id="restockDisplayCategory"></strong>
                </div>
                <div style="font-size: 2rem; font-weight: 700; color: #059669;">
                  <h3 class="text-muted mb-2">Current Stock</h3>
                  <span id="restockDisplayStock">0</span>
                </div>
                <div class="row g-3">
                  <div class="col-6">
                    <small class="text-muted d-block">Buying Price</small>
                    <div style="font-size: 2rem; font-weight: 700; color: #10b981;">
                      KSH <span id="restockDisplayBuyingPrice">0.00</span>
                    </div>
                  </div>
                  <div class="col-6">
                    <small class="text-muted d-block">Selling Price</small>
                    <div style="font-size: 2rem; font-weight: 700; color: #10b981;">
                      KSH <span id="restockDisplaySellingPrice">0.00</span>
                    </div>
                  </div>
                </div>                
              </div>
            </div>

            <!-- Success Message Display -->
            <div id="restockSuccessDisplay" class="alert alert-success" style="display: none;">
              <i class="bi bi-check-circle-fill"></i>
              <strong>Stock Added Successfully!</strong>
              <div class="mt-2">
                <small>New stock quantity: <strong id="restockNewStock"></strong> units</small>
              </div>
            </div>

          </div>

        </div>
      </div>
    </div>

  </div><!-- End Row -->

</div>



<!-- ============================= -->
<!--  TRANSFER PRODUCT SECTION   -->
<!-- ============================= -->
<div id="transfer-product" class="content-section">

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">
        <i class="bi bi-arrow-left-right"></i> Transfer Product
      </h2>
    </div>
  </div>

  <div class="row">
    <!-- LEFT COLUMN: Search & Form -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-search"></i> Search Product</h5>
        </div>
        <div class="card-body">
          <!-- Search Input -->
          <div class="mb-3">
            <label class="form-label fw-bold">Product Code or SKU</label>
            <div class="input-group">
              <input 
                type="text" 
                class="form-control" 
                id="transferSearchInput"
                placeholder="Enter product code, name, or SKU..."
                autocomplete="off"
              >
              <button class="btn btn-primary" type="button" id="transferSearchBtn">
                <i class="bi bi-search"></i> Search
              </button>
            </div>
            <div id="transferSearchingIndicator" style="display: none; margin-top: 8px;">
              <span class="spinner-border spinner-border-sm text-primary"></span>
              <span class="text-muted ms-2">Searching...</span>
            </div>
          </div>

          <!-- Transfer Form -->
          <div class="mb-3">
            <label class="form-label fw-bold">Receiving User</label>
            <select class="form-select" id="transferUserSelect" disabled>
              <option value="">Select receiving user</option>
            </select>
          </div>

          <div class="mb-3" id="transferQuantityField" style="display: none;">
            <label class="form-label fw-bold">Quantity to Transfer</label>
            <input 
              type="number" 
              class="form-control" 
              id="transferQuantity"
              min="1"
              value="1"
            >
            <small class="text-muted">
              Maximum available: <span id="transferMaxQuantity">0</span> units
            </small>
          </div>

          <!-- Action Buttons -->
          <div class="d-grid gap-2">
            <button class="btn btn-success btn-lg" id="transferSubmitBtn" disabled>
              <i class="bi bi-check-circle"></i> Confirm Transfer
            </button>
            <button class="btn btn-outline-secondary" id="transferResetBtn">
              <i class="bi bi-arrow-counterclockwise"></i> Reset
            </button>
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div id="transferMessage" class="mt-3"></div>
    </div>

    <!-- RIGHT COLUMN: Live Preview -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="bi bi-eye"></i> Live Preview</h5>
        </div>
        <div class="card-body">
          <!-- Product Preview -->
          <div class="mb-3 p-3 bg-light rounded">
            <div class="fw-bold text-muted mb-2">PRODUCT</div>
            <div id="liveProductPreview" class="fs-6">
              <span class="text-muted">No product selected</span>
            </div>
          </div>

          <!-- Owner Transfer Preview -->
          <div class="mb-3 p-3 bg-light rounded">
            <div class="fw-bold text-muted mb-2">OWNER TRANSFER</div>
            <div id="liveOwnerPreview" class="fs-6">
              <span class="text-muted">No transfer configured</span>
            </div>
          </div>

          <!-- Divider -->
          <hr class="my-3">

          <!-- Product Details Area - NOW INSIDE LIVE PREVIEW CARD -->
          <div id="transferEmptyState">
            <div class="text-center py-4">
              <i class="bi bi-box-seam display-4 text-muted"></i>
              <h6 class="mt-3 text-muted">No Product Selected</h6>
              <p class="text-muted small mb-0">Search for a product to view details</p>
            </div>
          </div>

          <div id="transferLoadingState" style="display: none;">
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <h6 class="mt-3 text-muted">Loading Product Details...</h6>
            </div>
          </div>

          <div id="transferProductDetails" style="display: none;">
            <!-- Product details will be inserted here by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</div>



<!-- ============================= -->
<!--        SALES SECTION          -->
<!-- ============================= -->
<div id="sales-list" class="content-section">

  <!-- Header with Filters and Action Button -->
  <div class="content-header">
    <h1 class="page-title">SALES MANAGEMENT</h1>
    <div style="display: flex; gap: 10px; align-items: center;">
      <!-- Search Input Field -->
      <div style="position: relative;">
        <input type="text" 
               id="searchSaleInput" 
               class="form-control" 
               placeholder="Search Sale" 
               style="padding-right: 40px; min-width: 300px;">
        <button class="btn btn-primary" 
                onclick="searchSale()" 
                style="position: absolute; right: 0; top: 0; height: 75%; border-radius: 0 4px 4px 0; display: flex; align-items: center; padding: 0 15px;">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Sales Summary Stats -->
  <div class="stats-grid" style="margin-bottom: 1.5rem;">
    
    <!-- Daily Sales -->
    <div class="stat-card stat-card-success">
      <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
      <div class="stat-content">
        <span class="stat-label">Daily Sales</span>
        <h3 class="stat-value" id="dailySalesCount">{{ daily_sales_count }}</h3>
      </div>
    </div>
    <!-- Weekly Sales -->
    <div class="stat-card stat-card-success">
      <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
      <div class="stat-content">
        <span class="stat-label">Weekly Sales</span>
        <h3 class="stat-value" id="weeklySalesCount">{{ weekly_sales_count }}</h3>
      </div>
    </div>
    <!-- Monthly Sales -->
    <div class="stat-card stat-card-success">
      <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
      <div class="stat-content">
        <span class="stat-label">Monthly Sales</span>
        <h3 class="stat-value" id="monthlySalesCount">{{ monthly_sales_count }}</h3>
      </div>
    </div>
    <!-- Active Sales -->
    <div class="stat-card stat-card-success">
      <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
      <div class="stat-content">
        <span class="stat-label">Active Sales</span>
        <h3 class="stat-value" id="activeSalesCount">{{ active_sales_count }}</h3>
      </div>
    </div>    
    <!-- Reversed Sales -->
    <div class="stat-card stat-card-warning">
      <div class="stat-icon"><i class="bi bi-arrow-counterclockwise"></i></div>
      <div class="stat-content">
        <span class="stat-label">Reversed Sales</span>
        <h3 class="stat-value" id="reversedSalesCount">{{ reversed_sales_count }}</h3>
      </div>
    </div>
  </div>

  <!-- Sales Table -->
  <div class="data-card">
    <div class="table-wrapper">
      <table class="data-table" id="salesTable">
        <thead>
          <tr>
            <th><strong style="color:#000000;">SALE ID</strong></th>
            <th><strong style="color:#000000;">ETR NO</strong></th>              
            <th><strong style="color:#000000;">BUYER</strong></th>
            <th><strong style="color:#000000;">TOTAL AMOUNT</strong></th>
            <th><strong style="color:#000000;">SOLD BY</strong></th>
            <th><strong style="color:#000000;">DATE SOLD</strong></th>
            <th style="text-align: center; white-space: nowrap;"><strong style="color:#ff0000;">FIELDMAX SALES MANAGEMENT</strong></th>
          </tr>
        </thead>
        <tbody>
          {% for sale in all_sales %}
          <tr class="sale-row"
              id="sale-row-{{ sale.sale_id }}"
              data-status="{% if sale.is_reversed %}reversed{% else %}active{% endif %}"
              data-type="{% if sale.has_sku_items %}single{% else %}bulk{% endif %}"
              data-seller="{{ sale.seller.id|default:'' }}"
              data-sale-id="{{ sale.sale_id }}">

            <!-- Sale ID & Reversal Badge -->
            <td>
              <strong>#{{ sale.sale_id }}</strong>
              {% if sale.is_reversed %}
              <span class="badge badge-warning"
                    style="font-size: 10px; background:#fef3c7; color:#92400e;">
                <i class="bi bi-arrow-counterclockwise"></i> REVERSED
              </span>
              {% endif %}
            </td>

            <!-- ETR NUMBER -->
            <td>{{ sale.etr_receipt_number }}</td>

            <!-- Buyer -->
            <td>{{ sale.buyer_name|default:"Walk-in" }}</td>

            <!-- Total Amount -->
            <td><strong style="color:#10b981;">{{ sale.total_amount }}</strong></td>

            <!-- Sold By -->
            <td>{{ sale.seller.username|default:"N/A" }}</td>

            <!-- Date -->
            <td>{{ sale.sale_date|date:"M d, Y H:i" }}</td>

             <!-- Actions -->
            <td style="text-align: center;">
             <div class="action-buttons" style="display: flex; gap: 0.5rem; justify-content: center; align-items: center; flex-wrap: wrap;">
                 {% if not sale.is_reversed %}
                    
                <!-- Reverse Sale Link -->
                 <a href="#" 
                      class="reverse-sale-btn btn btn-warning btn-sm"
                      data-sale-id="{{ sale.sale_id }}"
                      style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.875rem; text-decoration: none; white-space: nowrap;">
                      Reverse Sale
                 </a> 

                    <!-- Optional: View Receipt -->
                 <a href="{% url 'sales:sale-etr' sale.sale_id %}" 
                    target="_blank" 
                    class="btn btn-primary"
                    style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.875rem; text-decoration: none; white-space: nowrap;">
                    <i class="bi bi-receipt"></i> View Receipt
                 </a>
                 {% else %}
                 <span class="text-muted">Reversed</span>
                 {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <!-- No sales message -->
          <tr>
            <td colspan="11">
              <div class="empty-state">
                <i class="bi bi-receipt"></i>
                <p>No sales found.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>



<!--================================= -->
<!-- =================================-->
<!-- RECORD SALE SECTION     ðŸ›’ðŸ›’ðŸ›’ -->
<!--================================= -->
<!--================================= -->
<div id="record-sale" class="content-section">

  <!-- Header -->
  <div class="content-header">
    <button class="mobile-sidebar-toggle" id="mobileSidebarToggle3">
      <i class="bi bi-list"></i>
    </button>
    <h1 class="page-title">
      <i class="bi bi-cart-plus"></i> Record Sale
      <small class="text-muted" style="font-size: 0.6em; display: block; margin-top: 0.5rem;">
        Sales Management
      </small>
    </h1>
  </div>

  <!-- Two Column Layout -->
  <div class="row g-4">
    
    <!-- ==========================================
         COLUMN A: INPUT FORM
    ========================================== -->
    <div class="col-lg-6">
      <div class="data-card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-pencil-square"></i> Sale Input Form
          </h5>
        </div>
        <div class="card-body" style="padding: 2rem;">
          
          <form id="saleForm">
            {% csrf_token %}

            <!-- Product Code / SKU -->
            <div class="mb-4 position-relative">
              <label for="productCode" class="form-label required">
                <i class="bi bi-upc-scan"></i> Product Code / SKU
              </label>
              <div class="input-group input-group-lg">
                <span class="input-group-text">
                  <i class="bi bi-search"></i>
                </span>
                <input type="text" 
                       id="productCode" 
                       name="product_code" 
                       class="form-control"
                       placeholder="Scan or enter code" 
                       required 
                       autocomplete="off"
                       autofocus>
              </div>
              <small class="form-text text-muted">
                IMEI, Serial, Barcode, or Product Code
              </small>
            </div>

            <!-- Quantity -->
            <div class="mb-3">
              <label for="quantity" class="form-label">
                <i class="bi bi-123"></i> Quantity
              </label>
              <input type="number" 
                     id="quantity" 
                     name="quantity" 
                     class="form-control form-control-lg"
                     min="1" 
                     value="1" 
                     placeholder="Enter quantity">
              <small class="form-text text-muted">
                Auto-locked to 1 for single items
              </small>
            </div>

            <!-- Unit Price -->
            <div class="mb-3">
              <label for="saleAmount" class="form-label">
                <i class="bi bi-currency-exchange"></i> Unit Price (KSH)
              </label>
              <div class="input-group input-group-lg">
                <span class="input-group-text">KSH</span>
                <input type="number" 
                       id="saleAmount" 
                       name="unit_price" 
                       step="0.01" 
                       min="0"
                       class="form-control" 
                       placeholder="0.00">
              </div>
            </div>

            <!-- Total Amount -->
            <div class="mb-4">
              <label for="totalAmount" class="form-label">
                <i class="bi bi-calculator"></i> Total Sale Amount
              </label>
              <input type="text" 
                     id="totalAmount" 
                     name="total_amount" 
                     class="form-control form-control-lg text-center"
                     readonly 
                     style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); 
                            font-weight: 700; 
                            font-size: 1.5rem; 
                            color: #059669;
                            border: 2px solid #10b981;">
            </div>

            <hr class="my-4">

            <!-- Client Details Collapsible -->
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label fw-bold mb-0">
                  <i class="bi bi-person-vcard"></i> Client Details
                </label>
                <span class="badge bg-secondary">Optional</span>
              </div>

              <button class="btn btn-outline-secondary w-100 d-flex justify-content-between align-items-center"
                      type="button" 
                      data-bs-toggle="collapse" 
                      data-bs-target="#clientDetailsDropdown"
                      aria-expanded="false">
                  <span><i class="bi bi-person-plus"></i> Fill Client Details</span>
                  <i class="bi bi-chevron-down"></i>
              </button>

              <!-- Collapsible Form -->
              <div class="collapse mt-3" id="clientDetailsDropdown">
                <div class="card card-body bg-light">

                  <div class="mb-3">
                    <label for="client_phone" class="form-label">
                      <i class="bi bi-telephone"></i> Phone
                    </label>
                    <input type="text" 
                           id="client_phone" 
                           name="buyer_phone" 
                           class="form-control"
                           placeholder="0712345678">
                    <small class="form-text text-muted">
                      Auto-fills if client exists
                    </small>
                  </div>

                  <div class="mb-3">
                    <label for="client_name" class="form-label">
                      <i class="bi bi-person"></i> Name
                    </label>
                    <input type="text" 
                           id="client_name" 
                           name="buyer_name" 
                           class="form-control"
                           placeholder="Full name">
                  </div>

                  <div class="mb-3">
                    <label for="client_id" class="form-label">
                      <i class="bi bi-card-text"></i> ID Number
                    </label>
                    <input type="text" 
                           id="client_id" 
                           name="buyer_id_number" 
                           class="form-control"
                           placeholder="ID number">
                  </div>

                  <hr>

                  <h6 class="text-muted mb-3">Next of Kin</h6>

                  <div class="mb-3">
                    <label for="nok_name" class="form-label">
                      <i class="bi bi-person-badge"></i> NOK Name
                    </label>
                    <input type="text" 
                           id="nok_name" 
                           name="nok_name" 
                           class="form-control"
                           placeholder="NOK name">
                  </div>

                  <div class="mb-3">
                    <label for="nok_phone" class="form-label">
                      <i class="bi bi-telephone-forward"></i> NOK Phone
                    </label>
                    <input type="text" 
                           id="nok_phone" 
                           name="nok_phone" 
                           class="form-control"
                           placeholder="NOK phone">
                  </div>

                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2 mt-4">
              <button type="button" 
                      id="recordSaleBtn" 
                      class="btn btn-success btn-lg" 
                      disabled>
                <i class="bi bi-check-circle"></i> Record Sale
              </button>
              <button type="button" 
                      id="addAnotherBtn" 
                      class="btn btn-primary btn-lg" 
                      disabled>
                <i class="bi bi-plus-circle"></i> Add Another Sale
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>

    <!-- ==========================================
         COLUMN B: DISPLAY SECTION
    ========================================== -->
    <div class="col-lg-6">
      <div class="data-card h-100">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-display"></i> Product Details & Status
          </h5>
        </div>
        <div class="card-body" style="padding: 2rem;">
          
          <!-- Initial State (No Product Selected) -->
          <div id="emptyState" class="text-center py-5">
            <i class="bi bi-box-seam" style="font-size: 4rem; color: #cbd5e1;"></i>
            <h5 class="text-muted mt-3">No Product Selected</h5>
            <p class="text-muted">
              Scan or enter a product code to view details
            </p>
          </div>

          <!-- Product Details Display -->
          <div id="productDetails" style="display: none;">
            <!-- Content will be dynamically inserted here -->
          </div>

          <!-- Sale Messages -->
          <div id="saleMessage" class="mt-4"></div>
        </div>
      </div>
    </div>

  </div><!-- End Row -->

</div>



<!-- ============================= -->
<!--     USERS LIST SECTION        -->
<!-- ============================= -->
<div id="users-list" class="content-section">
  
  <!-- Header -->
  <div class="content-header">
    <button class="mobile-sidebar-toggle" id="mobileSidebarToggle5">
      <i class="bi bi-list"></i>
    </button>
    <h1 class="page-title">
      <i class="bi bi-people-fill"></i> User Management
      <small class="text-muted" style="font-size: 0.6em; display: block; margin-top: 0.5rem;">
        Manage System Users
      </small>
    </h1>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <!-- Filter Buttons -->
      <select id="roleFilter" class="form-select" style="width: auto;" onchange="filterUsers()">
        <option value="all">All Roles</option>
        <option value="admin">Admin</option>
        <option value="manager">Manager</option>
        <option value="cashier">Cashier</option>
        <option value="agent">Agent</option>
      </select>
      
      <select id="userStatusFilter" class="form-select" style="width: auto;" onchange="filterUsers()">
        <option value="all">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
    </div>
  </div>

  <!-- User Statistics -->
  <div class="stats-grid" style="margin-bottom: 1.5rem;">
    <div class="stat-card stat-card-info">
      <div class="stat-icon"><i class="bi bi-people"></i></div>
      <div class="stat-content">
        <span class="stat-label">Total Users</span>
        <h3 class="stat-value" id="totalUsersCount">{{ users.count }}</h3>
      </div>
    </div>
    
    <div class="stat-card stat-card-success">
      <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
      <div class="stat-content">
        <span class="stat-label">Active Users</span>
        <h3 class="stat-value" id="activeUsersCount">{{ active_users_count }}</h3>
      </div>
    </div>
    
    <div class="stat-card stat-card-warning">
      <div class="stat-icon"><i class="bi bi-person-badge"></i></div>
      <div class="stat-content">
        <span class="stat-label">Admins</span>
        <h3 class="stat-value" id="adminUsersCount">{{ admin_count }}</h3>
      </div>
    </div>
    
    <div class="stat-card stat-card-primary">
      <div class="stat-icon"><i class="bi bi-person-workspace"></i></div>
      <div class="stat-content">
        <span class="stat-label">Managers</span>
        <h3 class="stat-value" id="managerUsersCount">{{ manager_count }}</h3>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="data-card">
    <!-- Table Controls: Search and Entries -->
    <div class="table-controls">
      <div class="entries-control">
        <label for="userEntriesSelect">Show</label>
        <select id="userEntriesSelect" onchange="changeUserEntries()">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="all">All</option>
        </select>
        <span>entries</span>
      </div>
      
      <div class="search-control">
        <input type="text" id="userSearch" placeholder="Search users..." onkeyup="searchUsers()">
        <button onclick="searchUsers()">
          <i class="bi bi-search"></i>
          <span>Search</span>
        </button>
      </div>
    </div>

    <div class="table-wrapper">
      <table class="data-table" id="usersTable">
        <thead>
          <tr>
            <th><strong style="color:#ff0000;">USER ID</strong></th>
            <th><strong style="color:#ff0000;">USERNAME</strong></th>
            <th><strong style="color:#ff0000;">FULL NAME</strong></th>
            <th><strong style="color:#ff0000;">EMAIL</strong></th>
            <th><strong style="color:#ff0000;">ROLE</strong></th>
            <th><strong style="color:#ff0000;">PHONE</strong></th>
            <th><strong style="color:#ff0000;">ID NUMBER</strong></th>
            <th><strong style="color:#ff0000;">STATUS</strong></th>
            <th><strong style="color:#ff0000;">DATE JOINED</strong></th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr class="user-row" 
              id="user-row-{{ user.id }}"
              data-user-id="{{ user.id }}"
              data-role="{% if user.profile.role %}{{ user.profile.role.name|lower }}{% else %}none{% endif %}"
              data-status="{% if user.is_active %}active{% else %}inactive{% endif %}">
            
            <!-- User ID -->
            <td>
              <code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                #{{ user.id }}
              </code>
            </td>

            <!-- Username -->
            <td><strong>{{ user.username }}</strong></td>

            <!-- Full Name -->
            <td>
              {% if user.first_name or user.last_name %}
                {{ user.first_name }} {{ user.last_name }}
              {% else %}
                <span style="color: #999;">N/A</span>
              {% endif %}
            </td>

            <!-- Email -->
            <td>
              {% if user.email %}
                {{ user.email }}
              {% else %}
                <span style="color: #999;">N/A</span>
              {% endif %}
            </td>

            <!-- Role Badge -->
            <td>
              {% if user.profile.role %}
                {% if user.profile.role.name == 'Admin' %}
                  <span class="badge" style="background: #ef4444; color: white;">
                    <i class="bi bi-shield-fill"></i> Admin
                  </span>
                {% elif user.profile.role.name == 'Manager' %}
                  <span class="badge" style="background: #3b82f6; color: white;">
                    <i class="bi bi-person-badge"></i> Manager
                  </span>
                {% elif user.profile.role.name == 'Cashier' %}
                  <span class="badge" style="background: #10b981; color: white;">
                    <i class="bi bi-cash-stack"></i> Cashier
                  </span>
                {% elif user.profile.role.name == 'Agent' %}
                  <span class="badge" style="background: #f59e0b; color: white;">
                    <i class="bi bi-person"></i> Agent
                  </span>
                {% else %}
                  <span class="badge bg-secondary">
                    <i class="bi bi-person"></i> {{ user.profile.role.name }}
                  </span>
                {% endif %}
              {% else %}
                <span class="badge bg-secondary">
                  <i class="bi bi-question-circle"></i> No Role
                </span>
              {% endif %}
            </td>

            <!-- Phone -->
            <td>
              {% if user.profile.phone_number %}
                {{ user.profile.phone_number }}
              {% else %}
                <span style="color: #999;">N/A</span>
              {% endif %}
            </td>

            <!-- ID Number -->
            <td>
              {% if user.profile.id_number %}
                {{ user.profile.id_number }}
              {% else %}
                <span style="color: #999;">N/A</span>
              {% endif %}
            </td>

            <!-- Status Badge -->
            <td>
              {% if user.is_active %}
                <span class="badge badge-success">
                  <i class="bi bi-check-circle-fill"></i> Active
                </span>
              {% else %}
                <span class="badge badge-danger">
                  <i class="bi bi-x-circle-fill"></i> Inactive
                </span>
              {% endif %}
            </td>

            <!-- Date Joined -->
            <td><span style="color: #6c757d;">{{ user.date_joined|date:"M d, Y" }}</span></td>

          </tr>
          {% empty %}
          <tr>
            <td colspan="9">
              <div class="empty-state">
                <i class="bi bi-people"></i>
                <p>No users found in the system.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="table-footer">
      <div class="table-info">
        Showing <span id="userShowingStart">1</span> to <span id="userShowingEnd">{{ users.count }}</span> of <span id="userTotalEntries">{{ users.count }}</span> entries
      </div>
    </div>
  </div>
</div>



<!-- ============================= -->
<!--      ADD USER SECTION         -->
<!-- ============================= -->
<div id="add-user" class="content-section">
  <div class="content-header">
    <h1 class="page-title">Add New User</h1>
  </div>

  <div class="data-card">
    <div style="padding: 2rem; max-width: 800px; margin: 0 auto;">
      
      <!-- Success Message -->
      <div id="success-message-user" style="display: none;" class="alert alert-success">
        User created successfully!
      </div>

      <!-- Error Message -->
      <div id="message-div-user"></div>

      <form id="addUserForm" method="POST" action="{% url 'user-add' %}" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="row g-3">
          <!-- Username -->
          <div class="col-md-6">
            <label for="username" class="form-label required">Username</label>
            <input type="text" name="username" id="username" class="form-control" placeholder="Enter username" required>
          </div>

          <!-- Email -->
          <div class="col-md-6">
            <label for="email" class="form-label required">Email</label>
            <input type="email" name="email" id="email" class="form-control" placeholder="user@example.com" required>
          </div>

          <!-- First Name -->
          <div class="col-md-6">
            <label for="first_name" class="form-label required">First Name</label>
            <input type="text" name="first_name" id="first_name" class="form-control" placeholder="Enter first name" required>
          </div>

          <!-- Last Name -->
          <div class="col-md-6">
            <label for="last_name" class="form-label required">Last Name</label>
            <input type="text" name="last_name" id="last_name" class="form-control" placeholder="Enter last name" required>
          </div>

          <!-- Password -->
          <div class="col-md-6">
            <label for="password" class="form-label required">Password</label>
            <input type="password" name="password" id="password" class="form-control" placeholder="Enter password" required>
          </div>

          <!-- Confirm Password -->
          <div class="col-md-6">
            <label for="confirm_password" class="form-label required">Confirm Password</label>
            <input type="password" name="confirm_password" id="confirm_password" class="form-control" placeholder="Confirm password" required>
          </div>

          <!-- Role -->
          <div class="col-md-6">
            <label for="role" class="form-label required">Role</label>
            <select name="role" id="role" class="form-select" required>
              <option value="">Select Role</option>
              {% for role in roles %}
              <option value="{{ role.id }}">{{ role.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Phone Number -->
          <div class="col-md-6">
            <label for="phone_number" class="form-label">Phone Number</label>
            <input type="text" name="phone_number" id="phone_number" class="form-control" placeholder="0712345678">
          </div>

          <!-- ID Number -->
          <div class="col-md-6">
            <label for="id_number" class="form-label">ID Number</label>
            <input type="text" name="id_number" id="id_number" class="form-control" placeholder="12345678">
          </div>

          <!-- Date of Birth -->
          <div class="col-md-6">
            <label for="date_of_birth" class="form-label">Date of Birth</label>
            <input type="date" name="date_of_birth" id="date_of_birth" class="form-control">
          </div>

          <!-- Passport Image -->
          <div class="col-12">
            <label for="passport_image" class="form-label">Passport Photo</label>
            <input type="file" name="passport_image" id="passport_image" class="form-control" accept="image/*">
            <small class="form-text text-muted">Supported formats: JPG, PNG (Max 5MB)</small>
          </div>

          <!-- Buttons -->
          <div class="col-12" style="margin-top: 1.5rem;">
            <button type="submit" class="btn-action btn-primary">
              <i class="bi bi-save"></i>
              <span>Create User</span>
            </button>
            <a href="#users-list" class="btn-action" style="background: #6c757d; color: #fff; margin-left: 0.5rem;" data-section="users-list">
              <i class="bi bi-x-circle"></i>
              <span>Cancel</span>
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>




<!-- ============================= -->
<!--  ROLES & PERMISSIONS SECTION  -->
<!-- ============================= -->
<div id="roles-permissions" class="content-section">
  <div class="content-header">
    <h1 class="page-title">
      <i class="bi bi-shield-check"></i> Roles & Permissions
    </h1>
  </div>

  <div class="data-card">
    <div style="padding: 2rem;">
      <h4 class="mb-4">System Roles Overview</h4>
      
      <div class="row g-4">
        <!-- Admin Role -->
        <div class="col-md-6">
          <div class="card border-danger">
            <div class="card-header bg-danger text-white">
              <h3 class="mb-0"><i class="bi bi-shield-fill"></i> Admin</h3>
            </div>
            <div class="card-body">
              <p class="text-muted">Full system access and control</p>
              <ul class="list-unstyled">
                <li><i class="bi bi-check-circle text-success"></i> Manage all users</li>
                <li><i class="bi bi-check-circle text-success"></i> Manage inventory</li>
                <li><i class="bi bi-check-circle text-success"></i> Process sales</li>
                <li><i class="bi bi-check-circle text-success"></i> View all reports</li>
                <li><i class="bi bi-check-circle text-success"></i> System configuration</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Manager Role -->
        <div class="col-md-6">
          <div class="card border-primary">
            <div class="card-header bg-primary text-white">
              <h3 class="mb-0"><i class="bi bi-person-badge"></i> Manager</h3>
            </div>
            <div class="card-body">
              <p class="text-muted">Manage operations and staff</p>
              <ul class="list-unstyled">
                <li><i class="bi bi-check-circle text-success"></i> Manage cashiers</li>
                <li><i class="bi bi-check-circle text-success"></i> Manage inventory</li>
                <li><i class="bi bi-check-circle text-success"></i> Process sales</li>
                <li><i class="bi bi-check-circle text-success"></i> View reports</li>
                <li><i class="bi bi-x-circle text-danger"></i> System configuration</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Cashier Role -->
        <div class="col-md-6">
          <div class="card border-success">
            <div class="card-header bg-success text-white">
              <h3 class="mb-0"><i class="bi bi-cash-stack"></i> Cashier</h3>
            </div>
            <div class="card-body">
              <p class="text-muted">Process sales and transactions</p>
              <ul class="list-unstyled">
                <li><i class="bi bi-x-circle text-danger"></i> Manage users</li>
                <li><i class="bi bi-check-circle text-success"></i> View inventory</li>
                <li><i class="bi bi-check-circle text-success"></i> Process sales</li>
                <li><i class="bi bi-check-circle text-success"></i> View own sales</li>
                <li><i class="bi bi-x-circle text-danger"></i> System configuration</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Agent Role -->
        <div class="col-md-6">
          <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
              <h3 class="mb-0"><i class="bi bi-person"></i> Agent</h3>
            </div>
            <div class="card-body">
              <p class="text-muted">Limited sales access</p>
              <ul class="list-unstyled">
                <li><i class="bi bi-x-circle text-danger"></i> Manage users</li>
                <li><i class="bi bi-check-circle text-success"></i> View inventory</li>
                <li><i class="bi bi-check-circle text-success"></i> Record sales</li>
                <li><i class="bi bi-check-circle text-success"></i> View own sales</li>
                <li><i class="bi bi-x-circle text-danger"></i> System configuration</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>





<!--=======================================-->
<!-- ======================================-->
<!-- REPORTS GENERATOR SECTION     ðŸ‘ï¸ðŸ‘ï¸   -->
<!--=======================================-->
<!--=======================================-->

<div id="generate-report" class="content-section">

  <!-- Header -->
  <div class="content-header">
    <button class="mobile-sidebar-toggle" id="mobileSidebarToggle3">
      <i class="bi bi-list"></i>
    </button>
    <h1 class="page-title">
      <i class="bi bi-bar-chart-line"></i> Sales Reports
      <small class="text-muted" style="font-size: 0.6em; display: block; margin-top: 0.5rem;">
        Filtered Sales Reports
      </small>
    </h1>
  </div>

  <!-- Two Column Layout -->
  <div class="row g-4">
    
    <!-- ==========================================
         COLUMN A: FILTER FORM
    ========================================== -->
    <div class="col-lg-6">
      <div class="data-card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-funnel"></i> Report Filters
          </h5>
        </div>
        <div class="card-body" style="padding: 2rem;">
          
          <form id="reportFilterForm">

            <!-- Seller -->
            <div class="mb-4">
              <label for="seller" class="form-label required">
                <i class="bi bi-person-badge"></i> Seller
              </label>
              <select id="seller" name="seller" class="form-select form-select-lg">
                <option value="">All Sellers</option>
              </select>
            </div>

            <!-- Category -->
            <div class="mb-4">
              <label for="category" class="form-label required">
                <i class="bi bi-tags"></i> Category
              </label>
              <select id="category" name="category" class="form-select form-select-lg">
                <option value="">All Categories</option>
              </select>
            </div>

            <!-- Date Range -->
            <div class="mb-4">
              <label class="form-label">
                <i class="bi bi-calendar-range"></i> Date Range
              </label>
              <div class="row g-2">
                <div class="col-md-6">
                  <input type="date" id="startDate" name="start_date" class="form-control form-control-lg">
                </div>
                <div class="col-md-6">
                  <input type="date" id="endDate" name="end_date" class="form-control form-control-lg">
                </div>
              </div>
            </div>

            <!-- Buttons -->
            <div class="d-grid gap-2 mt-4">
              <button type="button" id="generateReportBtn" class="btn btn-success btn-lg">
                <i class="bi bi-file-earmark-bar-graph"></i> Generate Report
              </button>
              <button type="button" id="exportReportBtn" class="btn btn-secondary btn-lg" disabled>
                <i class="bi bi-download"></i> Export Report
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>

    <!-- ==========================================
         COLUMN B: REPORT DISPLAY
    ========================================== -->
    <div class="col-lg-6">
      <div class="data-card h-100">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-table"></i> Report Results
          </h5>
        </div>
        <div class="card-body" style="padding: 2rem;">
          
          <!-- Empty State -->
          <div id="reportEmptyState" class="text-center py-5">
            <i class="bi bi-clipboard-data" style="font-size: 4rem; color: #cbd5e1;"></i>
            <h5 class="text-muted mt-3">No Report Generated</h5>
            <p class="text-muted">
              Select filters and click "Generate Report"
            </p>
          </div>

          <!-- Report Table -->
          <div id="reportResults" style="display: none;">
            <div class="table-responsive">
              <table class="table table-bordered table-striped">
                <thead class="table-light">
                  <tr>
                    <th>DATE</th>
                    <th>SELLER</th>
                    <th>CUSTOMER</th>
                    <th>ETR</th>
                    <th>PRODUCT</th>
                    <th>SKU/IMEI</th>
                    <th>QTY</th>
                    <th>PRICE</th>
                    <th>TOTALS</th>
                  </tr>
                </thead>
                <tbody id="reportTableBody"></tbody>
              </table>
            </div>

            <!-- Summary -->
            <div class="mt-3 alert alert-success">
              <div class="row">
                  <div class="col-md-6">
                    <strong>Total Items Sold:</strong> <span id="reportItemCount">0</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Total Revenue:</strong> KSH <span id="reportTotal">0.00</span>
                 </div>
              </div>
          </div>
        </div>
      </div>
    </div>
  </div>
 </main>
</div>




<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>

<script>

// ======================================
// ======================================
// DASHBOARD SIDEBAR MOBILE ENHANCEMENT
// ======================================


document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Dashboard Sidebar Mobile Enhancement Loaded');

    // Get all elements
    const dashboardSidebar = document.getElementById('dashboardSidebar');
    const mobileSidebarToggles = document.querySelectorAll('.mobile-sidebar-toggle');
    
    // Create overlay if it doesn't exist
    let sidebarOverlay = document.querySelector('.sidebar-overlay');
    if (!sidebarOverlay && dashboardSidebar) {
        sidebarOverlay = document.createElement('div');
        sidebarOverlay.className = 'sidebar-overlay';
        sidebarOverlay.style.cssText = `
            display: none;
            position: fixed;
            top: 76px;
            left: 0;
            width: 100%;
            height: calc(100vh - 76px);
            background: rgba(0, 0, 0, 0.5);
            z-index: 997;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
        dashboardSidebar.parentElement.appendChild(sidebarOverlay);
    }

    // ============================================
    // TOGGLE SIDEBAR FUNCTION
    // ============================================
    function toggleDashboardSidebar() {
        if (!dashboardSidebar) return;
        
        const isActive = dashboardSidebar.classList.contains('active');
        
        if (isActive) {
            closeDashboardSidebar();
        } else {
            openDashboardSidebar();
        }
    }

    // ============================================
    // OPEN SIDEBAR
    // ============================================
    function openDashboardSidebar() {
        if (!dashboardSidebar) return;
        
        dashboardSidebar.classList.add('active');
        
        if (sidebarOverlay) {
            sidebarOverlay.style.display = 'block';
            setTimeout(() => {
                sidebarOverlay.style.opacity = '1';
            }, 10);
        }
        
        // Prevent body scroll on mobile
        if (window.innerWidth <= 992) {
            document.body.style.overflow = 'hidden';
        }
        
        console.log('âœ… Sidebar opened');
    }

    // ============================================
    // CLOSE SIDEBAR
    // ============================================
    function closeDashboardSidebar() {
        if (!dashboardSidebar) return;
        
        dashboardSidebar.classList.remove('active');
        
        if (sidebarOverlay) {
            sidebarOverlay.style.opacity = '0';
            setTimeout(() => {
                sidebarOverlay.style.display = 'none';
            }, 300);
        }
        
        document.body.style.overflow = '';
        
        console.log('âŒ Sidebar closed');
    }

    // ============================================
    // ATTACH EVENT LISTENERS TO ALL TOGGLE BUTTONS
    // ============================================
    mobileSidebarToggles.forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleDashboardSidebar();
        });
    });

    // ============================================
    // CLOSE SIDEBAR WHEN CLICKING OVERLAY
    // ============================================
    if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', closeDashboardSidebar);
    }

    // ============================================
    // CLOSE SIDEBAR WHEN CLICKING NAVIGATION ITEMS
    // ============================================
    if (dashboardSidebar) {
        const navItems = dashboardSidebar.querySelectorAll('.nav-item, .submenu-item');
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                if (window.innerWidth <= 992) {
                    setTimeout(closeDashboardSidebar, 300);
                }
            });
        });
    }

    // ============================================
    // CLOSE SIDEBAR ON WINDOW RESIZE TO DESKTOP
    // ============================================
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            if (window.innerWidth > 992) {
                closeDashboardSidebar();
            }
        }, 250);
    });

    // ============================================
    // CLOSE SIDEBAR ON ORIENTATION CHANGE
    // ============================================
    window.addEventListener('orientationchange', function() {
        if (window.innerWidth <= 992 && dashboardSidebar && dashboardSidebar.classList.contains('active')) {
            closeDashboardSidebar();
        }
    });

    // ============================================
    // PREVENT SIDEBAR CLICK FROM CLOSING (CLICK INSIDE)
    // ============================================
    if (dashboardSidebar) {
        dashboardSidebar.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }

    // ============================================
    // CLOSE ON ESCAPE KEY
    // ============================================
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && dashboardSidebar && dashboardSidebar.classList.contains('active')) {
            closeDashboardSidebar();
        }
    });

    // ============================================
    // SWIPE GESTURE SUPPORT (MOBILE)
    // ============================================
    let touchStartX = 0;
    let touchEndX = 0;

    document.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    document.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }, { passive: true });

    function handleSwipe() {
        const swipeDistance = touchEndX - touchStartX;
        const minSwipeDistance = 50;

        // Swipe right to open (from left edge)
        if (swipeDistance > minSwipeDistance && touchStartX < 30) {
            if (!dashboardSidebar.classList.contains('active')) {
                openDashboardSidebar();
            }
        }

        // Swipe left to close
        if (swipeDistance < -minSwipeDistance) {
            if (dashboardSidebar.classList.contains('active')) {
                closeDashboardSidebar();
            }
        }
    }

    console.log('âœ… Dashboard Sidebar Mobile Enhancement Complete');
});



// ======================================
// ======================================
// CAMERA CAPTURE
// ======================================
let cameraStream = null;
let cameraModal = null;

// Open camera modal
function openCameraModal() {
  // Try simple file input first (works on most mobile devices)
  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    document.getElementById('camera-capture').click();
    return;
  }
  
  // Desktop - open modal
  if (!cameraModal) {
    cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'), {
      backdrop: true,
      keyboard: true
    });
  }
  
  // Reset modal state
  resetCameraModal();
  
  // Show modal
  cameraModal.show();
  
  // Start camera after modal is shown
  document.getElementById('cameraModal').addEventListener('shown.bs.modal', function() {
    startCamera();
  }, { once: true });
}

// Close camera modal properly
function closeCameraModal() {
  stopCamera();
  if (cameraModal) {
    cameraModal.hide();
  }
  // Remove any lingering backdrops
  setTimeout(() => {
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
  }, 300);
}

// Reset modal state
function resetCameraModal() {
  document.getElementById('cameraStream').style.display = 'none';
  document.getElementById('cameraCanvas').style.display = 'none';
  document.getElementById('cameraError').style.display = 'none';
  document.getElementById('cameraLoading').style.display = 'none';
  document.getElementById('captureBtn').style.display = 'none';
  document.getElementById('retakeBtn').style.display = 'none';
  document.getElementById('usePhotoBtn').style.display = 'none';
}

// Start camera stream
async function startCamera() {
  try {
    const video = document.getElementById('cameraStream');
    const errorDiv = document.getElementById('cameraError');
    const loading = document.getElementById('cameraLoading');
    
    loading.style.display = 'block';
    
    // Request camera access with fallback
    const constraints = {
      video: { 
        facingMode: 'environment', // Use back camera on mobile
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    };
    
    try {
      cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
    } catch (err) {
      // Fallback: try with any camera
      cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
    }
    
    video.srcObject = cameraStream;
    
    // Wait for video to load
    video.onloadedmetadata = function() {
      loading.style.display = 'none';
      video.style.display = 'block';
      document.getElementById('captureBtn').style.display = 'inline-block';
      errorDiv.style.display = 'none';
    };
    
  } catch (error) {
    console.error('Camera error:', error);
    document.getElementById('cameraLoading').style.display = 'none';
    document.getElementById('cameraError').textContent = 'Unable to access camera. Please check permissions or use the upload option.';
    document.getElementById('cameraError').style.display = 'block';
  }
}

// Stop camera stream
function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
  const video = document.getElementById('cameraStream');
  if (video) {
    video.srcObject = null;
  }
}

// Capture photo from video stream
function capturePhoto() {
  const video = document.getElementById('cameraStream');
  const canvas = document.getElementById('cameraCanvas');
  const context = canvas.getContext('2d');
  
  // Set canvas size to video size
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  
  // Draw video frame to canvas
  context.drawImage(video, 0, 0);
  
  // Hide video, show canvas
  video.style.display = 'none';
  canvas.style.display = 'block';
  
  // Show retake and use buttons
  document.getElementById('captureBtn').style.display = 'none';
  document.getElementById('retakeBtn').style.display = 'inline-block';
  document.getElementById('usePhotoBtn').style.display = 'inline-block';
  
  // Stop camera
  stopCamera();
}

// Retake photo
function retakePhoto() {
  document.getElementById('cameraCanvas').style.display = 'none';
  document.getElementById('retakeBtn').style.display = 'none';
  document.getElementById('usePhotoBtn').style.display = 'none';
  startCamera();
}

// Use captured photo
function usePhoto() {
  const canvas = document.getElementById('cameraCanvas');
  
  // Convert canvas to blob
  canvas.toBlob(function(blob) {
    // Create file from blob
    const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
    
    // Add to file input
    const dt = new DataTransfer();
    dt.items.add(file);
    document.getElementById('product-image').files = dt.files;
    
    // Show preview
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('imagePreview').src = e.target.result;
      document.getElementById('imagePreviewContainer').style.display = 'block';
    };
    reader.readAsDataURL(file);
    
    // Close modal
    closeCameraModal();
  }, 'image/jpeg', 0.9);
}

// Preview image before upload
function previewImage(input) {
  const file = input.files[0];
  if (file) {
    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
      alert('File size must be less than 5MB');
      input.value = '';
      return;
    }
    
    // Validate file type
    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    if (!validTypes.includes(file.type)) {
      alert('Please upload a valid image file (JPG, PNG, GIF, WEBP)');
      input.value = '';
      return;
    }
    
    // Show preview
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('imagePreview').src = e.target.result;
      document.getElementById('imagePreviewContainer').style.display = 'block';
      
      // Sync the file to the actual form input
      if (input.id === 'camera-capture') {
        const dt = new DataTransfer();
        dt.items.add(file);
        document.getElementById('product-image').files = dt.files;
      }
    };
    reader.readAsDataURL(file);
  }
}

// Clear image preview
function clearImage() {
  document.getElementById('product-image').value = '';
  document.getElementById('camera-capture').value = '';
  document.getElementById('imagePreview').src = '';
  document.getElementById('imagePreviewContainer').style.display = 'none';
}

// Clean up on page unload
window.addEventListener('beforeunload', function() {
  stopCamera();
});

// Handle modal close events
document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function() {
  stopCamera();
  resetCameraModal();
});




let barcodeScannerModal = null;
let barcodeStream = null;
let barcodeReader = null;
let currentScanTarget = null; // 'sku' or 'barcode'
let detectedBarcodeValue = null;
let isScanning = false;

// Open barcode scanner
function openBarcodeScanner(target) {
  currentScanTarget = target;
  
  if (!barcodeScannerModal) {
    barcodeScannerModal = new bootstrap.Modal(document.getElementById('barcodeScannerModal'), {
      backdrop: true,
      keyboard: true
    });
  }
  
  // Reset modal state
  resetBarcodeScanner();
  
  // Show modal
  barcodeScannerModal.show();
  
  // Start scanner after modal is shown
  document.getElementById('barcodeScannerModal').addEventListener('shown.bs.modal', function() {
    startBarcodeScanner();
  }, { once: true });
}

// Close barcode scanner
function closeBarcodeScanner() {
  stopBarcodeScanner();
  if (barcodeScannerModal) {
    barcodeScannerModal.hide();
  }
  // Remove any lingering backdrops
  setTimeout(() => {
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
  }, 300);
}

// Reset scanner modal
function resetBarcodeScanner() {
  document.getElementById('barcodeScannerVideo').style.display = 'none';
  document.getElementById('scanningOverlay').style.display = 'none';
  document.getElementById('scannerStatus').style.display = 'none';
  document.getElementById('scannerError').style.display = 'none';
  document.getElementById('scannerLoading').style.display = 'none';
  document.getElementById('scannerResult').style.display = 'none';
  document.getElementById('useBarcodeBtn').style.display = 'none';
  document.getElementById('rescanBtn').style.display = 'none';
  detectedBarcodeValue = null;
  isScanning = false;
}

// Start barcode scanner
async function startBarcodeScanner() {
  try {
    const video = document.getElementById('barcodeScannerVideo');
    const loading = document.getElementById('scannerLoading');
    const statusDiv = document.getElementById('scannerStatus');
    const statusText = document.getElementById('scannerStatusText');
    const errorDiv = document.getElementById('scannerError');
    
    loading.style.display = 'block';
    statusDiv.style.display = 'block';
    statusText.textContent = 'Requesting camera access...';
    
    // Request camera access
    barcodeStream = await navigator.mediaDevices.getUserMedia({
      video: { 
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    });
    
    video.srcObject = barcodeStream;
    
    video.onloadedmetadata = function() {
      loading.style.display = 'none';
      video.style.display = 'block';
      document.getElementById('scanningOverlay').style.display = 'block';
      statusText.textContent = 'Ready to scan. Position barcode in the frame.';
      
      // Initialize barcode reader
      initBarcodeReader();
    };
    
  } catch (error) {
    console.error('Scanner error:', error);
    document.getElementById('scannerLoading').style.display = 'none';
    document.getElementById('scannerStatus').style.display = 'none';
    document.getElementById('scannerError').textContent = 'Unable to access camera. Please check permissions.';
    document.getElementById('scannerError').style.display = 'block';
  }
}

// Initialize barcode reader with ZXing
function initBarcodeReader() {
  const video = document.getElementById('barcodeScannerVideo');
  const canvas = document.getElementById('barcodeScannerCanvas');
  const context = canvas.getContext('2d');
  
  // Set canvas size
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  
  // Create code reader
  barcodeReader = new ZXing.BrowserMultiFormatReader();
  isScanning = true;
  
  // Start continuous scanning
  scanBarcode();
}

// Scan barcode continuously
function scanBarcode() {
  if (!isScanning) return;
  
  const video = document.getElementById('barcodeScannerVideo');
  const canvas = document.getElementById('barcodeScannerCanvas');
  const context = canvas.getContext('2d');
  
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
    
    try {
      const code = barcodeReader.decodeFromImageData(imageData);
      
      if (code) {
        // Barcode detected!
        handleBarcodeDetected(code);
        return;
      }
    } catch (error) {
      // No barcode detected, continue scanning
    }
  }
  
  // Continue scanning
  requestAnimationFrame(scanBarcode);
}

// Handle detected barcode
function handleBarcodeDetected(code) {
  isScanning = false;
  detectedBarcodeValue = code.text;
  
  // Update UI
  document.getElementById('scanningOverlay').style.display = 'none';
  document.getElementById('scannerStatus').style.display = 'none';
  document.getElementById('detectedCode').textContent = code.text;
  document.getElementById('detectedFormat').textContent = `Format: ${code.format}`;
  document.getElementById('scannerResult').style.display = 'block';
  document.getElementById('useBarcodeBtn').style.display = 'inline-block';
  document.getElementById('rescanBtn').style.display = 'inline-block';
  
  // Play success sound (optional)
  playBeep();
  
  // Stop camera
  stopBarcodeScanner();
}

// Use detected barcode
function useDetectedBarcode() {
  if (detectedBarcodeValue) {
    if (currentScanTarget === 'sku') {
      document.getElementById('sku-input').value = detectedBarcodeValue;
    } else if (currentScanTarget === 'barcode') {
      document.getElementById('barcode-input').value = detectedBarcodeValue;
    }
  }
  closeBarcodeScanner();
}

// Restart scanner
function restartScanner() {
  resetBarcodeScanner();
  startBarcodeScanner();
}

// Stop barcode scanner
function stopBarcodeScanner() {
  isScanning = false;
  
  if (barcodeStream) {
    barcodeStream.getTracks().forEach(track => track.stop());
    barcodeStream = null;
  }
  
  const video = document.getElementById('barcodeScannerVideo');
  if (video) {
    video.srcObject = null;
  }
  
  if (barcodeReader) {
    barcodeReader.reset();
  }
}

// Play success beep sound
function playBeep() {
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.frequency.value = 800;
  oscillator.type = 'sine';
  
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.1);
}

// Clean up on page unload
window.addEventListener('beforeunload', function() {
  stopBarcodeScanner();
});

// Handle modal close events
document.getElementById('barcodeScannerModal').addEventListener('hidden.bs.modal', function() {
  stopBarcodeScanner();
  resetBarcodeScanner();
});




// ==========================
// =========================
// UTILITY FUNCTIONS
// =========================
function csrfToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]').value;
}


// =========================
// SECTION NAVIGATION SYSTEM
// =========================
function showSection(sectionId) {
  document.querySelectorAll('.content-section').forEach(section => {
    section.classList.remove('active');
  });

  const targetSection = document.getElementById(sectionId);
  if (targetSection) targetSection.classList.add('active');

  document.querySelectorAll('.nav-item, .submenu-item').forEach(item => {
    item.classList.remove('active');
  });

  const clickedNavItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
  const clickedSubmenuItem = document.querySelector(`.submenu-item[data-section="${sectionId}"]`);

  if (clickedNavItem) clickedNavItem.classList.add('active');
  if (clickedSubmenuItem) clickedSubmenuItem.classList.add('active');

  window.scrollTo({ top: 0, behavior: 'smooth' });

  const sidebar = document.getElementById('dashboardSidebar');
  if (window.innerWidth <= 992 && sidebar) sidebar.classList.remove('active');
}

// Handle navigation clicks
document.querySelectorAll('[data-section]').forEach(el => {
  el.addEventListener('click', e => {
    e.preventDefault();
    const sectionId = el.getAttribute('data-section');
    showSection(sectionId);
    history.pushState(null, null, `#${sectionId}`);
  });
});

window.addEventListener('popstate', () => {
  const hash = window.location.hash.substring(1);
  showSection(hash || 'dashboard');
});

window.addEventListener('DOMContentLoaded', () => {
  const hash = window.location.hash.substring(1);
  if (hash) showSection(hash);
});


// ====================================
// ===================================
// MOBILE SIDEBAR TOGGLE
// ==================================
const toggleBtn = document.getElementById('mobileSidebarToggle');
if (toggleBtn) {
  toggleBtn.addEventListener('click', () => sidebar.classList.toggle('active'));
}


// ===================
// SWIPE TO CLOSE SIDEBAR (MOBILE)
// ===================
let touchStartX = 0;
let touchEndX = 0;

sidebar.addEventListener('touchstart', (e) => {
  touchStartX = e.changedTouches[0].screenX;
}, { passive: true });

sidebar.addEventListener('touchend', (e) => {
  touchEndX = e.changedTouches[0].screenX;
  handleSwipeGesture();
}, { passive: true });

function handleSwipeGesture() {
  // Swipe left to close (threshold: 50px)
  if (touchStartX - touchEndX > 50) {
    if (sidebar.classList.contains('active')) {
      sidebar.classList.remove('active');
      const overlay = document.getElementById('sidebarOverlay');
      if (overlay) overlay.remove();
    }
  }
}

// ===================
// PREVENT BODY SCROLL WHEN SIDEBAR IS OPEN (MOBILE)
// ===================
const observer = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    if (mutation.attributeName === 'class') {
      if (window.innerWidth <= 992) {
        if (sidebar.classList.contains('active')) {
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = '';
        }
      }
    }
  });
});

observer.observe(sidebar, { attributes: true });


// ====================================
// ==============================
// COLLAPSE ICON ROTATION HANDLER
// ==============================
document.querySelectorAll('.nav-item[data-bs-toggle="collapse"]').forEach(item => {
  item.addEventListener('click', () => {
    const expanded = item.getAttribute('aria-expanded') === 'true';
    item.setAttribute('aria-expanded', !expanded);
  });
});




// ====================================
// ================================
// FILTER PRODUCTS
// ================================
function filterProducts() {
  const statusFilter = document.getElementById('productStatusFilter').value;
  const categoryFilter = document.getElementById('productCategoryFilter').value;
  const typeFilter = document.getElementById('productTypeFilter').value;
  const rows = document.querySelectorAll('.product-row');
  
  let visibleCount = 0;
  
  rows.forEach(row => {
    const stockStatus = row.dataset.stockStatus;
    const category = row.dataset.category;
    const type = row.dataset.type;
    
    const statusMatch = statusFilter === 'all' || stockStatus === statusFilter;
    const categoryMatch = categoryFilter === 'all' || category === categoryFilter;
    const typeMatch = typeFilter === 'all' || type === typeFilter;
    
    if (statusMatch && categoryMatch && typeMatch) {
      row.classList.remove('hidden');
      row.style.display = '';
      visibleCount++;
    } else {
      row.classList.add('hidden');
      row.style.display = 'none';
    }
  });
  
  updateProductStats();
}




// ====================================
// ================================
// LOAD SELLERS FROM DATABASE
// ================================
async function loadSellers() {
  try {
    // Replace with your actual API endpoint that returns users who have made sales
    const response = await fetch('/sales/api/get-sellers/');
    const data = await response.json();
    
    const sellerFilter = document.getElementById('sellerFilter');
    
    // Clear existing options except "All Sellers"
    sellerFilter.innerHTML = '<option value="all">All Sellers</option>';
    
    // Add sellers from database
    // Expected format: [{id: 1, username: "john"}, {id: 2, username: "jane"}]
    const sellers = data.sellers || data;
    
    sellers.forEach(seller => {
      const option = document.createElement('option');
      option.value = seller.id; // User ID
      option.textContent = seller.username || seller.first_name || `User ${seller.id}`;
      sellerFilter.appendChild(option);
    });
  } catch (error) {
    console.error('Error loading sellers:', error);
    // Continue without sellers loaded - filter will just show "All Sellers"
  }
}


// ====================================
// ================================
// FILTER SALES (Like filterProducts)
// ================================
function filterSales() {
  const statusFilter = document.getElementById('statusFilter').value;
  const sellerFilter = document.getElementById('sellerFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;
  const rows = document.querySelectorAll('.sale-row');
  
  let visibleCount = 0;
  let totalActive = 0;
  let totalReversed = 0;
  
  rows.forEach(row => {
    const status = row.dataset.status;
    const type = row.dataset.type;
    const seller = row.dataset.seller; // You'll need to add this to your template
    
    const statusMatch = statusFilter === 'all' || status === statusFilter;
    const sellerMatch = sellerFilter === 'all' || seller === sellerFilter;
    const typeMatch = typeFilter === 'all' || type === typeFilter;
    
    if (statusMatch && sellerMatch && typeMatch) {
      row.classList.remove('hidden');
      row.style.display = '';
      visibleCount++;
      
      // Count active/reversed for filtered results
      if (status === 'active') totalActive++;
      if (status === 'reversed') totalReversed++;
    } else {
      row.classList.add('hidden');
      row.style.display = 'none';
    }
  });
  
  updateSalesStats(visibleCount, totalActive, totalReversed);
}



// ====================================
// ================================
// UPDATE STATS AFTER FILTERING
// ================================
function updateSalesStats(visibleCount, activeCount, reversedCount) {
  // Update total visible sales
  const totalSalesElement = document.getElementById('totalSalesCount');
  if (totalSalesElement) {
    totalSalesElement.textContent = visibleCount;
  }
  
  // Update active sales count
  const activeSalesElement = document.getElementById('activeSalesCount');
  if (activeSalesElement) {
    activeSalesElement.textContent = activeCount;
  }
  
  // Update reversed sales count
  const reversedSalesElement = document.getElementById('reversedSalesCount');
  if (reversedSalesElement) {
    reversedSalesElement.textContent = reversedCount;
  }
}


// ====================================
// ================================
// INITIALIZE ON PAGE LOAD
// ================================
document.addEventListener('DOMContentLoaded', function() {
  // Load sellers from database
  loadSellers();
  
  // Initial stats count
  const totalRows = document.querySelectorAll('.sale-row').length;
  const activeRows = document.querySelectorAll('.sale-row[data-status="active"]').length;
  const reversedRows = document.querySelectorAll('.sale-row[data-status="reversed"]').length;
  
  updateSalesStats(totalRows, activeRows, reversedRows);
});


// ====================================
// ================================
// UPDATE STATISTICS
// ================================
function updateProductStats() {
  const allRows = document.querySelectorAll('.product-row');
  const inStockRows = document.querySelectorAll('.product-row[data-stock-status="instock"]');
  const lowStockRows = document.querySelectorAll('.product-row[data-stock-status="lowstock"]');
  const outOfStockRows = document.querySelectorAll('.product-row[data-stock-status="outofstock"]');
  
  const totalCount = document.getElementById('totalProductsCount');
  const inStockCount = document.getElementById('inStockCount');
  const lowStockCount = document.getElementById('lowStockCount');
  const outOfStockCount = document.getElementById('outOfStockCount');
  
  if (totalCount) totalCount.textContent = allRows.length;
  if (inStockCount) inStockCount.textContent = inStockRows.length;
  if (lowStockCount) lowStockCount.textContent = lowStockRows.length;
  if (outOfStockCount) outOfStockCount.textContent = outOfStockRows.length;
}

// ================================
// VIEW PRODUCT DETAILS
// ================================
function viewProductDetails(productId) {
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  fetch(`/inventory/products/${productId}/`, {
    method: 'GET',
    headers: {
      'X-CSRFToken': csrftoken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      const product = data.product;
      const margin = product.selling_price - product.buying_price;
      const marginPct = ((margin / product.buying_price) * 100).toFixed(1);
      
      document.getElementById('productDetailsContent').innerHTML = `
        <div style="display: grid; gap: 15px;">
          <div style="display: grid; grid-template-columns: 140px 1fr; gap: 10px; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <strong>Product Code:</strong>
            <code style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">${product.product_code}</code>
          </div>
          
          <div style="display: grid; grid-template-columns: 140px 1fr; gap: 10px; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <strong>Product Name:</strong>
            <span>${product.name}</span>
          </div>
          
          <div style="display: grid; grid-template-columns: 140px 1fr; gap: 10px; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <strong>Category:</strong>
            <span class="badge bg-secondary">${product.category || 'N/A'}</span>
          </div>
          
          <div style="display: grid; grid-template-columns: 140px 1fr; gap: 10px; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <strong>Quantity:</strong>
            <span style="font-weight: 600; color: ${product.quantity > 5 ? '#10b981' : product.quantity > 0 ? '#f59e0b' : '#ef4444'}">
              ${product.quantity}
            </span>
          </div>
          
          <div style="display: grid; grid-template-columns: 140px 1fr; gap: 10px; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <strong>Buying Price:</strong>
            <span>KSH ${product.buying_price.toFixed(2)}</span>
          </div>
          
          <div style="display: grid; grid-template-columns: 140px 1fr; gap: 10px; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <strong>Selling Price:</strong>
            <span style="color: #10b981; font-weight: 600;">KSH ${product.selling_price.toFixed(2)}</span>
          </div>
          
          <div style="display: grid; grid-template-columns: 140px 1fr; gap: 10px; padding: 12px; background: #e0f2fe; border-radius: 6px; border-left: 4px solid #3b82f6;">
            <strong>Profit Margin:</strong>
            <div>
              <span style="font-weight: 600; color: #10b981;">KSH ${margin.toFixed(2)}</span>
              <span class="badge" style="background: ${marginPct >= 30 ? '#10b981' : marginPct >= 15 ? '#f59e0b' : '#ef4444'}; color: white; margin-left: 8px;">
                +${marginPct}%
              </span>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 140px 1fr; gap: 10px; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <strong>Status:</strong>
            <span>${product.is_active ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-danger">Inactive</span>'}</span>
          </div>
          
          <div style="display: grid; grid-template-columns: 140px 1fr; gap: 10px; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <strong>Owner:</strong>
            <span>${product.owner || 'FIELDMAX'}</span>
          </div>
        </div>
      `;
      
      document.getElementById('productDetailsModal').style.display = 'flex';
    } else {
      showToast('Failed to load product details', 'error');
    }
  })
  .catch(err => {
    console.error('Error fetching product details:', err);
    showToast('Error loading product details', 'error');
  });
}

function closeProductDetails() {
  document.getElementById('productDetailsModal').style.display = 'none';
}


// ====================================
// ====================================
// BAR AND DONUT CHART STATISTICS
// ====================================
document.addEventListener('DOMContentLoaded', function() {
  console.log('ðŸ“Š Initializing Sales Statistics Charts...');
  
  // ==========================================
  // GET DATA FROM DJANGO TEMPLATE
  // ==========================================
  
  let barChartData, donutChartData;
  
  try {
    // âœ… Parse Django data (already JSON strings from view)
    const barLabels = '{{ chart_data.bar_chart.labels|safe }}';
    const barSales = '{{ chart_data.bar_chart.sales_count|safe }}';
    const barRevenue = '{{ chart_data.bar_chart.revenue|safe }}';
    
    const donutLabels = '{{ chart_data.donut_chart.labels|safe }}';
    const donutCounts = '{{ chart_data.donut_chart.counts|safe }}';
    const donutColors = '{{ chart_data.donut_chart.colors|safe }}';
    
    console.log('Raw data from Django:');
    console.log('Bar Labels:', barLabels);
    console.log('Bar Sales:', barSales);
    console.log('Donut Labels:', donutLabels);
    
    // Check if we have valid data
    if (barLabels && barSales && barRevenue && donutLabels && donutCounts) {
      barChartData = {
        labels: JSON.parse(barLabels),
        sales: JSON.parse(barSales),
        revenue: JSON.parse(barRevenue)
      };
      
      donutChartData = {
        labels: JSON.parse(donutLabels),
        sales: JSON.parse(donutCounts),
        colors: JSON.parse(donutColors)
      };
      
      console.log('âœ… Successfully parsed database data:');
      console.log('Bar Chart:', barChartData);
      console.log('Donut Chart:', donutChartData);
    } else {
      throw new Error('Missing chart data from Django');
    }
  } catch (error) {
    console.warn('âš ï¸ Error loading chart data, using sample data:', error.message);
    
    // Fallback sample data
    barChartData = {
      labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
      sales: [5, 8, 6, 10, 7, 12, 9],
      revenue: [15000, 24000, 18000, 30000, 21000, 36000, 27000]
    };
    
    donutChartData = {
      labels: ['Phones', 'Accessories', 'Electronics', 'Others'],
      sales: [25, 15, 10, 5],
      colors: [
        'rgba(59, 130, 246, 0.8)',
        'rgba(16, 185, 129, 0.8)',
        'rgba(245, 158, 11, 0.8)',
        'rgba(139, 92, 246, 0.8)'
      ]
    };
  }

  // ==========================================
  // BAR CHART - SALES TRENDS (Last 7 Days)
  // ==========================================
  const barCtx = document.getElementById('salesBarChart');
  
  if (barCtx) {
    new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: barChartData.labels,
        datasets: [
          {
            label: 'Sales Count',
            data: barChartData.sales,
            backgroundColor: 'rgba(59, 130, 246, 0.8)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 2,
            borderRadius: 8,
            yAxisID: 'y'
          },
          {
            label: 'Revenue (KSH)',
            data: barChartData.revenue,
            backgroundColor: 'rgba(16, 185, 129, 0.8)',
            borderColor: 'rgba(16, 185, 129, 1)',
            borderWidth: 2,
            borderRadius: 8,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 15,
              font: {
                size: 12,
                weight: '600'
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleFont: {
              size: 14,
              weight: 'bold'
            },
            bodyFont: {
              size: 13
            },
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.dataset.yAxisID === 'y1') {
                  label += 'KSH ' + context.parsed.y.toLocaleString();
                } else {
                  label += context.parsed.y + ' sales';
                }
                return label;
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              display: false
            },
            ticks: {
              font: {
                size: 12,
                weight: '600'
              }
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            },
            ticks: {
              font: {
                size: 11
              },
              callback: function(value) {
                return value + ' sales';
              }
            },
            title: {
              display: true,
              text: 'Sales Count',
              font: {
                size: 12,
                weight: 'bold'
              }
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            grid: {
              drawOnChartArea: false
            },
            ticks: {
              font: {
                size: 11
              },
              callback: function(value) {
                return 'KSH ' + (value / 1000) + 'k';
              }
            },
            title: {
              display: true,
              text: 'Revenue (KSH)',
              font: {
                size: 12,
                weight: 'bold'
              }
            }
          }
        }
      }
    });
    
    console.log('âœ… Bar Chart Initialized');
  }

  // ==========================================
  // DONUT CHART - SALES BY CATEGORY
  // ==========================================
  const donutCtx = document.getElementById('salesDonutChart');
  
  if (donutCtx) {
    new Chart(donutCtx, {
      type: 'doughnut',
      data: {
        labels: donutChartData.labels,
        datasets: [{
          data: donutChartData.sales,
          backgroundColor: donutChartData.colors,
          borderColor: '#ffffff',
          borderWidth: 3,
          hoverOffset: 15
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: true,
            position: 'right',
            labels: {
              usePointStyle: true,
              padding: 20,
              font: {
                size: 13,
                weight: '600'
              },
              generateLabels: function(chart) {
                const data = chart.data;
                if (data.labels.length && data.datasets.length) {
                  return data.labels.map((label, i) => {
                    const value = data.datasets[0].data[i];
                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    
                    return {
                      text: `${label} (${percentage}%)`,
                      fillStyle: data.datasets[0].backgroundColor[i],
                      hidden: false,
                      index: i
                    };
                  });
                }
                return [];
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleFont: {
              size: 14,
              weight: 'bold'
            },
            bodyFont: {
              size: 13
            },
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                return `${label}: ${value} sales (${percentage}%)`;
              }
            }
          }
        },
        cutout: '60%',
        animation: {
          animateRotate: true,
          animateScale: true
        }
      }
    });
    
    console.log('âœ… Donut Chart Initialized');
  }

  console.log('âœ… Sales Statistics Charts Ready');
});



// ====================================
// ====================================
// ADD CATEORY AREA
// ====================================
  let productIndex = 1;
  document.getElementById('add-product-btn').addEventListener('click', function() {
    const tableBody = document.querySelector('#products-table tbody');
    const newRow = document.querySelector('.product-row').cloneNode(true);
    newRow.querySelectorAll('input, select').forEach(el => {
      const name = el.getAttribute('name');
      el.setAttribute('name', name.replace(/products-\d+-/, `products-${productIndex}-`));
      if (el.type !== 'checkbox') el.value = '';
      else el.checked = true;
    });
    tableBody.appendChild(newRow);
    productIndex++;
  });

  // Remove product row
  document.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('remove-product')){
      const row = e.target.closest('tr');
      if(document.querySelectorAll('#products-table tbody tr').length > 1){
        row.remove();
      }
    }
  });


document.addEventListener('DOMContentLoaded', function () {
    const itemTypeSelect = document.getElementById("id_item_type");
    const skuField = document.getElementById("sku-field");
    const quantityField = document.getElementById("quantity-field");

    function toggleFields() {
        const value = itemTypeSelect.value;
        if (value === 'single') {
            skuField.style.display = 'block';
            quantityField.style.display = 'none';
        } else if (value === 'bulk') {
            skuField.style.display = 'none';
            quantityField.style.display = 'block';
        } else {
            skuField.style.display = 'none';
            quantityField.style.display = 'none';
        }
    }

    itemTypeSelect.addEventListener('change', toggleFields);
    toggleFields();  // initialize on page load
});



// ====================================
// ====================================
// ADD CATEGORY SECTION - FIXED VERSION
// ====================================
document.addEventListener("DOMContentLoaded", function() {
    console.log('ðŸ”§ Category form initialization started');
    
    // Wait for section to be visible
    const initCategoryForm = () => {
        const addBtn = document.getElementById("add-product-btn");
        const tableBody = document.querySelector("#products-table tbody");
        const categoryNameInput = document.getElementById("category-name");
        const categoryCodeInput = document.getElementById("category-code");
        const categoryForm = document.getElementById("addCategoryForm");

        if (categoryForm.dataset.initialized === "true") {
           console.log("âš ï¸ Form already initialized, skipping duplicate binding");
           return;
        }
        categoryForm.dataset.initialized = "true";


        if (!addBtn || !tableBody || !categoryNameInput || !categoryCodeInput) {
            console.log('â³ Category form elements not ready, retrying...');
            setTimeout(initCategoryForm, 500);
            return;
        }

        console.log('âœ… Category form elements found');

        // ==========================================
        // AUTO-GENERATE CATEGORY CODE
        // ==========================================
        categoryNameInput.addEventListener("input", function() {
            const name = this.value.trim();
            if (name.length > 0) {
                const firstLetter = name.charAt(0).toUpperCase();
                categoryCodeInput.value = `${firstLetter}FSL`;
            } else {
                categoryCodeInput.value = "";
            }
        });

        // ==========================================
        // ADD NEW PRODUCT ROW
        // ==========================================
        addBtn.addEventListener("click", function(e) {
            e.preventDefault();
            console.log('âž• Adding new product row');
            
            const rows = tableBody.querySelectorAll("tr.product-row");
            const newIndex = rows.length;
            
            // Clone the first row
            const firstRow = rows[0];
            const newRow = firstRow.cloneNode(true);

            // Update all input/select names with new index
            newRow.querySelectorAll("input, select").forEach(el => {
                const name = el.getAttribute("name");
                if (name) {
                    // Replace any existing index with new index
                    const newName = name.replace(/products-\d+-/, `products-${newIndex}-`);
                    el.setAttribute("name", newName);
                    el.setAttribute("id", `id_${newName}`);

                    // Reset values
                    if (el.type === "checkbox") {
                        el.checked = true;
                    } else if (el.tagName.toLowerCase() === "select") {
                        el.selectedIndex = 0;
                    } else if (!el.readOnly) {
                        el.value = "";
                    }
                }
            });

            // Auto-generate product code for new row
            const codeInput = newRow.querySelector('input[name^="products-"][name$="-code"]');
            if (codeInput && categoryCodeInput.value) {
                const categoryCode = categoryCodeInput.value;
                codeInput.value = `${categoryCode}${String(newIndex + 1).padStart(3, '0')}`;
            }

            tableBody.appendChild(newRow);
            console.log(`âœ… New row added with index ${newIndex}`);
        });

        // ==========================================
        // REMOVE PRODUCT ROW
        // ==========================================
        tableBody.addEventListener("click", function(e) {
            if (e.target && e.target.classList.contains("remove-product")) {
                e.preventDefault();
                
                const rows = tableBody.querySelectorAll("tr.product-row");
                
                if (rows.length <= 1) {
                    alert("âš ï¸ At least one product row is required.");
                    return;
                }

                const row = e.target.closest("tr");
                row.remove();
                console.log('ðŸ—‘ï¸ Product row removed');

                // Reindex remaining rows
                reindexProductRows();
            }
        });

        // ==========================================
        // REINDEX ROWS AFTER DELETION
        // ==========================================
        function reindexProductRows() {
            const rows = tableBody.querySelectorAll("tr.product-row");
            
            rows.forEach((row, index) => {
                row.querySelectorAll("input, select").forEach(el => {
                    const name = el.getAttribute("name");
                    if (name) {
                        const newName = name.replace(/products-\d+-/, `products-${index}-`);
                        el.setAttribute("name", newName);
                        el.setAttribute("id", `id_${newName}`);
                    }
                });

                // Update product code
                const codeInput = row.querySelector('input[name^="products-"][name$="-code"]');
                if (codeInput && categoryCodeInput.value) {
                    const categoryCode = categoryCodeInput.value;
                    codeInput.value = `${categoryCode}${String(index + 1).padStart(3, '0')}`;
                }
            });
            
            console.log(`âœ… Reindexed ${rows.length} product rows`);
        }

        // ==========================================
        // AUTO-GENERATE PRODUCT CODES ON CATEGORY CODE CHANGE
        // ==========================================
        categoryCodeInput.addEventListener("change", function() {
            const categoryCode = this.value;
            if (!categoryCode) return;

            const rows = tableBody.querySelectorAll("tr.product-row");
            rows.forEach((row, index) => {
                const codeInput = row.querySelector('input[name^="products-"][name$="-code"]');
                if (codeInput) {
                    codeInput.value = `${categoryCode}${String(index + 1).padStart(3, '0')}`;
                }
            });
        });

        // ==========================================
        // FORM SUBMISSION - AJAX
        // ==========================================
        if (categoryForm) {
            categoryForm.addEventListener("submit", function(e) {
                e.preventDefault();
                
                console.log('ðŸ“¤ Submitting category form');
                
                const submitBtn = categoryForm.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                
                // Disable submit button
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
                
                const formData = new FormData(categoryForm);
                
                // Add management form data for formset
                const rows = tableBody.querySelectorAll("tr.product-row");
                formData.set('products-TOTAL_FORMS', rows.length);
                formData.set('products-INITIAL_FORMS', '0');
                formData.set('products-MIN_NUM_FORMS', '0');
                formData.set('products-MAX_NUM_FORMS', '1000');

                fetch(categoryForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('âœ… Category saved successfully');
                        
                        // Show success message
                        const successDiv = document.getElementById('success-message-category');
                        if (successDiv) {
                            successDiv.textContent = data.message || 'Category saved successfully!';
                            successDiv.style.display = 'block';
                            
                            setTimeout(() => {
                                successDiv.style.display = 'none';
                            }, 5000);
                        }
                        
                        // Reset form
                        categoryForm.reset();
                        categoryCodeInput.value = '';
                        
                        // Reset product rows to one empty row
                        const allRows = Array.from(tableBody.querySelectorAll("tr.product-row"));
                        allRows.slice(1).forEach(row => row.remove());
                        
                        // Clear first row
                        const firstRow = tableBody.querySelector("tr.product-row");
                        firstRow.querySelectorAll("input, select").forEach(el => {
                            if (el.type === "checkbox") {
                                el.checked = true;
                            } else if (!el.readOnly) {
                                el.value = "";
                            }
                        });
                        
                        // Show toast notification
                        showToast('âœ… Category created successfully!', 'success');
                        
                        // Optional: Navigate to category list
                        // setTimeout(() => {
                        //     showSection('category-list');
                        // }, 2000);
                        
                    } else {
                        console.error('âŒ Server error:', data.message);
                        
                        const messageDiv = document.getElementById('message-div-category');
                        if (messageDiv) {
                            messageDiv.innerHTML = `
                                <div class="alert alert-danger">
                                    <strong>Error:</strong> ${data.message || 'Failed to save category'}
                                </div>
                            `;
                        }
                        
                        showToast('âŒ ' + (data.message || 'Failed to save category'), 'error');
                    }
                })
                .catch(error => {
                    console.error('âŒ Network error:', error);
                    
                    const messageDiv = document.getElementById('message-div-category');
                    if (messageDiv) {
                        messageDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <strong>Network Error:</strong> Could not connect to server. Please try again.
                            </div>
                        `;
                    }
                    
                    showToast('âŒ Network error occurred', 'error');
                })
                .finally(() => {
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                });
            });
        }

        console.log('âœ… Category form fully initialized');
    };

    // Initialize when add-category section becomes active
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.target.id === 'add-category' && 
                mutation.target.classList.contains('active')) {
                console.log('ðŸ“‹ Add Category section activated');
                initCategoryForm();
            }
        });
    });

    const addCategorySection = document.getElementById('add-category');
    if (addCategorySection) {
        observer.observe(addCategorySection, {
            attributes: true,
            attributeFilter: ['class']
        });
    }

    // Also try immediate init if section is already active
    if (addCategorySection && addCategorySection.classList.contains('active')) {
        initCategoryForm();
    }
});

// ==========================================
// HELPER: SHOW TOAST NOTIFICATION
// ==========================================
function showToast(message, type = 'success') {
    const existingToast = document.querySelector('.toast-message');
    if (existingToast) {
        existingToast.remove();
    }

    const toast = document.createElement('div');
    toast.className = `toast-message ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 400);
    }, 4000);
}



// ====================================
// ====================================
// ADD PRODUCT  SECTION
// ====================================
document.addEventListener('DOMContentLoaded', function () {

    const categorySelect = document.getElementById('category-select');
    const skuField = document.getElementById('sku-field');
    const skuInput = document.getElementById('sku-input');
    const skuLabel = document.getElementById('sku-label');
    const quantityField = document.getElementById('quantity-field');
    const quantityInput = document.getElementById('quantity');
    const form = document.getElementById('addProductForm');
    const messageDiv = document.getElementById('message-div');
    const successDiv = document.getElementById('success-message-product');
    const saveBtn = form.querySelector("button[type='submit']");

    function getCookie(name) {
        let cookieValue = null;
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = cookie.slice(name.length + 1);
                break;
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function showToast(msg, type="success") {
        const t = document.createElement("div");
        t.className = `toast-message ${type}`;
        t.innerHTML = msg;
        document.body.appendChild(t);
        setTimeout(() => t.classList.add("show"), 50);
        setTimeout(() => t.remove(), 3500);
    }

    function validateInline() {
        const name = document.getElementById("product-name").value.trim();
        const category = categorySelect.value;
        const buy = parseFloat(document.getElementById("buying-price").value);
        const sell = parseFloat(document.getElementById("selling-price").value);

        messageDiv.innerHTML = "";

        if (!category) {
            messageDiv.innerHTML = `<div class="alert alert-danger">Please select a category.</div>`;
            return false;
        }

        if (!name) {
            messageDiv.innerHTML = `<div class="alert alert-danger">Product name is required.</div>`;
            return false;
        }

        if (isNaN(buy) || buy <= 0) {
            messageDiv.innerHTML = `<div class="alert alert-danger">Valid buying price is required.</div>`;
            return false;
        }

        if (isNaN(sell) || sell <= 0) {
            messageDiv.innerHTML = `<div class="alert alert-danger">Valid selling price is required.</div>`;
            return false;
        }

        if (sell < buy) {
            messageDiv.innerHTML = `<div class="alert alert-danger">Selling price must be higher than buying price.</div>`;
            return false;
        }

        // Check if single item needs SKU
        const selected = categorySelect.options[categorySelect.selectedIndex];
        const isSingle = selected.dataset.isSingle === "true";
        if (isSingle && !skuInput.value.trim()) {
            messageDiv.innerHTML = `<div class="alert alert-danger">SKU/IMEI/Serial is required for single items.</div>`;
            skuInput.focus();
            return false;
        }

        // Check if bulk item needs quantity
        const isBulk = selected.dataset.isBulk === "true";
        if (isBulk) {
            const qty = parseInt(quantityInput.value);
            if (isNaN(qty) || qty <= 0) {
                messageDiv.innerHTML = `<div class="alert alert-danger">Valid quantity is required for bulk items.</div>`;
                quantityInput.focus();
                return false;
            }
        }

        return true;
    }

    function updateFields() {
        const selected = categorySelect.options[categorySelect.selectedIndex];
        const isSingle = selected.dataset.isSingle === "true";
        const isBulk = selected.dataset.isBulk === "true";
        const skuType = selected.dataset.skuType || "SKU";

        const barcodeField = document.getElementById('barcode-field');
        const barcodeInput = document.getElementById('barcode-input');

        if (isSingle) {
            // Single items: show SKU field (IMEI/Serial)
            skuField.style.display = 'block';
            skuLabel.textContent = `${skuType} *`;
            skuInput.required = true;
            skuInput.disabled = false; // Enable SKU input
        
            // Hide and disable barcode field
            barcodeField.style.display = 'none';
            barcodeInput.required = false;
            barcodeInput.disabled = true; // Disable so it won't submit
            barcodeInput.value = ''; // Clear value
        
            quantityField.style.display = 'none';
            quantityInput.value = 1;
            quantityInput.required = false;
        
        } else if (isBulk) {
            // Bulk items: show barcode and quantity fields
            skuField.style.display = 'none';
            skuInput.required = false;
            skuInput.disabled = true; // Disable so it won't submit
            skuInput.value = ''; // Clear value
        
            barcodeField.style.display = 'block';
            barcodeInput.required = false;
            barcodeInput.disabled = false; // Enable barcode input
        
            quantityField.style.display = 'block';
            quantityInput.required = true;
        
        } else {
            // No category selected: hide all
            skuField.style.display = 'none';
            skuInput.required = false;
            skuInput.disabled = true;
        
            barcodeField.style.display = 'none';
            barcodeInput.required = false;
            barcodeInput.disabled = true;
        
            quantityField.style.display = 'none';
            quantityInput.required = false;
        }
    }

    categorySelect.addEventListener('change', updateFields);
    updateFields();

    form.addEventListener('submit', function (e) {
        e.preventDefault();

        if (!validateInline()) return;

        saveBtn.disabled = true;
        saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Saving...`;
        messageDiv.innerHTML = "";

        fetch(form.action, {
            method: "POST",
            body: new FormData(form),
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": csrftoken
            }
        })
        .then(response => {
            // CRITICAL FIX: Check content type before parsing
            const contentType = response.headers.get("content-type");
            
            if (contentType && contentType.includes("application/json")) {
                return response.json().then(data => ({ 
                    status: response.status, 
                    data: data 
                }));
            } else {
                // Non-JSON response (probably HTML redirect or error page)
                return response.text().then(text => ({ 
                    status: response.status, 
                    data: { success: false, message: "Unexpected response from server" },
                    rawText: text
                }));
            }
        })
        .then(({ status, data, rawText }) => {
            console.log("Response status:", status);
            console.log("Response data:", data);
            
            if (status === 200 && data.success) {
                showToast("âœ… Product saved successfully!");

                form.reset();
                updateFields();

                successDiv.style.display = "block";
                setTimeout(() => successDiv.style.display = "none", 5000);

                // Navigate to product list
                const listBtn = document.querySelector("[data-section='product-list']");
                if (listBtn) {
                    setTimeout(() => {
                        listBtn.click();
                        // Optionally reload to show new product
                        setTimeout(() => window.location.reload(), 500);
                    }, 1200);
                }
            }
            else {
                // Error response
                let errorMessage = "Error saving product";
                
                if (data.message) {
                    errorMessage = data.message;
                } else if (data.errors) {
                    const firstError = Object.values(data.errors)[0];
                    if (Array.isArray(firstError) && firstError.length > 0) {
                        errorMessage = firstError[0];
                    }
                } else if (rawText) {
                    console.error("Raw response:", rawText);
                    errorMessage = "Server error. Check console for details.";
                }
                
                messageDiv.innerHTML = `<div class="alert alert-danger"><strong>âŒ Error:</strong> ${errorMessage}</div>`;
                showToast(errorMessage, "error");
            }
        })
        .catch(error => {
            console.error("Network error:", error);
            messageDiv.innerHTML = `<div class="alert alert-danger"><strong>âŒ Network Error:</strong> Could not connect to server. Please check your connection.</div>`;
            showToast("Network error occurred", "error");
        })
        .finally(() => {
            saveBtn.disabled = false;
            saveBtn.innerHTML = `<i class="bi bi-save"></i><span> Save Product</span>`;
        });
    });
});


// ====================================
// ====================================
// RESTOCK PRODUCT JAVASCRIPT
// ====================================
document.addEventListener('DOMContentLoaded', function() {
  // Elements
  const searchInput = document.getElementById('restockSearchInput');
  const searchBtn = document.getElementById('restockSearchBtn');
  const searchMessage = document.getElementById('restockSearchMessage');
  const autocompleteDiv = document.getElementById('restockAutocomplete');
  const autocompleteList = document.getElementById('restockAutocompleteList');
  const multipleResults = document.getElementById('restockMultipleResults');
  const productsList = document.getElementById('restockProductsList');
  const formSection = document.getElementById('restockFormSection');
  const restockForm = document.getElementById('restockForm');
  const resetBtn = document.getElementById('restockResetBtn');
  const submitBtn = document.getElementById('restockSubmitBtn');
  const formMessage = document.getElementById('restockFormMessage');
  const emptyState = document.getElementById('restockEmptyState');
  const productInfo = document.getElementById('restockProductInfo');
  
  // Form inputs
  const quantityInput = document.getElementById('restockQuantity');
  const buyingPriceInput = document.getElementById('restockBuyingPrice');
  const sellingPriceInput = document.getElementById('restockSellingPrice');
  const totalAmountDiv = document.getElementById('restockTotalAmountDisplay');
  const totalAmountSpan = document.getElementById('restockTotalAmount');
  const successDisplay = document.getElementById('restockSuccessDisplay');

  let autocompleteTimer = null;

  // Auto-complete on input
  searchInput.addEventListener('input', function() {
    clearTimeout(autocompleteTimer);
    const searchTerm = searchInput.value.trim();
    
    if (searchTerm.length < 2) {
      autocompleteDiv.style.display = 'none';
      return;
    }

    // Debounce - wait 300ms after user stops typing
    autocompleteTimer = setTimeout(() => {
      fetchAutocomplete(searchTerm);
    }, 300);
  });

  // Hide autocomplete when clicking outside
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !autocompleteDiv.contains(e.target)) {
      autocompleteDiv.style.display = 'none';
    }
  });

  // Fetch autocomplete suggestions
  function fetchAutocomplete(searchTerm) {
    fetch(`/inventory/restock/search/?search=${encodeURIComponent(searchTerm)}&autocomplete=true`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success && data.suggestions && data.suggestions.length > 0) {
        displayAutocomplete(data.suggestions);
      } else {
        autocompleteDiv.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Autocomplete error:', error);
      autocompleteDiv.style.display = 'none';
    });
  }

  // Display autocomplete suggestions
  function displayAutocomplete(suggestions) {
    autocompleteList.innerHTML = suggestions.map(item => `
      <div class="autocomplete-item p-3 border-bottom" 
           style="cursor: pointer; transition: background 0.2s;"
           onmouseover="this.style.background='#f3f4f6'"
           onmouseout="this.style.background='white'"
           onclick="selectAutocompleteItem(${item.id}, '${item.name.replace(/'/g, "\\'")}')">
        <div class="d-flex justify-content-between align-items-start">
          <div style="flex: 1;">
            <div class="fw-bold text-dark">${item.name}</div>
            <small class="text-muted">
              <i class="bi bi-tag me-1"></i>${item.product_code}
              ${item.category ? ` | <i class="bi bi-folder me-1"></i>${item.category}` : ''}
              | <i class="bi bi-box me-1"></i>Stock: ${item.current_quantity}
            </small>
          </div>
          ${item.is_single_item 
            ? '<span class="badge bg-danger ms-2">Cannot Restock</span>' 
            : '<span class="badge bg-success ms-2">Can Restock</span>'}
        </div>
      </div>
    `).join('');
    
    autocompleteDiv.style.display = 'block';
  }

  // Select item from autocomplete
  window.selectAutocompleteItem = function(productId, productName) {
    searchInput.value = productName;
    autocompleteDiv.style.display = 'none';
    performSearch();
  };

  // Search on Enter key
  searchInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      autocompleteDiv.style.display = 'none';
      performSearch();
    }
  });

  // Search button click
  searchBtn.addEventListener('click', function() {
    autocompleteDiv.style.display = 'none';
    performSearch();
  });

  // Reset button
  resetBtn.addEventListener('click', function() {
    resetSearch();
  });

  function resetSearch() {
    searchInput.value = '';
    searchInput.focus();
    autocompleteDiv.style.display = 'none';
    formSection.style.display = 'none';
    multipleResults.style.display = 'none';
    searchMessage.style.display = 'none';
    emptyState.style.display = 'block';
    productInfo.style.display = 'none';
    successDisplay.style.display = 'none';
    restockForm.reset();
    totalAmountDiv.style.display = 'none';
  }

  function performSearch() {
    const searchTerm = searchInput.value.trim();
    if (!searchTerm) {
      showSearchMessage('Please enter a product name, code, or SKU', 'error');
      return;
    }

    searchBtn.disabled = true;
    searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Searching...';
    searchMessage.style.display = 'none';
    multipleResults.style.display = 'none';
    formSection.style.display = 'none';

    fetch(`/inventory/restock/search/?search=${encodeURIComponent(searchTerm)}`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        if (data.multiple) {
          displayMultipleProducts(data.products);
        } else {
          displayRestockForm(data.product);
        }
      } else {
        showSearchMessage(data.message, 'error');
      }
    })
    .catch(error => {
      showSearchMessage('Search failed: ' + error.message, 'error');
    })
    .finally(() => {
      searchBtn.disabled = false;
      searchBtn.innerHTML = '<i class="bi bi-search"></i> Search';
    });
  }

  function showSearchMessage(message, type) {
    searchMessage.className = 'alert ' + (type === 'error' ? 'alert-danger' : 'alert-success');
    searchMessage.innerHTML = `<i class="bi bi-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}-fill me-2"></i>${message}`;
    searchMessage.style.display = 'block';
  }

  function displayMultipleProducts(products) {
    productsList.innerHTML = products.map(p => `
      <button 
        onclick="selectRestockProduct(${p.id})"
        class="btn btn-outline-primary text-start p-3">
        <div class="fw-bold">${p.name}</div>
        <small class="text-muted">
          Code: ${p.product_code} | Category: ${p.category} | Stock: ${p.current_quantity}
        </small>
      </button>
    `).join('');
    multipleResults.style.display = 'block';
  }

  // Make selectRestockProduct global
  window.selectRestockProduct = function(productId) {
    fetch(`/inventory/restock/search/?search=${productId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success && !data.multiple) {
        displayRestockForm(data.product);
        multipleResults.style.display = 'none';
      }
    });
  };

  function displayRestockForm(product) {
    // Fill product info
    document.getElementById('restockProductId').value = product.id;
    document.getElementById('restockDisplayName').textContent = product.name;
    document.getElementById('restockDisplayCode').textContent = product.product_code;
    document.getElementById('restockDisplayCategory').textContent = product.category;
    document.getElementById('restockDisplayStock').textContent = product.current_quantity;
    document.getElementById('restockDisplayBuyingPrice').textContent = parseFloat(product.buying_price).toFixed(2);
    document.getElementById('restockDisplaySellingPrice').textContent = parseFloat(product.selling_price).toFixed(2);
    
    // Pre-fill prices
    buyingPriceInput.value = product.buying_price || '';
    sellingPriceInput.value = product.selling_price || '';
    
    // Show sections
    emptyState.style.display = 'none';
    productInfo.style.display = 'block';
    formSection.style.display = 'block';
    successDisplay.style.display = 'none';
    quantityInput.focus();
  }

  // Calculate total amount
  function updateTotal() {
    const qty = parseFloat(quantityInput.value) || 0;
    const price = parseFloat(buyingPriceInput.value) || 0;
    const total = qty * price;

    if (qty > 0 && price > 0) {
      totalAmountSpan.textContent = total.toFixed(2);
      totalAmountDiv.style.display = 'block';
    } else {
      totalAmountDiv.style.display = 'none';
    }
  }

  quantityInput.addEventListener('input', updateTotal);
  buyingPriceInput.addEventListener('input', updateTotal);

  // Form submission
  restockForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(restockForm);
    const submitText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
    formMessage.style.display = 'none';
    successDisplay.style.display = 'none';

    fetch('/inventory/restock/process/', {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update stock display
        document.getElementById('restockDisplayStock').textContent = data.product.new_quantity;
        document.getElementById('restockNewStock').textContent = data.product.new_quantity;
        
        // Show success message
        successDisplay.style.display = 'block';
        
        // Reset form fields but keep product info
        quantityInput.value = '';
        document.getElementById('restockNotes').value = '';
        totalAmountDiv.style.display = 'none';
        
        // Scroll to success message
        successDisplay.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Focus back to quantity
        setTimeout(() => {
          quantityInput.focus();
          successDisplay.style.display = 'none';
        }, 4000);
      } else {
        throw new Error(data.message || 'Operation failed');
      }
    })
    .catch(error => {
      formMessage.className = 'alert alert-danger';
      formMessage.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>${error.message || 'An error occurred'}`;
      formMessage.style.display = 'block';
    })
    .finally(() => {
      submitBtn.disabled = false;
      submitBtn.innerHTML = submitText;
    });
  });
});


// ====================================
// ====================================
// TRANSFER PRODUCT JAVASCRIPT 
// ====================================
document.addEventListener('DOMContentLoaded', function() {
  console.log('ðŸ”§ Enhanced Transfer Product Module Initializing...');
  
  // ============================================
  // ELEMENTS
  // ============================================
  const searchInput = document.getElementById('transferSearchInput');
  const searchBtn = document.getElementById('transferSearchBtn');
  const searchingIndicator = document.getElementById('transferSearchingIndicator');
  const autocompleteDropdown = document.createElement('div');
  const userSelect = document.getElementById('transferUserSelect');
  const quantityField = document.getElementById('transferQuantityField');
  const quantityInput = document.getElementById('transferQuantity');
  const maxQuantitySpan = document.getElementById('transferMaxQuantity');
  const submitBtn = document.getElementById('transferSubmitBtn');
  const resetBtn = document.getElementById('transferResetBtn');
  const messageDiv = document.getElementById('transferMessage');
  const emptyState = document.getElementById('transferEmptyState');
  const loadingState = document.getElementById('transferLoadingState');
  const productDetails = document.getElementById('transferProductDetails');
  
  // NEW: Live preview elements
  const liveProductPreview = document.getElementById('liveProductPreview');
  const liveOwnerPreview = document.getElementById('liveOwnerPreview');
  
  // ============================================
  // STATE
  // ============================================
  let currentProduct = null;
  let autocompleteTimer = null;
  let currentRequest = null;
  let selectedIndex = -1;
  let autocompleteResults = [];
  let usersList = [];
  
  // ============================================
  // SETUP AUTOCOMPLETE DROPDOWN
  // ============================================
  autocompleteDropdown.id = 'transferAutocompleteDropdown';
  autocompleteDropdown.className = 'autocomplete-dropdown';
  autocompleteDropdown.style.cssText = `
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 350px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    display: none;
    margin-top: -1px;
  `;
  
  const searchContainer = searchInput.parentElement;
  searchContainer.style.position = 'relative';
  searchContainer.appendChild(autocompleteDropdown);

  // ============================================
  // LOAD USERS FOR DROPDOWN
  // ============================================
  function loadTransferUsers() {
    console.log('ðŸ“¥ Loading transfer users...');
    
    fetch('/inventory/transfer/users/', {
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        usersList = data.users;
        userSelect.innerHTML = '<option value="">Select receiving user</option>';
        
        data.users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = user.full_name;
          userSelect.appendChild(option);
        });
        
        console.log(`âœ… Loaded ${data.users.length} users`);
      } else {
        console.error('âŒ Failed to load users');
        showMessage('Failed to load users', 'danger');
      }
    })
    .catch(err => {
      console.error('âŒ Error loading users:', err);
      showMessage('Error loading users', 'danger');
    });
  }

  // ============================================
  // LIVE SEARCH - WITH PREVIEW
  // ============================================
  
  searchInput.addEventListener('input', function(e) {
    const searchTerm = e.target.value.trim();
    
    // Clear existing timer
    clearTimeout(autocompleteTimer);
    
    // Cancel any pending request
    if (currentRequest) {
      currentRequest.abort();
      currentRequest = null;
    }
    
    // Reset selection
    selectedIndex = -1;
    
    // Update live preview
    if (searchTerm.length >= 2) {
      updateLiveProductPreview('Searching...', 'info');
    } else {
      updateLiveProductPreview('', 'empty');
    }
    
    // Hide dropdown if input is too short
    if (searchTerm.length < 2) {
      hideAutocomplete();
      return;
    }
    
    // Show loading indicator
    searchingIndicator.style.display = 'inline-block';
    
    // Debounce the search (300ms delay)
    autocompleteTimer = setTimeout(() => {
      performLiveSearch(searchTerm);
    }, 300);
  });

  // Keyboard navigation for autocomplete
  searchInput.addEventListener('keydown', function(e) {
    if (autocompleteDropdown.style.display === 'none') return;
    
    const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
      updateAutocompleteSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, -1);
      updateAutocompleteSelection(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (selectedIndex >= 0 && items[selectedIndex]) {
        items[selectedIndex].click();
      } else {
        performFullSearch();
      }
    } else if (e.key === 'Escape') {
      hideAutocomplete();
    }
  });
  
  // User selection change - update owner preview
  userSelect.addEventListener('change', function() {
    updateLiveOwnerPreview();
  });
  
  // Quantity change - update preview
  quantityInput.addEventListener('input', function() {
    updateTransferPreview();
  });
  
  // Close autocomplete when clicking outside
  document.addEventListener('click', function(e) {
    if (!searchContainer.contains(e.target)) {
      hideAutocomplete();
    }
  });

  // ============================================
  // LIVE PREVIEW FUNCTIONS
  // ============================================
  
  function updateLiveProductPreview(text, type = 'info') {
    if (!liveProductPreview) return;
    
    let icon = 'ðŸ“¦';
    let className = 'text-muted';
    
    if (type === 'success') {
      icon = 'âœ…';
      className = 'text-success fw-bold';
    } else if (type === 'warning') {
      icon = 'âš ï¸';
      className = 'text-warning';
    } else if (type === 'error') {
      icon = 'âŒ';
      className = 'text-danger';
    } else if (type === 'info') {
      icon = 'ðŸ”';
      className = 'text-info';
    }
    
    liveProductPreview.innerHTML = text ? 
      `<span class="${className}">${icon} ${text}</span>` : 
      '<span class="text-muted">No product selected</span>';
  }
  
  function updateLiveOwnerPreview() {
    if (!liveOwnerPreview) return;
    
    const selectedUserId = userSelect.value;
    const selectedUser = usersList.find(u => u.id == selectedUserId);
    
    if (!currentProduct) {
      liveOwnerPreview.innerHTML = '<span class="text-muted">Select product first</span>';
      return;
    }
    
    if (!selectedUser) {
      liveOwnerPreview.innerHTML = '<span class="text-muted">Select new owner</span>';
      return;
    }
    
    const currentOwner = currentProduct.owner || 'FIELDMAX';
    
    liveOwnerPreview.innerHTML = `
      <div class="transfer-preview">
        <span class="text-muted">${currentOwner}</span>
        <i class="bi bi-arrow-right mx-2 text-primary"></i>
        <span class="text-success fw-bold">${selectedUser.full_name}</span>
      </div>
    `;
    
    updateTransferPreview();
  }
  
  function updateTransferPreview() {
    if (!currentProduct || !userSelect.value) return;
    
    const quantity = parseInt(quantityInput.value) || 1;
    const selectedUser = usersList.find(u => u.id == userSelect.value);
    
    if (!selectedUser) return;
    
    // Calculate remaining quantity after transfer
    let remaining = currentProduct.is_single_item ? 0 : currentProduct.current_quantity - quantity;
    
    // Update the transfer summary
    const summaryHtml = `
      <div class="alert alert-light border mt-3">
        <div class="row text-center">
          <div class="col-md-4">
            <div class="fw-bold text-primary">Transferring</div>
            <div class="fs-5">${quantity} ${currentProduct.is_single_item ? 'item' : 'units'}</div>
          </div>
          <div class="col-md-4">
            <div class="fw-bold text-success">To</div>
            <div class="fs-5">${selectedUser.full_name}</div>
          </div>
          <div class="col-md-4">
            <div class="fw-bold ${remaining === 0 ? 'text-warning' : 'text-muted'}">Remaining</div>
            <div class="fs-5">${remaining} units</div>
          </div>
        </div>
      </div>
    `;
    
    // Check if transfer summary div exists, if not create it
    let summaryDiv = document.getElementById('transferSummary');
    if (!summaryDiv) {
      summaryDiv = document.createElement('div');
      summaryDiv.id = 'transferSummary';
      productDetails.appendChild(summaryDiv);
    }
    
    summaryDiv.innerHTML = summaryHtml;
  }

  function performLiveSearch(searchTerm) {
    const controller = new AbortController();
    currentRequest = controller;
    
    const url = `/inventory/transfer/search/?search=${encodeURIComponent(searchTerm)}&autocomplete=true`;
    
    fetch(url, {
      headers: {'X-Requested-With': 'XMLHttpRequest'},
      signal: controller.signal
    })
    .then(res => res.json())
    .then(data => {
      currentRequest = null;
      searchingIndicator.style.display = 'none';
      
      if (data.success && data.suggestions) {
        autocompleteResults = data.suggestions;
        displayAutocomplete(data.suggestions, searchTerm);
        
        // Update live preview with match count
        updateLiveProductPreview(
          `${data.suggestions.length} product(s) found`, 
          'success'
        );
      } else {
        hideAutocomplete();
        updateLiveProductPreview('No matches found', 'warning');
      }
    })
    .catch(err => {
      if (err.name === 'AbortError') {
        console.log('Request cancelled');
      } else {
        console.error('Live search error:', err);
        searchingIndicator.style.display = 'none';
        updateLiveProductPreview('Search error', 'error');
      }
      currentRequest = null;
    });
  }

  function displayAutocomplete(suggestions, searchTerm) {
    if (suggestions.length === 0) {
      hideAutocomplete();
      return;
    }
    
    let html = '';
    
    suggestions.forEach((product, index) => {
      const ownerBadge = product.is_mine ? 
        '<span class="badge bg-success" style="font-size: 0.7rem;">Yours</span>' : 
        `<span class="badge bg-secondary" style="font-size: 0.7rem;">${product.owner}</span>`;
      
      const stockInfo = product.is_single_item ? 
        '<span class="text-muted" style="font-size: 0.8rem;">Single Item</span>' :
        `<span class="text-success" style="font-size: 0.8rem;"><strong>${product.current_quantity}</strong> units</span>`;
      
      const highlightedName = highlightMatch(product.name, searchTerm);
      const highlightedCode = highlightMatch(product.product_code, searchTerm);
      
      html += `
        <div class="autocomplete-item" data-product-id="${product.id}" style="
          padding: 12px 16px;
          cursor: pointer;
          border-bottom: 1px solid #f0f0f0;
          transition: all 0.2s ease;
        ">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #2c3e50; margin-bottom: 4px;">
                ${highlightedName}
              </div>
              <div style="font-size: 0.85rem; color: #7f8c8d;">
                Code: ${highlightedCode} | ${product.category}
              </div>
            </div>
            <div style="text-align: right; margin-left: 12px;">
              ${ownerBadge}
              <div style="margin-top: 4px;">
                ${stockInfo}
              </div>
            </div>
          </div>
        </div>
      `;
    });
    
    autocompleteDropdown.innerHTML = html;
    autocompleteDropdown.style.display = 'block';
    
    // Add click handlers
    const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
    items.forEach((item, index) => {
      item.addEventListener('click', function() {
        const productId = this.dataset.productId;
        selectProductFromAutocomplete(productId);
      });
      
      // Hover effect
      item.addEventListener('mouseenter', function() {
        items.forEach(i => i.style.backgroundColor = '');
        this.style.backgroundColor = '#f8f9fa';
        selectedIndex = index;
      });
      
      item.addEventListener('mouseleave', function() {
        this.style.backgroundColor = '';
      });
    });
  }

  function highlightMatch(text, searchTerm) {
    if (!searchTerm || !text) return text;
    
    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<strong style="background-color: #fff3cd; color: #856404;">$1</strong>');
  }

  function updateAutocompleteSelection(items) {
    items.forEach((item, index) => {
      if (index === selectedIndex) {
        item.style.backgroundColor = '#e3f2fd';
        item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      } else {
        item.style.backgroundColor = '';
      }
    });
  }

  function hideAutocomplete() {
    autocompleteDropdown.style.display = 'none';
    autocompleteDropdown.innerHTML = '';
    selectedIndex = -1;
    autocompleteResults = [];
  }

  function selectProductFromAutocomplete(productId) {
    hideAutocomplete();
    const selected = autocompleteResults.find(p => p.id == productId);
    if (selected) {
      searchInput.value = selected.product_code;
      updateLiveProductPreview(`Selected: ${selected.name}`, 'success');
    }
    performFullSearch();
  }

  // ============================================
  // FULL SEARCH (ON ENTER OR BUTTON CLICK)
  // ============================================
  searchBtn.addEventListener('click', performFullSearch);
  
  function performFullSearch() {
    const searchTerm = searchInput.value.trim();
    
    if (!searchTerm) {
      showMessage('Please enter a product code or SKU', 'danger');
      updateLiveProductPreview('Enter search term', 'warning');
      return;
    }
    
    hideAutocomplete();
    searchingIndicator.style.display = 'inline-block';
    emptyState.style.display = 'none';
    loadingState.style.display = 'block';
    productDetails.style.display = 'none';
    updateLiveProductPreview('Loading...', 'info');

    const url = `/inventory/transfer/search/?search=${encodeURIComponent(searchTerm)}`;

    fetch(url, {
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        if (data.multiple) {
          displayMultipleProducts(data.products);
          updateLiveProductPreview(`${data.products.length} products found`, 'success');
        } else if (data.product) {
          displayProductInfo(data.product);
          updateLiveProductPreview(`${data.product.name} (${data.product.product_code})`, 'success');
        }
      } else {
        showMessage(data.message, 'danger');
        showEmptyState();
        updateLiveProductPreview(data.message, 'error');
      }
    })
    .catch(err => {
      console.error('Search error:', err);
      showMessage('Search failed. Please try again.', 'danger');
      showEmptyState();
      updateLiveProductPreview('Search failed', 'error');
    })
    .finally(() => {
      searchingIndicator.style.display = 'none';
      loadingState.style.display = 'none';
    });
  }

  // ============================================
  // DISPLAY MULTIPLE PRODUCTS
  // ============================================
  function displayMultipleProducts(products) {
    let html = `
      <div class="alert alert-info" style="margin-bottom: 16px;">
        <i class="bi bi-info-circle"></i>
        <strong>Multiple Products Found (${products.length})</strong>
        <p class="mb-0 mt-2">Click on a product to select it for transfer:</p>
      </div>
    `;

    products.forEach(p => {
      const ownerBadge = p.is_mine ? 
        '<span class="badge bg-success">Your Product</span>' : 
        `<span class="badge bg-secondary">Owner: ${p.owner}</span>`;
      
      const clickable = p.is_mine || (typeof userIsAdmin !== 'undefined' && userIsAdmin);
      const cardStyle = clickable ? 
        'cursor: pointer; transition: all 0.2s ease;' : 
        'opacity: 0.6; cursor: not-allowed;';
      
      const cardClass = clickable ? 'product-card-selectable' : '';
      
      html += `
        <div class="card mb-2 ${cardClass}" ${clickable ? `onclick="selectTransferProduct(${p.id})"` : ''} style="${cardStyle}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div style="flex: 1;">
                <h6 class="mb-2">${p.name}</h6>
                <div class="text-muted" style="font-size: 0.9rem;">
                  <strong>Code:</strong> ${p.product_code} | 
                  <strong>Category:</strong> ${p.category} | 
                  ${p.is_single_item ? 
                    '<span class="badge bg-primary">Single Item</span>' : 
                    `<span class="badge bg-success">${p.current_quantity} units</span>`
                  }
                </div>
              </div>
              <div style="text-align: right;">
                ${ownerBadge}
              </div>
            </div>
          </div>
        </div>
      `;
    });

    productDetails.innerHTML = html;
    productDetails.style.display = 'block';
    emptyState.style.display = 'none';
    
    // Add hover effects
    document.querySelectorAll('.product-card-selectable').forEach(card => {
      card.addEventListener('mouseenter', function() {
        this.style.backgroundColor = '#f8f9fa';
        this.style.transform = 'translateX(4px)';
        this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
      });
      
      card.addEventListener('mouseleave', function() {
        this.style.backgroundColor = '';
        this.style.transform = '';
        this.style.boxShadow = '';
      });
    });
  }

  // Make function global
  window.selectTransferProduct = function(productId) {
    searchInput.value = productId;
    performFullSearch();
  };

  // ============================================
  // DISPLAY PRODUCT INFO
  // ============================================
  function displayProductInfo(product) {
    currentProduct = product;

    let ownerBadge;
    if (product.is_admin) {
      ownerBadge = product.is_mine ? 
        '<span class="badge bg-success">Your Product</span>' : 
        `<span class="badge bg-info">Owner: ${product.owner}</span>`;
    } else {
      ownerBadge = product.is_mine ? 
        '<span class="badge bg-success">Your Product</span>' : 
        `<span class="badge bg-warning text-dark">Owner: ${product.owner}</span>`;
    }

    const adminNote = product.is_admin && !product.is_mine ? 
      `<div class="alert alert-info mt-3">
        <i class="bi bi-shield-check"></i> 
        <strong>Admin Mode:</strong> You can transfer this product from ${product.owner} to another user.
      </div>` : '';

    let html = `
      <div class="alert ${product.is_single_item ? 'alert-info' : 'alert-success'}">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <h5 class="mb-0">
            ${product.is_single_item ? 'ðŸ“±' : 'ðŸ“¦'} ${product.name}
          </h5>
          ${ownerBadge}
        </div>
        
        <div class="product-info-card">
          <div class="product-info-item">
            <span class="product-info-label">Product Code</span>
            <span class="product-info-value">${product.product_code}</span>
          </div>
          
          <div class="product-info-item">
            <span class="product-info-label">SKU</span>
            <span class="product-info-value">${product.sku_value}</span>
          </div>
          
          <div class="product-info-item">
            <span class="product-info-label">Category</span>
            <span class="product-info-value">${product.category}</span>
          </div>
          
          <div class="product-info-item">
            <span class="product-info-label">Current Owner</span>
            <span class="product-info-value">
              <strong>${product.owner}</strong>
            </span>
          </div>
          
          <div class="product-info-item">
            <span class="product-info-label">Type</span>
            <span class="product-info-value">
              ${product.is_single_item ? 
                '<span class="badge bg-primary">Single Item</span>' : 
                '<span class="badge bg-success">Bulk Item</span>'}
            </span>
          </div>
          
          <div class="product-info-item">
            <span class="product-info-label">Available Quantity</span>
            <span class="product-info-value text-success">
              <strong>${product.current_quantity} ${product.is_single_item ? 'unit' : 'units'}</strong>
            </span>
          </div>
        </div>
        
        ${adminNote}
      </div>
    `;

    productDetails.innerHTML = html;
    productDetails.style.display = 'block';
    emptyState.style.display = 'none';

    // Enable form
    userSelect.disabled = false;
    submitBtn.disabled = false;

    // Handle quantity field
    if (product.is_single_item) {
      quantityField.style.display = 'none';
      quantityInput.value = 1;
    } else {
      quantityField.style.display = 'block';
      quantityInput.max = product.current_quantity;
      maxQuantitySpan.textContent = product.current_quantity;
      quantityInput.value = 1;
    }

    // Update live previews
    updateLiveOwnerPreview();
    userSelect.focus();
  }

  // ============================================
  // SUBMIT TRANSFER
  // ============================================
  submitBtn.addEventListener('click', function(e) {
    e.preventDefault();

    if (!currentProduct) {
      showMessage('Please search for a product first', 'danger');
      return;
    }

    const userId = userSelect.value;
    const quantity = parseInt(quantityInput.value);

    if (!userId) {
      showMessage('Please select a recipient', 'danger');
      userSelect.focus();
      return;
    }

    if (!currentProduct.is_single_item && (!quantity || quantity <= 0)) {
      showMessage('Please enter a valid quantity', 'danger');
      quantityInput.focus();
      return;
    }

    if (!currentProduct.is_single_item && quantity > currentProduct.current_quantity) {
      showMessage(`Only ${currentProduct.current_quantity} units available`, 'danger');
      return;
    }

    // Confirm transfer
    const recipientName = userSelect.options[userSelect.selectedIndex].text;
    const confirmMsg = `Transfer ${quantity} unit(s) of "${currentProduct.name}" to ${recipientName}?`;
    
    if (!confirm(confirmMsg)) return;

    // Submit
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

    const formData = new FormData();
    formData.append('product_id', currentProduct.id);
    formData.append('user_id', userId);
    formData.append('quantity', quantity);

    fetch('/inventory/transfer/process/', {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showMessage(data.message, 'success');
        
        // Update UI based on transfer type
        if (currentProduct.is_single_item || data.product.remaining_quantity === 0) {
          showMessage('Product transferred successfully. Redirecting...', 'success');
          updateLiveProductPreview('Transfer complete! âœ…', 'success');
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          // Partial transfer - update current product
          currentProduct.current_quantity = data.product.remaining_quantity;
          showMessage(data.message + ' You can transfer more or search for another product.', 'success');
          displayProductInfo(currentProduct);
          updateLiveProductPreview(`${currentProduct.name} - ${data.product.remaining_quantity} units remaining`, 'success');
        }
      } else {
        showMessage(data.message, 'danger');
        updateLiveProductPreview('Transfer failed', 'error');
      }
    })
    .catch(err => {
      console.error('Transfer error:', err);
      showMessage('Transfer failed. Please try again.', 'danger');
      updateLiveProductPreview('Transfer failed', 'error');
    })
    .finally(() => {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Confirm Transfer';
    });
  });

  // ============================================
  // RESET FORM
  // ============================================
  resetBtn.addEventListener('click', resetForm);

  function resetForm() {
    searchInput.value = '';
    userSelect.value = '';
    userSelect.disabled = true;
    quantityInput.value = 1;
    quantityField.style.display = 'none';
    submitBtn.disabled = true;
    currentProduct = null;
    messageDiv.innerHTML = '';
    hideAutocomplete();
    showEmptyState();
    
    // Reset live previews
    updateLiveProductPreview('', 'empty');
    if (liveOwnerPreview) {
      liveOwnerPreview.innerHTML = '<span class="text-muted">No transfer configured</span>';
    }
    
    // Remove transfer summary if exists
    const summaryDiv = document.getElementById('transferSummary');
    if (summaryDiv) {
      summaryDiv.remove();
    }
    
    searchInput.focus();
  }

  // ============================================
  // UTILITY FUNCTIONS
  // ============================================
  function showEmptyState() {
    emptyState.style.display = 'block';
    productDetails.style.display = 'none';
    loadingState.style.display = 'none';
  }

  function showMessage(msg, type = 'info') {
    const alertClass = type === 'danger' ? 'alert-danger' : 
                       type === 'success' ? 'alert-success' : 'alert-info';
    
    const icon = type === 'danger' ? 'bi-exclamation-triangle' :
                 type === 'success' ? 'bi-check-circle' : 'bi-info-circle';
    
    messageDiv.innerHTML = `
      <div class="alert ${alertClass} alert-dismissible fade show">
        <i class="bi ${icon}"></i>
        ${msg}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
    
    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    // Auto-dismiss success messages after 5 seconds
    if (type === 'success') {
      setTimeout(() => {
        const alert = messageDiv.querySelector('.alert');
        if (alert) {
          alert.classList.remove('show');
          setTimeout(() => messageDiv.innerHTML = '', 150);
        }
      }, 5000);
    }
  }

  // ============================================
  // INITIALIZE
  // ============================================
  loadTransferUsers();
  searchInput.focus();
  
  // Initialize live previews
  updateLiveProductPreview('Enter product code to search', 'info');
  if (liveOwnerPreview) {
    liveOwnerPreview.innerHTML = '<span class="text-muted">No transfer configured</span>';
  }
  
  console.log('âœ… Enhanced Transfer Product Module Ready with Live Previews');
});


// ============================================
// FILTER USERS
// ============================================
function filterUsers() {
  const roleFilter = document.getElementById('roleFilter').value.toLowerCase();
  const statusFilter = document.getElementById('userStatusFilter').value.toLowerCase();
  const rows = document.querySelectorAll('.user-row');
  
  let visibleCount = 0;
  
  rows.forEach(row => {
    const role = row.getAttribute('data-role');
    const status = row.getAttribute('data-status');
    
    const roleMatch = roleFilter === 'all' || role === roleFilter;
    const statusMatch = statusFilter === 'all' || status === statusFilter;
    
    if (roleMatch && statusMatch) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });
  
  updateUserTableInfo(visibleCount);
}

// Search users
function searchUsers() {
  const searchValue = document.getElementById('userSearch').value.toLowerCase();
  const rows = document.querySelectorAll('.user-row');
  
  let visibleCount = 0;
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    if (text.includes(searchValue)) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });
  
  updateUserTableInfo(visibleCount);
}

// Change entries per page
function changeUserEntries() {
  const entriesValue = document.getElementById('userEntriesSelect').value;
  const rows = document.querySelectorAll('.user-row');
  
  if (entriesValue === 'all') {
    rows.forEach(row => row.style.display = '');
    updateUserTableInfo(rows.length);
  } else {
    const limit = parseInt(entriesValue);
    rows.forEach((row, index) => {
      row.style.display = index < limit ? '' : 'none';
    });
    updateUserTableInfo(Math.min(limit, rows.length));
  }
}

// Update table info
function updateUserTableInfo(visibleCount) {
  document.getElementById('userShowingStart').textContent = visibleCount > 0 ? '1' : '0';
  document.getElementById('userShowingEnd').textContent = visibleCount;
}


// ====================================
// =====================================
// BUTTON CLICK HANDLERS FOR ROW ACTIONS
// ====================================
function editProduct(btn) {
    const id = btn.dataset.id;
    const name = btn.dataset.name;
    const row = document.getElementById(`product-row-${id}`);
    const buy = row.querySelector(".product-buying-price").innerText.replace("KSH", "").trim();
    const sell = row.querySelector(".product-selling-price").innerText.replace("KSH", "").trim();
    const qty = row.querySelector(".product-quantity").innerText.trim();
    openEditModal(id, name, buy, sell, qty);
}

function deleteProduct(btn) {
    openDeleteModal(btn.dataset.id, btn.dataset.name);
}

function transferProduct(btn) {
    const id = btn.dataset.id;
    const row = document.getElementById(`product-row-${id}`);
    const qty = parseInt(row.querySelector(".product-quantity").innerText);
    const isSKU = qty === 1;
    openTransferModal(id, isSKU);
}


// ====================================
// ====================================
// RECORD SALE FUNCTIONALITY ðŸ›’ðŸ›’ðŸ›’
// ====================================
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('saleForm');
    const productCodeInput = document.getElementById('productCode');
    const quantityInput = document.getElementById('quantity');
    const unitPriceInput = document.getElementById('saleAmount');
    const totalAmountInput = document.getElementById('totalAmount');
    
    // Column B - Display Elements
    const emptyState = document.getElementById('emptyState');
    const productDetailsDiv = document.getElementById('productDetails');
    const saleMessageDiv = document.getElementById('saleMessage');
    
    const recordSaleBtn = document.getElementById('recordSaleBtn');
    const addAnotherBtn = document.getElementById('addAnotherBtn');
    const clientPhoneInput = document.getElementById('client_phone');
    
    let currentProduct = null;
    let debounceTimer = null;

    // ============================================
    // PRODUCT CODE LOOKUP WITH DEBOUNCE
    // ============================================
    productCodeInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const code = this.value.trim();
        
        if (code.length < 2) {
            showEmptyState();
            return;
        }
        
        showLoadingState();
        debounceTimer = setTimeout(() => lookupProduct(code), 500);
    });

    // ============================================
    // SHOW LOADING STATE IN COLUMN B
    // ============================================
    function showLoadingState() {
        emptyState.style.display = 'none';
        productDetailsDiv.style.display = 'block';
        productDetailsDiv.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mt-3">Searching product...</p>
            </div>
        `;
    }

    // ============================================
    // SHOW EMPTY STATE (NO PRODUCT)
    // ============================================
    function showEmptyState() {
        emptyState.style.display = 'block';
        productDetailsDiv.style.display = 'none';
        saleMessageDiv.innerHTML = '';
        currentProduct = null;
        disableSaleForm();
    }

    // ============================================
    // PRODUCT LOOKUP API CALL
    // ============================================
    async function lookupProduct(code) {
        try {
            const response = await fetch(`/sales/product-lookup/?product_code=${encodeURIComponent(code)}`);
            const data = await response.json();
            
            emptyState.style.display = 'none';
            
            if (!data.success) {
                displayProductError(data.message || 'Product not found');
                currentProduct = null;
                return;
            }
            
            const product = data.product;
            
            // âœ… NEW: Check if product is SOLD (single-item only)
            if (product.is_single_item && product.status === 'sold') {
                displaySoldProduct(product);
                currentProduct = null;
                return;
            }
            
            // âœ… NEW: Check if bulk product is OUT OF STOCK
            if (!product.is_single_item && product.quantity === 0) {
                displayOutOfStockProduct(product);
                currentProduct = null;
                return;
            }
            
            // Product is available - display in Column B
            currentProduct = product;
            displayAvailableProduct(product);
            
        } catch (error) {
            console.error('Lookup error:', error);
            displayProductError('Error looking up product. Please try again.');
        }
    }

    // ============================================
    // DISPLAY AVAILABLE PRODUCT IN COLUMN B
    // ============================================
    function displayAvailableProduct(product) {
        const itemTypeIcon = product.is_single_item ? 'ðŸ“±' : 'ðŸ“¦';
        
        // Determine status badge
        let statusBadge, statusText;
        if (product.is_single_item) {
            statusBadge = '<span class="badge bg-success product-badge"><i class="bi bi-check-circle-fill"></i> AVAILABLE</span>';
            statusText = '<span class="text-success"><strong>Available</strong></span>';
        } else {
            if (product.quantity > 5) {
                statusBadge = '<span class="badge bg-success product-badge"><i class="bi bi-check-circle-fill"></i> IN STOCK</span>';
                statusText = `<span class="text-success"><strong>${product.quantity} units</strong></span>`;
            } else if (product.quantity > 0) {
                statusBadge = '<span class="badge bg-warning product-badge"><i class="bi bi-exclamation-triangle-fill"></i> LOW STOCK</span>';
                statusText = `<span class="text-warning"><strong>${product.quantity} units (Low)</strong></span>`;
            }
        }
        
        // Calculate product age for FIFO
        const createdDate = new Date(product.created_at);
        const ageInDays = Math.floor((new Date() - createdDate) / (1000 * 60 * 60 * 24));
        
        let html = `
            <div class="available-alert">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h4 class="mb-0">
                        ${itemTypeIcon} ${product.name}
                    </h4>
                    ${statusBadge}
                </div>
                
                <!-- Product Info Grid -->
                <div class="product-info-card mt-3">
                    
                    <div class="product-info-item">
                        <span class="product-info-label">
                            <i class="bi bi-tag"></i> Product Code
                        </span>
                        <span class="product-info-value">${product.product_code}</span>
                    </div>
                    
                    <div class="product-info-item">
                        <span class="product-info-label">
                            <i class="bi bi-upc"></i> SKU / Identifier
                        </span>
                        <span class="product-info-value">${product.sku_code}</span>
                    </div>
                    
                    <div class="product-info-item">
                        <span class="product-info-label">
                            <i class="bi bi-folder"></i> Category
                        </span>
                        <span class="product-info-value">${product.category}</span>
                    </div>
                    
                    <div class="product-info-item">
                        <span class="product-info-label">
                            <i class="bi bi-box-seam"></i> Stock Status
                        </span>
                        <span class="product-info-value">
                            ${statusText}
                        </span>
                    </div>
                    
                    <div class="product-info-item">
                        <span class="product-info-label">
                            <i class="bi bi-cash"></i> Unit Price
                        </span>
                        <span class="product-info-value text-primary">
                            KSH ${parseFloat(product.unit_price).toLocaleString('en-KE', {minimumFractionDigits: 2})}
                        </span>
                    </div>
        `;
        
        // Show FIFO age for single items
        if (product.is_single_item) {
            html += `
                    <div class="product-info-item">
                        <span class="product-info-label">
                            <i class="bi bi-clock-history"></i> Item Age
                        </span>
                        <span class="product-info-value">${ageInDays} days</span>
                    </div>
            `;
            
            html += `
                </div><!-- End product-info-card -->
                
                <div class="fifo-badge mt-3">
                    <i class="bi bi-check-circle-fill"></i> FIFO: Oldest Available Unit
                    <span class="ms-2">(${ageInDays} days old)</span>
                </div>
            `;
        } else {
            html += `
                </div><!-- End product-info-card -->
            `;
        }
        
        html += `
            </div><!-- End available-alert -->
        `;
        
        productDetailsDiv.innerHTML = html;
        productDetailsDiv.style.display = 'block';
        
        // Auto-fill unit price in Column A
        unitPriceInput.value = product.unit_price;
        
        // Handle quantity constraints
        if (product.is_single_item) {
            quantityInput.value = 1;
            quantityInput.max = 1;
            quantityInput.disabled = true;
        } else {
            quantityInput.value = 1;
            quantityInput.max = product.quantity;
            quantityInput.disabled = false;
        }
        
        calculateTotal();
        enableSaleForm();
    }

    // ============================================
    // âœ… NEW: DISPLAY SOLD PRODUCT (SINGLE-ITEM)
    // ============================================
    function displaySoldProduct(product) {
        let html = `
            <div class="sold-alert">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h4 class="mb-0 text-danger">
                        <i class="bi bi-x-circle-fill"></i> Product Already Sold
                    </h4>
                    <span class="badge bg-danger product-badge">SOLD</span>
                </div>
                
                <div class="alert alert-warning mb-3">
                    <strong>âš ï¸ Cannot Sell This Product</strong>
                    <p class="mb-0 mt-2">This single-item product has already been sold and cannot be sold again.</p>
                </div>
                
                <!-- Product Info -->
                <div class="product-info-card">
                    <div class="product-info-item">
                        <span class="product-info-label"><i class="bi bi-box"></i> Product Name</span>
                        <span class="product-info-value">${product.name}</span>
                    </div>
                    <div class="product-info-item">
                        <span class="product-info-label"><i class="bi bi-tag"></i> Product Code</span>
                        <span class="product-info-value">${product.product_code}</span>
                    </div>
                    <div class="product-info-item">
                        <span class="product-info-label"><i class="bi bi-upc"></i> SKU</span>
                        <span class="product-info-value">${product.sku_code}</span>
                    </div>
                    <div class="product-info-item">
                        <span class="product-info-label"><i class="bi bi-box-seam"></i> Status</span>
                        <span class="product-info-value text-danger">
                            <strong><i class="bi bi-x-circle-fill"></i> SOLD</strong>
                        </span>
                    </div>
        `;
        
        // Add sale reference if available
        if (product.sale_id) {
            html += `
                    <div class="product-info-item">
                        <span class="product-info-label"><i class="bi bi-receipt"></i> Sale ID</span>
                        <span class="product-info-value">#${product.sale_id}</span>
                    </div>
            `;
        }
        
        html += `
                </div><!-- End product-info-card -->
        `;
        
        // Add action buttons if sale_id available
        if (product.sale_id) {
            html += `
                <div class="d-grid gap-2 mt-4">
                    <a href="/sales/sale/${product.sale_id}/" 
                       class="btn btn-info" 
                       target="_blank">
                        <i class="bi bi-eye"></i> View Sale Details
                    </a>
                    <button type="button" 
                            class="btn btn-warning" 
                            onclick="showReversalModal(${product.sale_id})">
                        <i class="bi bi-arrow-counterclockwise"></i> Reverse This Sale
                    </button>
                </div>
            `;
        }
        
        html += `</div><!-- End sold-alert -->`;
        
        productDetailsDiv.innerHTML = html;
        productDetailsDiv.style.display = 'block';
        
        disableSaleForm();
    }

    // ============================================
    // âœ… NEW: DISPLAY OUT OF STOCK PRODUCT (BULK)
    // ============================================
    function displayOutOfStockProduct(product) {
        let html = `
            <div class="sold-alert">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h4 class="mb-0 text-danger">
                        <i class="bi bi-x-circle-fill"></i> Product Out of Stock
                    </h4>
                    <span class="badge bg-danger product-badge">OUT OF STOCK</span>
                </div>
                
                <div class="alert alert-danger mb-3">
                    <strong>âš ï¸ Cannot Sell This Product</strong>
                    <p class="mb-0 mt-2">This product has 0 units remaining. Please restock before selling.</p>
                </div>
                
                <!-- Product Info -->
                <div class="product-info-card">
                    <div class="product-info-item">
                        <span class="product-info-label"><i class="bi bi-box"></i> Product Name</span>
                        <span class="product-info-value">${product.name}</span>
                    </div>
                    <div class="product-info-item">
                        <span class="product-info-label"><i class="bi bi-tag"></i> Product Code</span>
                        <span class="product-info-value">${product.product_code}</span>
                    </div>
                    <div class="product-info-item">
                        <span class="product-info-label"><i class="bi bi-upc"></i> SKU</span>
                        <span class="product-info-value">${product.sku_code}</span>
                    </div>
                    <div class="product-info-item">
                        <span class="product-info-label"><i class="bi bi-folder"></i> Category</span>
                        <span class="product-info-value">${product.category}</span>
                    </div>
                    <div class="product-info-item">
                        <span class="product-info-label"><i class="bi bi-box-seam"></i> Stock Status</span>
                        <span class="product-info-value text-danger">
                            <strong><i class="bi bi-x-circle-fill"></i> 0 units (Out of Stock)</strong>
                        </span>
                    </div>
                </div><!-- End product-info-card -->
                
                <div class="d-grid gap-2 mt-4">
                    <a href="/products/" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Restock This Product
                    </a>
                </div>
            </div><!-- End sold-alert -->
        `;
        
        productDetailsDiv.innerHTML = html;
        productDetailsDiv.style.display = 'block';
        
        disableSaleForm();
    }

    // ============================================
    // DISPLAY ERROR IN COLUMN B
    // ============================================
    function displayProductError(message) {
        productDetailsDiv.innerHTML = `
            <div class="alert alert-danger">
                <h5 class="alert-heading">
                    <i class="bi bi-exclamation-triangle-fill"></i> Error
                </h5>
                <p class="mb-0">${message}</p>
            </div>
        `;
        productDetailsDiv.style.display = 'block';
        disableSaleForm();
    }

    // ============================================
    // FORM STATE MANAGEMENT
    // ============================================
    function enableSaleForm() {
        recordSaleBtn.disabled = false;
        addAnotherBtn.disabled = false;
        unitPriceInput.disabled = false;
    }

    function disableSaleForm() {
        recordSaleBtn.disabled = true;
        addAnotherBtn.disabled = true;
        unitPriceInput.disabled = true;
        quantityInput.disabled = true;
    }

    // ============================================
    // CALCULATE TOTAL (REAL-TIME)
    // ============================================
    function calculateTotal() {
        const quantity = parseInt(quantityInput.value) || 0;
        const unitPrice = parseFloat(unitPriceInput.value) || 0;
        const total = quantity * unitPrice;
        
        if (total > 0) {
            totalAmountInput.value = `KSH ${total.toLocaleString('en-KE', {minimumFractionDigits: 2})}`;
        } else {
            totalAmountInput.value = '';
        }
    }

    quantityInput.addEventListener('input', calculateTotal);
    unitPriceInput.addEventListener('input', calculateTotal);

    // ============================================
    // CLIENT PHONE LOOKUP (AUTO-FILL)
    // ============================================
    clientPhoneInput.addEventListener('blur', async function() {
        const phone = this.value.trim();
        if (!phone) return;
        
        try {
            const response = await fetch(`/sales/client-lookup/?phone=${encodeURIComponent(phone)}`);
            const data = await response.json();
            
            if (data.exists) {
                document.getElementById('client_name').value = data.name || '';
                document.getElementById('client_id').value = data.id_number || '';
                document.getElementById('nok_name').value = data.nok_name || '';
                document.getElementById('nok_phone').value = data.nok_phone || '';
                
                showTempMessage('Client details auto-filled from previous sale', 'info');
            }
        } catch (error) {
            console.error('Client lookup error:', error);
        }
    });

    // ============================================
    // SUBMIT SALE
    // ============================================
    recordSaleBtn.addEventListener('click', () => submitSale(false));
    addAnotherBtn.addEventListener('click', () => submitSale(true));

    async function submitSale(addAnother) {
        if (!currentProduct) {
            showMessage('Please select a valid product first', 'danger');
            return;
        }
        
        const quantity = parseInt(quantityInput.value);
        const unitPrice = parseFloat(unitPriceInput.value);
        
        if (!quantity || quantity <= 0) {
            showMessage('Please enter a valid quantity', 'danger');
            return;
        }
        
        if (!unitPrice || unitPrice <= 0) {
            showMessage('Please enter a valid unit price', 'danger');
            return;
        }
        
        // Validate quantity for bulk products
        if (!currentProduct.is_single_item && quantity > currentProduct.quantity) {
            showMessage(`Cannot sell ${quantity} units. Only ${currentProduct.quantity} available.`, 'danger');
            return;
        }
        
        // Prepare data
        const formData = {
            product_code: productCodeInput.value.trim(),
            quantity: quantity,
            unit_price: unitPrice,
            buyer_name: document.getElementById('client_name').value.trim(),
            buyer_phone: document.getElementById('client_phone').value.trim(),
            buyer_id_number: document.getElementById('client_id').value.trim(),
            nok_name: document.getElementById('nok_name').value.trim(),
            nok_phone: document.getElementById('nok_phone').value.trim()
        };
        
        try {
            disableSaleForm();
            showMessage('Processing sale...', 'info');
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            const response = await fetch('/sales/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                showSuccessMessage(data, addAnother);
                
                if (addAnother) {
                    setTimeout(() => resetFormForNewSale(), 2000);
                } else {
                    const receiptUrl = `/sales/sale/${data.sale_id}/etr/`;
                    window.open(receiptUrl, '_blank');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            } else {
                showMessage(data.message, 'danger');
                
                // Reload product if sale failed due to status change
                if (data.message.includes('SOLD') || data.message.includes('stock')) {
                    setTimeout(() => lookupProduct(productCodeInput.value), 1000);
                }
                
                enableSaleForm();
            }
            
        } catch (error) {
            console.error('Sale submission error:', error);
            showMessage('Error submitting sale. Please try again.', 'danger');
            enableSaleForm();
        }
    }

    // ============================================
    // SUCCESS MESSAGE IN COLUMN B
    // ============================================
    function showSuccessMessage(data, addAnother) {
        let html = `
            <div class="alert alert-success">
                <h5 class="alert-heading">
                    <i class="bi bi-check-circle-fill"></i> Sale Recorded Successfully!
                </h5>
                <hr>
                <div class="product-info-card">
                    <div class="product-info-item">
                        <span class="product-info-label">Sale ID</span>
                        <span class="product-info-value">#${data.sale_id}</span>
                    </div>
        `;
        
        if (data.fifo_details) {
            const fifo = data.fifo_details;
            html += `
                    <div class="product-info-item">
                        <span class="product-info-label">Product</span>
                        <span class="product-info-value">${fifo.product_code}</span>
                    </div>
                    <div class="product-info-item">
                        <span class="product-info-label">SKU</span>
                        <span class="product-info-value">${fifo.sku}</span>
                    </div>
            `;
            
            if (fifo.was_oldest_available) {
                html += `
                    <div class="product-info-item">
                        <span class="product-info-label">FIFO Status</span>
                        <span class="product-info-value text-success">
                            âœ… Oldest unit (${fifo.age_days} days)
                        </span>
                    </div>
                `;
            }
        }
        
        html += `
                    <div class="product-info-item">
                        <span class="product-info-label">Quantity</span>
                        <span class="product-info-value">${data.sale_details.quantity}</span>
                    </div>
                    <div class="product-info-item">
                        <span class="product-info-label">Total Amount</span>
                        <span class="product-info-value text-success">
                            KSH ${parseFloat(data.sale_details.total_price).toLocaleString('en-KE', {minimumFractionDigits: 2})}
                        </span>
                    </div>
                </div>
                <div class="alert alert-info mt-3 mb-0">
                    ${data.stock_alert}
                </div>
        `;
        
        if (!addAnother) {
            html += `<p class="mt-3 mb-0 text-center"><em>Redirecting to dashboard...</em></p>`;
        }
        
        html += `</div>`;
        
        saleMessageDiv.innerHTML = html;
    }

    // ============================================
    // MESSAGE DISPLAY IN COLUMN B
    // ============================================
    function showMessage(message, type = 'info') {
        const alertClass = `alert alert-${type}`;
        saleMessageDiv.innerHTML = `<div class="${alertClass}">${message}</div>`;
    }

    function showTempMessage(message, type = 'info') {
        showMessage(message, type);
        setTimeout(() => {
            saleMessageDiv.innerHTML = '';
        }, 3000);
    }

    // ============================================
    // RESET FORM FOR NEW SALE
    // ============================================
    function resetFormForNewSale() {
        form.reset();
        productCodeInput.value = '';
        quantityInput.value = 1;
        quantityInput.disabled = false;
        unitPriceInput.value = '';
        unitPriceInput.disabled = false;
        totalAmountInput.value = '';
        showEmptyState();
        saleMessageDiv.innerHTML = '';
        productCodeInput.focus();
    }
});



// ================================
// ================================
// GENERATE REPORT SECTION  ðŸ‘ï¸ðŸ‘ï¸
// ================================
document.addEventListener("DOMContentLoaded", function () {

  // --- DOM Elements ---
  const sellerSelect = document.getElementById("seller");
  const categorySelect = document.getElementById("category");
  const startDateInput = document.getElementById("startDate");
  const endDateInput = document.getElementById("endDate");
  const generateBtn = document.getElementById("generateReportBtn");
  const exportBtn = document.getElementById("exportReportBtn");
  const emptyState = document.getElementById("reportEmptyState");
  const reportResults = document.getElementById("reportResults");
  const reportTableBody = document.getElementById("reportTableBody");
  const reportTotal = document.getElementById("reportTotal");

  let currentReportData = [];

  // --- Initialize Sellers & Categories ---
  function loadFilterOptions() {
    // Fetch sellers
    console.log("ðŸ“¡ Loading sellers...");
    fetch("/sales/api/get-sellers/")
      .then(res => {
        console.log("âœ… Sellers response status:", res.status);
        return res.json();
      })
      .then(data => {
        console.log("ðŸ“¦ Sellers data:", data);
        
        if (data.success && data.sellers && data.sellers.length > 0) {
          console.log(`âœ… Found ${data.sellers.length} sellers`);
          data.sellers.forEach(seller => {
            const opt = document.createElement("option");
            opt.value = seller.id;
            opt.textContent = seller.display_name || seller.username;
            sellerSelect.appendChild(opt);
          });
        } else {
          console.warn("âš ï¸ No sellers found or API returned empty");
          // Try alternative endpoint if first one fails
          fetch("/sales/api/get-all-sellers/")
            .then(res => res.json())
            .then(altData => {
              if (altData.success && altData.sellers) {
                console.log(`âœ… Alternative endpoint: Found ${altData.sellers.length} sellers`);
                altData.sellers.forEach(seller => {
                  const opt = document.createElement("option");
                  opt.value = seller.id;
                  opt.textContent = seller.display_name || seller.username;
                  sellerSelect.appendChild(opt);
                });
              }
            })
            .catch(err => console.error("âŒ Error loading alternative sellers:", err));
        }
      })
      .catch(err => {
        console.error("âŒ Error loading sellers:", err);
        alert("Failed to load sellers. Check console for details.");
      });

    // Fetch categories
    console.log("ðŸ“¡ Loading categories...");
    fetch("/inventory/api/get-categories/")
      .then(res => {
        console.log("âœ… Categories response status:", res.status);
        return res.json();
      })
      .then(data => {
        console.log("ðŸ“¦ Categories data:", data);
        
        if (data.success && data.categories && data.categories.length > 0) {
          console.log(`âœ… Found ${data.categories.length} categories`);
          data.categories.forEach(cat => {
            const opt = document.createElement("option");
            opt.value = cat.id;
            opt.textContent = cat.name;
            categorySelect.appendChild(opt);
          });
        } else {
          console.warn("âš ï¸ No categories found or API returned empty");
        }
      })
      .catch(err => {
        console.error("âŒ Error loading categories:", err);
        alert("Failed to load categories. Check console for details.");
      });
  }

  loadFilterOptions();

  // --- Generate Report ---
  if (generateBtn) {
    generateBtn.addEventListener("click", function () {
      const seller = sellerSelect.value;
      const category = categorySelect.value;
      const start = startDateInput.value;
      const end = endDateInput.value;

      console.log("ðŸ” Report Filters:", {
        seller: seller || "All",
        category: category || "All",
        start: start || "No start date",
        end: end || "No end date"
      });

      // Show loading state
      generateBtn.disabled = true;
      generateBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Loading...';

      const reportUrl = `/sales/api/reports/?seller=${seller}&category=${category}&start=${start}&end=${end}`;
      console.log("ðŸ“¡ Fetching report from:", reportUrl);

      fetch(reportUrl)
        .then(res => {
          console.log("âœ… Report response status:", res.status);
          return res.json();
        })
        .then(data => {
          console.log("ðŸ“¦ Report data:", data);
          
          generateBtn.disabled = false;
          generateBtn.innerHTML = '<i class="bi bi-file-earmark-bar-graph"></i> Generate Report';

          if (data.status === 'success') {
            currentReportData = data.results || [];
            console.log(`âœ… Received ${currentReportData.length} report items`);
            renderReport(currentReportData);
          } else {
            console.error("âŒ Report error:", data.message);
            alert("Failed to generate report: " + (data.message || "Unknown error"));
          }
        })
        .catch(err => {
          generateBtn.disabled = false;
          generateBtn.innerHTML = '<i class="bi bi-file-earmark-bar-graph"></i> Generate Report';
          console.error("âŒ Error fetching report:", err);
          alert("Failed to fetch report. Please try again.");
        });
    });
  }

  // --- Render Report Table (FIXED) ---
  function renderReport(data) {
    reportTableBody.innerHTML = "";
    let total = 0;
    let itemCount = 0;

    if (!data || data.length === 0) {
      emptyState.style.display = "block";
      reportResults.style.display = "none";
      exportBtn.disabled = true;
      reportTotal.textContent = "0.00";
      const itemCountEl = document.getElementById('reportItemCount');
      if (itemCountEl) {
        itemCountEl.textContent = "0";
      }
      return;
    }

    emptyState.style.display = "none";
    reportResults.style.display = "block";

    data.forEach(row => {
      total += parseFloat(row.total || 0);
      itemCount += parseInt(row.quantity || 0);
      
      // âœ… FIX: Handle product data correctly (it's now an object)
      const productName = row.product?.name || row.product || "N/A";
      const etrNumber = row.product?.etr_number || "N/A";
      const skuValue = row.product?.sku_value || "N/A";
      const sellingPrice = parseFloat(row.product?.selling_price || row.unit_price || 0);
      
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.date}</td>
        <td>${row.seller}</td>
        <td>${row.buyer_name || 'Walk-in Customer'}</td>
        <td><span class="badge bg-secondary">${etrNumber}</span></td>
        <td>${productName}</td>
        <td>${skuValue}</td>
        <td class="text-center"><strong>${row.quantity}</strong></td>
        <td class="text-end">KSH ${sellingPrice.toFixed(2)}</td>
        <td class="text-end"><strong style="color: #10b981;">KSH ${parseFloat(row.total || 0).toFixed(2)}</strong></td>
      `;
      reportTableBody.appendChild(tr);
    });

    reportTotal.textContent = total.toFixed(2);
    
    const itemCountEl = document.getElementById('reportItemCount');
    if (itemCountEl) {
      itemCountEl.textContent = itemCount;
    }
    
    exportBtn.disabled = false;
    
    console.log(`âœ… Report rendered: ${data.length} rows, ${itemCount} items, KSH ${total.toFixed(2)}`);
  }

  // --- Export Report as CSV (FIXED) ---
  if (exportBtn) {
    exportBtn.addEventListener("click", function () {
      if (!currentReportData.length) {
        alert("No data to export");
        return;
      }

      let csvContent = "Date,Seller,Customer,Category,Product,SKU/IMEI,Quantity,Unit Price,Total\n";
      
      currentReportData.forEach(row => {
        // âœ… FIX: Handle product data correctly
        const productName = row.product?.name || row.product || "N/A";
        const skuValue = (row.product?.sku_value || "N/A").replace(/,/g, ';');
        const unitPrice = row.unit_price || row.product?.selling_price || 0;
        const buyerName = (row.buyer_name || "Walk-in Customer").replace(/,/g, ';');
        
        csvContent += `${row.date},${row.seller},${buyerName},${row.category},${productName},${skuValue},${row.quantity},${unitPrice},${row.total || 0}\n`;
      });

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `sales_report_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      console.log('âœ… Report exported with SKU values');
    });
  }

});



// ========================================
/* ========================================
   LIVE PRODUCT TABLE UPDATER FOR FIELDMAX
   Matches your EXACT HTML table structure
   ===================================== */
// ========================================
function updateProductRow(product) {
    const row = document.querySelector(`#product-row-${product.id}`);
    if (!row) return;

    /* ---------------------------
       Update dataset attributes
       --------------------------- */
    row.dataset.stockStatus = product.status;
    row.dataset.category = product.category_id;
    row.dataset.type = product.is_single ? "single" : "bulk";

    /* ---------------------------
       Update PRODUCT NAME
       --------------------------- */
    row.querySelector(".product-name").innerHTML = `<strong>${product.name}</strong>`;

    /* ---------------------------
       Update BUYING PRICE
       --------------------------- */
    row.querySelector(".product-buying-price").innerHTML =
        `<strong style="color:#10b981;">KSH ${Number(product.buying_price).toFixed(2)}</strong>`;

    /* ---------------------------
       Update SELLING PRICE
       --------------------------- */
    row.querySelector(".product-selling-price").innerHTML =
        `<strong style="color:#10b981;">KSH ${Number(product.selling_price).toFixed(2)}</strong>`;

    /* ---------------------------
       STATUS BADGE
       --------------------------- */
    let statusHtml = "";

    if (product.is_single) {
        if (product.status === "sold") {
            statusHtml = `
                <span class="badge badge-danger">
                    <i class="bi bi-x-circle-fill"></i> Sold Out
                </span>`;
        } else {
            statusHtml = `
                <span class="badge badge-success">
                    <i class="bi bi-check-circle-fill"></i> In Stock
                </span>`;
        }
    } else {
        if (product.quantity === 0) {
            statusHtml = `
                <span class="badge badge-danger">
                    <i class="bi bi-x-circle-fill"></i> Out of Stock
                </span>`;
        } else if (product.quantity <= 5) {
            statusHtml = `
                <span class="badge badge-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i> Low Stock
                </span>`;
        } else {
            statusHtml = `
                <span class="badge badge-success">
                    <i class="bi bi-check-circle-fill"></i> In Stock
                </span>`;
        }
    }

    row.querySelector("td:nth-child(5)").innerHTML = statusHtml;

    /* ---------------------------
       STOCK COLUMN
       --------------------------- */
    let stockHtml = "";

    if (product.is_single) {
        if (product.status === "sold") {
            stockHtml = `
                <strong style="color:#dc3545;font-weight:bold;">
                    <i class="bi bi-x-circle-fill"></i> SOLD
                </strong>`;
        } else {
            stockHtml = `
                <strong style="color:#28a745;font-weight:bold;">
                    <i class="bi bi-check-circle-fill"></i> Available
                </strong>`;
        }
    } else {
        if (product.quantity === 0) {
            stockHtml = `
                <strong style="color:#dc3545;font-weight:bold;">
                    0 units (Out)
                </strong>`;
        } else if (product.quantity <= 5) {
            stockHtml = `
                <strong style="color:#ffc107;font-weight:bold;">
                    ${product.quantity} units (Low)
                </strong>`;
        } else {
            stockHtml = `
                <strong style="color:#28a745;font-weight:bold;">
                    ${product.quantity} units
                </strong>`;
        }
    }

    row.querySelector(".product-quantity").innerHTML = stockHtml;

    /* ---------------------------
       MARGIN BADGE
       --------------------------- */
    const marginCell = row.querySelector("td:nth-child(9)");
    const marginPct = Number(product.margin_percentage);

    let marginClass = "margin-low";
    if (marginPct >= 30) marginClass = "margin-high";
    else if (marginPct >= 15) marginClass = "margin-medium";

    marginCell.innerHTML = `
        <span class="badge ${marginClass}">
            +${marginPct.toFixed(0)}%
        </span>
    `;

    /* ---------------------------
       Update OWNER
       --------------------------- */
    row.querySelector(".product-owner span").textContent = product.owner;

    /* ---------------------------
       Update summary counters
       --------------------------- */
    refreshInventoryCounters();
}


// ======================================
// ======================================
/* ======================================
   UPDATE INVENTORY STATISTICS COUNTERS
   =================================== */

function refreshInventoryCounters() {
    const rows = document.querySelectorAll(".product-row");

    let total = 0, instock = 0, lowstock = 0, outofstock = 0;

    rows.forEach(row => {
        total++;

        const status = row.dataset.stockStatus;
        const qtyCell = row.querySelector(".product-quantity").innerText;

        if (qtyCell.includes("Out")) outofstock++;
        else if (qtyCell.includes("Low")) lowstock++;
        else instock++;
    });

    document.getElementById("totalProductsCount").innerText = total;
    document.getElementById("inStockCount").innerText = instock;
    document.getElementById("lowStockCount").innerText = lowstock;
    document.getElementById("outOfStockCount").innerText = outofstock;
}

/* ======================================================
   CALL THIS AFTER SALE OR REVERSAL API RESPONDS
   ====================================================== */
/*
fetch('/reverse-sale/12/', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        updateProductRow(data.product);
    });
*/


// ====================================
// ====================================
// FILTER LOGIC 
// ====================================
// ====================================

function filterProducts() {
    const statusFilter = document.getElementById("productStatusFilter").value;
    const categoryFilter = document.getElementById("productCategoryFilter").value;
    const typeFilter = document.getElementById("productTypeFilter").value;

    const rows = document.querySelectorAll("#productsTable tbody .product-row");

    rows.forEach(row => {
        const rowStatus = row.dataset.stockStatus;       // instock | lowstock | outofstock | sold
        const rowCategory = row.dataset.category;        // category id
        const rowType = row.dataset.type;                // single | bulk

        let visible = true;

        // ----- STATUS FILTER -----
        if (statusFilter !== "all") {
            if (statusFilter === "instock" && rowStatus !== "instock") visible = false;
            else if (statusFilter === "lowstock" && rowStatus !== "lowstock") visible = false;
            else if (statusFilter === "outofstock") {
                if (rowStatus !== "outofstock" && rowStatus !== "sold") visible = false;
            }
        }

        // ----- CATEGORY FILTER -----
        if (categoryFilter !== "all" && rowCategory !== categoryFilter) {
            visible = false;
        }

        // ----- TYPE FILTER -----
        if (typeFilter !== "all" && rowType !== typeFilter) {
            visible = false;
        }

        // Show / Hide row
        row.style.display = visible ? "" : "none";
    });

    // After filtering, update stats
    updateProductStats();
}


// ====================================
// ====================================
// ========================= 
// STAT REFRESH 
// ========================= //

function updateProductStats() {
    const rows = document.querySelectorAll("#productsTable tbody .product-row");

    let total = 0;
    let instock = 0;
    let low = 0;
    let out = 0;

    rows.forEach(row => {
        if (row.style.display === "none") return; // Skip hidden rows

        total++;

        const status = row.dataset.stockStatus;

        if (status === "instock") instock++;
        else if (status === "lowstock") low++;
        else if (status === "outofstock" || status === "sold") out++;
    });

    document.getElementById("totalProductsCount").textContent = total;
    document.getElementById("inStockCount").textContent = instock;
    document.getElementById("lowStockCount").textContent = low;
    document.getElementById("outOfStockCount").textContent = out;
}



// ======= AUTO-RUN ON LOAD ========= //
document.addEventListener("DOMContentLoaded", filterProducts);


// ====================================
// ====================================
/* ===============================
   GLOBAL CONFIG
   ============================ */
// ====================================
// ====================================

let currentPage = 1;
const rowsPerPage = 20;  // Adjust if needed

// Cache selectors
const table = document.getElementById("productsTable");
const tbody = table.querySelector("tbody");
const rows = Array.from(tbody.querySelectorAll(".product-row"));


// ===============================
/* ==============================
   SAVE / LOAD FILTER STATE
   ============================= */
function saveFilterState() {
    localStorage.setItem("productFilters", JSON.stringify({
        status: document.getElementById("productStatusFilter").value,
        category: document.getElementById("productCategoryFilter").value,
        type: document.getElementById("productTypeFilter").value,
        search: document.getElementById("productSearchInput")?.value || ""
    }));
}

function loadFilterState() {
    const state = JSON.parse(localStorage.getItem("productFilters") || "{}");

    if (state.status) document.getElementById("productStatusFilter").value = state.status;
    if (state.category) document.getElementById("productCategoryFilter").value = state.category;
    if (state.type) document.getElementById("productTypeFilter").value = state.type;

    if (state.search && document.getElementById("productSearchInput")) {
        document.getElementById("productSearchInput").value = state.search;
    }
}


// ==============================
/* ==============================
   FILTERING SYSTEM 
   ========================== */
// =============================
function filterProducts() {
    const statusFilter = document.getElementById("productStatusFilter").value;
    const categoryFilter = document.getElementById("productCategoryFilter").value;
    const typeFilter = document.getElementById("productTypeFilter").value;
    const searchTerm = (document.getElementById("productSearchInput")?.value || "").toLowerCase();

    // âœ… define rows here
    const rows = document.querySelectorAll(".product-row");

    rows.forEach(row => {
        const rowStatus = row.dataset.stockStatus;
        const rowCategory = row.dataset.category;
        const rowType = row.dataset.type;
        const rowName = row.querySelector(".product-name").innerText.toLowerCase();
        const rowCode = row.querySelector("code").innerText.toLowerCase();

        let visible = true;

        if (statusFilter !== "all") {
            if (statusFilter === "instock" && rowStatus !== "instock") visible = false;
            else if (statusFilter === "lowstock" && rowStatus !== "lowstock") visible = false;
            else if (statusFilter === "outofstock") {
                if (rowStatus !== "outofstock" && rowStatus !== "sold") visible = false;
            }
        }

        if (categoryFilter !== "all" && rowCategory !== categoryFilter) visible = false;

        if (typeFilter !== "all" && rowType !== typeFilter) visible = false;

        if (searchTerm && !rowName.includes(searchTerm) && !rowCode.includes(searchTerm)) {
            visible = false;
        }

        row.style.display = visible ? "" : "none";
    });

    if (typeof saveFilterState === "function") saveFilterState();
    if (typeof updateProductStats === "function") updateProductStats();
    if (typeof paginateRows === "function") paginateRows();
}


// ==============================
/* ==============================
    SEARCH BUTTON AND ENTRIES
   =========================== */
function searchProducts() {
  const searchTerm = document.getElementById('productSearch').value.toLowerCase();
  const rows = document.querySelectorAll('.product-row');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
  });
}

// Entries selection functionality
function changeEntries() {
  const entriesValue = document.getElementById('entriesSelect').value;
  const rows = document.querySelectorAll('.product-row');
  
  if (entriesValue === 'all') {
    rows.forEach(row => row.style.display = '');
  } else {
    const limit = parseInt(entriesValue);
    rows.forEach((row, index) => {
      row.style.display = index < limit ? '' : 'none';
    });
  }
}


// =============================
/* ============================
   LIVE SEARCH
   ========================= */
// ============================
function setupSearchBox() {
    if (!document.getElementById("productSearchInput")) {

        // Insert search bar dynamically
        const header = document.querySelector(".content-header div");
        const searchInput = document.createElement("input");
        searchInput.id = "productSearchInput";
        searchInput.className = "form-control";
        searchInput.placeholder = "Search by code or name...";
        searchInput.style.width = "250px";
        searchInput.onkeyup = filterProducts;

        header.prepend(searchInput);  
    }
}


function searchSale() {
    const searchTerm = document.getElementById('searchSaleInput').value.trim().toLowerCase();
    
    if (!searchTerm) {
        // If search is empty, show all rows
        document.querySelectorAll('.sale-row').forEach(row => {
            row.style.display = '';
        });
        return;
    }
    
    // Filter rows based on search term
    document.querySelectorAll('.sale-row').forEach(row => {
        const saleId = row.getAttribute('data-sale-id') || '';
        const etrNo = row.cells[1]?.textContent?.trim().toLowerCase() || '';
        const buyer = row.cells[2]?.textContent?.trim().toLowerCase() || '';
        
        const matches = saleId.includes(searchTerm) || 
                       etrNo.includes(searchTerm) || 
                       buyer.includes(searchTerm);
        
        row.style.display = matches ? '' : 'none';
    });
}

// Add event listener for Enter key in search input
document.getElementById('searchSaleInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchSale();
    }
});

function filterSales() {
    // Existing filterSales function code
    // ... (keep your existing filterSales function)
    // Note: You might want to combine search with other filters
}


// ============================
// ============================
/* ==========================
   COLUMN SORTING
   ======================== */
let sortDirection = 1;

function sortTable(columnIndex) {
    const sorted = rows.sort((a, b) => {
        const A = a.children[columnIndex].innerText.trim().toLowerCase();
        const B = b.children[columnIndex].innerText.trim().toLowerCase();

        if (!isNaN(A) && !isNaN(B)) {
            return (parseFloat(A) - parseFloat(B)) * sortDirection;
        }
        return A.localeCompare(B) * sortDirection;
    });

    sortDirection *= -1; // toggle

    tbody.innerHTML = "";
    sorted.forEach(r => tbody.appendChild(r));

    paginateRows();
}

function enableColumnSorting() {
    const headers = table.querySelectorAll("thead th");
    headers.forEach((th, i) => {
        th.style.cursor = "pointer";
        th.addEventListener("click", () => sortTable(i));
    });
}


// ============================
/* =========================
   PAGINATION
   ======================= */
// ============================

function paginateRows() {
    const visibleRows = rows.filter(r => r.style.display !== "none");

    const total = visibleRows.length;
    const totalPages = Math.ceil(total / rowsPerPage);

    visibleRows.forEach((row, index) => {
        row.style.display =
            index >= (currentPage - 1) * rowsPerPage &&
            index < currentPage * rowsPerPage
            ? ""
            : "none";
    });

    renderPaginationControls(totalPages);
}

function renderPaginationControls(totalPages) {
    let container = document.getElementById("paginationControls");

    if (!container) {
        container = document.createElement("div");
        container.id = "paginationControls";
        container.style.marginTop = "10px";
        container.style.display = "flex";
        container.style.gap = "10px";
        document.querySelector("#product-list").appendChild(container);
    }

    container.innerHTML = "";

    const prev = document.createElement("button");
    prev.innerText = "Previous";
    prev.className = "btn btn-secondary";
    prev.disabled = currentPage === 1;
    prev.onclick = () => {
        currentPage--;
        paginateRows();
    };

    const next = document.createElement("button");
    next.innerText = "Next";
    next.className = "btn btn-secondary";
    next.disabled = currentPage === totalPages;
    next.onclick = () => {
        currentPage++;
        paginateRows();
    };

    container.appendChild(prev);
    container.appendChild(next);
}


// ==============================
/* ==============================
   HIDE / SHOW COLUMNS
   ============================ */
function toggleColumn(index) {
    const rowsAll = table.querySelectorAll("tr");
    rowsAll.forEach(row => {
        const cell = row.children[index];
        if (cell) {
            cell.style.display = cell.style.display === "none" ? "" : "none";
        }
    });
}

function initColumnHider() {
    const controls = document.createElement("div");
    controls.style.margin = "10px 0";

    const headers = table.querySelectorAll("thead th");

    headers.forEach((th, i) => {
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = true;
        cb.onchange = () => toggleColumn(i);

        const label = document.createElement("label");
        label.style.marginRight = "10px";
        label.appendChild(cb);
        label.appendChild(document.createTextNode(" " + th.innerText));

        controls.appendChild(label);
    });

    document.querySelector("#product-list").prepend(controls);
}


// ==============================
/* ==============================
   EXPORT TO EXCEL
   =========================== */
function exportTableToExcel() {
    let csv = [];

    const trs = table.querySelectorAll("tr");
    trs.forEach(tr => {
        if (tr.style.display === "none") return; // skip hidden

        const cells = Array.from(tr.children).map(td => '"' + td.innerText.replace(/"/g, '""') + '"');
        csv.push(cells.join(","));
    });

    const blob = new Blob([csv.join("\n")], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "products_export.csv";
    a.click();
}


// ===============================
// ===============================
// INITIALIZE ALL SYSTEMS
// ===============================
document.addEventListener("DOMContentLoaded", () => {
    setupSearchBox();
    enableColumnSorting();
    initColumnHider();
    loadFilterState();
    filterProducts();  // automatically triggers pagination
});

/* DRAG-TO-REORDER COLUMNS */
(function(){
  const tableEl = document.getElementById('productsTable');
  const storageKey = 'productsTableColOrder';

  function getHeaderCells() {
    return Array.from(tableEl.querySelectorAll('thead th'));
  }

  function saveOrder() {
    const order = getHeaderCells().map(th => th.innerText.trim());
    localStorage.setItem(storageKey, JSON.stringify(order));
  }

  function applySavedOrder() {
    const saved = JSON.parse(localStorage.getItem(storageKey) || 'null');
    if (!saved) return;
    const headers = getHeaderCells();
    const current = headers.map(h => h.innerText.trim());
    // Build mapping index -> current index of saved label
    const newIndexOrder = saved.map(label => current.indexOf(label)).filter(i => i >= 0);

    // Reorder head
    const theadRow = tableEl.querySelector('thead tr');
    newIndexOrder.forEach(idx => theadRow.appendChild(headers[idx]));

    // Reorder each body row accordingly
    const bodyRows = tableEl.querySelectorAll('tbody tr');
    bodyRows.forEach(r => {
      const cells = Array.from(r.children);
      newIndexOrder.forEach(idx => r.appendChild(cells[idx]));
    });
  }

  function enableDrag() {
    const headers = getHeaderCells();
    headers.forEach(th => {
      th.classList.add('draggable');
      th.draggable = true;
      th.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', th.innerText.trim());
        th.classList.add('dragging');
      });
      th.addEventListener('dragend', () => th.classList.remove('dragging'));
      th.addEventListener('dragover', e => e.preventDefault());
      th.addEventListener('drop', e => {
        e.preventDefault();
        const label = e.dataTransfer.getData('text/plain');
        const dragged = Array.from(headers).find(h => h.innerText.trim() === label);
        if (!dragged) return;
        // insert before target
        const target = e.currentTarget;
        if (dragged !== target) {
          target.parentNode.insertBefore(dragged, target);
          // apply same reordering to all rows
          const newOrder = Array.from(tableEl.querySelectorAll('thead th')).map(h => h.innerText.trim());
          const currentCells = Array.from(tableEl.querySelectorAll('thead th')).map(h => h.innerText.trim());
          // find new indices
          const indices = newOrder.map(lbl => currentCells.indexOf(lbl));
          const bodyRows = tableEl.querySelectorAll('tbody tr');
          bodyRows.forEach(row => {
            const cells = Array.from(row.children);
            indices.forEach(i => row.appendChild(cells[i]));
          });
          saveOrder();
        }
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    applySavedOrder();
    enableDrag();
  });
})();


// ================================
// ================================
// TOGGLE CARD DROPDOWN
// ================================
function toggleCardDropdown(header) {
  const dropdown = header.parentElement.querySelector('.stat-dropdown');
  const icon = header.querySelector('.dropdown-icon');
  
  // Prevent navigation when clicking card
  event.stopPropagation();
  event.preventDefault();
  
  dropdown.classList.toggle('active');
  icon.classList.toggle('rotated');
}

// ================================
// PREVENT CARD NAVIGATION
// ================================
document.addEventListener('DOMContentLoaded', function() {
  // Remove data-section from stat cards with dropdowns
  document.querySelectorAll('.stat-card .stat-header').forEach(header => {
    const card = header.closest('.stat-card');
    if (card) {
      // Remove the data-section attribute to prevent navigation
      card.removeAttribute('data-section');
      
      // Remove the click event that triggers navigation
      card.style.cursor = 'default';
    }
  });
  
  // Keep only the header clickable for dropdown
  document.querySelectorAll('.stat-header').forEach(header => {
    header.style.cursor = 'pointer';
  });
});

</script>

{% endblock %}