
{% extends "website/base.html" %}
{% block title %}Agent Dashboard - Fieldmax Shop{% endblock %}

{% block content %}
<style>
/* ========================================
   DASHBOARD LAYOUT
   ======================================== */
.dashboard-wrapper {
  display: flex;
  min-height: calc(100vh - 160px);
  background-color: #516272;
}

/* ========================================
   SIDEBAR NAVIGATION
   ======================================== */
.dashboard-sidebar {
  width: 260px;
  background: #ffffff;
  border-right: 1px solid #e5e7eb;
  padding: 1.5rem 0;
  position: sticky;
  top: 76px;
  height: calc(100vh - 76px);
  overflow-y: auto;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
  flex-shrink: 0;
}

.sidebar-header {
  padding: 0 1.5rem 1.5rem;
  border-bottom: 2px solid #e5e7eb;
  margin-bottom: 1rem;
}

.sidebar-title {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  color: #1a1f2e;
  font-size: 1.25rem;
  font-weight: 700;
  margin: 0;
}

.sidebar-title i {
  font-size: 1.75rem;
  color: #10b981;
}

.sidebar-user {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: #6c757d;
  font-size: 0.9rem;
  margin-top: 0.5rem;
}

.sidebar-nav {
  padding: 0 1rem;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  color: #6c757d;
  font-weight: 500;
  border-radius: 0.5rem;
  transition: all 0.3s ease;
  cursor: pointer;
  border: none;
  background: transparent;
  width: 100%;
  text-align: left;
  font-size: 0.95rem;
  text-decoration: none;
  margin-bottom: 0.25rem;
}

.nav-item:hover {
  background: #f3f4f6;
  color: #1a1f2e;
  text-decoration: none;
}

.nav-item.active {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: #ffffff;
  box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
}

.nav-item i {
  font-size: 1.25rem;
  width: 24px;
  text-align: center;
}

/* ========================================
   MAIN CONTENT AREA
   ======================================== */
.dashboard-content {
  flex: 1;
  padding: 2rem;
  overflow-x: hidden;
}

.content-section {
  display: none;
}

.content-section.active {
  display: block;
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.content-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2rem;
  gap: 1rem;
  flex-wrap: wrap;
}

.page-title {
  font-size: 2rem;
  font-weight: 500;
  color: #1a1f2e;
  margin: 0;
}

.mobile-sidebar-toggle {
  display: none;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  color: #1a1f2e;
  font-size: 1.5rem;
  padding: 0.5rem 0.75rem;
  border-radius: 0.5rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.mobile-sidebar-toggle:hover {
  background: #10b981;
  color: #ffffff;
  border-color: #10b981;
}

/* ========================================
   CARDS & GRIDS
   ======================================== */
.lookup-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.lookup-card {
  background: #ffffff;
  border-radius: 0.75rem;
  border: 1px solid #e5e7eb;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  padding: 1.5rem;
  transition: all 0.3s ease;
}

.lookup-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.card-header-custom {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1.25rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid #f3f4f6;
}

.card-icon {
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0.5rem;
  font-size: 1.5rem;
}

.card-icon.primary {
  background: linear-gradient(135deg, rgba(13, 202, 240, 0.15) 0%, rgba(13, 202, 240, 0.05) 100%);
  color: #0dcaf0;
}

.card-icon.success {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
  color: #10b981;
}

.card-icon.info {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.05) 100%);
  color: #3b82f6;
}

.card-title-custom {
  font-size: 1.1rem;
  font-weight: 600;
  color: #1a1f2e;
  margin: 0;
}

.display-box {
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f9fafb;
  border: 2px dashed #e5e7eb;
  border-radius: 0.5rem;
  padding: 1.5rem;
  text-align: center;
  transition: all 0.3s ease;
}

.display-box.has-content {
  background: #ffffff;
  border: 2px solid #10b981;
  border-style: solid;
}

.display-value {
  font-size: 1.25rem;
  font-weight: 600;
  color: #1a1f2e;
  margin: 0;
}

.display-label {
  font-size: 0.875rem;
  color: #6c757d;
  margin-top: 0.25rem;
}

/* ========================================
   DATA TABLES
   ======================================== */
.data-card {
  background: #ffffff;
  border-radius: 0.75rem;
  border: 1px solid #e5e7eb;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  overflow: hidden;
}

.card-header-table {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  background: #f9fafb;
  border-bottom: 2px solid #e5e7eb;
}

.section-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1a1f2e;
  margin: 0;
}

.table-wrapper {
  overflow-x: auto;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
}

.data-table thead {
  background: #f3f4f6;
}

.data-table th {
  padding: 1rem 1.25rem;
  text-align: left;
  font-size: 0.8rem;
  font-weight: 600;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid #e5e7eb;
}

.data-table td {
  padding: 1rem 1.25rem;
  border-bottom: 1px solid #f3f4f6;
  color: #1a1f2e;
  font-size: 0.925rem;
}

.data-table tbody tr {
  transition: background-color 0.15s ease;
}

.data-table tbody tr:hover {
  background: #f9fafb;
}

.data-table tbody tr:last-child td {
  border-bottom: none;
}

.sale-id {
  font-family: 'Courier New', monospace;
  color: #6c757d;
  font-weight: 600;
}

.price-tag {
  color: #10b981;
  font-weight: 700;
  font-size: 1.05rem;
}

.empty-state {
  padding: 3rem !important;
  color: #6c757d;
  text-align: center;
}

.empty-state i {
  font-size: 3rem;
  color: #d1d5db;
  display: block;
  margin-bottom: 1rem;
}

/* ========================================
   FORMS & INPUTS
   ======================================== */
.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: #1a1f2e;
  font-size: 0.95rem;
}

.required::after {
  content: " *";
  color: #dc3545;
}

.form-control {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #e5e7eb;
  border-radius: 0.5rem;
  font-size: 0.95rem;
  transition: all 0.3s ease;
}

.form-control:focus {
  outline: none;
  border-color: #10b981;
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.form-control-lg {
  padding: 1rem;
  font-size: 1.1rem;
}

/* ========================================
   BUTTONS
   ======================================== */
.btn-action {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border-radius: 0.5rem;
  font-weight: 600;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  border: none;
  cursor: pointer;
  text-decoration: none;
  width: 100%;
}

.btn-primary {
  background: linear-gradient(135deg, #0dcaf0 0%, #0ab4d6 100%);
  color: #ffffff;
  box-shadow: 0 2px 4px rgba(13, 202, 240, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(13, 202, 240, 0.4);
  color: #ffffff;
  text-decoration: none;
}

.btn-success {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: #ffffff;
  box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
  color: #ffffff;
  text-decoration: none;
}

.btn:disabled {
  cursor: not-allowed;
  opacity: 0.5;
}

/* ========================================
   PRODUCT DETAILS
   ======================================== */
.product-info-card {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 12px;
  padding: 1.5rem;
  border: 2px solid #e2e8f0;
}

.product-info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  border-bottom: 1px solid #e2e8f0;
}

.product-info-item:last-child {
  border-bottom: none;
}

.product-info-label {
  color: #64748b;
  font-size: 0.875rem;
  font-weight: 500;
}

.product-info-value {
  color: #1e293b;
  font-size: 1rem;
  font-weight: 600;
}

.fifo-badge {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-size: 0.875rem;
  display: inline-block;
  margin-top: 0.5rem;
}

.sold-alert {
  border-left: 4px solid #ef4444;
  background: #fef2f2;
  padding: 1.5rem;
  border-radius: 8px;
}

.available-alert {
  border-left: 4px solid #10b981;
  background: #f0fdf4;
  padding: 1.5rem;
  border-radius: 8px;
}

.product-badge {
  font-size: 0.875rem;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-weight: 600;
}

/* ========================================
   ALERTS & MESSAGES
   ======================================== */
.alert {
  padding: 1rem;
  border-radius: 0.5rem;
  margin-bottom: 1rem;
}

.alert-info {
  background: #e0f7ff;
  border: 1px solid #0dcaf0;
  color: #0a7a8f;
}

.alert-success {
  background: #d1fae5;
  border: 1px solid #10b981;
  color: #065f46;
}

.alert-danger {
  background: #fee2e2;
  border: 1px solid #ef4444;
  color: #991b1b;
}

.toast-message {
  position: fixed;
  top: 20px;
  right: -300px;
  padding: 15px 20px;
  background: #10b981;
  color: white;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transition: all 0.4s ease;
  z-index: 9999;
  font-weight: bold;
}

.toast-message.error {
  background: #ef4444;
}

.toast-message.show {
  right: 20px;
}

/* ========================================
   ANIMATIONS
   ======================================== */
#productDetails {
  animation: fadeInUp 0.4s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#emptyState i {
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 0.6; }
}

/* ========================================
   RESPONSIVE DESIGN
   ======================================== */
@media (max-width: 992px) {
  .dashboard-wrapper {
    flex-direction: column;
  }

  .dashboard-sidebar {
    position: fixed;
    left: -260px;
    top: 76px;
    z-index: 998;
    transition: left 0.3s ease;
  }

  .dashboard-sidebar.active {
    left: 0;
  }

  .mobile-sidebar-toggle {
    display: block;
  }

  .dashboard-content {
    padding: 1.5rem;
  }

  .lookup-grid {
    grid-template-columns: 1fr;
  }

  .col-lg-6 {
    margin-bottom: 1.5rem;
  }
}

@media (max-width: 768px) {
  .dashboard-content {
    padding: 1rem;
  }

  .page-title {
    font-size: 1.5rem;
  }
}


.product-display-card, .client-display-card {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 12px;
  padding: 1.5rem;
  border: 2px solid #e2e8f0;
}

.info-item {
  padding: 0.5rem 0;
}

.display-label {
  display: block;
  color: #64748b;
  font-size: 0.875rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.display-value {
  color: #1e293b;
  font-size: 1.1rem;
  font-weight: 600;
  padding: 0.75rem;
  background: #ffffff;
  border-radius: 6px;
  border: 1px solid #e2e8f0;
}

.input-group .form-control:read-only {
  background-color: #f8fafc;
}

.required::after {
  content: " *";
  color: #dc3545;
}

 /* Styling for search results */
  #skuSearchResults .list-group-item {
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  #skuSearchResults .list-group-item:hover {
    background-color: #f8f9fa;
    border-left: 4px solid #0d6efd;
  }
  
  #skuSearchResults .list-group-item.active {
    background-color: #0d6efd;
    border-color: #0d6efd;
  }
  
  .product-sku {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: #0d6efd;
  }
  
  .product-price {
    color: #198754;
    font-weight: 600;
  }
  
  .search-loading {
    padding: 1rem;
    text-align: center;
    color: #6c757d;
  }
  
  .no-results {
    padding: 1rem;
    text-align: center;
    color: #dc3545;
  }

</style>












<div class="dashboard-wrapper">
  
  <!-- Sidebar Navigation -->
  <aside class="dashboard-sidebar" id="dashboardSidebar">
    <div class="sidebar-header">
      <h2 class="sidebar-title">
        <i class="bi bi-person-badge"></i>
        <span>FIELDDMAX STAFF ðŸªª</span>
      </h2>
      <div class="sidebar-user">
        <i class="bi bi-person-circle"></i>
        <span>
          {% if user.is_authenticated %}
            {{ user.get_full_name|default:user.username }}
          {% else %}
            Guest
          {% endif %}
        </span>
      </div>
    </div>
    
    <nav class="sidebar-nav">
      <button type="button" class="nav-item active" data-section="overview">
        <i class="bi bi-speedometer2"></i>
        <span>Overview</span>
      </button>

      <button type="button" class="nav-item" data-section="product-lookup">
        <i class="bi bi-search"></i>
        <span>Product Lookup</span>
      </button>

      <button type="button" class="nav-item" data-section="record-sale">
        <i class="bi bi-cart-plus"></i>
        <span>Record Sale</span>
      </button>

      <button type="button" class="nav-item" data-section="my-sales">
        <i class="bi bi-receipt"></i>
        <span>My Sales</span>
      </button>

      <button type="button" class="nav-item" data-section="My-inventory">
        <i class="bi bi-box-seam"></i>
        <span>My Inventory</span>
      </button>

      <!-- Logout Section -->
      <div style="margin-top: auto; padding: 1rem; border-top: 2px solid #e5e7eb;">
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit" class="nav-item" style="border: 1px solid #dc2626; background: #fee2e2; color: #dc2626; width: 100%;">
            <i class="bi bi-box-arrow-right"></i>
            <span>Logout</span>
          </button>
        </form>
      </div>
    </nav>
  </aside>













<!-- Main Dashboard Content -->
  <main class="dashboard-content">
    
    <!-- ========================================
         OVERVIEW SECTION
         ======================================== -->
    <div id="overview" class="content-section active">
      <div class="content-header">
        <button class="mobile-sidebar-toggle" id="mobileSidebarToggle">
          <i class="bi bi-list"></i>
        </button>
        <h1 class="page-title">Sales Overview</h1>
      </div>

      <!-- Statistics Cards Grid -->
      <div class="lookup-grid">
        <!-- Today's Sales Count Card -->
        <div class="lookup-card">
          <div class="card-header-custom">
            <div class="card-icon success">
              <i class="bi bi-currency-dollar"></i>
            </div>
            <h3 class="card-title-custom">Daily Sales Count</h3>
          </div>
          <div class="display-box has-content">
            <div>
              <p class="display-value">{{ todays_sales_count|default:"0" }}</p>
              <p class="display-label">Transactions today</p>
            </div>
          </div>
        </div>

        <!-- Weekly Sales Count Card -->
        <div class="lookup-card">
          <div class="card-header-custom">
            <div class="card-icon primary">
              <i class="bi bi-graph-up"></i>
            </div>
            <h3 class="card-title-custom">Weekly Sales Count</h3>
          </div>
          <div class="display-box has-content">
            <div>
              <p class="display-value">{{ weekly_sales_count|default:"0" }}</p>
              <p class="display-label">Transactions this week</p>
            </div>
          </div>
        </div>

        <!-- Monthly Sales Count Card -->
        <div class="lookup-card">
          <div class="card-header-custom">
            <div class="card-icon primary">
              <i class="bi bi-graph-up"></i>
            </div>
            <h3 class="card-title-custom">Monthly Sales Count</h3>
          </div>
          <div class="display-box has-content">
            <div>
              <p class="display-value">{{ monthly_sales_count|default:"0" }}</p>
              <p class="display-label">Transactions this month</p>
            </div>
          </div>
        </div>  

        <!-- Inventory Count Card -->
        <div class="lookup-card">
          <div class="card-header-custom">
            <div class="card-icon info">
              <i class="bi bi-box-seam"></i>
            </div>
            <h3 class="card-title-custom">My Products Count</h3>
          </div>
          <div class="display-box has-content">
            <div>
              <p class="display-value">{{ my_products_count|default:"0" }}</p>
              <p class="display-label">Items in inventory</p>
            </div>
          </div>
        </div>        

      </div>

      <!-- Quick Actions Grid -->
      <div class="lookup-grid">
        <!-- Product Search Action -->
        <div class="lookup-card">
          <div class="card-header-custom">
            <div class="card-icon primary">
              <i class="bi bi-search"></i>
            </div>
            <h3 class="card-title-custom">Quick Lookup</h3>
          </div>
          <button type="button" class="btn-action btn-primary" data-section="product-lookup">
            <i class="bi bi-search"></i>
            <span>Search Product</span>
          </button>
        </div>

        <!-- Record Sale Action -->
        <div class="lookup-card">
          <div class="card-header-custom">
            <div class="card-icon success">
              <i class="bi bi-cart-plus"></i>
            </div>
            <h3 class="card-title-custom">Record Sale</h3>
          </div>
          <button type="button" class="btn-action btn-success" data-section="record-sale">
            <i class="bi bi-plus-circle"></i>
            <span>New Sale</span>
          </button>
        </div>
      </div>

      <!-- Recent Sales Table -->
      <div class="data-card" style="margin-top: 2rem;">
        <div class="card-header-table">
          <h2 class="section-title">Recent Sales</h2>
          <button type="button" class="btn-action btn-success" data-section="record-sale" style="width: auto; padding: 0.5rem 1.25rem;">
            <i class="bi bi-plus-circle"></i>
            <span>Record Sale</span>
          </button>
        </div>
        
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Sale ID</th>
                <th>Buyer</th>
                <th>Total Price</th>
                <th>Date Sold</th>
                <th>View Receipt</th>
              </tr>
            </thead>
        <tbody>
          {% for sale in recent_sales %}
          <tr>
            <!-- Sale ID -->
            <td>
              <strong>#{{ sale.sale_id }}</strong>
              {% if sale.is_reversed %}
                <span class="badge badge-warning" style="font-size: 10px; background: #fef3c7; color: #92400e;">
                  <i class="bi bi-arrow-counterclockwise"></i> REVERSED
                </span>
              {% endif %}
            </td>

            <!-- buyer -->
            <td>{{ sale.buyer_name|default:"Walk-in" }}</td>

            <!-- Total Price -->
            <td><strong style="color:#10b981;">{{ sale.total_amount }}</strong></td>


            <!-- sale date -->
            <td>{{ sale.sale_date|date:"M d, Y H:i" }}</td>

            <!-- Vieww etr-->
            <td>
              {% if sale.is_reversed %}
                <span class="btn btn-secondary disabled">ETR Returned</span>

              {% else %}
                {% if sale.batch_id %}
                  <a href="{% url 'sales:batch-receipt' sale.batch_id %}"
                     class="btn btn-primary"
                     style="display: inline-block;">
                    View Receipt ({{ sale.batch_total_sales }} items)
                  </a>
                {% else %}
                  <a href="{% url 'sales:sale-etr' sale.sale_id %}"
                     class="btn btn-primary"
                     style="display: inline-block;">
                   View Receipt
                  </a>
                {% endif %}
                {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9">
              <div class="empty-state">
                <i class="bi bi-box-seam"></i>
                <p>No recent sales found.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
</div>













    <!-- ========================================
         PRODUCT LOOKUP SECTION
         ======================================== -->
    <div id="product-lookup" class="content-section">
      <div class="content-header">
        <button class="mobile-sidebar-toggle" id="mobileSidebarToggle2">
          <i class="bi bi-list"></i>
        </button>
        <h1 class="page-title">Product Lookup & Quick Sale</h1>
      </div>

      <!-- Product Lookup 3-Column Grid -->
      <div class="lookup-grid">
        <!-- Product Code Input -->
        <div class="lookup-card">
          <div class="card-header-custom">
            <div class="card-icon primary">
              <i class="bi bi-upc-scan"></i>
            </div>
            <h3 class="card-title-custom">Product Code</h3>
          </div>
          <input type="text" id="lookup-product-code" class="form-control form-control-lg" placeholder="Enter product codeâ€¦">
          <button type="button" class="btn-action btn-primary" id="btn-search-product" style="margin-top: 1rem;">
            <i class="bi bi-search"></i>
            <span>Lookup Product</span>
          </button>
        </div>

        <!-- Product Name Display -->
        <div class="lookup-card">
          <div class="card-header-custom">
            <div class="card-icon success">
              <i class="bi bi-box"></i>
            </div>
            <h3 class="card-title-custom">Product Name</h3>
          </div>
          <div class="display-box" id="product-name-display">
            <p style="color: #9ca3af; margin: 0;">Search for a product</p>
          </div>
        </div>

        <!-- Selling Price Display -->
        <div class="lookup-card">
          <div class="card-header-custom">
            <div class="card-icon info">
              <i class="bi bi-currency-dollar"></i>
            </div>
            <h3 class="card-title-custom">Selling Price</h3>
          </div>
          <div class="display-box" id="selling-price-display">
            <p style="color: #9ca3af; margin: 0;">---</p>
          </div>
        </div>
      </div>

      <!-- Recent Sales Table -->
      <div class="data-card" style="margin-top: 2rem;">
        <div class="card-header-table">
          <h2 class="section-title">Recent Sales</h2>
          <button type="button" class="btn-action btn-success" data-section="record-sale" style="width: auto; padding: 0.5rem 1.25rem;">
            <i class="bi bi-plus-circle"></i>
            <span>Record Sale</span>
          </button>
        </div>
        
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Sale ID</th>
                <th>Buyer</th>
                <th>Total Price</th>
                <th>Date Sold</th>
                <th>View Receipt</th>
              </tr>
            </thead>
        <tbody>
          {% for sale in recent_sales %}
          <tr>
            <!-- Sale ID -->
            <td>
              <strong>#{{ sale.sale_id }}</strong>
              {% if sale.is_reversed %}
                <span class="badge badge-warning" style="font-size: 10px; background: #fef3c7; color: #92400e;">
                  <i class="bi bi-arrow-counterclockwise"></i> REVERSED
                </span>
              {% endif %}
            </td>

            <!-- buyer -->
            <td>{{ sale.buyer_name|default:"Walk-in" }}</td>

            <!-- Total Price -->
            <td><strong style="color:#10b981;">{{ sale.total_amount }}</strong></td>


            <!-- sale date -->
            <td>{{ sale.sale_date|date:"M d, Y H:i" }}</td>

            <!-- Vieww etr-->
            <td>
              {% if sale.is_reversed %}
                <span class="btn btn-secondary disabled">ETR Returned</span>

              {% else %}
                {% if sale.batch_id %}
                  <a href="{% url 'sales:batch-receipt' sale.batch_id %}"
                     class="btn btn-primary"
                     style="display: inline-block;">
                    View Receipt ({{ sale.batch_total_sales }} items)
                  </a>
                {% else %}
                  <a href="{% url 'sales:sale-etr' sale.sale_id %}"
                     class="btn btn-primary"
                     style="display: inline-block;">
                   View Receipt
                  </a>
                {% endif %}
                {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9">
              <div class="empty-state">
                <i class="bi bi-box-seam"></i>
                <p>No recent sales found.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
</div>














    <!-- ==========================================
         RECORD SALE SECTION
    ========================================== -->
<div id="record-sale" class="content-section">

  <!-- Header -->
  <div class="content-header">
    <button class="mobile-sidebar-toggle" id="mobileSidebarToggle3">
      <i class="bi bi-list"></i>
    </button>
    <h1 class="page-title">
      <i class="bi bi-cart-plus"></i> Record Sale
    </h1>
  </div>

  <!-- Two Column Layout -->
  <div class="row g-4">
    
    <!-- ==========================================
         COLUMN A: INPUT FORM
    ========================================== -->
    <div class="col-lg-6">
      <div class="data-card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-pencil-square"></i> Sale Input Form
          </h5>
        </div>
        <div class="card-body" style="padding: 2rem;">
          
          <form id="simpleSaleForm">
            
            <!-- SKU Value with Live Search -->
            <div class="mb-4">
              <label for="skuValue" class="form-label required">
                <i class="bi bi-upc-scan"></i> SKU Value
              </label>
              <input type="text" 
                     id="skuValue" 
                     name="sku_value" 
                     class="form-control form-control-lg"
                     placeholder="Start typing SKU / IMEI / Serial Number" 
                     required 
                     autocomplete="off"
                     autofocus>
              <small class="form-text text-muted">
                Type to search products in real-time
              </small>
              
              <!-- Live Search Results Dropdown -->
              <div id="skuSearchResults" class="list-group mt-2" style="display: none; max-height: 300px; overflow-y: auto; position: relative; z-index: 1000;"></div>
            </div>

            <!-- Client Name -->
            <div class="mb-3">
              <label for="clientName" class="form-label required">
                <i class="bi bi-person"></i> Client Name
              </label>
              <input type="text" 
                     id="clientName" 
                     name="client_name" 
                     class="form-control form-control-lg"
                     placeholder="Enter client full name" 
                     required>
            </div>

            <!-- ID Number -->
            <div class="mb-3">
              <label for="idNumber" class="form-label required">
                <i class="bi bi-card-text"></i> ID Number
              </label>
              <input type="text" 
                     id="idNumber" 
                     name="id_number" 
                     class="form-control form-control-lg"
                     placeholder="Enter ID number" 
                     required>
            </div>

            <!-- Phone Number -->
            <div class="mb-3">
              <label for="phoneNumber" class="form-label required">
                <i class="bi bi-telephone"></i> Phone Number
              </label>
              <input type="tel" 
                     id="phoneNumber" 
                     name="phone_number" 
                     class="form-control form-control-lg"
                     placeholder="0712345678" 
                     required>
            </div>

            <!-- NOK Name -->
            <div class="mb-3">
              <label for="nokName" class="form-label required">
                <i class="bi bi-person-badge"></i> Next of Kin Name
              </label>
              <input type="text" 
                     id="nokName" 
                     name="nok_name" 
                     class="form-control form-control-lg"
                     placeholder="Enter NOK name" 
                     required>
            </div>

            <!-- NOK Phone Number -->
            <div class="mb-4">
              <label for="nokPhone" class="form-label required">
                <i class="bi bi-telephone-forward"></i> NOK Phone Number
              </label>
              <input type="tel" 
                     id="nokPhone" 
                     name="nok_phone" 
                     class="form-control form-control-lg"
                     placeholder="0712345678" 
                     required>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2 mt-4">
              <button type="submit" 
                      id="submitSaleBtn" 
                      class="btn btn-success btn-lg">
                <i class="bi bi-check-circle"></i> Submit Sale
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>

    <!-- ==========================================
         COLUMN B: DISPLAY & EDIT SECTION
    ========================================== -->
    <div class="col-lg-6">
      <div class="data-card h-100">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-display"></i> Product & Client Details
          </h5>
        </div>
        <div class="card-body" style="padding: 2rem;">
          
          <!-- Initial State (No Product Selected) -->
          <div id="emptyDisplayState" class="text-center py-5">
            <i class="bi bi-box-seam" style="font-size: 4rem; color: #cbd5e1;"></i>
            <h5 class="text-muted mt-3">No Product Selected</h5>
            <p class="text-muted">
              Start typing SKU value to search products
            </p>
          </div>

          <!-- Product Details Display -->
          <div id="productDisplaySection" style="display: none;">
            
            <!-- Product Info Card -->
            <div class="product-display-card mb-4">
              <h5 class="mb-3" style="color: #10b981; font-weight: 700;">
                <i class="bi bi-box"></i> Product Information
              </h5>
              
              <div class="info-item mb-3">
                <label class="display-label">
                  <i class="bi bi-tag"></i> Product Name
                </label>
                <div class="display-value" id="displayProductName">---</div>
              </div>

              <div class="info-item mb-3">
                <label class="display-label">
                  <i class="bi bi-upc"></i> Full SKU Value
                </label>
                <div class="display-value" id="displaySkuValue">---</div>
              </div>

              <div class="info-item mb-3">
                <label class="display-label">
                  <i class="bi bi-currency-exchange"></i> Selling Price (Editable)
                </label>
                <div class="input-group">
                  <span class="input-group-text">KSH</span>
                  <input type="number" 
                         id="editSellingPrice" 
                         class="form-control form-control-lg" 
                         step="0.01"
                         placeholder="0.00">
                  <button class="btn btn-outline-success" 
                          type="button" 
                          id="updatePriceBtn">
                    <i class="bi bi-check"></i> Update
                  </button>
                </div>
              </div>
            </div>

            <hr class="my-4">

            <!-- Client Details Display -->
            <div class="client-display-card">
              <h5 class="mb-3" style="color: #0dcaf0; font-weight: 700;">
                <i class="bi bi-person-vcard"></i> Client Information
              </h5>

              <!-- Client Name -->
              <div class="info-item mb-3">
                <label class="display-label">
                  <i class="bi bi-person"></i> Client Name
                </label>
                <div class="input-group">
                  <input type="text" 
                         id="editClientName" 
                         class="form-control" 
                         placeholder="Client name"
                         readonly>
                  <button class="btn btn-outline-primary btn-sm" 
                          type="button" 
                          onclick="enableEdit('editClientName')">
                    <i class="bi bi-pencil"></i>
                  </button>
                </div>
              </div>

              <!-- ID Number -->
              <div class="info-item mb-3">
                <label class="display-label">
                  <i class="bi bi-card-text"></i> ID Number
                </label>
                <div class="input-group">
                  <input type="text" 
                         id="editIdNumber" 
                         class="form-control" 
                         placeholder="ID number"
                         readonly>
                  <button class="btn btn-outline-primary btn-sm" 
                          type="button" 
                          onclick="enableEdit('editIdNumber')">
                    <i class="bi bi-pencil"></i>
                  </button>
                </div>
              </div>

              <!-- Phone Number -->
              <div class="info-item mb-3">
                <label class="display-label">
                  <i class="bi bi-telephone"></i> Phone Number
                </label>
                <div class="input-group">
                  <input type="tel" 
                         id="editPhoneNumber" 
                         class="form-control" 
                         placeholder="Phone number"
                         readonly>
                  <button class="btn btn-outline-primary btn-sm" 
                          type="button" 
                          onclick="enableEdit('editPhoneNumber')">
                    <i class="bi bi-pencil"></i>
                  </button>
                </div>
              </div>

              <!-- NOK Name -->
              <div class="info-item mb-3">
                <label class="display-label">
                  <i class="bi bi-person-badge"></i> NOK Name
                </label>
                <div class="input-group">
                  <input type="text" 
                         id="editNokName" 
                         class="form-control" 
                         placeholder="NOK name"
                         readonly>
                  <button class="btn btn-outline-primary btn-sm" 
                          type="button" 
                          onclick="enableEdit('editNokName')">
                    <i class="bi bi-pencil"></i>
                  </button>
                </div>
              </div>

              <!-- NOK Phone -->
              <div class="info-item mb-3">
                <label class="display-label">
                  <i class="bi bi-telephone-forward"></i> NOK Phone
                </label>
                <div class="input-group">
                  <input type="tel" 
                         id="editNokPhone" 
                         class="form-control" 
                         placeholder="NOK phone"
                         readonly>
                  <button class="btn btn-outline-primary btn-sm" 
                          type="button" 
                          onclick="enableEdit('editNokPhone')">
                    <i class="bi bi-pencil"></i>
                  </button>
                </div>
              </div>
            </div>

          </div>

          <!-- Sale Messages -->
          <div id="saleStatusMessage" class="mt-4"></div>

        </div>
      </div>
    </div>

  </div><!-- End Row -->

</div>












    <!-- ========================================
         MY SALES SECTION
         ======================================== -->
    <div id="my-sales" class="content-section">
      <div class="content-header">
        <button class="mobile-sidebar-toggle" id="mobileSidebarToggle4">
          <i class="bi bi-list"></i>
        </button>
        <h1 class="page-title">My Sales</h1>
        <button type="button" class="btn-action btn-success" data-section="record-sale" style="width: auto; padding: 0.75rem 1.5rem;">
          <i class="bi bi-plus-circle"></i>
          <span>Record Sale</span>
        </button>
      </div>
      
      <div class="data-card">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Sale ID</th>
                <th>Buyer</th>
                <th>Total Amount</th>
                <th>Date Sold</th>
                <th>View Receipt</th>
              </tr>
            </thead>
            <tbody>
          {% for sale in all_sales %}
          <tr>
            <td class="sale-id">#{{ sale.sale_id }}</td>
            <td>{{ sale.buyer_name|default:"N/A" }}</td>
            <td><strong style="color:#10b981;">{{ sale.total_amount }}</strong></td>
            <td>{{ sale.sale_date|date:"M d, Y H:i" }}</td>
            <td>
              {% if sale.is_reversed %}
                <span class="btn btn-secondary disabled">ETR Returned</span>

              {% else %}
                {% if sale.batch_id %}
                  <a href="{% url 'sales:batch-receipt' sale.batch_id %}"
                    class="btn btn-primary"
                     style="display: inline-block;">
                    View Receipt ({{ sale.batch_total_sales }} items)
                  </a>
                {% else %}
                  <a href="{% url 'sales:sale-etr' sale.sale_id %}"
                     class="btn btn-primary"
                     style="display: inline-block;">
                    View Receipt
                  </a>
                {% endif %}
              {% endif %}
            </td>

          </tr>

          {% empty %}
          <tr>
            <td colspan="8" class="empty-state">
              <i class="bi bi-receipt"></i>
              <p>No sales recorded yet</p>
            </td>
          </tr>
          {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ========================================
         ALL INVENTORY SECTION
         ======================================== -->
    <div id="My-inventory" class="content-section">
      <div class="content-header">
        <button class="mobile-sidebar-toggle" id="mobileSidebarToggle5">
          <i class="bi bi-list"></i>
        </button>
        <h1 class="page-title">All Inventory</h1>
              <!-- Filter Buttons -->
        <select id="productStatusFilter" class="form-select" style="width: auto;" onchange="filterProducts()">
          <option value="all">All Products</option>
          <option value="instock">In Stock</option>
          <option value="outofstock">Out of Stock</option>
          <option value="lowstock">Low Stock (â‰¤5)</option>
        </select>
      
        <select id="productCategoryFilter" class="form-select" style="width: auto;" onchange="filterProducts()">
          <option value="all">All Categories</option>
          {% for category in categories %}
          <option value="{{ category.id }}">{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="data-card">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Product Code</th>
                <th>Product Name</th>
                <th>Category</th>
                <th>Stock</th>
                <th>IMEI/Serial Number</th>
                <th>Selling Price</th>
              </tr>
            </thead>
            <tbody>
              {% for product in my_products %}
              <tr>
                <td><strong>{{ product.product_code }}</strong></td>
                <td>{{ product.name }}</td>
                <td>{{ product.category.name }}</td>


<!-- STOCK COLUMN -->
<td class="product-quantity">
  {% if product.category.is_single_item %}
    {% if product.status == 'sold' %}
      <strong style="color: #dc3545; font-weight: bold;">
        <i class="bi bi-x-circle-fill"></i> SOLD
      </strong>
    {% else %}
      <strong style="color: #28a745; font-weight: bold;">
        <i class="bi bi-check-circle-fill"></i> Available
      </strong>
    {% endif %}
  {% else %}
    {% if product.quantity > 5 %}
      <strong style="color: #28a745; font-weight: bold;">
        {{ product.quantity }} units
      </strong>
    {% elif product.quantity > 0 %}
      <strong style="color: #ffc107; font-weight: bold;">
        {{ product.quantity }} units (Low)
      </strong>
    {% else %}
      <strong style="color: #dc3545; font-weight: bold;">
        0 units (Out)
      </strong>
    {% endif %}
  {% endif %}
</td>


                <td>{{ product.sku_value }}</td>
                <td class="price-tag">KSH {{ product.selling_price }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="empty-state">
                  <i class="bi bi-box-seam"></i>
                  <p>No products in inventory</p>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </main>
</div>












<script>
  
// ================================
// SECTION NAVIGATION SYSTEM
// ================================

document.addEventListener('DOMContentLoaded', function() {
  const navItems = document.querySelectorAll('.nav-item[data-section], .btn-action[data-section], button[data-section]');
  const sections = document.querySelectorAll('.content-section');
  const sidebar = document.getElementById('dashboardSidebar');
  
  // Get all mobile sidebar toggles
  const mobileSidebarToggles = [
    document.getElementById('mobileSidebarToggle'),
    document.getElementById('mobileSidebarToggle2'),
    document.getElementById('mobileSidebarToggle3'),
    document.getElementById('mobileSidebarToggle4'),
    document.getElementById('mobileSidebarToggle5')
  ];

  // ============================================
  // DETECT FRESH LOGIN vs NAVIGATION
  // ============================================
  function isFreshLogin() {
    // Check if this is the first page load after login
    const isFirstLoad = !sessionStorage.getItem('dashboardVisited');
    
    if (isFirstLoad) {
      // Mark that dashboard has been visited in this session
      sessionStorage.setItem('dashboardVisited', 'true');
      return true;
    }
    
    return false;
  }

  // Navigation handler
  function navigateToSection(sectionId) {
    // Hide all sections
    sections.forEach(section => section.classList.remove('active'));
    
    // Remove active class from all sidebar nav items only
    document.querySelectorAll('.sidebar-nav .nav-item').forEach(item => {
      item.classList.remove('active');
    });
    
    // Show target section
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
      targetSection.classList.add('active');
      
      // Scroll to top of page
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Add active class to clicked sidebar nav item
    const activeSidebarNavItem = document.querySelector(`.sidebar-nav .nav-item[data-section="${sectionId}"]`);
    if (activeSidebarNavItem) {
      activeSidebarNavItem.classList.add('active');
    }
    
    // Save current section to localStorage
    localStorage.setItem('activeSection', sectionId);
    
    // Close mobile sidebar if open
    if (window.innerWidth <= 992) {
      sidebar.classList.remove('active');
    }
  }

  // ============================================
  // RESTORE SECTION ON PAGE LOAD
  // ============================================
  function restoreActiveSection() {
    // âœ… If fresh login, always go to Overview
    if (isFreshLogin()) {
      console.log('Fresh login detected - Loading Overview');
      navigateToSection('overview');
      return;
    }
    
    // âœ… Otherwise, restore saved section
    const savedSection = localStorage.getItem('activeSection');
    if (savedSection) {
      console.log('Restoring saved section:', savedSection);
      navigateToSection(savedSection);
    } else {
      // Fallback to overview if no saved section
      navigateToSection('overview');
    }
  }

  // Restore section on page load
  restoreActiveSection();

  // Add click handlers to all navigation items
  navItems.forEach(item => {
    item.addEventListener('click', function(e) {
      // Don't prevent default for logout button
      if (this.type !== 'submit' || !this.closest('form[action*="logout"]')) {
        e.preventDefault();
      }
      
      const sectionId = this.getAttribute('data-section');
      if (sectionId) {
        navigateToSection(sectionId);
      }
    });
  });

  // Mobile sidebar toggle handlers
  mobileSidebarToggles.forEach(toggle => {
    if (toggle) {
      toggle.addEventListener('click', function(e) {
        e.stopPropagation();
        sidebar.classList.toggle('active');
      });
    }
  });

  // Close sidebar when clicking outside on mobile
  document.addEventListener('click', function(e) {
    if (window.innerWidth <= 992) {
      const isClickInsideSidebar = sidebar.contains(e.target);
      const isClickOnToggle = mobileSidebarToggles.some(toggle => toggle && toggle.contains(e.target));
      
      if (!isClickInsideSidebar && !isClickOnToggle && sidebar.classList.contains('active')) {
        sidebar.classList.remove('active');
      }
    }
  });

  // Handle window resize
  window.addEventListener('resize', function() {
    if (window.innerWidth > 992) {
      sidebar.classList.remove('active');
    }
  });

  // ============================================
  // CLEAR SESSION ON LOGOUT
  // ============================================
  const logoutButton = document.querySelector('form[action*="logout"] button[type="submit"]');
  if (logoutButton) {
    logoutButton.addEventListener('click', function() {
      // Clear session storage on logout
      sessionStorage.removeItem('dashboardVisited');
      console.log('Session cleared on logout');
    });
  }
});


// ================================
// PRODUCT LOOKUP - AJAX FUNCTIONALITY
// ================================

document.addEventListener('DOMContentLoaded', function() {
  const lookupBtn = document.getElementById("btn-search-product");
  const productCodeInput = document.getElementById("lookup-product-code");
  const nameDisplay = document.getElementById("product-name-display");
  const priceDisplay = document.getElementById("selling-price-display");

  // Ensure the URL points to your Django AJAX endpoint
  const productLookupUrl = "{% url 'inventory:product-lookup' %}";

  function resetDisplays() {
    if (nameDisplay) {
      nameDisplay.innerHTML = '<p style="color: #9ca3af; margin: 0;">Search for a product</p>';
      nameDisplay.classList.remove('has-content');
    }
    if (priceDisplay) {
      priceDisplay.innerHTML = '<p style="color: #9ca3af; margin: 0;">---</p>';
      priceDisplay.classList.remove('has-content');
    }
  }

  function showToast(message, type="info") {
    // Simple toast implementation
    const toast = document.createElement("div");
    toast.className = `toast-message ${type}`;
    toast.innerText = message;
    document.body.appendChild(toast);
    setTimeout(() => { toast.classList.add("show"); }, 50);
    setTimeout(() => { toast.remove(); }, 3000);
  }

  function lookupProduct() {
    const code = productCodeInput.value.trim();
    if (!code) {
      showToast("Please enter a product code", "error");
      return;
    }

    // Show loading
    lookupBtn.disabled = true;
    lookupBtn.innerHTML = '<i class="bi bi-hourglass-split"></i><span> Searching...</span>';

    fetch(`${productLookupUrl}?product_code=${encodeURIComponent(code)}`)
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          // Update Product Name
          if (nameDisplay) {
            nameDisplay.innerHTML = `
              <div>
                <p class="display-value">${data.product_name}</p>
                <p class="display-label">${data.product_code}</p>
              </div>
            `;
            nameDisplay.classList.add('has-content');
          }

          // Update Selling Price
          if (priceDisplay) {
            const price = parseFloat(data.selling_price).toFixed(2);
            priceDisplay.innerHTML = `
              <div>
                <p class="display-value">KSH ${price}</p>
                <p class="display-label">Current price</p>
              </div>
            `;
            priceDisplay.classList.add('has-content');
          }

          showToast("Product found!", "success");

        } else {
          showToast(data.message || "Product not found", "error");
          resetDisplays();
        }
      })
      .catch(err => {
        console.error("Product lookup error:", err);
        showToast("Error connecting to server", "error");
        resetDisplays();
      })
      .finally(() => {
        lookupBtn.disabled = false;
        lookupBtn.innerHTML = '<i class="bi bi-search"></i><span> Lookup Product</span>';
      });
  }

  // Button click
  if (lookupBtn) {
    lookupBtn.addEventListener("click", lookupProduct);
  }

  // Enter key support
  if (productCodeInput) {
    productCodeInput.addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        lookupProduct();
      }
    });
  }

});















// ================================
//  RECORD SALE SECTION - LIVE SEARCH
// ================================
document.addEventListener('DOMContentLoaded', function() {
  const skuInput = document.getElementById('skuValue');
  const clientNameInput = document.getElementById('clientName');
  const idNumberInput = document.getElementById('idNumber');
  const phoneNumberInput = document.getElementById('phoneNumber');
  const nokNameInput = document.getElementById('nokName');
  const nokPhoneInput = document.getElementById('nokPhone');
  
  const skuSearchResults = document.getElementById('skuSearchResults');
  const emptyDisplayState = document.getElementById('emptyDisplayState');
  const productDisplaySection = document.getElementById('productDisplaySection');
  
  const displayProductName = document.getElementById('displayProductName');
  const displaySkuValue = document.getElementById('displaySkuValue');
  const editSellingPrice = document.getElementById('editSellingPrice');
  
  const editClientName = document.getElementById('editClientName');
  const editIdNumber = document.getElementById('editIdNumber');
  const editPhoneNumber = document.getElementById('editPhoneNumber');
  const editNokName = document.getElementById('editNokName');
  const editNokPhone = document.getElementById('editNokPhone');
  
  const saleForm = document.getElementById('simpleSaleForm');
  const saleStatusMessage = document.getElementById('saleStatusMessage');

  let debounceTimer;
  let currentProduct = null;

  // ============================================
  // LIVE SKU SEARCH - TRIGGERS ON EVERY KEYSTROKE
  // ============================================
  skuInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    const searchTerm = this.value.trim();
    
    // Search starts from the first digit entered
    if (searchTerm.length === 0) {
      hideSearchResults();
      showEmptyState();
      return;
    }
    
    // Debounce the search slightly (200ms) to avoid too many requests
    debounceTimer = setTimeout(() => searchProducts(searchTerm), 200);
  });

  // ============================================
  // SEARCH PRODUCTS IN DATABASE
  // ============================================
  async function searchProducts(searchTerm) {
    try {
      showSearchLoading();
      
      // Call Django backend with search term
      // This endpoint should return ALL products containing the search term
      const response = await fetch(`/sales/product-search/?q=${encodeURIComponent(searchTerm)}`);
      const data = await response.json();
      
      if (data.success && data.products && data.products.length > 0) {
        displaySearchResults(data.products);
      } else {
        showNoResults(searchTerm);
      }
      
    } catch (error) {
      console.error('Search error:', error);
      showSearchError();
    }
  }

  // ============================================
  // DISPLAY SEARCH RESULTS
  // ============================================
  function displaySearchResults(products) {
    skuSearchResults.innerHTML = '';
    skuSearchResults.style.display = 'block';
    
    products.forEach(product => {
      const resultItem = document.createElement('a');
      resultItem.href = '#';
      resultItem.className = 'list-group-item list-group-item-action';
      
      resultItem.innerHTML = `
        <div class="d-flex w-100 justify-content-between align-items-center">
          <div>
            <h6 class="mb-1">${escapeHtml(product.name)}</h6>
            <small class="product-sku">
              <i class="bi bi-upc-scan"></i> ${escapeHtml(product.sku_code || product.product_code)}
            </small>
          </div>
          <span class="product-price">
            KSH ${formatPrice(product.unit_price || product.selling_price)}
          </span>
        </div>
      `;
      
      // Click handler to select product
      resultItem.addEventListener('click', function(e) {
        e.preventDefault();
        selectProduct(product);
      });
      
      skuSearchResults.appendChild(resultItem);
    });
  }

  // ============================================
  // SELECT PRODUCT FROM SEARCH RESULTS
  // ============================================
  function selectProduct(product) {
    currentProduct = product;
    
    // Update SKU input with selected product's SKU
    skuInput.value = product.sku_code || product.product_code;
    
    // Hide search results
    hideSearchResults();
    
    // Display product details
    displayProductDetails(product);
    
    // Focus on next input (client name)
    clientNameInput.focus();
  }

  // ============================================
  // DISPLAY PRODUCT DETAILS IN COLUMN B
  // ============================================
  function displayProductDetails(product) {
    emptyDisplayState.style.display = 'none';
    productDisplaySection.style.display = 'block';
    
    displayProductName.textContent = product.name || '---';
    displaySkuValue.textContent = product.sku_code || product.product_code || '---';
    editSellingPrice.value = product.unit_price || product.selling_price || '';
  }

  // ============================================
  // SEARCH RESULT STATES
  // ============================================
  function showSearchLoading() {
    skuSearchResults.innerHTML = '<div class="search-loading"><i class="bi bi-hourglass-split"></i> Searching database...</div>';
    skuSearchResults.style.display = 'block';
  }

  function showNoResults(searchTerm) {
    skuSearchResults.innerHTML = `
      <div class="no-results">
        <i class="bi bi-search"></i> 
        No products found matching "${escapeHtml(searchTerm)}"
      </div>
    `;
    skuSearchResults.style.display = 'block';
  }

  function showSearchError() {
    skuSearchResults.innerHTML = `
      <div class="no-results">
        <i class="bi bi-exclamation-triangle"></i> 
        Error searching database
      </div>
    `;
    skuSearchResults.style.display = 'block';
  }

  function hideSearchResults() {
    skuSearchResults.style.display = 'none';
    skuSearchResults.innerHTML = '';
  }

  // ============================================
  // SYNC CLIENT DETAILS TO COLUMN B
  // ============================================
  clientNameInput.addEventListener('input', function() {
    editClientName.value = this.value;
  });

  idNumberInput.addEventListener('input', function() {
    editIdNumber.value = this.value;
  });

  phoneNumberInput.addEventListener('input', function() {
    editPhoneNumber.value = this.value;
  });

  nokNameInput.addEventListener('input', function() {
    editNokName.value = this.value;
  });

  nokPhoneInput.addEventListener('input', function() {
    editNokPhone.value = this.value;
  });

  // ============================================
  // ENABLE EDIT FOR READONLY FIELDS
  // ============================================
  window.enableEdit = function(fieldId) {
    const field = document.getElementById(fieldId);
    if (field) {
      field.removeAttribute('readonly');
      field.focus();
      field.classList.add('border-primary');
    }
  };

  // ============================================
  // UPDATE PRICE BUTTON
  // ============================================
  document.getElementById('updatePriceBtn').addEventListener('click', function() {
    const newPrice = editSellingPrice.value;
    if (newPrice && parseFloat(newPrice) > 0) {
      showMessage('Price updated successfully!', 'success');
    } else {
      showMessage('Please enter a valid price', 'warning');
    }
  });

  // ============================================
  // FORM SUBMISSION
  // ============================================
  saleForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!currentProduct) {
      showMessage('Please select a valid product first', 'danger');
      return;
    }
    
    const saleData = {
      product_id: currentProduct.id,
      sku_value: skuInput.value.trim(),
      product_name: displayProductName.textContent,
      selling_price: editSellingPrice.value,
      client_name: editClientName.value,
      id_number: editIdNumber.value,
      phone_number: editPhoneNumber.value,
      nok_name: editNokName.value,
      nok_phone: editNokPhone.value
    };
    
    try {
      showMessage('Processing sale...', 'info');
      
      // Submit to Django backend
      const response = await fetch('/sales/record-sale/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(saleData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        showMessage('âœ… Sale recorded successfully!', 'success');
        
        // Reset form after 2 seconds
        setTimeout(() => {
          saleForm.reset();
          showEmptyState();
          currentProduct = null;
          skuInput.focus();
        }, 2000);
      } else {
        showMessage('âŒ Error: ' + (result.message || 'Failed to record sale'), 'danger');
      }
      
    } catch (error) {
      console.error('Submission error:', error);
      showMessage('âŒ Error submitting sale', 'danger');
    }
  });

  // ============================================
  // UTILITY FUNCTIONS
  // ============================================
  function showEmptyState() {
    emptyDisplayState.style.display = 'block';
    productDisplaySection.style.display = 'none';
  }

  function showMessage(message, type = 'info') {
    const alertClass = `alert alert-${type}`;
    saleStatusMessage.innerHTML = `<div class="${alertClass}">${message}</div>`;
    
    if (type === 'success') {
      setTimeout(() => {
        saleStatusMessage.innerHTML = '';
      }, 5000);
    }
  }

  function formatPrice(price) {
    return parseFloat(price).toLocaleString('en-KE', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, m => map[m]);
  }

  function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // ============================================
  // KEYBOARD NAVIGATION FOR SEARCH RESULTS
  // ============================================
  let selectedResultIndex = -1;
  
  skuInput.addEventListener('keydown', function(e) {
    const results = skuSearchResults.querySelectorAll('.list-group-item');
    
    if (results.length === 0) return;
    
    // Arrow Down
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedResultIndex = Math.min(selectedResultIndex + 1, results.length - 1);
      highlightResult(results);
    }
    
    // Arrow Up
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedResultIndex = Math.max(selectedResultIndex - 1, 0);
      highlightResult(results);
    }
    
    // Enter - Select highlighted result
    if (e.key === 'Enter' && selectedResultIndex >= 0) {
      e.preventDefault();
      results[selectedResultIndex].click();
    }
    
    // Escape - Close results
    if (e.key === 'Escape') {
      hideSearchResults();
      selectedResultIndex = -1;
    }
  });
  
  function highlightResult(results) {
    results.forEach((result, index) => {
      if (index === selectedResultIndex) {
        result.classList.add('active');
        result.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      } else {
        result.classList.remove('active');
      }
    });
  }
});














// ================================
//  ETR TRIGGER + FISCAL RECEIPT
// ================================
document.querySelectorAll('.action-btn-success').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        const url = this.href;

        // Step 1: Trigger ETR
        fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {

                const etrNumber = data.data.receiptNumber;
                const saleId = data.data.saleId;

                // Step 2: Trigger Fiscal Receipt
                fetch('/sales/fiscal/receipt/', {   // <--- FIXED URL
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sale_id: saleId })
                })
                .then(resp => resp.json())
                .then(fiscalData => {
                    if (fiscalData.status === 'success') {
                        const fiscalReceiptNumber = fiscalData.receipt_number;
                        alert(
`ETR sent successfully!
Receipt No: ${etrNumber}
Fiscal Receipt No: ${fiscalReceiptNumber}`
                        );
                    } else {
                        alert(
`ETR sent: ${etrNumber}
Fiscal receipt failed: ${fiscalData.message}`
                        );
                    }
                })
                .catch(err => {
                    alert(
`ETR sent: ${etrNumber}
Fiscal receipt error: ${err}`
                    );
                });

            } else {
                alert('ETR failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(err => console.error('ETR error:', err));
    });
});


</script>

{% endblock %}